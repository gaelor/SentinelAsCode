[![Metsys](https://www.metsys.fr/wp-content/themes/metsys/images/svg/metsys-logo.svg)](https://www.metsys.fr/ "Metsys")
# Workbooks
JSON files in this folder are ARM templates that define Workbooks that need to be deployed on a given Sentinel environment.
## AADAudit
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/AADAudit.json)

### Workbook details

> Description: This workbook will get a report on Azure AD.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Azure AD audit logs"},"name":"text - 1"},{"type":9,"content":{"version":"KqlParameterItem/1.0","query":"","crossComponentResources":[],"parameters":[{"id":"bc372bf5-2dcd-4efa-aa85-94b6e6fafe14","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"isRequired":true,"value":{"durationMs":7776000000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}],"allowCustom":true}},{"id":"e032b9f7-5449-4180-9c20-75760afa96f6","version":"KqlParameterItem/1.0","name":"User","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"AuditLogs\r\n| where SourceSystem == \"Azure AD\"\r\n| extend initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \"\", tostring(InitiatedBy.user.userPrincipalName), \"unknown\")\r\n//| where initiator!= \"\"\r\n| summarize Count = count() by initiator\r\n| order by Count desc, initiator asc\r\n| project Value = initiator, Label = strcat(initiator, ' - ', Count), Selected = false","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"0a59a0b3-6d93-4fee-bdbe-147383c510c6","version":"KqlParameterItem/1.0","name":"Category","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"AuditLogs\r\n| extend initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \"\", tostring(InitiatedBy.user.userPrincipalName), \"unknown\")\r\n| where \"{User:lable}\" == \"All\" or initiator in ({User})\r\n| summarize Count = count() by Category\r\n| order by Count desc, Category asc\r\n| project Value = Category, Label = strcat(Category, ' - ', Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"4d2b245b-5e59-4eb6-9f51-ba926581ab47","version":"KqlParameterItem/1.0","name":"Result","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"AuditLogs\r\n| extend initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \"\", tostring(InitiatedBy.user.userPrincipalName), \"unknown\")\r\n| where \"{User:lable}\" == \"All\" or initiator in ({User})\r\n| summarize Count = count() by Result\r\n| order by Count desc, Result asc\r\n| project Value = Result, Label = strcat(Result, ' - ', Count, ' sign-ins')","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = AuditLogs\r\n| where \"{Category:lable}\" == \"All\" or Category in ({Category})\r\n| where \"{Result:lable}\" == \"All\" or Result in ({Result})\r\n| extend initiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\r\n| where initiatingUserPrincipalName != \"\" \r\n| where \"{User:lable}\" == \"All\" or initiatingUserPrincipalName in ({User});\r\ndata\r\n| summarize Count = count() by Category\r\n| join kind = fullouter (datatable(Category:string)['Medium', 'high', 'low']) on Category\r\n| project Category = iff(Category == '', Category1, Category), Count = iff(Category == '', 0, Count)\r\n| join kind = inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Category)\r\n    on Category\r\n| project-away Category1, TimeGenerated\r\n| extend Category = Category\r\n| union (\r\n    data \r\n    | summarize Count = count() \r\n    | extend jkey = 1\r\n    | join kind=inner (data\r\n        | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n        | extend jkey = 1) on jkey\r\n    | extend Category = 'All', Categorys = '*'    \r\n)\r\n| order by Count desc\r\n| take 10","size":4,"exportFieldName":"Category","exportParameterName":"CategoryFIlter","exportDefaultValue":"All","exportToExcelOptions":"visible","title":"Categories volume","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Category","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"secondaryContent":{"columnMatch":"Trend","formatter":21,"formatOptions":{"palette":"purple","showIcon":true}},"showBorder":false}},"name":"query - 4"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = AuditLogs\r\n| where \"{Result:lable}\" == \"All\" or Result in ({Result})\r\n| extend initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \"\", tostring(InitiatedBy.user.userPrincipalName), \"unknown\")\r\n| where \"{User:lable}\" == \"All\" or initiator in ({User})\r\n| where \"{Category:lable}\" == \"All\" or Category in ({Category})\r\n| where Category == '{CategoryFIlter}' or '{CategoryFIlter}' == \"All\";\r\nlet appData = data\r\n| summarize TotalCount = count() by OperationName, Category\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by OperationName\r\n    | project-away TimeGenerated) on OperationName\r\n| order by TotalCount desc, OperationName asc\r\n| project OperationName, TotalCount, Trend, Category\r\n| serialize Id = row_number();\r\ndata\r\n| summarize TotalCount = count() by initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \"\", tostring(InitiatedBy.user.userPrincipalName), \"unknown\"), Category, OperationName\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by OperationName, initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \"\", tostring(InitiatedBy.user.userPrincipalName), \"unknown\")\r\n    | project-away TimeGenerated) on OperationName, initiator\r\n| order by TotalCount desc, OperationName asc\r\n| project OperationName, initiator, TotalCount, Category, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on OperationName\r\n| project Id, Name = initiator, Type = 'initiator', ['Operations Count'] = TotalCount, Trend, Category, ParentId = Id1\r\n| union (appData \r\n    | project Id, Name = OperationName, Type = 'Operation', ['Operations Count'] = TotalCount, Category, Trend)\r\n| order by ['Operations Count'] desc, Name asc","size":0,"exportParameterName":"UserInfo","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\"}","showAnalytics":true,"showExportToExcel":true,"exportToExcelOptions":"visible","title":"User activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Type","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Operations Count","formatter":8,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":0,"options":{"style":"decimal"}}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"turquoise","showIcon":true},"numberFormat":{"unit":0,"options":{"style":"decimal"}}},{"columnMatch":"Category","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name"},"labelSettings":[]}},"customWidth":"70","showPin":true,"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({UserInfo});\r\nAuditLogs\r\n| where \"{Category:lable}\" == \"All\" or Category in ({Category})\r\n| where \"{Result:lable}\" == \"All\" or Result in ({Result})\r\n| extend initiatingUserPrincipalName = iif (tostring(InitiatedBy.user.userPrincipalName) != \"\", tostring(InitiatedBy.user.userPrincipalName), \"unknown\")\r\n//| where initiatingUserPrincipalName != \"\" \r\n| where \"{User:lable}\" == \"All\" or initiatingUserPrincipalName in ({User})\r\n| where details.Type == '*' or (details.Type == 'initiator' and initiatingUserPrincipalName == details.Name) or (details.Type == 'Operation' and OperationName == details.Name)\r\n| summarize Activities = count() by initiatingUserPrincipalName\r\n| sort by Activities desc nulls last ","size":0,"exportToExcelOptions":"visible","title":"Top active users","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"30","name":"query - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({UserInfo});\r\nlet data = AuditLogs\r\n| extend initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \"\", tostring(InitiatedBy.user.userPrincipalName), \"unknown\")\r\n| where details.Type == '*' or (details.Type == 'initiator' and initiator == details.Name) or (details.Type == 'Operation' and OperationName == details.Name)\r\n| where \"{Category:lable}\" == \"All\" or Category in ({Category})\r\n| where \"{Result:lable}\" == \"All\" or Result in ({Result})\r\n| where \"{User:lable}\" == \"All\" or initiator in ({User});\r\nlet appData = data\r\n| summarize TotalCount = count() by Result\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Result\r\n    | project-away TimeGenerated) on Result\r\n| order by TotalCount desc, Result asc\r\n| project Result, TotalCount, Trend\r\n| serialize Id = row_number();\r\ndata\r\n| summarize TotalCount = count() by OperationName, Result\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Result, OperationName\r\n    | project-away TimeGenerated) on Result, OperationName\r\n| order by TotalCount desc, Result asc\r\n| project Result, OperationName, TotalCount, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on Result\r\n| project Id, Name = OperationName, Type = 'Operation', ['Results Count'] = TotalCount, Trend, ParentId = Id1\r\n| union (appData \r\n    | project Id, Name = Result, Type = 'Result', ['Results Count'] = TotalCount, Trend)\r\n| order by ['Results Count'] desc, Name asc","size":0,"exportParameterName":"ResultInfo","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\"}","exportToExcelOptions":"visible","title":"Result status","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Type","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Results Count","formatter":8,"formatOptions":{"min":0,"palette":"grayBlue","showIcon":true}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"palette":"greenDark","showIcon":true}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Category","formatter":0,"formatOptions":{"showIcon":true}}],"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name"},"labelSettings":[]}},"customWidth":"70","name":"query - 5"}],"styleSettings":{},"fromTemplateId":"sentinel-AzureActiveDirectoryAuditLogs","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FAADAudit.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## AADAuditActivitySignin
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/AADAuditActivitySignin.json)

### Workbook details

> Description: This workbook will get a report on Azure AD Activity.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Azure AD audit, sign-in and Azure Activity logs\n---\nThis workbook combines the following Azure Monitoring tables:\n* Azure Active Directory audit logs\n* Signin logs\n* Azure Activity logs\n\n\nEdit the parameter below to change the timerange used by the graphs"},"name":"text - 2"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"d1983eba-6224-4c08-b792-4910eff535ad","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"description":"Select the time range that will be used for the query's","value":{"durationMs":604800000},"typeSettings":{"selectableValues":[{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}]}}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters"},{"type":1,"content":{"json":"----\n## Signin Logs\n\nWith the SigninLogs we can give a security analyst insight into the different login statuses and locations <br>\n\nThese graphs give a quick representation of the Signin activity of the company's users. <br>\nA security team can easy view the Signin locations and most used applications"},"name":"text - 10"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\n| extend ResultText = case(isnotempty(ResultDescription), ResultDescription, ResultType == 0 and isempty(ResultDescription), \"Successfull login\", \"unknown\") // Create readable result text to include succesfull logins\n| summarize dcount(CorrelationId) by ResultText // Signin results by unique CorrelationId\n| render piechart","size":0,"title":"Login events by result","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"ResultText","exportParameterName":"Selected_ResultText","exportDefaultValue":"","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","chartSettings":{"group":"ResultText","createOtherGroup":null,"seriesLabelSettings":[{"seriesName":"Successfull login","color":"green"}],"ySettings":{"unit":17,"min":null,"max":null}}},"customWidth":"33","name":"query - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\n| extend ResultText = case(isnotempty(ResultDescription), ResultDescription, ResultType == 0 and isempty(ResultDescription), \"Successfull login\", \"unknown\")\n| summarize dcount(CorrelationId) by ResultText, bin(TimeGenerated,4h) // summarize the total Signin events per Description per hour (by unique CorrelationId's)","size":0,"title":"Count of login types per 4 hours","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"barchart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"ResultText","formatter":1},"leftContent":{"columnMatch":"dcount_CorrelationId","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{}},"customWidth":"33","name":"query - 4"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\n| where isnotempty(LocationDetails['countryOrRegion']) and ResultType == 0// Where location details are available and login is successfull\n| extend city = tostring(LocationDetails['city'])\n| summarize count() by city, Location // Summarize by city name\n| join (\nSigninLogs\n| extend city = tostring(LocationDetails['city'])\n| make-series TrendList = count() on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by city \n) on city\n| project Location, city, [\"Total events\"] = count_, TrendLine = TrendList\n| top 10 by [\"Total events\"] desc","size":0,"title":"Successfull login locations","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Location","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"city","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Total events","formatter":4,"formatOptions":{"palette":"blue","showIcon":true}},{"columnMatch":"TrendLine","formatter":9,"formatOptions":{"palette":"greenRed","showIcon":true}},{"columnMatch":"Events","formatter":4,"formatOptions":{"palette":"blue","showIcon":true}},{"columnMatch":"count_","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"TimeGenerated","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"id","formatter":5,"formatOptions":{"showIcon":true}}],"hierarchySettings":{"idColumn":"city","parentColumn":"Location","treeType":0,"expanderColumn":"city","expandTopLevel":false}},"sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"city","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"secondaryContent":{"columnMatch":"Events","formatter":9,"formatOptions":{"showIcon":true}},"showBorder":false},"graphSettings":{"type":0,"topContent":{"columnMatch":"LocationDetails","formatter":1,"formatOptions":{"showIcon":true}},"centerContent":{"columnMatch":"count_","formatter":1,"formatOptions":{"showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"nodeIdField":"count_","sourceIdField":"Location","targetIdField":"city","nodeSize":null,"staticNodeSize":100,"colorSettings":null,"hivesMargin":5},"mapSettings":{"locInfo":"LatLong","locInfoColumn":"GeoSelection","latitude":"latitude","longitude":"longitude","sizeSettings":"count_","sizeAggregation":"Sum","defaultSize":0,"labelSettings":"locationInfo","legendMetric":"count_","legendAggregation":"Sum","itemColorSettings":{"nodeColorField":"count_","colorAggregation":"Sum","type":"heatmap","heatmapPalette":"redGreen"}}},"customWidth":"33","name":"query - 7"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\r\n| where ResultType == 0 and AppDisplayName != \"\"\r\n| summarize count() by AppDisplayName\r\n| join (\r\nSigninLogs\r\n| make-series TrendList = count() on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, 4h) by AppDisplayName \r\n) on AppDisplayName\r\n| top 10 by count_ desc","size":4,"title":"Successfull logins by application","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"AppDisplayName","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"secondaryContent":{"columnMatch":"TrendList","formatter":9,"formatOptions":{"showIcon":true}},"showBorder":false},"graphSettings":{"type":0,"topContent":{"columnMatch":"AppDisplayName","formatter":1},"centerContent":{"columnMatch":"count_","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"name":"query - 14"},{"type":1,"content":{"json":"----\n## AuditLogs\n\nThese tables give an Azure administrators the information they needs to make sure that the services and user operations are successfullly executed. <br>\nIt also benefits the security operator by seeing which operations are perfomed by which users or services. Therefore he can act quickly on a suspicious operation."},"name":"text - 9"},{"type":3,"content":{"version":"KqlItem/1.0","query":"\nAuditLogs\n| summarize Runs = count(), Success = countif(Result == 'success'), Fails = countif(Result != 'success') by OperationName // Summarize the total, successful and failed operations by name\n| extend SuccessRate = (Success * 100 / Runs) // Calculate the percentage of succesful operations against the total\n| join (\nAuditLogs\n| where Result == 'success'\n| make-series TrendList = count() on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by OperationName \n) on OperationName\n| project OperationName, Runs, SuccessRate, TrendList\n| top 10 by Runs desc // Show the top 10 of most run operations","size":0,"title":"Top 10 operation by successrate","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"OperationName","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Runs","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"SuccessRate","formatter":8,"formatOptions":{"min":0,"max":100,"palette":"redGreen","showIcon":true}},{"columnMatch":"TrendList","formatter":9,"formatOptions":{"showIcon":true}}]}},"customWidth":"50","name":"query - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"\nAuditLogs\n| summarize Runs = count(), Success = countif(Result == 'success'), Fails = countif(Result != 'success') by OperationName // Summarize the total, successful and failed operations by name\n| extend SuccessRate = (Success * 100 / Runs) // Calculate the percentage of succesful operations against the total\n| project OperationName, Runs, SuccessRate, Fails\n| top 10 by SuccessRate asc // Show the 10 Operation by least SuccessRate","size":0,"title":"Top 10 most failed operations","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"OperationName","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Runs","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"SuccessRate","formatter":8,"formatOptions":{"min":0,"max":100,"palette":"redGreen","showIcon":true}},{"columnMatch":"Fails","formatter":8,"formatOptions":{"palette":"redBright","showIcon":true}}]}},"customWidth":"50","name":"query - 5 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity \n| union (AuditLogs) // Insert AuditLogs\n| extend CallerUserName = case( Type == 'AuditLogs' and notempty(InitiatedBy['user']), InitiatedBy['user']['userPrincipalName'], // Find best initiator for data source\n                                Type == 'AuditLogs' and InitiatedBy == \"{}\", Identity,\n                                Type == 'AzureActivity'   ,Caller, 'Unknown')\n| extend TargetResource =  case( Type == 'AuditLogs' and TargetResources[0]['type'] == 'User', strcat(TargetResources[0]['type'], \": \", TargetResources[0]['userPrincipalName']), // Find the best resource name for the data source\n                                Type == 'AuditLogs' and TargetResources[0]['type'] == 'Group', strcat(TargetResources[0]['type'], \": \", TargetResources[0]['displayName']),\n                                Type == 'AzureActivity'   ,Resource, 'Unknown')\n| extend ResultStatus =  case( Type == 'AuditLogs' and Result == 'failure', 'failed', // Change the result value to failure for the icon\n                               Type == 'AuditLogs' and Result == 'success', Result, // Only resutl that directly matches icon name\n                               Type == 'AzureActivity' and ActivityStatus == 'Started', 'info', // There is no started icon so using info instead.\n                               Type == 'AzureActivity' and ActivityStatus == 'Failed', 'failed', // change to failed\n                               Type == 'AzureActivity' and ActivityStatus == 'Succeeded', 'success', // Change to success\n                               'unknown')\n| sort by TimeGenerated desc // Sort descending on TimeGenerated to see latest events\n| project Time = TimeGenerated, ['From data source'] = Type, Operation = OperationName, ['Initiated by'] = CallerUserName, TargetResource, ResultStatus\n","size":0,"title":"Latest operation from audit and activity logs","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Time","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Operation","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"InitiatedByName","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Target","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Result","formatter":11,"formatOptions":{"showIcon":true}}],"sortBy":[{"itemKey":"Time","sortOrder":1}]},"sortBy":[{"itemKey":"Time","sortOrder":1}]},"name":"query - 2"},{"type":1,"content":{"json":"---\n## Azure Activity"},"name":"text - 13"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity\r\n| summarize count() by ResourceProvider","size":0,"title":"Most activity by ResourceProvider","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart","gridSettings":{"formatters":[{"columnMatch":"ResourceProvider","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"TotalEvents","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"ResourceProvider1","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Events","formatter":19,"formatOptions":{"showIcon":true,"timelineSettings":{"timelineStartColumn":"TimeGenerated"}}},{"columnMatch":"TimeGenerated","formatter":0,"formatOptions":{"showIcon":true}}]},"tileSettings":{"titleContent":{"columnMatch":"ExtendedLocation","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"LoginEvents","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"secondaryContent":{"columnMatch":"Events","formatter":19,"formatOptions":{"palette":"blueOrange","showIcon":true,"timelineSettings":{"timelineStartColumn":"TimeGenerated","timestampIsEndTime":true}}},"showBorder":false,"sortCriteriaField":"TotalEvents","sortOrderField":2},"graphSettings":{"type":0,"topContent":{"columnMatch":"ResourceProvider","formatter":1},"centerContent":{"columnMatch":"TotalEvents","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{}},"customWidth":"35","name":"query - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity\r\n| summarize Activities = count() by User = Caller","size":0,"title":"Activities by user","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table"},"customWidth":"25","name":"query - 16"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity\n| extend ActivityType = case(OperationName contains \"delete\", \"Delete\",\n                             OperationName contains \"create\", \"Create\",\n                             OperationName contains \"Update\", \"Update\", \"Other\")\n| summarize Succeeded = countif(ActivityStatus == \"Succeeded\"), Failed = countif(ActivityStatus == \"Failed\") by ResourceProvider, ActivityType\n| extend SuccesRate = Succeeded * 100 / (Succeeded + Failed)\n| where isnotempty(SuccesRate)\n| top 10 by SuccesRate asc \n| project ActivityType, ResourceProvider, SuccesRate, Succeeded, Failed ","size":0,"title":"Least successrate by Action and ResourceProvider","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"ActivityType","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"ResourceProvider","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"SuccesRate","formatter":8,"formatOptions":{"palette":"greenRed","showIcon":true}},{"columnMatch":"Succeeded","formatter":4,"formatOptions":{"palette":"blue","showIcon":true}},{"columnMatch":"Failed","formatter":8,"formatOptions":{"palette":"redBright","showIcon":true}}]},"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"OperationName","formatter":1},"leftContent":{"columnMatch":"Runs","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"customWidth":"40","name":"query - 13","styleSettings":{"maxWidth":"100%"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity\r\n| summarize count() by OperationName, bin(TimeGenerated, 4h)","size":0,"title":"Timechart count activitytypes by 4 hours","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"areachart"},"customWidth":"50","name":"query - 15"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity\r\n//| where ActivityStatus == 'Succeeded'\r\n| summarize Actions = count() by OperationName, Id = strcat(Caller, ' - ', CallerIpAddress)\r\n| extend Name = Id\r\n| union ( AzureActivity\r\n//| where ActivityStatus == 'Succeeded'\r\n| summarize Actions = count() by Id = OperationName\r\n| extend Name = Id)\r\n| project Name, Actions, Id, OperationName\r\n| order by Actions desc","size":0,"title":"Tree view for users by operations","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Actions","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"OperationName","formatter":5,"formatOptions":{"showIcon":true}}],"hierarchySettings":{"idColumn":"Id","parentColumn":"OperationName","treeType":0,"expanderColumn":"Name","expandTopLevel":true}},"sortBy":[]},"customWidth":"50","name":"query - 14"}],"fromTemplateId":"AzureAuditActivityAndSigninWorkbook","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FAADAuditActivitySignin.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## AADSignin
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/AADSignin.json)

### Workbook details

> Description: This workbook will get a report on Azure AD Signin.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Sign-in Analysis"},"name":"text - 0"},{"type":9,"content":{"version":"KqlParameterItem/1.0","query":"","crossComponentResources":[],"parameters":[{"id":"13f56671-7604-4427-a4d8-663f3da0cbc5","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"isRequired":true,"value":{"durationMs":1209600000},"typeSettings":{"selectableValues":[{"durationMs":300000,"createdTime":"2018-11-13T19:33:10.162Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":900000,"createdTime":"2018-11-13T19:33:10.164Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":1800000,"createdTime":"2018-11-13T19:33:10.164Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":3600000,"createdTime":"2018-11-13T19:33:10.164Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":14400000,"createdTime":"2018-11-13T19:33:10.164Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":43200000,"createdTime":"2018-11-13T19:33:10.164Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":86400000,"createdTime":"2018-11-13T19:33:10.165Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":172800000,"createdTime":"2018-11-13T19:33:10.166Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":259200000,"createdTime":"2018-11-13T19:33:10.166Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":604800000,"createdTime":"2018-11-13T19:33:10.166Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":1209600000,"createdTime":"2018-11-13T19:33:10.166Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":2592000000,"createdTime":"2018-11-13T19:33:10.167Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false}],"allowCustom":true}},{"id":"3b5cc420-8ad8-4523-ba28-a54910756794","version":"KqlParameterItem/1.0","name":"Apps","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SigninLogs\r\n| summarize Count = count() by AppDisplayName\r\n| order by Count desc, AppDisplayName asc\r\n| project Value = AppDisplayName, Label = strcat(AppDisplayName, ' - ', Count, ' sign-ins'), Selected = false\r\n","value":["value::all"],"typeSettings":{"limitSelectTo":10,"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"f7f7970b-58c1-474f-9043-62243d2d4edd","version":"KqlParameterItem/1.0","name":"Users","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n| summarize Count = count() by UserDisplayName\r\n| order by Count desc, UserDisplayName asc\r\n| project Value = UserDisplayName, Label = strcat(UserDisplayName, ' - ', Count, ' sign-ins'), Selected = false\r\n","value":["value::all"],"typeSettings":{"limitSelectTo":20,"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n|extend errorCode = Status.errorCode\r\n|extend SigninStatus = case(errorCode == 0, \"Success\", errorCode == 50058, \"Pending user action\",errorCode == 50140, \"Pending user action\", errorCode == 51006, \"Pending user action\", errorCode == 50059, \"Pending user action\",errorCode == 65001, \"Pending user action\", errorCode == 52004, \"Pending user action\", errorCode == 50055, \"Pending user action\", errorCode == 50144, \"Pending user action\", errorCode == 50072, \"Pending user action\", errorCode == 50074, \"Pending user action\", errorCode == 16000, \"Pending user action\", errorCode == 16001, \"Pending user action\", errorCode == 16003, \"Pending user action\", errorCode == 50127, \"Pending user action\", errorCode == 50125, \"Pending user action\", errorCode == 50129, \"Pending user action\", errorCode == 50143, \"Pending user action\", errorCode == 81010, \"Pending user action\", errorCode == 81014, \"Pending user action\", errorCode == 81012 ,\"Pending user action\", \"Failure\");\r\ndata\r\n| summarize Count = count() by SigninStatus\r\n| join kind = fullouter (datatable(SigninStatus:string)['Success', 'Pending action (Interrupts)', 'Failure']) on SigninStatus\r\n| project SigninStatus = iff(SigninStatus == '', SigninStatus1, SigninStatus), Count = iff(SigninStatus == '', 0, Count)\r\n| join kind = inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SigninStatus)\r\n    on SigninStatus\r\n| project-away SigninStatus1, TimeGenerated\r\n| extend Status = SigninStatus\r\n| union (\r\n    data \r\n    | summarize Count = count() \r\n    | extend jkey = 1\r\n    | join kind=inner (data\r\n        | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n        | extend jkey = 1) on jkey\r\n    | extend SigninStatus = 'All Sign-ins', Status = '*'    \r\n)\r\n| order by Count desc\r\n\r\n\r\n\r\n","size":3,"exportFieldName":"Status","exportParameterName":"SigninStatus","exportDefaultValue":"*","exportToExcelOptions":"visible","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"SigninStatus","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"blue","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"secondaryContent":{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue","showIcon":true}},"showBorder":false}},"name":"query - 5"},{"type":1,"content":{"json":"<br />\r\n💡 _Click on a tile or a row in the grid to drill-in further_"},"name":"text - 6 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SigninLogs\r\n| extend AppDisplayName = iff(AppDisplayName == '', 'Unknown', AppDisplayName)\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend Country = iff(LocationDetails.countryOrRegion == '', 'Unknown country', tostring(LocationDetails.countryOrRegion))\r\n| extend City = iff(LocationDetails.city == '', 'Unknown city', tostring(LocationDetails.city))\r\n| extend errorCode = Status.errorCode\r\n| extend SigninStatus = case(errorCode == 0, \"Success\", errorCode == 50058, \"Pending user action\",errorCode == 50140, \"Pending user action\", errorCode == 51006, \"Pending user action\", errorCode == 50059, \"Pending user action\",errorCode == 65001, \"Pending user action\", errorCode == 52004, \"Pending user action\", errorCode == 50055, \"Pending user action\", errorCode == 50144, \"Pending user action\", errorCode == 50072, \"Pending user action\", errorCode == 50074, \"Pending user action\", errorCode == 16000, \"Pending user action\", errorCode == 16001, \"Pending user action\", errorCode == 16003, \"Pending user action\", errorCode == 50127, \"Pending user action\", errorCode == 50125, \"Pending user action\", errorCode == 50129, \"Pending user action\", errorCode == 50143, \"Pending user action\", errorCode == 81010, \"Pending user action\", errorCode == 81014, \"Pending user action\", errorCode == 81012 ,\"Pending user action\", \"Failure\")\r\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins';\r\nlet countryData = data\r\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \"Success\"), FailureCount = countif(SigninStatus == \"Failure\"), InterruptCount = countif(SigninStatus == \"Pending user action\") by Country\r\n| join kind=inner\r\n(\r\n    data\r\n   | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by  Country\r\n    | project-away TimeGenerated\r\n)\r\non Country\r\n| project Country, TotalCount, SuccessCount,FailureCount,InterruptCount,  Trend\r\n| order by TotalCount desc, Country asc;\r\ndata\r\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \"Success\"), FailureCount = countif(SigninStatus == \"Failure\"), InterruptCount = countif(SigninStatus == \"Pending user action\") by Country, City\r\n| join kind=inner\r\n(\r\n    data    \r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Country, City\r\n    | project-away TimeGenerated\r\n)\r\non Country, City\r\n| order by TotalCount desc, Country asc\r\n| project Country, City,TotalCount, SuccessCount,FailureCount,InterruptCount, Trend\r\n| join kind=inner\r\n(\r\n    countryData\r\n)\r\non Country\r\n| project Id = City, Name = City, Type = 'City', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = Country\r\n| union (countryData\r\n| project Id = Country, Name = Country, Type = 'Country', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = 'root')\r\n| order by ['Sign-in Count'] desc, Name asc","size":1,"exportParameterName":"LocationDetail","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\"}","showAnalytics":true,"exportToExcelOptions":"visible","title":"Sign-ins by Location","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Type","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Sign-in Count","formatter":8,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue","showIcon":true}},{"columnMatch":"Failure Count|Interrupt Count","formatter":8,"formatOptions":{"min":0,"palette":"orange","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Success Rate","formatter":5,"formatOptions":{"showIcon":true},"numberFormat":{"unit":0,"options":{"style":"percent"}}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name","expandTopLevel":false},"labelSettings":[]}},"customWidth":"67","showPin":true,"name":"query - 8"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({LocationDetail});\r\nlet data = SigninLogs\r\n| extend AppDisplayName = iff(AppDisplayName == '', 'Unknown', AppDisplayName)\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend Country = tostring(LocationDetails.countryOrRegion)\r\n| extend City = tostring(LocationDetails.city)\r\n| extend errorCode = Status.errorCode\r\n| extend SigninStatus = case(errorCode == 0, \"Success\", errorCode == 50058, \"Pending user action\",errorCode == 50140, \"Pending user action\", errorCode == 51006, \"Pending user action\", errorCode == 50059, \"Pending user action\",errorCode == 65001, \"Pending user action\", errorCode == 52004, \"Pending user action\", errorCode == 50055, \"Pending user action\", errorCode == 50144, \"Pending user action\", errorCode == 50072, \"Pending user action\", errorCode == 50074, \"Pending user action\", errorCode == 16000, \"Pending user action\", errorCode == 16001, \"Pending user action\", errorCode == 16003, \"Pending user action\", errorCode == 50127, \"Pending user action\", errorCode == 50125, \"Pending user action\", errorCode == 50129, \"Pending user action\", errorCode == 50143, \"Pending user action\", errorCode == 81010, \"Pending user action\", errorCode == 81014, \"Pending user action\", errorCode == 81012 ,\"Pending user action\", \"Failure\")\r\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins'\r\n| where details.Type == '*' or (details.Type == 'Country' and Country == details.Name) or (details.Type == 'City' and City == details.Name);\r\ndata\r\n| top 200 by TimeGenerated desc\r\n| extend TimeFromNow = now() - TimeGenerated\r\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| project User = UserDisplayName, ['Sign-in Status'] = strcat(iff(SigninStatus == 'Success', '✔️', '❌'), ' ', SigninStatus), ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = errorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName\r\n\r\n","size":1,"showAnalytics":true,"exportToExcelOptions":"visible","title":"Location Sign-in details","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Sign-in Status","formatter":7,"formatOptions":{"linkTarget":"CellDetails","showIcon":true}},{"columnMatch":"App","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Error code","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result type","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result signature","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result description","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Conditional access policies","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Conditional access status","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Operating system","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Browser","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Country or region","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"State","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"City","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Time generated","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Status","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"User principal name","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"TimeGenerated","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"labelSettings":[]}},"customWidth":"33","name":"query - 8"},{"type":1,"content":{"json":""},"name":"text - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend errorCode = Status.errorCode\r\n| extend SigninStatus = case(errorCode == 0, \"Success\", errorCode == 50058, \"Pending user action\",errorCode == 50140, \"Pending user action\", errorCode == 51006, \"Pending user action\", errorCode == 50059, \"Pending user action\",errorCode == 65001, \"Pending user action\", errorCode == 52004, \"Pending user action\", errorCode == 50055, \"Pending user action\", errorCode == 50144, \"Pending user action\", errorCode == 50072, \"Pending user action\", errorCode == 50074, \"Pending user action\", errorCode == 16000, \"Pending user action\", errorCode == 16001, \"Pending user action\", errorCode == 16003, \"Pending user action\", errorCode == 50127, \"Pending user action\", errorCode == 50125, \"Pending user action\", errorCode == 50129, \"Pending user action\", errorCode == 50143, \"Pending user action\", errorCode == 81010, \"Pending user action\", errorCode == 81014, \"Pending user action\", errorCode == 81012 ,\"Pending user action\", \"Failure\")\r\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins';\r\nlet appData = data\r\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \"Success\"), FailureCount = countif(SigninStatus == \"Failure\"), InterruptCount = countif(SigninStatus == \"Pending user action\") by Os = tostring(DeviceDetail.operatingSystem)\r\n| where Os != ''\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Os = tostring(DeviceDetail.operatingSystem)\r\n    | project-away TimeGenerated) on Os\r\n| order by TotalCount desc, Os asc\r\n| project Os, TotalCount, SuccessCount, FailureCount, InterruptCount, Trend\r\n| serialize Id = row_number();\r\ndata\r\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \"Success\"), FailureCount = countif(SigninStatus == \"Failure\"), InterruptCount = countif(SigninStatus == \"Pending user action\") by Os = tostring(DeviceDetail.operatingSystem), Browser = tostring(DeviceDetail.browser)\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Os = tostring(DeviceDetail.operatingSystem), Browser = tostring(DeviceDetail.browser)\r\n    | project-away TimeGenerated) on Os, Browser\r\n| order by TotalCount desc, Os asc\r\n| project Os, Browser, TotalCount, SuccessCount, FailureCount, InterruptCount, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on Os\r\n| project Id, Name = Browser, Type = 'Browser', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = Id1\r\n| union (appData \r\n    | project Id, Name = Os, Type = 'Operating System', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = -1)\r\n| order by ['Sign-in Count'] desc, Name asc","size":1,"exportParameterName":"DeviceDetail","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\"}","showAnalytics":true,"exportToExcelOptions":"visible","title":"Sign-ins by Device","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Type","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Sign-in Count","formatter":8,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Failure Count|Interrupt Count","formatter":8,"formatOptions":{"min":0,"palette":"orange","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Success Rate","formatter":5,"formatOptions":{"showIcon":true},"numberFormat":{"unit":0,"options":{"style":"percent"}}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name","expandTopLevel":false},"labelSettings":[]}},"customWidth":"67","showPin":true,"name":"query - 9"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({DeviceDetail});\r\nlet data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend errorCode = Status.errorCode\r\n| extend SigninStatus = case(errorCode == 0, \"Success\", errorCode == 50058, \"Pending user action\",errorCode == 50140, \"Pending user action\", errorCode == 51006, \"Pending user action\", errorCode == 50059, \"Pending user action\",errorCode == 65001, \"Pending user action\", errorCode == 52004, \"Pending user action\", errorCode == 50055, \"Pending user action\", errorCode == 50144, \"Pending user action\", errorCode == 50072, \"Pending user action\", errorCode == 50074, \"Pending user action\", errorCode == 16000, \"Pending user action\", errorCode == 16001, \"Pending user action\", errorCode == 16003, \"Pending user action\", errorCode == 50127, \"Pending user action\", errorCode == 50125, \"Pending user action\", errorCode == 50129, \"Pending user action\", errorCode == 50143, \"Pending user action\", errorCode == 81010, \"Pending user action\", errorCode == 81014, \"Pending user action\", errorCode == 81012 ,\"Pending user action\", \"Failure\")\r\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins'\r\n| extend Os = tostring(DeviceDetail.operatingSystem), Browser = tostring(DeviceDetail.browser)\r\n| where details.Type == '*' or (details.Type == 'Operating System' and Os == details.Name) or (details.Type == 'Browser' and Browser == details.Name);\r\ndata\r\n| order by TimeGenerated desc\r\n| top 200 by TimeGenerated desc\r\n| extend TimeFromNow = now() - TimeGenerated\r\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| project User = UserDisplayName, ['Sign-in Status'] = strcat(iff(SigninStatus == 'Success', '✔️', '❌'), ' ', SigninStatus), ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = errorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName\r\n\r\n","size":1,"showAnalytics":true,"exportToExcelOptions":"visible","title":"Device Sign-in details","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Sign-in Status","formatter":7,"formatOptions":{"linkTarget":"CellDetails","showIcon":true}},{"columnMatch":"App","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Error code","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result type","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result signature","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result description","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Conditional access policies","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Conditional access status","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Operating system","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Browser","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Country or region","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"State","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"City","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Time generated","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Status","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"User principal name","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"labelSettings":[]}},"customWidth":"33","name":"query - 8 - Copy"},{"type":1,"content":{"json":"## Sign-ins using Conditional Access"},"name":"text - 12"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n|extend CAStatus = case(ConditionalAccessStatus ==\"success\",\"Successful\",\r\n                    ConditionalAccessStatus == \"failure\", \"Failed\",                                     \r\n                    ConditionalAccessStatus == \"notApplied\", \"Not applied\",                                     \r\n                    isempty(ConditionalAccessStatus), \"Not applied\", \r\n                    \"Disabled\")\r\n|mvexpand ConditionalAccessPolicies\r\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\r\n|extend CAGrantControl = case(CAGrantControlName contains \"MFA\", \"Require MFA\", \r\n                            CAGrantControlName contains \"Terms of Use\", \"Require Terms of Use\", \r\n                            CAGrantControlName contains \"Privacy\", \"Require Privacy Statement\", \r\n                            CAGrantControlName contains \"Device\", \"Require Device Compliant\", \r\n                            CAGrantControlName contains \"Azure AD Joined\", \"Require Hybird Azure AD Joined Device\", \r\n                            CAGrantControlName contains \"Apps\", \"Require Approved Apps\",\r\n                            \"Other\");\r\ndata\r\n| summarize Count = dcount(Id) by CAStatus\r\n| join kind = inner (data\r\n                    | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus\r\n                    ) on CAStatus\r\n| project-away CAStatus1, TimeGenerated\r\n| order by Count desc","size":4,"exportToExcelOptions":"visible","title":"Conditional access status","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"CAStatus","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"secondaryContent":{"columnMatch":"Trend","formatter":9,"formatOptions":{"showIcon":true}},"showBorder":false}},"name":"query - 9"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n|extend errorCode = toint(Status.errorCode)\r\n|extend Reason = tostring(Status.failureReason)\r\n|extend CAStatus = case(ConditionalAccessStatus ==0,\"✔️ Success\",                                     \r\n                        ConditionalAccessStatus == 1, \"❌ Failure\",                                     \r\n                        ConditionalAccessStatus == 2, \"⚠️ Not Applied\",                                     \r\n                        ConditionalAccessStatus == \"\", \"⚠️ Not Applied\", \r\n                        \"🚫 Disabled\")\r\n|mvexpand ConditionalAccessPolicies\r\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\r\n|extend CAGrantControl = case(CAGrantControlName contains \"MFA\", \"Require MFA\", \r\n                            CAGrantControlName contains \"Terms of Use\", \"Require Terms of Use\", \r\n                            CAGrantControlName contains \"Privacy\", \"Require Privacy Statement\", \r\n                            CAGrantControlName contains \"Device\", \"Require Device Compliant\", \r\n                            CAGrantControlName contains \"Azure AD Joined\", \"Require Hybird Azure AD Joined Device\", \r\n                            CAGrantControlName contains \"Apps\", \"Require Approved Apps\",\"Other\");\r\ndata\r\n| summarize Count = dcount(Id) by CAStatus, CAGrantControl\r\n| project Id = strcat(CAStatus, '/', CAGrantControl), Name = CAGrantControl, Parent = CAStatus, Count, Type = 'CAGrantControl'\r\n| join kind = inner (data\r\n                    | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus, CAGrantControl\r\n                    | project Id = strcat(CAStatus, '/', CAGrantControl), Trend\r\n                    ) on Id\r\n| project-away Id1\r\n| union (data\r\n    | summarize Count = dcount(Id) by CAStatus\r\n    | project Id = CAStatus, Name = CAStatus, Parent = '', Count, Type = 'CAStatus'\r\n    | join kind = inner (data\r\n                        | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus\r\n                        | project Id = CAStatus, Trend\r\n                        ) on Id\r\n    | project-away Id1)\r\n| order by Count desc","size":0,"exportParameterName":"Detail","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\", \"Parent\":\"*\"}","exportToExcelOptions":"visible","title":"Conditional access status","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Parent","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Count","formatter":8,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":0,"options":{"style":"decimal"}}},{"columnMatch":"Type","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue","showIcon":true}}],"hierarchySettings":{"idColumn":"Id","parentColumn":"Parent","treeType":0,"expanderColumn":"Name","expandTopLevel":true},"labelSettings":[]}},"customWidth":"50","name":"query - 10","styleSettings":{"margin":"50"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({Detail});\r\nlet data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n|extend errorCode = toint(Status.errorCode)\r\n|extend Reason = tostring(Status.failureReason)\r\n|extend CAStatus = case(ConditionalAccessStatus ==\"success\",\"✔️ Success\",                                     \r\n                        ConditionalAccessStatus == \"failure\", \"❌ Failure\",                                     \r\n                        ConditionalAccessStatus == \"notApplied\", \"⚠️ Not Applied\",                                     \r\n                        ConditionalAccessStatus == \"\", \"⚠️ Not Applied\", \r\n                        \"🚫 Disabled\")\r\n|mvexpand ConditionalAccessPolicies\r\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\r\n|extend CAGrantControl = case(CAGrantControlName contains \"MFA\", \"Require MFA\", \r\n                            CAGrantControlName contains \"Terms of Use\", \"Require Terms of Use\", \r\n                            CAGrantControlName contains \"Privacy\", \"Require Privacy Statement\", \r\n                            CAGrantControlName contains \"Device\", \"Require Device Compliant\", \r\n                            CAGrantControlName contains \"Azure AD Joined\", \"Require Hybird Azure AD Joined Device\", \r\n                            CAGrantControlName contains \"Apps\", \"Require Approved Apps\",\r\n                            \"Other\")\r\n|extend CAGrantControlRank = case(CAGrantControlName contains \"MFA\", 1, \r\n                            CAGrantControlName contains \"Terms of Use\", 2, \r\n                            CAGrantControlName contains \"Privacy\", 3, \r\n                            CAGrantControlName contains \"Device\", 4, \r\n                            CAGrantControlName contains \"Azure AD Joined\", 5, \r\n                            CAGrantControlName contains \"Apps\", 6,\r\n                            7)\r\n| where details.Type == '*' or (details.Type == 'CAStatus' and CAStatus == details.Name) or (details.Type == 'CAGrantControl' and CAGrantControl == details.Name and CAStatus == details.Parent);\r\ndata\r\n| order by CAGrantControlRank desc\r\n| summarize CAGrantControls = make_set(CAGrantControl) by AppDisplayName, CAStatus, TimeGenerated, UserDisplayName\r\n| extend CAGrantControlText = replace(@\",\", \", \", replace(@'\"', @'', replace(@\"\\]\", @\"\", replace(@\"\\[\", @\"\", tostring(CAGrantControls)))))\r\n| extend CAGrantControlSummary = case(array_length(CAGrantControls) > 1, strcat(CAGrantControls[0], ' + ', array_length(CAGrantControls) - 1, ' more'), array_length(CAGrantControls) == 1, tostring(CAGrantControls[0]), 'None')\r\n| top 200 by TimeGenerated desc\r\n| extend TimeFromNow = now() - TimeGenerated\r\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| project Application = AppDisplayName, ['CA Status'] = CAStatus, ['CA Grant Controls'] = CAGrantControlSummary, ['All CA Grant Controls'] = CAGrantControlText, ['Sign-in Time'] = TimeAgo, ['User'] = UserDisplayName","size":0,"showAnalytics":true,"exportToExcelOptions":"visible","title":"Recent sign-ins","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Application","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"CA Status","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"CA Grant Controls","formatter":1,"formatOptions":{"showIcon":true}},{"columnMatch":"All CA Grant Controls","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Sign-in Time","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"User","formatter":5,"formatOptions":{"showIcon":true}}],"labelSettings":[]}},"customWidth":"50","showPin":true,"name":"query - 7 - Copy"},{"type":1,"content":{"json":"## Troubleshooting Sign-ins"},"name":"text - 13"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n|extend errorCode = Status.errorCode\r\n|extend SigninStatus = case(errorCode == 0, \"Success\", errorCode == 50058, \"Pending action (Interrupts)\",errorCode == 50140, \"Pending action (Interrupts)\", errorCode == 51006, \"Pending action (Interrupts)\", errorCode == 50059, \"Pending action (Interrupts)\",errorCode == 65001, \"Pending action (Interrupts)\", errorCode == 52004, \"Pending action (Interrupts)\", errorCode == 50055, \"Pending action (Interrupts)\", errorCode == 50144, \"Pending action (Interrupts)\", errorCode == 50072, \"Pending action (Interrupts)\", errorCode == 50074, \"Pending action (Interrupts)\", errorCode == 16000, \"Pending action (Interrupts)\", errorCode == 16001, \"Pending action (Interrupts)\", errorCode == 16003, \"Pending action (Interrupts)\", errorCode == 50127, \"Pending action (Interrupts)\", errorCode == 50125, \"Pending action (Interrupts)\", errorCode == 50129, \"Pending action (Interrupts)\", errorCode == 50143, \"Pending action (Interrupts)\", errorCode == 81010, \"Pending action (Interrupts)\", errorCode == 81014, \"Pending action (Interrupts)\", errorCode == 81012 ,\"Pending action (Interrupts)\", \"Failure\");\r\ndata\r\n| summarize Count = count() by SigninStatus\r\n| join kind = fullouter (datatable(SigninStatus:string)['Success', 'Pending action (Interrupts)', 'Failure']) on SigninStatus\r\n| project SigninStatus = iff(SigninStatus == '', SigninStatus1, SigninStatus), Count = iff(SigninStatus == '', 0, Count)\r\n| join kind = inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SigninStatus)\r\n    on SigninStatus\r\n| project-away SigninStatus1, TimeGenerated\r\n| extend Status = SigninStatus\r\n| union (\r\n    data \r\n    | summarize Count = count() \r\n    | extend jkey = 1\r\n    | join kind=inner (data\r\n        | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n        | extend jkey = 1) on jkey\r\n    | extend SigninStatus = 'All Sign-ins', Status = '*'    \r\n)\r\n| order by Count desc\r\n\r\n\r\n\r\n","size":3,"exportDefaultValue":"*","exportToExcelOptions":"visible","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"SigninStatus","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"blue","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"secondaryContent":{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue","showIcon":true}},"showBorder":false}},"name":"query - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs \r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend ErrorCode = tostring(Status.errorCode) \r\n| extend FailureReason = tostring(Status.failureReason) \r\n| where ErrorCode !in (\"0\",\"50058\",\"50148\",\"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\",\"50072\", \"50074\", \"16000\",\"16001\", \"16003\", \"50127\", \"50125\", \"50129\",\"50143\", \"81010\", \"81014\", \"81012\") \r\n|summarize errCount = count() by ErrorCode, tostring(FailureReason)| sort by errCount\r\n|project ['❌ Error Code'] = ErrorCode, ['Reason']= FailureReason, ['Error Count'] = toint(errCount)","size":1,"exportFieldName":"❌ Error Code","exportParameterName":"ErrorCode","exportDefaultValue":"*","showAnalytics":true,"exportToExcelOptions":"visible","title":"Summary of top errors","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Error Count","formatter":8,"formatOptions":{"min":0,"palette":"orange","showIcon":true}}],"filter":true,"labelSettings":[]}},"customWidth":"67","showPin":true,"name":"query - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs \r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend ErrorCode = tostring(Status.errorCode) \r\n| extend FailureReason = tostring(Status.failureReason) \r\n| where ErrorCode !in (\"0\",\"50058\",\"50148\",\"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\",\"50072\", \"50074\", \"16000\",\"16001\", \"16003\", \"50127\", \"50125\", \"50129\",\"50143\", \"81010\", \"81014\", \"81012\") \r\n| where '{ErrorCode}' == '*' or '{ErrorCode}' == ErrorCode\r\n| top 200 by TimeGenerated desc\r\n| extend TimeFromNow = now() - TimeGenerated\r\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| project User = UserDisplayName, IPAddress, ['❌ Error Code'] = ErrorCode, ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = ErrorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName\r\n\r\n\r\n","size":1,"showAnalytics":true,"exportToExcelOptions":"visible","title":"Sign-ins with errors","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"❌ Error Code","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","showIcon":true}},{"columnMatch":"App","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Error code","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result type","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result signature","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result description","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Conditional access policies","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Conditional access status","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Operating system","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Browser","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Country or region","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"State","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"City","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Time generated","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Status","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"User principal name","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"sortBy":[{"itemKey":"IPAddress","sortOrder":2}],"labelSettings":[]}},"customWidth":"33","name":"query - 5 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs \r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend ErrorCode = tostring(Status.errorCode) \r\n| extend FailureReason = Status.failureReason \r\n| where ErrorCode in (\"50058\",\"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\",\"50072\", \"50074\", \"16000\",\"16001\", \"16003\", \"50127\", \"50125\", \"50129\",\"50143\", \"81010\", \"81014\", \"81012\") \r\n|summarize errCount = count() by ErrorCode, tostring(FailureReason)\r\n| sort by errCount\r\n|project ['❌ Error Code'] = ErrorCode, ['Reason'] = FailureReason, ['Interrupt Count'] = toint(errCount)","size":1,"exportFieldName":"❌ Error Code","exportParameterName":"InterruptErrorCode","exportDefaultValue":"*","showAnalytics":true,"exportToExcelOptions":"visible","title":"Summary of sign-ins waiting on user action","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Interrupt Count","formatter":8,"formatOptions":{"min":0,"palette":"orange"}}],"filter":true,"labelSettings":[]}},"customWidth":"67","showPin":true,"name":"query - 7"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs \r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend ErrorCode = tostring(Status.errorCode) \r\n| extend FailureReason = Status.failureReason \r\n| where ErrorCode in (\"50058\",\"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\",\"50072\", \"50074\", \"16000\",\"16001\", \"16003\", \"50127\", \"50125\", \"50129\",\"50143\", \"81010\", \"81014\", \"81012\") \r\n| where '{InterruptErrorCode}' == '*' or '{InterruptErrorCode}' == ErrorCode\r\n| top 200 by TimeGenerated desc\r\n| extend TimeFromNow = now() - TimeGenerated\r\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| project User = UserDisplayName, IPAddress, ['❌ Error Code'] = ErrorCode, ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = ErrorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName\r\n\r\n","size":1,"showAnalytics":true,"exportToExcelOptions":"visible","title":"Sign-ins waiting on user action","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"❌ Error Code","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","showIcon":true}},{"columnMatch":"App","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Error code","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result type","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result signature","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Result description","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Conditional access policies","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Conditional access status","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Operating system","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Browser","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Country or region","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"State","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"City","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Time generated","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Status","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"User principal name","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"labelSettings":[]}},"customWidth":"33","showPin":true,"name":"query - 7 - Copy"}],"styleSettings":{},"fromTemplateId":"sentinel-AzureActiveDirectorySigninLogs","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FAADSignin.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## AADSigninLighthouse
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/AADSigninLighthouse.json)

### Workbook details

> Description: This workbook will get a report on Azure AD Signin Multi Tenant.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":"{\"json\":\"## Sign-in Analysis\"}","name":"text - 0"},{"type":9,"content":"{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::all\"],\"parameters\":[{\"id\":\"13f56671-7604-4427-a4d8-663f3da0cbc5\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":1209600000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000,\"createdTime\":\"2018-11-13T19:33:10.162Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":900000,\"createdTime\":\"2018-11-13T19:33:10.164Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":1800000,\"createdTime\":\"2018-11-13T19:33:10.164Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":3600000,\"createdTime\":\"2018-11-13T19:33:10.164Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":14400000,\"createdTime\":\"2018-11-13T19:33:10.164Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":43200000,\"createdTime\":\"2018-11-13T19:33:10.164Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":86400000,\"createdTime\":\"2018-11-13T19:33:10.165Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":172800000,\"createdTime\":\"2018-11-13T19:33:10.166Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":259200000,\"createdTime\":\"2018-11-13T19:33:10.166Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":604800000,\"createdTime\":\"2018-11-13T19:33:10.166Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":1209600000,\"createdTime\":\"2018-11-13T19:33:10.166Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":2592000000,\"createdTime\":\"2018-11-13T19:33:10.167Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false}],\"allowCustom\":true}},{\"id\":\"3b5cc420-8ad8-4523-ba28-a54910756794\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Apps\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SigninLogs\\r\\n| summarize Count = count() by AppDisplayName\\r\\n| order by Count desc, AppDisplayName asc\\r\\n| project Value = AppDisplayName, Label = strcat(AppDisplayName, ' - ', Count, ' sign-ins'), Selected = false\\r\\n\",\"value\":[\"value::all\"],\"typeSettings\":{\"limitSelectTo\":10,\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"f7f7970b-58c1-474f-9043-62243d2d4edd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Users\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SigninLogs\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n| summarize Count = count() by UserDisplayName\\r\\n| order by Count desc, UserDisplayName asc\\r\\n| project Value = UserDisplayName, Label = strcat(UserDisplayName, ' - ', Count, ' sign-ins'), Selected = false\\r\\n\",\"value\":[\"value::all\"],\"typeSettings\":{\"limitSelectTo\":20,\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"120fa9ac-74bb-47da-88ca-14d72d04de75\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources | where type =~ 'Microsoft.operationsmanagement/solutions' | where name contains 'SecurityInsights' | project id = tostring(properties.workspaceResourceId)\",\"crossComponentResources\":[\"value::all\"],\"value\":[\"/subscriptions/1186543f-81e7-4a2c-ad55-fae1cc1c9eac/resourcegroups/Sentinel/providers/Microsoft.OperationalInsights/workspaces/sorisentinel\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}","name":"parameters - 1"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"let data = SigninLogs\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n|extend errorCode = Status.errorCode\\r\\n|extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending user action\\\",errorCode == 50140, \\\"Pending user action\\\", errorCode == 51006, \\\"Pending user action\\\", errorCode == 50059, \\\"Pending user action\\\",errorCode == 65001, \\\"Pending user action\\\", errorCode == 52004, \\\"Pending user action\\\", errorCode == 50055, \\\"Pending user action\\\", errorCode == 50144, \\\"Pending user action\\\", errorCode == 50072, \\\"Pending user action\\\", errorCode == 50074, \\\"Pending user action\\\", errorCode == 16000, \\\"Pending user action\\\", errorCode == 16001, \\\"Pending user action\\\", errorCode == 16003, \\\"Pending user action\\\", errorCode == 50127, \\\"Pending user action\\\", errorCode == 50125, \\\"Pending user action\\\", errorCode == 50129, \\\"Pending user action\\\", errorCode == 50143, \\\"Pending user action\\\", errorCode == 81010, \\\"Pending user action\\\", errorCode == 81014, \\\"Pending user action\\\", errorCode == 81012 ,\\\"Pending user action\\\", \\\"Failure\\\");\\r\\ndata\\r\\n| summarize Count = count() by SigninStatus\\r\\n| join kind = fullouter (datatable(SigninStatus:string)['Success', 'Pending action (Interrupts)', 'Failure']) on SigninStatus\\r\\n| project SigninStatus = iff(SigninStatus == '', SigninStatus1, SigninStatus), Count = iff(SigninStatus == '', 0, Count)\\r\\n| join kind = inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SigninStatus)\\r\\n    on SigninStatus\\r\\n| project-away SigninStatus1, TimeGenerated\\r\\n| extend Status = SigninStatus\\r\\n| union (\\r\\n    data \\r\\n    | summarize Count = count() \\r\\n    | extend jkey = 1\\r\\n    | join kind=inner (data\\r\\n        | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\\r\\n        | extend jkey = 1) on jkey\\r\\n    | extend SigninStatus = 'All Sign-ins', Status = '*'    \\r\\n)\\r\\n| order by Count desc\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":3,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Status\",\"exportParameterName\":\"SigninStatus\",\"exportDefaultValue\":\"*\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"SigninStatus\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}},\"showBorder\":false}}","name":"query - 5"},{"type":1,"content":"{\"json\":\"<br />\\r\\n💡 _Click on a tile or a row in the grid to drill-in further_\"}","name":"text - 6 - Copy"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"let data = SigninLogs\\r\\n| extend AppDisplayName = iff(AppDisplayName == '', 'Unknown', AppDisplayName)\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n| extend Country = iff(LocationDetails.countryOrRegion == '', 'Unknown country', tostring(LocationDetails.countryOrRegion))\\r\\n| extend City = iff(LocationDetails.city == '', 'Unknown city', tostring(LocationDetails.city))\\r\\n| extend errorCode = Status.errorCode\\r\\n| extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending user action\\\",errorCode == 50140, \\\"Pending user action\\\", errorCode == 51006, \\\"Pending user action\\\", errorCode == 50059, \\\"Pending user action\\\",errorCode == 65001, \\\"Pending user action\\\", errorCode == 52004, \\\"Pending user action\\\", errorCode == 50055, \\\"Pending user action\\\", errorCode == 50144, \\\"Pending user action\\\", errorCode == 50072, \\\"Pending user action\\\", errorCode == 50074, \\\"Pending user action\\\", errorCode == 16000, \\\"Pending user action\\\", errorCode == 16001, \\\"Pending user action\\\", errorCode == 16003, \\\"Pending user action\\\", errorCode == 50127, \\\"Pending user action\\\", errorCode == 50125, \\\"Pending user action\\\", errorCode == 50129, \\\"Pending user action\\\", errorCode == 50143, \\\"Pending user action\\\", errorCode == 81010, \\\"Pending user action\\\", errorCode == 81014, \\\"Pending user action\\\", errorCode == 81012 ,\\\"Pending user action\\\", \\\"Failure\\\")\\r\\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins';\\r\\nlet countryData = data\\r\\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \\\"Success\\\"), FailureCount = countif(SigninStatus == \\\"Failure\\\"), InterruptCount = countif(SigninStatus == \\\"Pending user action\\\") by Country\\r\\n| join kind=inner\\r\\n(\\r\\n    data\\r\\n   | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by  Country\\r\\n    | project-away TimeGenerated\\r\\n)\\r\\non Country\\r\\n| project Country, TotalCount, SuccessCount,FailureCount,InterruptCount,  Trend\\r\\n| order by TotalCount desc, Country asc;\\r\\ndata\\r\\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \\\"Success\\\"), FailureCount = countif(SigninStatus == \\\"Failure\\\"), InterruptCount = countif(SigninStatus == \\\"Pending user action\\\") by Country, City\\r\\n| join kind=inner\\r\\n(\\r\\n    data    \\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Country, City\\r\\n    | project-away TimeGenerated\\r\\n)\\r\\non Country, City\\r\\n| order by TotalCount desc, Country asc\\r\\n| project Country, City,TotalCount, SuccessCount,FailureCount,InterruptCount, Trend\\r\\n| join kind=inner\\r\\n(\\r\\n    countryData\\r\\n)\\r\\non Country\\r\\n| project Id = City, Name = City, Type = 'City', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = Country\\r\\n| union (countryData\\r\\n| project Id = Country, Name = Country, Type = 'Country', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = 'root')\\r\\n| order by ['Sign-in Count'] desc, Name asc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Sign-ins by Location\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportParameterName\":\"LocationDetail\",\"exportDefaultValue\":\"{ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\"}\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Sign-in Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"Failure Count|Interrupt Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"orange\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Success Rate\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"percent\"}}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\",\"expandTopLevel\":false}}}","customWidth":"67","showPin":true,"name":"query - 8"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"let details = dynamic({LocationDetail});\\r\\nlet data = SigninLogs\\r\\n| extend AppDisplayName = iff(AppDisplayName == '', 'Unknown', AppDisplayName)\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n| extend Country = tostring(LocationDetails.countryOrRegion)\\r\\n| extend City = tostring(LocationDetails.city)\\r\\n| extend errorCode = Status.errorCode\\r\\n| extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending user action\\\",errorCode == 50140, \\\"Pending user action\\\", errorCode == 51006, \\\"Pending user action\\\", errorCode == 50059, \\\"Pending user action\\\",errorCode == 65001, \\\"Pending user action\\\", errorCode == 52004, \\\"Pending user action\\\", errorCode == 50055, \\\"Pending user action\\\", errorCode == 50144, \\\"Pending user action\\\", errorCode == 50072, \\\"Pending user action\\\", errorCode == 50074, \\\"Pending user action\\\", errorCode == 16000, \\\"Pending user action\\\", errorCode == 16001, \\\"Pending user action\\\", errorCode == 16003, \\\"Pending user action\\\", errorCode == 50127, \\\"Pending user action\\\", errorCode == 50125, \\\"Pending user action\\\", errorCode == 50129, \\\"Pending user action\\\", errorCode == 50143, \\\"Pending user action\\\", errorCode == 81010, \\\"Pending user action\\\", errorCode == 81014, \\\"Pending user action\\\", errorCode == 81012 ,\\\"Pending user action\\\", \\\"Failure\\\")\\r\\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins'\\r\\n| where details.Type == '*' or (details.Type == 'Country' and Country == details.Name) or (details.Type == 'City' and City == details.Name);\\r\\ndata\\r\\n| top 200 by TimeGenerated desc\\r\\n| extend TimeFromNow = now() - TimeGenerated\\r\\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\\r\\n| project User = UserDisplayName, ['Sign-in Status'] = strcat(iff(SigninStatus == 'Success', '✔️', '❌'), ' ', SigninStatus), ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = errorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName\\r\\n\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Location Sign-in details\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Sign-in Status\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"showIcon\":true}},{\"columnMatch\":\"App\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Error code\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result signature\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result description\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access policies\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Operating system\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Browser\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Country or region\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"State\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"City\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Time generated\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"User principal name\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true}}","customWidth":"33","name":"query - 8"},{"type":1,"content":"{\"json\":\"\"}","name":"text - 5"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"let data = SigninLogs\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n| extend errorCode = Status.errorCode\\r\\n| extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending user action\\\",errorCode == 50140, \\\"Pending user action\\\", errorCode == 51006, \\\"Pending user action\\\", errorCode == 50059, \\\"Pending user action\\\",errorCode == 65001, \\\"Pending user action\\\", errorCode == 52004, \\\"Pending user action\\\", errorCode == 50055, \\\"Pending user action\\\", errorCode == 50144, \\\"Pending user action\\\", errorCode == 50072, \\\"Pending user action\\\", errorCode == 50074, \\\"Pending user action\\\", errorCode == 16000, \\\"Pending user action\\\", errorCode == 16001, \\\"Pending user action\\\", errorCode == 16003, \\\"Pending user action\\\", errorCode == 50127, \\\"Pending user action\\\", errorCode == 50125, \\\"Pending user action\\\", errorCode == 50129, \\\"Pending user action\\\", errorCode == 50143, \\\"Pending user action\\\", errorCode == 81010, \\\"Pending user action\\\", errorCode == 81014, \\\"Pending user action\\\", errorCode == 81012 ,\\\"Pending user action\\\", \\\"Failure\\\")\\r\\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins';\\r\\nlet appData = data\\r\\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \\\"Success\\\"), FailureCount = countif(SigninStatus == \\\"Failure\\\"), InterruptCount = countif(SigninStatus == \\\"Pending user action\\\") by Os = tostring(DeviceDetail.operatingSystem)\\r\\n| where Os != ''\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Os = tostring(DeviceDetail.operatingSystem)\\r\\n    | project-away TimeGenerated) on Os\\r\\n| order by TotalCount desc, Os asc\\r\\n| project Os, TotalCount, SuccessCount, FailureCount, InterruptCount, Trend\\r\\n| serialize Id = row_number();\\r\\ndata\\r\\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \\\"Success\\\"), FailureCount = countif(SigninStatus == \\\"Failure\\\"), InterruptCount = countif(SigninStatus == \\\"Pending user action\\\") by Os = tostring(DeviceDetail.operatingSystem), Browser = tostring(DeviceDetail.browser)\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Os = tostring(DeviceDetail.operatingSystem), Browser = tostring(DeviceDetail.browser)\\r\\n    | project-away TimeGenerated) on Os, Browser\\r\\n| order by TotalCount desc, Os asc\\r\\n| project Os, Browser, TotalCount, SuccessCount, FailureCount, InterruptCount, Trend\\r\\n| serialize Id = row_number(1000000)\\r\\n| join kind=inner (appData) on Os\\r\\n| project Id, Name = Browser, Type = 'Browser', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = Id1\\r\\n| union (appData \\r\\n    | project Id, Name = Os, Type = 'Operating System', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = -1)\\r\\n| order by ['Sign-in Count'] desc, Name asc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Sign-ins by Device\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportParameterName\":\"DeviceDetail\",\"exportDefaultValue\":\"{ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\"}\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Sign-in Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Failure Count|Interrupt Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"orange\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Success Rate\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"percent\"}}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\",\"expandTopLevel\":false}}}","customWidth":"67","showPin":true,"name":"query - 9"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"let details = dynamic({DeviceDetail});\\r\\nlet data = SigninLogs\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n| extend errorCode = Status.errorCode\\r\\n| extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending user action\\\",errorCode == 50140, \\\"Pending user action\\\", errorCode == 51006, \\\"Pending user action\\\", errorCode == 50059, \\\"Pending user action\\\",errorCode == 65001, \\\"Pending user action\\\", errorCode == 52004, \\\"Pending user action\\\", errorCode == 50055, \\\"Pending user action\\\", errorCode == 50144, \\\"Pending user action\\\", errorCode == 50072, \\\"Pending user action\\\", errorCode == 50074, \\\"Pending user action\\\", errorCode == 16000, \\\"Pending user action\\\", errorCode == 16001, \\\"Pending user action\\\", errorCode == 16003, \\\"Pending user action\\\", errorCode == 50127, \\\"Pending user action\\\", errorCode == 50125, \\\"Pending user action\\\", errorCode == 50129, \\\"Pending user action\\\", errorCode == 50143, \\\"Pending user action\\\", errorCode == 81010, \\\"Pending user action\\\", errorCode == 81014, \\\"Pending user action\\\", errorCode == 81012 ,\\\"Pending user action\\\", \\\"Failure\\\")\\r\\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins'\\r\\n| extend Os = tostring(DeviceDetail.operatingSystem), Browser = tostring(DeviceDetail.browser)\\r\\n| where details.Type == '*' or (details.Type == 'Operating System' and Os == details.Name) or (details.Type == 'Browser' and Browser == details.Name);\\r\\ndata\\r\\n| order by TimeGenerated desc\\r\\n| top 200 by TimeGenerated desc\\r\\n| extend TimeFromNow = now() - TimeGenerated\\r\\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\\r\\n| project User = UserDisplayName, ['Sign-in Status'] = strcat(iff(SigninStatus == 'Success', '✔️', '❌'), ' ', SigninStatus), ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = errorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName\\r\\n\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Device Sign-in details\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Sign-in Status\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"showIcon\":true}},{\"columnMatch\":\"App\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Error code\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result signature\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result description\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access policies\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Operating system\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Browser\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Country or region\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"State\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"City\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Time generated\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"User principal name\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true}}","customWidth":"33","name":"query - 8 - Copy"},{"type":1,"content":"{\"json\":\"## Sign-ins using Conditional Access\"}","name":"text - 12"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"let data = SigninLogs\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n|extend CAStatus = case(ConditionalAccessStatus ==\\\"success\\\",\\\"Successful\\\",\\r\\n                    ConditionalAccessStatus == \\\"failure\\\", \\\"Failed\\\",                                     \\r\\n                    ConditionalAccessStatus == \\\"notApplied\\\", \\\"Not applied\\\",                                     \\r\\n                    isempty(ConditionalAccessStatus), \\\"Not applied\\\", \\r\\n                    \\\"Disabled\\\")\\r\\n|mvexpand ConditionalAccessPolicies\\r\\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\\r\\n|extend CAGrantControl = case(CAGrantControlName contains \\\"MFA\\\", \\\"Require MFA\\\", \\r\\n                            CAGrantControlName contains \\\"Terms of Use\\\", \\\"Require Terms of Use\\\", \\r\\n                            CAGrantControlName contains \\\"Privacy\\\", \\\"Require Privacy Statement\\\", \\r\\n                            CAGrantControlName contains \\\"Device\\\", \\\"Require Device Compliant\\\", \\r\\n                            CAGrantControlName contains \\\"Azure AD Joined\\\", \\\"Require Hybird Azure AD Joined Device\\\", \\r\\n                            CAGrantControlName contains \\\"Apps\\\", \\\"Require Approved Apps\\\",\\r\\n                            \\\"Other\\\");\\r\\ndata\\r\\n| summarize Count = dcount(Id) by CAStatus\\r\\n| join kind = inner (data\\r\\n                    | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus\\r\\n                    ) on CAStatus\\r\\n| project-away CAStatus1, TimeGenerated\\r\\n| order by Count desc\",\"size\":4,\"title\":\"Conditional access status\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"CAStatus\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"showIcon\":true}},\"showBorder\":false}}","name":"query - 9"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"let data = SigninLogs\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n|extend errorCode = toint(Status.errorCode)\\r\\n|extend Reason = tostring(Status.failureReason)\\r\\n|extend CAStatus = case(ConditionalAccessStatus ==0,\\\"✔️ Success\\\",                                     \\r\\n                        ConditionalAccessStatus == 1, \\\"❌ Failure\\\",                                     \\r\\n                        ConditionalAccessStatus == 2, \\\"⚠️ Not Applied\\\",                                     \\r\\n                        ConditionalAccessStatus == \\\"\\\", \\\"⚠️ Not Applied\\\", \\r\\n                        \\\"🚫 Disabled\\\")\\r\\n|mvexpand ConditionalAccessPolicies\\r\\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\\r\\n|extend CAGrantControl = case(CAGrantControlName contains \\\"MFA\\\", \\\"Require MFA\\\", \\r\\n                            CAGrantControlName contains \\\"Terms of Use\\\", \\\"Require Terms of Use\\\", \\r\\n                            CAGrantControlName contains \\\"Privacy\\\", \\\"Require Privacy Statement\\\", \\r\\n                            CAGrantControlName contains \\\"Device\\\", \\\"Require Device Compliant\\\", \\r\\n                            CAGrantControlName contains \\\"Azure AD Joined\\\", \\\"Require Hybird Azure AD Joined Device\\\", \\r\\n                            CAGrantControlName contains \\\"Apps\\\", \\\"Require Approved Apps\\\",\\\"Other\\\");\\r\\ndata\\r\\n| summarize Count = dcount(Id) by CAStatus, CAGrantControl\\r\\n| project Id = strcat(CAStatus, '/', CAGrantControl), Name = CAGrantControl, Parent = CAStatus, Count, Type = 'CAGrantControl'\\r\\n| join kind = inner (data\\r\\n                    | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus, CAGrantControl\\r\\n                    | project Id = strcat(CAStatus, '/', CAGrantControl), Trend\\r\\n                    ) on Id\\r\\n| project-away Id1\\r\\n| union (data\\r\\n    | summarize Count = dcount(Id) by CAStatus\\r\\n    | project Id = CAStatus, Name = CAStatus, Parent = '', Count, Type = 'CAStatus'\\r\\n    | join kind = inner (data\\r\\n                        | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus\\r\\n                        | project Id = CAStatus, Trend\\r\\n                        ) on Id\\r\\n    | project-away Id1)\\r\\n| order by Count desc\",\"size\":0,\"title\":\"Conditional access status\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportParameterName\":\"Detail\",\"exportDefaultValue\":\"{ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\", \\\"Parent\\\":\\\"*\\\"}\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Name\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Parent\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"Parent\",\"treeType\":0,\"expanderColumn\":\"Name\",\"expandTopLevel\":true}}}","customWidth":"50","name":"query - 10","styleSettings":{"margin":"50"}},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"let details = dynamic({Detail});\\r\\nlet data = SigninLogs\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n|extend errorCode = toint(Status.errorCode)\\r\\n|extend Reason = tostring(Status.failureReason)\\r\\n|extend CAStatus = case(ConditionalAccessStatus ==\\\"success\\\",\\\"✔️ Success\\\",                                     \\r\\n                        ConditionalAccessStatus == \\\"failure\\\", \\\"❌ Failure\\\",                                     \\r\\n                        ConditionalAccessStatus == \\\"notApplied\\\", \\\"⚠️ Not Applied\\\",                                     \\r\\n                        ConditionalAccessStatus == \\\"\\\", \\\"⚠️ Not Applied\\\", \\r\\n                        \\\"🚫 Disabled\\\")\\r\\n|mvexpand ConditionalAccessPolicies\\r\\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\\r\\n|extend CAGrantControl = case(CAGrantControlName contains \\\"MFA\\\", \\\"Require MFA\\\", \\r\\n                            CAGrantControlName contains \\\"Terms of Use\\\", \\\"Require Terms of Use\\\", \\r\\n                            CAGrantControlName contains \\\"Privacy\\\", \\\"Require Privacy Statement\\\", \\r\\n                            CAGrantControlName contains \\\"Device\\\", \\\"Require Device Compliant\\\", \\r\\n                            CAGrantControlName contains \\\"Azure AD Joined\\\", \\\"Require Hybird Azure AD Joined Device\\\", \\r\\n                            CAGrantControlName contains \\\"Apps\\\", \\\"Require Approved Apps\\\",\\r\\n                            \\\"Other\\\")\\r\\n|extend CAGrantControlRank = case(CAGrantControlName contains \\\"MFA\\\", 1, \\r\\n                            CAGrantControlName contains \\\"Terms of Use\\\", 2, \\r\\n                            CAGrantControlName contains \\\"Privacy\\\", 3, \\r\\n                            CAGrantControlName contains \\\"Device\\\", 4, \\r\\n                            CAGrantControlName contains \\\"Azure AD Joined\\\", 5, \\r\\n                            CAGrantControlName contains \\\"Apps\\\", 6,\\r\\n                            7)\\r\\n| where details.Type == '*' or (details.Type == 'CAStatus' and CAStatus == details.Name) or (details.Type == 'CAGrantControl' and CAGrantControl == details.Name and CAStatus == details.Parent);\\r\\ndata\\r\\n| order by CAGrantControlRank desc\\r\\n| summarize CAGrantControls = make_set(CAGrantControl) by AppDisplayName, CAStatus, TimeGenerated, UserDisplayName\\r\\n| extend CAGrantControlText = replace(@\\\",\\\", \\\", \\\", replace(@'\\\"', @'', replace(@\\\"\\\\]\\\", @\\\"\\\", replace(@\\\"\\\\[\\\", @\\\"\\\", tostring(CAGrantControls)))))\\r\\n| extend CAGrantControlSummary = case(array_length(CAGrantControls) > 1, strcat(CAGrantControls[0], ' + ', array_length(CAGrantControls) - 1, ' more'), array_length(CAGrantControls) == 1, tostring(CAGrantControls[0]), 'None')\\r\\n| top 200 by TimeGenerated desc\\r\\n| extend TimeFromNow = now() - TimeGenerated\\r\\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\\r\\n| project Application = AppDisplayName, ['CA Status'] = CAStatus, ['CA Grant Controls'] = CAGrantControlSummary, ['All CA Grant Controls'] = CAGrantControlText, ['Sign-in Time'] = TimeAgo, ['User'] = UserDisplayName\",\"size\":0,\"showAnalytics\":true,\"title\":\"Recent sign-ins\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Application\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"CA Status\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"CA Grant Controls\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"All CA Grant Controls\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Sign-in Time\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"User\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}]}}","customWidth":"50","showPin":true,"name":"query - 7 - Copy"},{"type":1,"content":"{\"json\":\"## Troubleshooting Sign-ins\"}","name":"text - 13"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"let data = SigninLogs\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n|extend errorCode = Status.errorCode\\r\\n|extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending action (Interrupts)\\\",errorCode == 50140, \\\"Pending action (Interrupts)\\\", errorCode == 51006, \\\"Pending action (Interrupts)\\\", errorCode == 50059, \\\"Pending action (Interrupts)\\\",errorCode == 65001, \\\"Pending action (Interrupts)\\\", errorCode == 52004, \\\"Pending action (Interrupts)\\\", errorCode == 50055, \\\"Pending action (Interrupts)\\\", errorCode == 50144, \\\"Pending action (Interrupts)\\\", errorCode == 50072, \\\"Pending action (Interrupts)\\\", errorCode == 50074, \\\"Pending action (Interrupts)\\\", errorCode == 16000, \\\"Pending action (Interrupts)\\\", errorCode == 16001, \\\"Pending action (Interrupts)\\\", errorCode == 16003, \\\"Pending action (Interrupts)\\\", errorCode == 50127, \\\"Pending action (Interrupts)\\\", errorCode == 50125, \\\"Pending action (Interrupts)\\\", errorCode == 50129, \\\"Pending action (Interrupts)\\\", errorCode == 50143, \\\"Pending action (Interrupts)\\\", errorCode == 81010, \\\"Pending action (Interrupts)\\\", errorCode == 81014, \\\"Pending action (Interrupts)\\\", errorCode == 81012 ,\\\"Pending action (Interrupts)\\\", \\\"Failure\\\");\\r\\ndata\\r\\n| summarize Count = count() by SigninStatus\\r\\n| join kind = fullouter (datatable(SigninStatus:string)['Success', 'Pending action (Interrupts)', 'Failure']) on SigninStatus\\r\\n| project SigninStatus = iff(SigninStatus == '', SigninStatus1, SigninStatus), Count = iff(SigninStatus == '', 0, Count)\\r\\n| join kind = inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SigninStatus)\\r\\n    on SigninStatus\\r\\n| project-away SigninStatus1, TimeGenerated\\r\\n| extend Status = SigninStatus\\r\\n| union (\\r\\n    data \\r\\n    | summarize Count = count() \\r\\n    | extend jkey = 1\\r\\n    | join kind=inner (data\\r\\n        | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\\r\\n        | extend jkey = 1) on jkey\\r\\n    | extend SigninStatus = 'All Sign-ins', Status = '*'    \\r\\n)\\r\\n| order by Count desc\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":3,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"SigninStatus\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}},\"showBorder\":false}}","name":"query - 5"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs \\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n| extend ErrorCode = tostring(Status.errorCode) \\r\\n| extend FailureReason = tostring(Status.failureReason) \\r\\n| where ErrorCode !in (\\\"0\\\",\\\"50058\\\",\\\"50148\\\",\\\"50140\\\", \\\"51006\\\", \\\"50059\\\", \\\"65001\\\", \\\"52004\\\", \\\"50055\\\", \\\"50144\\\",\\\"50072\\\", \\\"50074\\\", \\\"16000\\\",\\\"16001\\\", \\\"16003\\\", \\\"50127\\\", \\\"50125\\\", \\\"50129\\\",\\\"50143\\\", \\\"81010\\\", \\\"81014\\\", \\\"81012\\\") \\r\\n|summarize errCount = count() by ErrorCode, tostring(FailureReason)| sort by errCount\\r\\n|project ['❌ Error Code'] = ErrorCode, ['Reason']= FailureReason, ['Error Count'] = toint(errCount)\",\"size\":1,\"showAnalytics\":true,\"title\":\"Summary of top errors\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"❌ Error Code\",\"exportParameterName\":\"ErrorCode\",\"exportDefaultValue\":\"*\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Error Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"orange\",\"showIcon\":true}}],\"filter\":true}}","customWidth":"67","showPin":true,"name":"query - 5"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs \\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n| extend ErrorCode = tostring(Status.errorCode) \\r\\n| extend FailureReason = tostring(Status.failureReason) \\r\\n| where ErrorCode !in (\\\"0\\\",\\\"50058\\\",\\\"50148\\\",\\\"50140\\\", \\\"51006\\\", \\\"50059\\\", \\\"65001\\\", \\\"52004\\\", \\\"50055\\\", \\\"50144\\\",\\\"50072\\\", \\\"50074\\\", \\\"16000\\\",\\\"16001\\\", \\\"16003\\\", \\\"50127\\\", \\\"50125\\\", \\\"50129\\\",\\\"50143\\\", \\\"81010\\\", \\\"81014\\\", \\\"81012\\\") \\r\\n| where '{ErrorCode}' == '*' or '{ErrorCode}' == ErrorCode\\r\\n| top 200 by TimeGenerated desc\\r\\n| extend TimeFromNow = now() - TimeGenerated\\r\\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\\r\\n| project User = UserDisplayName, IPAddress, ['❌ Error Code'] = ErrorCode, ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = ErrorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName\\r\\n\\r\\n\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Sign-ins with errors\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"❌ Error Code\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"GenericDetails\",\"showIcon\":true}},{\"columnMatch\":\"App\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Error code\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result signature\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result description\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access policies\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Operating system\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Browser\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Country or region\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"State\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"City\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Time generated\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"User principal name\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"sortBy\":[{\"itemKey\":\"IPAddress\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"IPAddress\",\"sortOrder\":2}]}","customWidth":"33","name":"query - 5 - Copy"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs \\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n| extend ErrorCode = tostring(Status.errorCode) \\r\\n| extend FailureReason = Status.failureReason \\r\\n| where ErrorCode in (\\\"50058\\\",\\\"50140\\\", \\\"51006\\\", \\\"50059\\\", \\\"65001\\\", \\\"52004\\\", \\\"50055\\\", \\\"50144\\\",\\\"50072\\\", \\\"50074\\\", \\\"16000\\\",\\\"16001\\\", \\\"16003\\\", \\\"50127\\\", \\\"50125\\\", \\\"50129\\\",\\\"50143\\\", \\\"81010\\\", \\\"81014\\\", \\\"81012\\\") \\r\\n|summarize errCount = count() by ErrorCode, tostring(FailureReason)\\r\\n| sort by errCount\\r\\n|project ['❌ Error Code'] = ErrorCode, ['Reason'] = FailureReason, ['Interrupt Count'] = toint(errCount)\",\"size\":1,\"showAnalytics\":true,\"title\":\"Summary of sign-ins waiting on user action\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"❌ Error Code\",\"exportParameterName\":\"InterruptErrorCode\",\"exportDefaultValue\":\"*\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Interrupt Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"orange\"}}],\"filter\":true}}","customWidth":"67","showPin":true,"name":"query - 7"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs \\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) or '*' in ({Users})\\r\\n| extend ErrorCode = tostring(Status.errorCode) \\r\\n| extend FailureReason = Status.failureReason \\r\\n| where ErrorCode in (\\\"50058\\\",\\\"50140\\\", \\\"51006\\\", \\\"50059\\\", \\\"65001\\\", \\\"52004\\\", \\\"50055\\\", \\\"50144\\\",\\\"50072\\\", \\\"50074\\\", \\\"16000\\\",\\\"16001\\\", \\\"16003\\\", \\\"50127\\\", \\\"50125\\\", \\\"50129\\\",\\\"50143\\\", \\\"81010\\\", \\\"81014\\\", \\\"81012\\\") \\r\\n| where '{InterruptErrorCode}' == '*' or '{InterruptErrorCode}' == ErrorCode\\r\\n| top 200 by TimeGenerated desc\\r\\n| extend TimeFromNow = now() - TimeGenerated\\r\\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\\r\\n| project User = UserDisplayName, IPAddress, ['❌ Error Code'] = ErrorCode, ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = ErrorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName\\r\\n\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Sign-ins waiting on user action\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"❌ Error Code\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"GenericDetails\",\"showIcon\":true}},{\"columnMatch\":\"App\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Error code\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result signature\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result description\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access policies\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Operating system\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Browser\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Country or region\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"State\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"City\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Time generated\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"User principal name\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true}}","customWidth":"33","showPin":true,"name":"query - 7 - Copy"}],"isLocked":false,"fromTemplateId":"sentinel-AzureActiveDirectorySigninLogs"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FAADSigninLighthouse.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## AzureActivity
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/AzureActivity.json)

### Workbook details

> Description: This workbook will get a report on Azure Activity.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","query":"","crossComponentResources":[],"parameters":[{"id":"52bfbd84-1639-480c-bda5-bfc87fd81832","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"isRequired":true,"value":{"durationMs":604800000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}]}},{"id":"eeb5dcf9-e898-46af-9c12-d91d97e13cd3","version":"KqlParameterItem/1.0","name":"Caller","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"AzureActivity\r\n| summarize by Caller","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"46375a76-7ae1-4d7e-9082-4191531198a9","version":"KqlParameterItem/1.0","name":"ResourceGroup","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"AzureActivity\r\n| summarize by ResourceGroup","value":["value::all"],"typeSettings":{"resourceTypeFilter":{"microsoft.resources/resourcegroups":true},"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = AzureActivity\r\n| where \"{Caller:lable}\" == \"All\" or \"{Caller:lable}\" == \"All\" or Caller in ({Caller})\r\n| where \"{ResourceGroup:lable}\" == \"All\" or \"{ResourceGroup:lable}\" == \"All\" or ResourceGroup in ({ResourceGroup});\r\ndata\r\n| summarize Count = count() by ResourceGroup\r\n| join kind = fullouter (datatable(ResourceGroup:string)['Medium', 'high', 'low']) on ResourceGroup\r\n| project ResourceGroup = iff(ResourceGroup == '', ResourceGroup1, ResourceGroup), Count = iff(ResourceGroup == '', 0, Count)\r\n| join kind = inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ResourceGroup)\r\n on ResourceGroup\r\n| project-away ResourceGroup1, TimeGenerated\r\n| extend ResourceGroups = ResourceGroup\r\n| union (\r\n data \r\n | summarize Count = count() \r\n | extend jkey = 1\r\n | join kind=inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n | extend jkey = 1) on jkey\r\n | extend ResourceGroup = 'All', ResourceGroups = '*' \r\n)\r\n| order by Count desc\r\n| take 10","size":4,"exportToExcelOptions":"visible","title":"Top 10 active resource groups","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"ResourceGroup","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"secondaryContent":{"columnMatch":"Trend","formatter":9,"formatOptions":{"palette":"blueOrange","showIcon":true}},"showBorder":false}},"name":"query - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity\r\n| where \"{Caller:lable}\" == \"All\" or Caller in ({Caller})\r\n| where \"{ResourceGroup:lable}\" == \"All\" or ResourceGroup in ({ResourceGroup})\r\n| summarize deletions = countif(OperationName contains \"Delete\"), creations = countif(OperationName contains \"Create\"), updates = countif(OperationName contains \"Update\"), Activities = count(OperationName) by bin_at(TimeGenerated, 1h, now())\r\n","size":0,"exportToExcelOptions":"visible","title":"Activities over time","color":"gray","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"linechart","graphSettings":{"type":0}},"name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity\r\n| where \"{Caller:lable}\" == \"All\" or Caller in ({Caller})\r\n| where \"{ResourceGroup:lable}\" == \"All\" or ResourceGroup in ({ResourceGroup})\r\n| summarize deletions = countif(OperationName contains \"Delete\"), creations = countif(OperationName contains \"Create\"), updates = countif(OperationName contains \"Update\"), Activities = count() by Caller\r\n","size":1,"exportToExcelOptions":"visible","title":"Caller activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Caller","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"deletions","formatter":4,"formatOptions":{"showIcon":true,"aggregation":"Count"}},{"columnMatch":"creations","formatter":4,"formatOptions":{"palette":"purple","showIcon":true,"aggregation":"Count"}},{"columnMatch":"updates","formatter":4,"formatOptions":{"palette":"gray","showIcon":true,"aggregation":"Count"}},{"columnMatch":"Activities","formatter":4,"formatOptions":{"palette":"greenDark","linkTarget":"GenericDetails","linkIsContextBlade":true,"showIcon":true,"aggregation":"Count","workbookContext":{"componentIdSource":"workbook","resourceIdsSource":"workbook","templateIdSource":"static","templateId":"https://go.microsoft.com/fwlink/?linkid=874159&resourceId=%2Fsubscriptions%2F44e4eff8-1fcb-4a22-a7d6-992ac7286382%2FresourceGroups%2FSOC&featureName=Workbooks&itemId=%2Fsubscriptions%2F44e4eff8-1fcb-4a22-a7d6-992ac7286382%2Fresourcegroups%2Fsoc%2Fproviders%2Fmicrosoft.insights%2Fworkbooks%2F4c195aec-747f-40bb-addb-934acb3ec646&name=CiscoASA&func=NavigateToPortalFeature&type=workbook","typeSource":"workbook","gallerySource":"workbook"}}}],"sortBy":[{"itemKey":"$gen_bar_updates_3","sortOrder":2}],"labelSettings":[]}},"name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity \r\n| where \"{Caller:lable}\" == \"All\" or Caller in ({Caller})\r\n| where \"{ResourceGroup:lable}\" == \"All\" or ResourceGroup in ({ResourceGroup})\r\n| summarize Informational = countif(Level == \"Informational\"), Warning = countif(Level == \"Warning\"), Error = countif(Level == \"Error\") by bin_at(TimeGenerated, 1h, now())\r\n","size":0,"exportToExcelOptions":"visible","color":"redBright","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"scatterchart","tileSettings":{"showBorder":false},"graphSettings":{"type":2,"topContent":{"columnMatch":"Error","formatter":12,"formatOptions":{"showIcon":true}},"hivesContent":{"columnMatch":"TimeGenerated","formatter":1,"formatOptions":{"showIcon":true}},"nodeIdField":"Error","sourceIdField":"Error","targetIdField":"Error","nodeSize":null,"staticNodeSize":100,"colorSettings":null,"groupByField":"TimeGenerated","hivesMargin":5}},"name":"query - 4"}],"styleSettings":{},"fromTemplateId":"sentinel-AzureActivity","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FAzureActivity.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## AzureDDOS
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/AzureDDOS.json)

### Workbook details

> Description: This workbook will get a report on DDOS Activity.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Azure DDoS Protection Workbook\n---\n"},"name":"text - 2"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"2647367d-91d2-4325-8923-6de1e66ba14f","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"DDoS Summary","subTarget":"DDoS Summary","preText":"DDoS Summary","style":"link"},{"id":"cf2e2031-1a40-42e2-b7f9-66bdf68e7b41","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"DDoS Metrics","subTarget":"DDoS Metrics","style":"link"},{"id":"e9425dcf-63f3-4cc7-afda-2682cafb513b","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"DDoS Investigation","subTarget":"DDoS Investigate","style":"link"}]},"name":"links - 23"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["value::selected"],"parameters":[{"id":"f9e7e362-f017-409a-8b8d-52da17b2df7c","version":"KqlParameterItem/1.0","name":"Workspaces","type":5,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| project id, name\r\n| order by name desc","crossComponentResources":["value::selected"],"value":["/subscriptions/7b76bfbc-cb1e-4df1-b6e8-b826eef6c592/resourceGroups/SOC/providers/Microsoft.OperationalInsights/workspaces/CyberSecuritySOC","/subscriptions/7b76bfbc-cb1e-4df1-b6e8-b826eef6c592/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/cybersecuritysoc"],"typeSettings":{"additionalResourceOptions":["value::all"]},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"e04e88aa-42d1-4bd4-a15d-33e4b161e108","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"isRequired":true,"value":{"durationMs":2419200000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}],"allowCustom":true}},{"id":"8ae1c617-04d0-4918-ac8e-4ba9083300f3","version":"KqlParameterItem/1.0","name":"Resource","type":5,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"where type =~ 'Microsoft.Network/PublicIPAddresses'\r\n| project id","crossComponentResources":["value::selected"],"value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"","showDefault":false},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":1,"resourceType":"microsoft.resourcegraph/resources","label":"Public IP Addresses"}],"style":"pills","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"conditionalVisibility":{"parameterName":"DDoS Summary","comparison":"isEqualTo"},"name":"parameters - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Category == \"DDoSProtectionNotifications\" or Category == \"DDoSMitigationReports\"\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| extend TotalTCPPackets = toint(tostring(parse_json(TrafficOverview_s).Total_TCP_packets))\r\n| extend TotalTCPPacketsDropped =  toint(tostring(parse_json(TrafficOverview_s).Total_TCP_packets_dropped))\r\n| extend TotalUDPPackets =  toint(tostring(parse_json(TrafficOverview_s).Total_UDP_packets))\r\n| extend TotalUDPPacketsDropped =  toint(tostring(parse_json(TrafficOverview_s).Total_UDP_packets_dropped))\r\n| extend TotalOtherPackets =  toint(tostring(parse_json(TrafficOverview_s).Total_other_packets))\r\n| extend TotalOtherPacketsDropped =  toint(tostring(parse_json(TrafficOverview_s).Total_other_packets_dropped))\r\n| extend TotalPackets =  toint(tostring(parse_json(TrafficOverview_s).Total_packets))\r\n| extend TotalPacketsDropped =  toint(tostring(parse_json(TrafficOverview_s).Total_packets_dropped))\r\n| summarize sum(TotalPacketsDropped), sum(TotalPackets), sum(TotalUDPPackets),sum(TotalUDPPacketsDropped),sum(TotalOtherPackets),sum(TotalOtherPacketsDropped),sum(TotalTCPPackets),sum(TotalTCPPacketsDropped)\r\n| extend TotalPackets = sum_TotalPackets , TotalPacketsDropped = sum_TotalPacketsDropped, TotalUDPPackets = sum_TotalUDPPackets, TotalUDPPacketsDropped = sum_TotalUDPPacketsDropped, TotalOtherPackets = sum_TotalOtherPackets, TotalOtherPacketsDropped = sum_TotalOtherPacketsDropped, TotalTCPPackets = sum_TotalTCPPackets, TotalTCPPacketsDropped = sum_TotalTCPPacketsDropped\r\n| project TotalPackets, TotalPacketsDropped, TotalTCPPackets, TotalTCPPacketsDropped, TotalUDPPackets, TotalUDPPacketsDropped, TotalOtherPackets, TotalOtherPacketsDropped \r\n| evaluate narrow()\r\n| extend TableName = Column\r\n| extend Count = Value\r\n| project TableName, Count","size":4,"title":"Traffic Overview","noDataMessage":"You do not have DDOS enabled","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"tiles","gridSettings":{"sortBy":[{"itemKey":"Count","sortOrder":1}]},"sortBy":[{"itemKey":"Count","sortOrder":1}],"tileSettings":{"titleContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false}}},"subtitleContent":{"columnMatch":"TableName"},"showBorder":true,"size":"auto"}},"customWidth":"100","name":"Traffic Overview"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| sort by TimeGenerated desc\r\n| extend TopAttackVector = tostring(parse_json(AttackVectors_s)[0]) \r\n| extend Total_packets_ = tostring(parse_json(TrafficOverview_s).Total_packets) \r\n| extend Total_packets_dropped_ = todouble(parse_json(TrafficOverview_s).Total_packets_dropped)\r\n| extend TotalPackets =todouble(Total_packets_)\r\n| where TotalPackets > 0\r\n| where TopAttackVector <> \"\"\r\n| take 10\r\n| project TimeGenerated , TopAttackVector , TotalPackets, TotalPacketsDropped = Total_packets_dropped_ , ResourceId , IPAddress, Resource\r\n\r\n","size":1,"title":"Last Ten DDoS Attack Reports, select attack to provide resource lookup","noDataMessage":"No DDoS Attacks Mitigated in~ Selected TimeRange","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportedParameters":[{"fieldName":"IPAddress","parameterName":"IPAddress","parameterType":1},{"fieldName":"ResourceId","parameterName":"ResourceId","parameterType":1,"defaultValue":"ResourceId"},{"fieldName":"Resource","parameterName":"AttackReport","parameterType":1,"defaultValue":"/"}],"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"gridSettings":{"formatters":[{"columnMatch":"TotalPackets","formatter":4,"formatOptions":{"palette":"coldHot"},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumSignificantDigits":4}}},{"columnMatch":"TotalPacketsDropped","formatter":4,"formatOptions":{"palette":"coldHot"},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumSignificantDigits":4}}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"Total_packets_","formatter":4,"formatOptions":{"palette":"hotCold"},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumSignificantDigits":4}}},{"columnMatch":"Total_packets_dropped_","formatter":4,"formatOptions":{"palette":"hotCold"},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumSignificantDigits":4}}}]},"tileSettings":{"titleContent":{"columnMatch":"IPAddress","formatter":12,"formatOptions":{"palette":"auto"}},"subtitleContent":{"columnMatch":"TopAttackVector","formatter":1},"leftContent":{"columnMatch":"Resource"},"rightContent":{"columnMatch":"TimeGenerated"},"showBorder":true,"size":"auto"}},"customWidth":"50","name":"query - 7"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources\r\n| where properties contains \"{AttackReport}\"\r\n| project id, name, type, tenantId, location, resourceGroup, subscriptionId","size":1,"title":"Resource Lookup, based on Most Recent DDoS Attack Report","noDataMessage":"Unable to find resources","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["value::selected"]},"customWidth":"50","name":"query - 24"},{"type":10,"content":{"chartId":"workbookd3c031a7-09cf-4cfd-bdec-ab452c540328","version":"MetricsItem/2.0","size":0,"chartType":2,"resourceType":"microsoft.network/publicipaddresses","metricScope":0,"resourceParameter":"Resource","resourceIds":["{Resource}"],"timeContextFromParameter":"TimeRange","timeContext":{"durationMs":2419200000},"metrics":[{"namespace":"microsoft.network/publicipaddresses","metric":"microsoft.network/publicipaddresses--PacketCount","aggregation":4,"splitBy":null}],"title":"Public IP Address Packet Count (Average)","gridSettings":{"rowLimit":10000}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Metrics"},"customWidth":"50","name":"metric - 25 - Copy - Copy - Copy - Copy"},{"type":10,"content":{"chartId":"workbookd3c031a7-09cf-4cfd-bdec-ab452c540328","version":"MetricsItem/2.0","size":0,"chartType":2,"resourceType":"microsoft.network/publicipaddresses","metricScope":0,"resourceParameter":"Resource","resourceIds":["{Resource}"],"timeContextFromParameter":"TimeRange","timeContext":{"durationMs":2419200000},"metrics":[{"namespace":"microsoft.network/publicipaddresses","metric":"microsoft.network/publicipaddresses--ByteCount","aggregation":4,"splitBy":null}],"title":"Public IP Address Byte Count (Average)","gridSettings":{"rowLimit":10000}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Metrics"},"customWidth":"50","name":"metric - 25 - Copy - Copy - Copy - Copy - Copy"},{"type":10,"content":{"chartId":"workbookd3c031a7-09cf-4cfd-bdec-ab452c540328","version":"MetricsItem/2.0","size":0,"chartType":2,"resourceType":"microsoft.network/publicipaddresses","metricScope":0,"resourceParameter":"Resource","resourceIds":["{Resource}"],"timeContextFromParameter":"TimeRange","timeContext":{"durationMs":2419200000},"metrics":[{"namespace":"microsoft.network/publicipaddresses","metric":"microsoft.network/publicipaddresses--DDoSTriggerSYNPackets","aggregation":3,"splitBy":null}],"title":"Inbound SYN Packets to trigger DDoS (MAX)","gridSettings":{"rowLimit":10000}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Metrics"},"customWidth":"50","name":"metric - 25"},{"type":10,"content":{"chartId":"workbookd3c031a7-09cf-4cfd-bdec-ab452c540328","version":"MetricsItem/2.0","size":0,"chartType":2,"resourceType":"microsoft.network/publicipaddresses","metricScope":0,"resourceParameter":"Resource","resourceIds":["{Resource}"],"timeContextFromParameter":"TimeRange","timeContext":{"durationMs":2419200000},"metrics":[{"namespace":"microsoft.network/publicipaddresses","metric":"microsoft.network/publicipaddresses--DDoSTriggerTCPPackets","aggregation":3,"splitBy":null}],"title":"Inbound TCP Packets to trigger DDoS (MAX)","gridSettings":{"rowLimit":10000}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Metrics"},"customWidth":"50","name":"metric - 25 - Copy"},{"type":10,"content":{"chartId":"workbookd3c031a7-09cf-4cfd-bdec-ab452c540328","version":"MetricsItem/2.0","size":0,"chartType":2,"resourceType":"microsoft.network/publicipaddresses","metricScope":0,"resourceParameter":"Resource","resourceIds":["{Resource}"],"timeContextFromParameter":"TimeRange","timeContext":{"durationMs":2419200000},"metrics":[{"namespace":"microsoft.network/publicipaddresses","metric":"microsoft.network/publicipaddresses--DDoSTriggerUDPPackets","aggregation":3,"splitBy":null}],"title":"Inbound UDP Packets to trigger DDoS (MAX)","gridSettings":{"rowLimit":10000}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Metrics"},"customWidth":"50","name":"metric - 25 - Copy - Copy"},{"type":10,"content":{"chartId":"workbookd3c031a7-09cf-4cfd-bdec-ab452c540328","version":"MetricsItem/2.0","size":0,"chartType":2,"resourceType":"microsoft.network/publicipaddresses","metricScope":0,"resourceParameter":"Resource","resourceIds":["{Resource}"],"timeContextFromParameter":"TimeRange","timeContext":{"durationMs":2419200000},"metrics":[{"namespace":"microsoft.network/publicipaddresses","metric":"microsoft.network/publicipaddresses--IfUnderDDoSAttack","aggregation":3,"splitBy":null}],"title":"Under DDoS Attack or Not (MAX)","gridSettings":{"rowLimit":10000}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Metrics"},"customWidth":"50","name":"metric - 25 - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| where Protocols_s <> \"{}\" \r\n| extend DynamicProtocols = todynamic(Protocols_s)\r\n| project DynamicProtocols\r\n| as T\r\n| mv-apply DynamicProtocols on (extend Protocol = tostring(bag_keys(DynamicProtocols)[0])\r\n| project Protocol, value = todouble(DynamicProtocols[Protocol])  )\r\n| summarize Percentage = strcat(round(100 * sum(value) / toscalar(T | count), 3)) by Protocol\r\n| extend PercDec = todouble(Percentage)\r\n| render piechart\r\n","size":0,"title":"Protocols","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"piechart","chartSettings":{"ySettings":{"unit":1,"min":null,"max":null}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"customWidth":"20","name":"query - 16"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| where SourceContinents_s <> \"{}\"\r\n| extend DynamicContinents = todynamic(SourceContinents_s) \r\n| project DynamicContinents\r\n| as T\r\n| mv-apply DynamicContinents on (\r\n    extend Continent = tostring(bag_keys(DynamicContinents)[0])\r\n    | project Continent, value = todouble(DynamicContinents[Continent])\r\n)\r\n| summarize Percentage = strcat(round(100 * sum(value) / toscalar(T | count), 3)) by Continent\r\n| extend Percent = todouble(Percentage)","size":0,"title":"Continent of orgin","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"piechart","chartSettings":{"ySettings":{"unit":1,"min":null,"max":null}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"customWidth":"20","name":"query - 13 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| where TopSourceCountries_s <> \"{}\"\r\n| extend DynamicCountries = todynamic(TopSourceCountries_s)\r\n| project DynamicCountries\r\n| as T\r\n| mv-apply DynamicCountries\r\non (extend Countries = tostring(bag_keys(DynamicCountries)[0])\r\n| project Countries, value = todouble(DynamicCountries[Countries])  )\r\n| summarize Percentage = strcat(round(100 * sum(value) / toscalar(T\r\n| count), 3)) by Countries\r\n| sort by Percentage desc\r\n| extend Percent = todouble(Percentage)","size":0,"title":"Countries of Origin","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"piechart","chartSettings":{"ySettings":{"unit":1,"min":null,"max":null}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"customWidth":"20","name":"query - 13 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| where TopSourceASNs_s <> \"{}\"\r\n| extend DynamicASNs = todynamic(TopSourceASNs_s)\r\n| project DynamicASNs\r\n| as T\r\n| mv-apply DynamicASNs on (extend ASN = tostring(bag_keys(DynamicASNs)[0])\r\n| project ASN, value = todouble(DynamicASNs[ASN])  )\r\n| summarize Percentage = strcat(round(100 * sum(value) / toscalar(T | count), 3)) by ASN\r\n| extend PercDec = todouble(Percentage)\r\n| sort by PercDec desc\r\n| render piechart","size":0,"title":"AS Numbers","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"chartSettings":{"ySettings":{"unit":1,"min":null,"max":null}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"customWidth":"20","name":"query - 15 - Copy","styleSettings":{"margin":"15"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| where DropReasons_s <> \"{}\"\r\n| extend DynamicDroppedReasons = todynamic(DropReasons_s)\r\n| project DynamicDroppedReasons\r\n| as T\r\n| mv-apply DynamicDroppedReasons on (extend Reasons = tostring(bag_keys(DynamicDroppedReasons)[0])\r\n| project Reasons, value = todouble(DynamicDroppedReasons[Reasons])  )\r\n| summarize Percentage = strcat(round(100 * sum(value) / toscalar(T\r\n| count), 3)) by Reasons\r\n| extend PercDec = todouble(Percentage)\r\n| render piechart","size":0,"title":"Drop Reasons","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"gridSettings":{"formatters":[{"columnMatch":"count_","formatter":4,"formatOptions":{"palette":"coldHot","showIcon":true}},{"columnMatch":"Count","formatter":8,"formatOptions":{"palette":"coldHot","showIcon":true}}],"sortBy":[{"itemKey":"Percentage","sortOrder":2}]},"sortBy":[{"itemKey":"Percentage","sortOrder":2}],"chartSettings":{"ySettings":{"unit":1,"min":null,"max":null}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"customWidth":"20","name":"Top Attack Vectors - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| where Protocols_s <> \"{}\"\r\n| extend DynamicProtocols = todynamic(Protocols_s)\r\n| project DynamicProtocols\r\n| as T\r\n| mv-apply DynamicProtocols on (extend Protocol = tostring(bag_keys(DynamicProtocols)[0])\r\n| project Protocol, value = todouble(DynamicProtocols[Protocol])  )\r\n| summarize Percentage = strcat(round(100 * sum(value) / toscalar(T\r\n| count), 3), \"%\") by Protocol\r\n| sort by Percentage desc","size":1,"title":"Protocols","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"customWidth":"20","name":"query - 16 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| where SourceContinents_s <> \"{}\"\r\n| extend DynamicContinents = todynamic(SourceContinents_s) \r\n| project DynamicContinents\r\n| as T\r\n| mv-apply DynamicContinents on (\r\n    extend Continent = tostring(bag_keys(DynamicContinents)[0])\r\n    | project Continent, value = todouble(DynamicContinents[Continent])\r\n)\r\n| summarize Percentage = strcat(round(100 * sum(value) / toscalar(T | count), 3), \"%\") by Continent\r\n| sort by Percentage desc","size":1,"title":"Continent of orgin","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"customWidth":"20","name":"query - 13"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| where TopSourceCountries_s <> \"{}\"\r\n| extend DynamicCountries = todynamic(TopSourceCountries_s)\r\n| project DynamicCountries\r\n| as T\r\n| mv-apply DynamicCountries on (extend Countries = tostring(bag_keys(DynamicCountries)[0])\r\n| project Countries, value = todouble(DynamicCountries[Countries])  )\r\n| summarize Percentage = strcat(round(100 * sum(value) / toscalar(T\r\n| count), 3), \"%\") by Countries\r\n| sort by Percentage desc","size":1,"title":"Countries of Origin","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"customWidth":"20","name":"query - 14"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| where TopSourceASNs_s <> \"{}\"\r\n| extend DynamicASNs = todynamic(TopSourceASNs_s)\r\n| project DynamicASNs\r\n| as T\r\n| mv-apply DynamicASNs on (extend ASN = tostring(bag_keys(DynamicASNs)[0])\r\n| project ASN, value = todouble(DynamicASNs[ASN])  )\r\n| summarize Percentage = strcat(round(100 * sum(value) / toscalar(T\r\n| count), 3), \"%\") by ASN\r\n| sort by Percentage desc","size":1,"title":"AS Numbers","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"customWidth":"20","name":"query - 15","styleSettings":{"margin":"15"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| where DropReasons_s <> \"{}\"\r\n| extend DynamicDroppedReasons = todynamic(DropReasons_s)\r\n| project DynamicDroppedReasons\r\n| as T\r\n| mv-apply DynamicDroppedReasons on (extend Reasons = tostring(bag_keys(DynamicDroppedReasons)[0])\r\n| project Reasons, value = todouble(DynamicDroppedReasons[Reasons])  )\r\n| summarize Percentage = strcat(round(100 * sum(value) / toscalar(T\r\n| count), 3), \"%\") by Reasons\r\n| sort by Percentage desc","size":1,"title":"Drop Reasons","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"gridSettings":{"formatters":[{"columnMatch":"count_","formatter":4,"formatOptions":{"palette":"coldHot","showIcon":true}},{"columnMatch":"Count","formatter":8,"formatOptions":{"palette":"coldHot","showIcon":true}}],"sortBy":[{"itemKey":"Percentage","sortOrder":2}]},"sortBy":[{"itemKey":"Percentage","sortOrder":2}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"customWidth":"20","name":"Top Attack Vectors"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| project  TimeGenerated, ResourceGroup, SubscriptionId, Resource, ResourceType, Message, ReportType = ReportType_s, MitigationStartingTime = MitigationPeriodStart_t, MitigationEndingTime = MitigationPeriodEnd_t, IPAddress, AttackVectors =  AttackVectors_s, TrafficOverview = TrafficOverview_s,Protocols = Protocols_s, DropReasons = DropReasons_s","size":0,"title":"Raw DDoS Mitigation Logs","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"name":"query - 23"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationFlowLogs\"\r\n| project  TimeGenerated, ResourceGroup, SubscriptionId, Resource, ResourceType, Message, SourcePublicIPAddress = sourcePublicIpAddress_s, SourcePorts = sourcePort_s, DestinationPublicIpAddress = destPublicIpAddress_s, DestinationPorts = destPort_s, Protocol = protocol_s, ResouceID = _ResourceId\r\n","size":0,"title":"Raw DDoS Flow Logs","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Summary"},"name":"query - 22"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationFlowLogs\" \r\n| where Message == \"Packet was forwarded to service\" \r\n| summarize count() by strcat(protocol_s, destPort_s) ","size":4,"showAnalytics":true,"title":"Allowed Traffic During Mitigation","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"tiles","tileSettings":{"titleContent":{"formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"secondaryContent":{"columnMatch":"Column1"},"showBorder":false},"graphSettings":{"type":0,"topContent":{"columnMatch":"destPort_s","formatter":1},"centerContent":{"columnMatch":"count_","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Investigate"},"customWidth":"50","name":"query - 4"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationFlowLogs\" \r\n| where Message startswith \"Protocol violation\" \r\n| summarize count() by strcat(protocol_s, destPort_s) ","size":4,"showAnalytics":true,"title":"Dropped Traffic During Mitigation","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"tiles","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Investigate"},"customWidth":"50","name":"query - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\n| where \"{Resource:label}\" == \"All\" or Resource in~ (split(\"{Resource:label}\", \", \"))\n| where Category == \"DDoSMitigationFlowLogs\" \n| summarize count() by TimeGenerated, sourcePublicIpAddress_s\n","size":1,"showAnnotations":true,"showAnalytics":true,"title":"Top Attacking IPs","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"brushtime","exportFieldName":"Category","exportParameterName":"Category","exportToExcelOptions":"all","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"areachart"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Investigate"},"customWidth":"100","name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSProtectionNotifications\"\r\n| project Message , publicIpAddress_s , ResourceId, TimeGenerated","size":0,"showAnalytics":true,"title":"DDoS Mitigation Activity","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"gridSettings":{"formatters":[{"columnMatch":"ResourceId","formatter":13,"formatOptions":{"linkColumn":"ResourceId","linkTarget":"Metrics","showIcon":true}}],"sortBy":[{"itemKey":"TimeGenerated","sortOrder":1}]},"sortBy":[{"itemKey":"TimeGenerated","sortOrder":1}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Investigate"},"customWidth":"50","name":"query - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where Resource in~ (split(\"{Resource:label}\", \", \"))\r\n| where Category == \"DDoSMitigationReports\"\r\n| distinct IPAddress","size":0,"showAnalytics":true,"title":"All Attacked IP Addresses - Select to Search Related","timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","exportFieldName":"IPAddress","exportParameterName":"IPAddress","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"table","gridSettings":{"sortBy":[{"itemKey":"IPAddress","sortOrder":1}]},"sortBy":[{"itemKey":"IPAddress","sortOrder":1}],"tileSettings":{"titleContent":{"columnMatch":"IPAddress","formatter":12,"formatOptions":{"showIcon":true}},"showBorder":false}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Investigate"},"customWidth":"25","name":"query - 7"},{"type":3,"content":{"version":"KqlItem/1.0","query":"search \"{IPAddress}\"\r\n| distinct Type","size":0,"showAnalytics":true,"title":"Table Matches - Select to View Logs","noDataMessage":"Select an IP Address to discovery tables","timeContext":{"durationMs":0},"timeContextFromParameter":"brushtime","exportFieldName":"Type","exportParameterName":"Type","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Investigate"},"customWidth":"25","name":"query - 8"},{"type":3,"content":{"version":"KqlItem/1.0","query":"{Type}\r\n| search \"{IPAddress}\"\r\n| sort by TimeGenerated desc","size":0,"showAnalytics":true,"title":"Logs Related to Attacked IP Address","timeContext":{"durationMs":0},"timeContextFromParameter":"brushtime","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"table","gridSettings":{"filter":true}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DDoS Investigate"},"name":"query - 9"}],"fallbackResourceIds":["/subscriptions/7b76bfbc-cb1e-4df1-b6e8-b826eef6c592/resourcegroups/soc/providers/microsoft.operationalinsights/workspaces/cybersecuritysoc"],"fromTemplateId":"sentinel-AzDDoSStandardWorkbook","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FAzureDDOS.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## AzureInventory
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/AzureInventory.json)

### Workbook details

> Description: This workbook will get a report on Azure Inventory.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"a36f0b3d-8826-4bec-95a9-70ec6cb77713","version":"KqlParameterItem/1.0","name":"Subscriptions","type":6,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::1","value::all"],"includeAll":true}}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 8"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"f321b3dd-4d96-4aa7-ac57-5ad8ce236a48","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Overview","subTarget":"overview","style":"link"},{"id":"e79a9ba1-8aca-4e4a-9df7-83123cae1627","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Compute","subTarget":"compute","preText":"IaaS","style":"link"},{"id":"ed3b708b-7054-424d-b32b-49451e04d36b","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"PaaS","subTarget":"paas","style":"link"},{"id":"9bd4447c-8cac-4e8a-9f9b-bbcc99209b13","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Networking","subTarget":"network","style":"link"},{"id":"8192cd42-be72-4d18-b234-9e9fef4418dd","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Monitoring & Security","subTarget":"monitor","style":"link"},{"id":"1c2b6655-5c72-47bf-b4c6-9ea2665c07ef","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Tagged Resources","subTarget":"tags","style":"link"},{"id":"284d9e1f-d3f9-477e-8fac-0fad54c0b392","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Untagged Resources","subTarget":"notag","style":"link"}]},"name":"links - 6","styleSettings":{"padding":"0 0 20px 0"}},{"type":1,"content":{"json":"## NoShow - Begin Overview"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow Overview"},{"type":1,"content":{"json":"# Overview Azure Resources"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"overview"},"name":"text - Title"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources | summarize count(type)","size":4,"title":"Count of All Resources","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","sortBy":[],"tileSettings":{"titleContent":{"formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"count_type","formatter":12,"formatOptions":{"showIcon":true}},"showBorder":true,"sortOrderField":2}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"overview"},"name":"query - Overview Count"},{"type":1,"content":{"json":"## Subscriptions and Resource Groups"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"overview"},"name":"text - Subscriptions text"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resourcecontainers \r\n| where type has \"microsoft.resources/subscriptions/resourcegroups\"\r\n| summarize Count=count(type) by type, subscriptionId | extend type = replace(@\"microsoft.resources/subscriptions/resourcegroups\", @\"Resource Groups\", type)","size":0,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"type","formatter":16,"formatOptions":{"showIcon":true}},{"columnMatch":"subscriptionId","formatter":5}],"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true}},"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"overview"},"name":"query - Subscription Overview"},{"type":1,"content":{"json":"## Resource Counts"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"overview"},"name":"text - Overview Resource text"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources \r\n| extend type = case(\r\ntype contains 'microsoft.netapp/netappaccounts', 'NetApp Accounts',\r\ntype contains 'microsoft.web/serverfarms', \"App Service Plans\",\r\ntype contains 'microsoft.web/sites', \"App Services\",\r\ntype contains \"microsoft.compute/virtualmachines\", \"Azure Compute\",\r\ntype contains \"microsoft.logic/workflows\", \"LogicApps\",\r\ntype contains 'microsoft.keyvault/vaults', \"Key Vaults\",\r\ntype contains 'microsoft.storage/storageaccounts', \"Storage Accounts\",\r\ntype contains 'microsoft.compute/availabilitysets', 'Availability Sets',\r\ntype contains 'microsoft.operationalinsights/workspaces', 'Log Analytics Workspaces',\r\ntype contains 'microsoft.operationsmanagement', 'Operations Management Resources',\r\ntype contains 'microsoft.insights/components','Application Insights',\r\ntype contains 'microsoft.insights/webtests', 'URL Web Tests',\r\ntype contains 'microsoft.insights/workbooks', 'Monitor Workbooks',\r\ntype contains 'microsoft.insights', 'Insights Resources',\r\ntype contains 'microsoft.desktopvirtualization/applicationgroups', 'WVD Application Groups',\r\ntype contains 'microsoft.desktopvirtualization/workspaces', 'WVD Workspaces',\r\ntype contains 'microsoft.desktopvirtualization/hostpools', 'WVD Hostpools',\r\ntype contains 'microsoft.recoveryservices/vaults', 'Backup Vaults',\r\ntype contains 'microsoft.web/connections', 'LogicApp Connectors',\r\ntype contains 'microsoft.web/customapis','LogicApp API Connectors',\r\ntype contains 'microsoft.managedidentity/userassignedidentities','Managed Identities',\r\ntype contains 'microsoft.storagesync/storagesyncservices', 'Azure File Sync',\r\ntype contains 'microsoft.hybridcompute/machines', 'ARC Machines',\r\ntype contains 'Microsoft.EventHub/namespaces', 'Event Hub Namespaces',\r\ntype contains 'Microsoft.EventGrid/systemTopics', 'Event Grid System Topics',\r\ntype contains 'Microsoft.Sql', 'SQL Resources',\r\ntype contains 'Microsoft.HDInsight/clusters', 'HDInsight Clusters',\r\ntype contains 'microsoft.devtestlab', 'DevTest Labs Resources',\r\ntype contains 'microsoft.containerinstance', 'Container Instances Resources',\r\ntype contains 'microsoft.portal/dashboards', 'Azure Dashboards',\r\ntype contains 'microsoft.containerregistry/registries', 'Container Registry',\r\ntype contains 'microsoft.automation', 'Automation Resources',\r\ntype contains 'microsoft.containerservice/managedclusters', 'AKS Clusters',\r\ntype contains 'sendgrid.email/accounts', 'SendGrid Accounts',\r\ntype contains 'microsoft.datafactory/factories', 'Data Factory',\r\ntype contains 'microsoft.databricks/workspaces', 'Databricks Workspaces',\r\ntype contains 'microsoft.machinelearningservices/workspaces', 'Machine Learnings Workspaces',\r\ntype contains 'microsoft.compute', 'Compute Resources',\r\ntype contains 'microsoft.alertsmanagement/smartdetectoralertrules', 'Smart Detector Alert Rules',\r\ntype contains 'microsoft.apimanagement/service', 'API Management Services',\r\ntype contains 'microsoft.dbforpostgresql', 'PostgreSQL Resources',\r\ntype contains 'microsoft.scheduler/jobcollections', 'Scheduler Job Collections',\r\ntype contains 'microsoft.eventgrid/topics', 'Event Grid Topics',\r\ntype contains 'microsoft.visualstudio/account', 'Azure DevOps Organization',\r\ntype contains 'microsoft.network/virtualnetworks', 'Virtual Networks',\r\ntype contains 'Microsoft.Network/routeTables', 'Route Tables',\r\ntype contains 'microsoft.network/networksecuritygroups', 'Network Security Groups',\r\ntype contains 'microsoft.network/applicationsecuritygroups', 'Application Security Groups',\r\ntype contains 'microsoft.network/applicationgateways', 'Application Gateways',\r\ntype contains 'microsoft.network/publicipaddresses', 'Public Ip Addresses',\r\ntype contains 'microsoft.network/', 'Network Resources',\r\ntype contains 'microsoft.migrate/' or type contains 'microsoft.offazure/vmwaresites', 'Azure Migrate Resources',\r\ntype contains 'microsoft.servicebus/namespaces', 'Service Bus Namespaces',\r\ntype contains 'microsoft.classic', 'ASM Obsolete Resources',\r\nstrcat(\"Not Translated: \", type))\r\n| summarize count() by type","size":2,"title":"Resource Count by Type","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2,"maximumSignificantDigits":3}}},"showBorder":true,"sortCriteriaField":"count_","sortOrderField":2}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"overview"},"name":"query - Overview Resource Counts by type"},{"type":1,"content":{"json":"## NoShow - End Overview\r\n\r\n\r\n## NoShow - Begin Compute"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow Begin Compute"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"a5b84469-ab4c-4b30-9983-22c454d61468","cellValue":"compute","linkTarget":"parameter","linkLabel":"Azure Compute","subTarget":"azure","style":"link"},{"id":"d44b3ab8-d86b-4c5c-939f-273554437a4e","cellValue":"compute","linkTarget":"parameter","linkLabel":"Hybrid Compute","subTarget":"arc","style":"link"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},"name":"tabs -  Compute"},{"type":1,"content":{"json":"## Current VM Status"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"}],"name":"text - Azure Compute"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources | where type == \"microsoft.compute/virtualmachines\"\r\n| extend vmState = tostring(properties.extended.instanceView.powerState.displayStatus)\r\n| extend vmState = iif(isempty(vmState), \"VM State Unknown\", (vmState))\r\n| summarize count() by vmState","size":4,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"vmState","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2,"maximumSignificantDigits":3}}},"showBorder":true},"graphSettings":{"type":0,"topContent":{"columnMatch":"vmSize","formatter":1},"centerContent":{"columnMatch":"Count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"}],"name":"query - Azure Compute Summary - Copy"},{"type":1,"content":{"json":"## Count of VMs by VM Size."},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"}],"name":"text - Azure Compute - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources | where type == \"microsoft.compute/virtualmachines\"\r\n| summarize Count=count(properties.hardwareProfile.vmSize) by vmSize=tostring(properties.hardwareProfile.vmSize)","size":0,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"vmSize","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true},"graphSettings":{"type":0,"topContent":{"columnMatch":"vmSize","formatter":1},"centerContent":{"columnMatch":"Count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"}],"name":"query - Azure Compute Summary"},{"type":1,"content":{"json":"## VMs by Storage and Networking\r\n\r\n💡 Select tab to see corresponding breakdown"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"}],"name":"text - Azure Compute - Copy"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"ac392a07-01a6-4727-b82b-117c529867c7","cellValue":"hardware","linkTarget":"parameter","linkLabel":"Networking","subTarget":"network","style":"link"},{"id":"9ba284c0-ba39-460c-9f74-b9ae8845245c","cellValue":"hardware","linkTarget":"parameter","linkLabel":"Storage","subTarget":"storage","style":"link"},{"id":"74bab549-0028-4018-8bf3-065b6c6fa28e","cellValue":"hardware","linkTarget":"parameter","linkLabel":"Orphaned Disks","subTarget":"orphaneddisks","style":"link"},{"id":"a45a3005-c5b6-46a7-8873-ac1e471c51b4","cellValue":"hardware","linkTarget":"parameter","linkLabel":"Orphaned NICs","subTarget":"orphanednics","style":"link"}]},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"}],"name":"links - Azure Compute Storage Networking Breakdown"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources\r\n| where type =~ 'microsoft.compute/virtualmachines'\r\n| extend nics=array_length(properties.networkProfile.networkInterfaces)\r\n| mv-expand nic=properties.networkProfile.networkInterfaces\r\n| where nics == 1 or nic.properties.primary =~ 'true' or isempty(nic)\r\n| project vmId = id, vmName = name, vmSize=tostring(properties.hardwareProfile.vmSize), nicId = tostring(nic.id)\r\n\t| join kind=leftouter (\r\n \t\tResources\r\n  \t\t| where type =~ 'microsoft.network/networkinterfaces'\r\n  \t\t| extend ipConfigsCount=array_length(properties.ipConfigurations)\r\n  \t\t| mv-expand ipconfig=properties.ipConfigurations\r\n  \t\t| where ipConfigsCount == 1 or ipconfig.properties.primary =~ 'true'\r\n  \t\t| project nicId = id, privateIP= tostring(ipconfig.properties.privateIPAddress), publicIpId = tostring(ipconfig.properties.publicIPAddress.id), subscriptionId) on nicId\r\n| project-away nicId1\r\n| summarize by vmId, vmSize, nicId, privateIP, publicIpId, subscriptionId\r\n\t| join kind=leftouter (\r\n  \t\tResources\r\n  \t\t| where type =~ 'microsoft.network/publicipaddresses'\r\n  \t\t| project publicIpId = id, publicIpAddress = tostring(properties.ipAddress)) on publicIpId\r\n| project-away publicIpId1\r\n| sort by publicIpAddress desc","size":2,"showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"vmId","formatter":5},{"columnMatch":"subscriptionId","formatter":5}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"vmId"}},"tileSettings":{"titleContent":{"columnMatch":"vmSize","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true},"graphSettings":{"type":0,"topContent":{"columnMatch":"vmSize","formatter":1},"centerContent":{"columnMatch":"Count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"},{"parameterName":"hardware","comparison":"isEqualTo","value":"network"}],"name":"query - Azure Compute Networking","styleSettings":{"padding":"0 0 200px 0"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources | where type == \"microsoft.compute/virtualmachines\"\r\n| extend osDiskId= tolower(tostring(properties.storageProfile.osDisk.managedDisk.id))\r\n        | join kind=leftouter(resources\r\n            | where type =~ 'microsoft.compute/disks'\r\n            | where properties !has 'Unattached'\r\n            | where properties has 'osType'\r\n            | project timeCreated = tostring(properties.timeCreated), OS = tostring(properties.osType), osSku = tostring(sku.name), osDiskSizeGB = toint(properties.diskSizeGB), osDiskId=tolower(tostring(id))) on osDiskId\r\n        | join kind=leftouter(Resources\r\n            | where type =~ 'microsoft.compute/disks'\r\n            | where properties !has \"osType\"\r\n            | where properties !has 'Unattached'\r\n            | project sku = tostring(sku.name), diskSizeGB = toint(properties.diskSizeGB), id = managedBy\r\n            | summarize sum(diskSizeGB), count(sku) by id, sku) on id\r\n| project vmId=id, OS, location, resourceGroup, timeCreated,subscriptionId, osDiskId, osSku, osDiskSizeGB, DataDisksGB=sum_diskSizeGB, diskSkuCount=count_sku\r\n| sort by diskSkuCount desc","size":2,"showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"vmId","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"timeCreated","formatter":6}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"vmId"}},"tileSettings":{"titleContent":{"columnMatch":"vmSize","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true},"graphSettings":{"type":0,"topContent":{"columnMatch":"vmSize","formatter":1},"centerContent":{"columnMatch":"Count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"},{"parameterName":"hardware","comparison":"isEqualTo","value":"storage"}],"name":"query - Azure Compute Disks","styleSettings":{"padding":"0 0 200px 0"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources  \r\n| where type contains \"microsoft.compute/disks\" \r\n| extend diskState = tostring(properties.diskState)\r\n| where managedBy == \"\"\r\n    or diskState == 'Unattached'\r\n| project id, diskState, resourceGroup, location, subscriptionId","size":2,"noDataMessage":"No oprhaned disks found","noDataMessageStyle":3,"showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"id","formatter":5},{"columnMatch":"subscriptionId","formatter":5}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"id"}},"tileSettings":{"titleContent":{"columnMatch":"vmSize","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true},"graphSettings":{"type":0,"topContent":{"columnMatch":"vmSize","formatter":1},"centerContent":{"columnMatch":"Count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"},{"parameterName":"hardware","comparison":"isEqualTo","value":"orphaneddisks"}],"name":"query - Azure Compute - Orphaned Disks","styleSettings":{"padding":"0 0 200px 0"}},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Subscriptions}"],"parameters":[{"id":"022b99ef-8f5f-4dfc-a599-81300086faa6","version":"KqlParameterItem/1.0","name":"nicWithPrivateEndpoints","type":1,"query":"Resources\n| where type =~ 'Microsoft.Network/privateEndpoints'\n| extend nics = parse_json(parse_json(properties).networkInterfaces)\n| mv-expand nics\n| project value=nics.id","crossComponentResources":["{Subscriptions}"],"isHiddenWhenLocked":true,"timeContext":{"durationMs":86400000},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"}],"style":"above","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"},{"parameterName":"hardware","comparison":"isEqualTo","value":"orphanednics"}],"name":"query - Networking Details - NIC attached to a Private Endpoint"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type contains \"microsoft.network/networkinterfaces\"\r\n| where \"{nicWithPrivateEndpoints}\" !has id  \r\n| where properties !has 'virtualmachine'\r\n| project id, resourceGroup, location, subscriptionId","size":2,"noDataMessage":"No orphaned nics found","noDataMessageStyle":3,"showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"id","formatter":5},{"columnMatch":"subscriptionId","formatter":5}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"id"}},"tileSettings":{"titleContent":{"columnMatch":"vmSize","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true},"graphSettings":{"type":0,"topContent":{"columnMatch":"vmSize","formatter":1},"centerContent":{"columnMatch":"Count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"azure"},{"parameterName":"hardware","comparison":"isEqualTo","value":"orphanednics"}],"name":"query - Azure Compute Orphaned NICs","styleSettings":{"padding":"0 0 200px 0"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"where type == \"microsoft.hybridcompute/machines\"\r\n| project id, status = properties.status, \r\n\t\t\t  LastSeen = properties.lastStatusChange, \r\n\t\t\t  FQDN = properties.machineFqdn, \r\n\t\t\t  OS = properties.osName, \r\n\t\t\t  ServerVersion = properties.osVersion\r\n| extend ServerVersion = iif(OS has \"windows\", ServerVersion = case(\r\n    ServerVersion has '10.0.17763', 'Server 2019',\r\n    ServerVersion has '10.0.16299', 'Server 2016',\r\n    ServerVersion has '10.0.14393', 'Server 2016',\r\n    ServerVersion has '6.3.9600', 'Server 2012 R2',\r\n    strcat(\"Version  not found\", ServerVersion)), 'OS Not Windows')","size":0,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"table","tileSettings":{"titleContent":{"columnMatch":"vmSize","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true},"graphSettings":{"type":0,"topContent":{"columnMatch":"vmSize","formatter":1},"centerContent":{"columnMatch":"Count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"compute"},{"parameterName":"compute","comparison":"isEqualTo","value":"arc"}],"name":"query - ARC Machines Inventory"},{"type":1,"content":{"json":"## NoShow - End Compute\r\n\r\n## NoShow - Begin PaaS"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow Beging Networking"},{"type":1,"content":{"json":"## PaaS Resources\r\n\r\n💡 Select tab to view releated resources for PaaS Services\r\n\r\n\r\n"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},"name":"text - PaaS Text","styleSettings":{"padding":"0 0 15px 0"}},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"a4ee3213-3bfc-4333-b798-934e866c48de","cellValue":"paas","linkTarget":"parameter","linkLabel":"Automation","subTarget":"automation","style":"link"},{"id":"c5ba791c-2cc3-4c32-8b5c-eab75cc0354c","cellValue":"paas","linkTarget":"parameter","linkLabel":"App Services","subTarget":"apps","style":"link"},{"id":"8d82d272-3094-4750-a058-9122b11ae50b","cellValue":"paas","linkTarget":"parameter","linkLabel":"Events","subTarget":"events","style":"link"},{"id":"ed78617d-664d-4727-87c6-91ac79010e2d","cellValue":"paas","linkTarget":"parameter","linkLabel":"Data","subTarget":"data","style":"link"},{"id":"a4e4ea2e-4c32-4143-92bd-27473db8bc81","cellValue":"paas","linkTarget":"parameter","linkLabel":"Storage and Backup","subTarget":"storage","style":"link"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},"name":"links - PaaS Tabs","styleSettings":{"padding":"0 0 15px 0"}},{"type":1,"content":{"json":"### Count of all Resource Types\r\n\r\n\r\n\r\n"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},"name":"text - PaaS Text - Overview","styleSettings":{"padding":"0 0 10px 0"}},{"type":1,"content":{"json":"### NoShow - Begin PaaS - Automation"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow Begin Automation"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type has 'microsoft.automation'\r\n\tor type has 'microsoft.logic'\r\n\tor type has 'microsoft.web/customapis'\r\n| extend type = case(\r\n\ttype =~ 'microsoft.automation/automationaccounts', 'Automation Accounts',\r\n\ttype == 'microsoft.web/serverfarms', \"App Service Plans\",\r\n\tkind == 'functionapp', \"Azure Functions\", \r\n\tkind == \"api\", \"API Apps\", \r\n\ttype == 'microsoft.web/sites', \"App Services\",\r\n\ttype =~ 'microsoft.web/connections', 'LogicApp Connectors',\r\n\ttype =~ 'microsoft.web/customapis','LogicApp API Connectors',\r\n\ttype =~ 'microsoft.logic/workflows','LogicApps',\r\n\ttype =~ 'microsoft.automation/automationaccounts/runbooks', 'Automation Runbooks',\r\n    type =~ 'microsoft.automation/automationaccounts/configurations', 'Automation Configurations',\r\nstrcat(\"Not Translated: \", type))\r\n| summarize count() by type\r\n| where type !has \"Not Translated\"","size":1,"noDataMessage":"No resources found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"type","sortOrderField":1}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"automation"}],"name":"query - PaaS - Automation Overview"},{"type":1,"content":{"json":"### Detailed View\r\n\r\n💡 select 'View Details' to see full return from Azure Resource Graph"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"automation"}],"name":"text - PaaS Text - Automation - Details "},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type has 'microsoft.automation'\r\n\t or type has 'microsoft.logic'\r\n\t or type has 'microsoft.web/customapis'\r\n| extend type = case(\r\n\ttype =~ 'microsoft.automation/automationaccounts', 'Automation Accounts',\r\n\ttype =~ 'microsoft.web/connections', 'LogicApp Connectors',\r\n\ttype =~ 'microsoft.web/customapis','LogicApp API Connectors',\r\n\ttype =~ 'microsoft.logic/workflows','LogicApps',\r\n\ttype =~ 'microsoft.automation/automationaccounts/runbooks', 'Automation Runbooks',\r\n\ttype =~ 'microsoft.automation/automationaccounts/configurations', 'Automation Configurations',\r\n\tstrcat(\"Not Translated: \", type))\r\n| extend RunbookType = tostring(properties.runbookType)\r\n| extend LogicAppTrigger = properties.definition.triggers\r\n| extend LogicAppTrigger = iif(type =~ 'LogicApps', case(\r\n\tLogicAppTrigger has 'manual', tostring(LogicAppTrigger.manual.type),\r\n\tLogicAppTrigger has 'Recurrence', tostring(LogicAppTrigger.Recurrence.type),\r\n\tstrcat(\"Unknown Trigger type\", LogicAppTrigger)), LogicAppTrigger)\r\n| extend State = case(\r\n\ttype =~ 'Automation Runbooks', properties.state, \r\n\ttype =~ 'LogicApps', properties.state,\r\n\ttype =~ 'Automation Accounts', properties.state,\r\n\ttype =~ 'Automation Configurations', properties.state,\r\n\t' ')\r\n| extend CreatedDate = case(\r\n\ttype =~ 'Automation Runbooks', properties.creationTime, \r\n\ttype =~ 'LogicApps', properties.createdTime,\r\n\ttype =~ 'Automation Accounts', properties.creationTime,\r\n\ttype =~ 'Automation Configurations', properties.creationTime,\r\n\t' ')\r\n| extend LastModified = case(\r\n\ttype =~ 'Automation Runbooks', properties.lastModifiedTime, \r\n\ttype =~ 'LogicApps', properties.changedTime,\r\n\ttype =~ 'Automation Accounts', properties.lastModifiedTime,\r\n\ttype =~ 'Automation Configurations', properties.lastModifiedTime,\r\n\t' ')\r\n| extend Details = pack_all()\r\n| project Resource=id, subscriptionId, type, resourceGroup, RunbookType, LogicAppTrigger, State, Details","size":2,"noDataMessage":"No resources found","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"type","sortOrderField":1}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"automation"}],"name":"query - PaaS - Automation Detailed","styleSettings":{"padding":"0 0 200px 0"}},{"type":1,"content":{"json":"### NoShow - End PaaS - Automation"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow End - PaaS - Automation"},{"type":1,"content":{"json":"### NoShow - Begin PaaS - Apps"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow Begin Automation"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type has 'microsoft.web'\r\n\t or type =~ 'microsoft.apimanagement/service'\r\n\t or type =~ 'microsoft.network/frontdoors'\r\n\t or type =~ 'microsoft.network/applicationgateways'\r\n\t or type =~ 'microsoft.appconfiguration/configurationstores'\r\n| extend type = case(\r\n\ttype == 'microsoft.web/serverfarms', \"App Service Plans\",\r\n\tkind == 'functionapp', \"Azure Functions\", \r\n\tkind == \"api\", \"API Apps\", \r\n\ttype == 'microsoft.web/sites', \"App Services\",\r\n\ttype =~ 'microsoft.network/applicationgateways', 'App Gateways',\r\n\ttype =~ 'microsoft.network/frontdoors', 'Front Door',\r\n\ttype =~ 'microsoft.apimanagement/service', 'API Management',\r\n\ttype =~ 'microsoft.web/certificates', 'App Certificates',\r\n\ttype =~ 'microsoft.appconfiguration/configurationstores', 'App Config Stores',\r\n\tstrcat(\"Not Translated: \", type))\r\n| where type !has \"Not Translated\"\r\n| summarize count() by type","size":1,"noDataMessage":"No resources found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5}],"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"type","sortOrderField":1}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"apps"}],"name":"query - PaaS - Apps Overview"},{"type":1,"content":{"json":"### Detailed View\r\n\r\n💡 select 'View Details' to see full return from Azure Resource Graph"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"apps"}],"name":"text - PaaS Text - App Services Details"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type has 'microsoft.web'\r\n\t or type =~ 'microsoft.apimanagement/service'\r\n\t or type =~ 'microsoft.network/frontdoors'\r\n\t or type =~ 'microsoft.network/applicationgateways'\r\n\t or type =~ 'microsoft.appconfiguration/configurationstores'\r\n| extend type = case(\r\n\ttype == 'microsoft.web/serverfarms', \"App Service Plans\",\r\n\tkind == 'functionapp', \"Azure Functions\", \r\n\tkind == \"api\", \"API Apps\", \r\n\ttype == 'microsoft.web/sites', \"App Services\",\r\n\ttype =~ 'microsoft.network/applicationgateways', 'App Gateways',\r\n\ttype =~ 'microsoft.network/frontdoors', 'Front Door',\r\n\ttype =~ 'microsoft.apimanagement/service', 'API Management',\r\n\ttype =~ 'microsoft.web/certificates', 'App Certificates',\r\n\ttype =~ 'microsoft.appconfiguration/configurationstores', 'App Config Stores',\r\n\tstrcat(\"Not Translated: \", type))\r\n| where type !has \"Not Translated\"\r\n| extend Sku = case(\r\n\ttype =~ 'App Gateways', properties.sku.name, \r\n\ttype =~ 'Azure Functions', properties.sku,\r\n\ttype =~ 'API Management', sku.name,\r\n\ttype =~ 'App Service Plans', sku.name,\r\n\ttype =~ 'App Services', properties.sku,\r\n\ttype =~ 'App Config Stores', sku.name,\r\n\t' ')\r\n| extend State = case(\r\n\ttype =~ 'App Config Stores', properties.provisioningState,\r\n\ttype =~ 'App Service Plans', properties.status,\r\n\ttype =~ 'Azure Functions', properties.enabled,\r\n\ttype =~ 'App Services', properties.state,\r\n\ttype =~ 'API Management', properties.provisioningState,\r\n\ttype =~ 'App Gateways', properties.provisioningState,\r\n\ttype =~ 'Front Door', properties.provisioningState,\r\n\t' ')\r\n| mv-expand publicIpId=properties.frontendIPConfigurations\r\n| mv-expand publicIpId = publicIpId.properties.publicIPAddress.id\r\n| extend publicIpId = tostring(publicIpId)\r\n\t| join kind=leftouter(\r\n\t  \tResources\r\n  \t\t| where type =~ 'microsoft.network/publicipaddresses'\r\n  \t\t| project publicIpId = id, publicIpAddress = tostring(properties.ipAddress)) on publicIpId\r\n| extend PublicIP = case(\r\n\ttype =~ 'API Management', properties.publicIPAddresses,\r\n\ttype =~ 'App Gateways', publicIpAddress,\r\n\t' ')\r\n| extend Details = pack_all()\r\n| project Resource=id, type, subscriptionId, Sku, State, PublicIP, Details","size":2,"noDataMessage":"No resources found","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"type","sortOrderField":1}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"apps"}],"name":"query - PaaS - Apps Detailed","styleSettings":{"padding":"0 0 200px 0"}},{"type":1,"content":{"json":"### NoShow - End PaaS - Apps"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow End PaaS - Apps"},{"type":1,"content":{"json":"### NoShow - Begin PaaS - Events"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow Begin PaaS - Events"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type has 'microsoft.servicebus'\r\n\tor type has 'microsoft.eventhub'\r\n\tor type has 'microsoft.eventgrid'\r\n\tor type has 'microsoft.relay'\r\n| extend type = case(\r\n\ttype == 'microsoft.eventgrid/systemtopics', \"EventGrid System Topics\",\r\n\ttype =~ \"microsoft.eventgrid/topics\", \"EventGrid Topics\",\r\n\ttype =~ 'microsoft.eventhub/namespaces', \"EventHub Namespaces\",\r\n\ttype =~ 'microsoft.servicebus/namespaces', 'ServiceBus Namespaces',\r\n\ttype =~ 'microsoft.relay/namespaces', 'Relays',\r\n\tstrcat(\"Not Translated: \", type))\r\n| where type !has \"Not Translated\"\r\n| summarize count() by type","size":1,"noDataMessage":"No resources found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5}],"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"type","sortOrderField":1}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"events"}],"name":"query - PaaS - Events Overview"},{"type":1,"content":{"json":"### Detailed View\r\n\r\n💡 select 'View Details' to see full return from Azure Resource Graph"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"events"}],"name":"text - PaaS Text - Events - Details"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type has 'microsoft.servicebus'\r\n\tor type has 'microsoft.eventhub'\r\n\tor type has 'microsoft.eventgrid'\r\n\tor type has 'microsoft.relay'\r\n| extend type = case(\r\n\ttype == 'microsoft.eventgrid/systemtopics', \"EventGrid System Topics\",\r\n\ttype =~ \"microsoft.eventgrid/topics\", \"EventGrid Topics\",\r\n\ttype =~ 'microsoft.eventhub/namespaces', \"EventHub Namespaces\",\r\n\ttype =~ 'microsoft.servicebus/namespaces', 'ServiceBus Namespaces',\r\n\ttype =~ 'microsoft.relay/namespaces', 'Relays',\r\n\tstrcat(\"Not Translated: \", type))\r\n| extend Sku = case(\r\n\ttype =~ 'Relays', sku.name, \r\n\ttype =~ 'EventGrid System Topics', properties.sku,\r\n\ttype =~ 'EventGrid Topics', sku.name,\r\n\ttype =~ 'EventHub Namespaces', sku.name,\r\n\ttype =~ 'ServiceBus Namespaces', sku.sku,\r\n\t' ')\r\n| extend Endpoint = case(\r\n\ttype =~ 'Relays', properties.serviceBusEndpoint,\r\n\ttype =~ 'EventGrid Topics', properties.endpoint,\r\n\ttype =~ 'EventHub Namespaces', properties.serviceBusEndpoint,\r\n\ttype =~ 'ServiceBus Namespaces', properties.serviceBusEndpoint,\r\n\t' ')\r\n| extend Status = case(\r\n\ttype =~ 'Relays', properties.provisioningState,\r\n\ttype =~ 'EventGrid System Topics', properties.provisioningState,\r\n\ttype =~ 'EventGrid Topics', properties.publicNetworkAccess,\r\n\ttype =~ 'EventHub Namespaces', properties.status,\r\n\ttype =~ 'ServiceBus Namespaces', properties.status,\r\n\t' ')\r\n| extend Details = pack_all()\r\n| project Resource=id, subscriptionId, resourceGroup, Sku, Status, Endpoint, Details","size":2,"noDataMessage":"No resources found","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"type","sortOrderField":1}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"events"}],"name":"query - PaaS - Events Detailed","styleSettings":{"padding":"0 0 200px 0"}},{"type":1,"content":{"json":"### NoShow - End PaaS - Events"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow End PaaS - Events"},{"type":1,"content":{"json":"### NoShow - Begin PaaS - Data"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow Begin PaaS - Data"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources \r\n| where type =~ 'microsoft.documentdb/databaseaccounts'\r\n\tor type =~ 'microsoft.sql/servers/databases'\r\n\tor type =~ 'microsoft.dbformysql/servers'\r\n\tor type =~ 'microsoft.sql/servers'\r\n| extend type = case(\r\n\ttype =~ 'microsoft.documentdb/databaseaccounts', 'CosmosDB',\r\n\ttype =~ 'microsoft.sql/servers/databases', 'SQL DBs',\r\n\ttype =~ 'microsoft.dbformysql/servers', 'MySQL',\r\n\ttype =~ 'microsoft.sql/servers', 'SQL Servers',\r\n\tstrcat(\"Not Translated: \", type))\r\n| where type !has \"Not Translated\"\r\n| summarize count() by type","size":1,"noDataMessage":"No resources found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5}],"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"type","sortOrderField":1}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"data"}],"name":"query - PaaS - Data Overview"},{"type":1,"content":{"json":"### Detailed View\r\n\r\n💡 select 'View Details' to see full return from Azure Resource Graph"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"data"}],"name":"text - PaaS Text - Data - Details"},{"type":3,"content":{"version":"KqlItem/1.0","query":"// data\r\n// Click the \"Run query\" command above to execute the query and see results.\r\nresources \r\n| where type =~ 'microsoft.documentdb/databaseaccounts'\r\n\tor type =~ 'microsoft.sql/servers/databases'\r\n\tor type =~ 'microsoft.dbformysql/servers'\r\n\tor type =~ 'microsoft.sql/servers'\r\n| extend type = case(\r\n\ttype =~ 'microsoft.documentdb/databaseaccounts', 'CosmosDB',\r\n\ttype =~ 'microsoft.sql/servers/databases', 'SQL DBs',\r\n\ttype =~ 'microsoft.dbformysql/servers', 'MySQL',\r\n\ttype =~ 'microsoft.sql/servers', 'SQL Servers',\r\n\tstrcat(\"Not Translated: \", type))\r\n| extend Sku = case(\r\n\ttype =~ 'CosmosDB', properties.databaseAccountOfferType,\r\n\ttype =~ 'SQL DBs', sku.name,\r\n\ttype =~ 'MySQL', sku.name,\r\n\t' ')\r\n| extend Status = case(\r\n\ttype =~ 'CosmosDB', properties.provisioningState,\r\n\ttype =~ 'SQL DBs', properties.status,\r\n\ttype =~ 'MySQL', properties.userVisibleState,\r\n\t' ')\r\n| extend Endpoint = case(\r\n\ttype =~ 'MySQL', properties.fullyQualifiedDomainName,\r\n\ttype =~ 'SQL Servers', properties.fullyQualifiedDomainName,\r\n\ttype =~ 'CosmosDB', properties.documentEndpoint,\r\n\t' ')\r\n| extend maxSizeGB = todouble(case(\r\n\ttype =~ 'SQL DBs', properties.maxSizeBytes,\r\n\ttype =~ 'MySQL', properties.storageProfile.storageMB,\r\n\t' '))\r\n| extend maxSizeGB = iif(type has 'SQL DBs', maxSizeGB /1000 /1000, maxSizeGB)\r\n| extend Details = pack_all()\r\n| project Resource=id, resourceGroup, subscriptionId, type, Sku, Status, Endpoint, maxSizeGB, Details\r\n\r\n","size":2,"noDataMessage":"No resources found","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"maxSizeGB","formatter":0,"numberFormat":{"unit":4,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}}],"rowLimit":1000,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"type","sortOrderField":1}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"data"}],"name":"query - PaaS - Data Detailed","styleSettings":{"padding":"0 0 200px 0"}},{"type":1,"content":{"json":"### NoShow - End PaaS - Data"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow End PaaS - Data"},{"type":1,"content":{"json":"### NoShow - Begin PaaS - Storage"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow Begin PaaS - Storage"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources \r\n| where type =~ 'microsoft.storagesync/storagesyncservices'\r\n\tor type =~ 'microsoft.recoveryservices/vaults'\r\n\tor type =~ 'microsoft.storage/storageaccounts'\r\n\tor type =~ 'microsoft.keyvault/vaults'\r\n| extend type = case(\r\n\ttype =~ 'microsoft.storagesync/storagesyncservices', 'Azure File Sync',\r\n\ttype =~ 'microsoft.recoveryservices/vaults', 'Azure Backup',\r\n\ttype =~ 'microsoft.storage/storageaccounts', 'Storage Accounts',\r\n\ttype =~ 'microsoft.keyvault/vaults', 'Key Vaults',\r\n\tstrcat(\"Not Translated: \", type))\r\n| where type !has \"Not Translated\"\r\n| summarize count() by type","size":1,"noDataMessage":"No resources found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5}],"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"type","sortOrderField":1}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"storage"}],"name":"query - PaaS - Data Overview "},{"type":1,"content":{"json":"### Detailed View\r\n\r\n💡 select 'View Details' to see full return from Azure Resource Graph"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"storage"}],"name":"text - PaaS Text - Storage - Details"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources \r\n| where type =~ 'microsoft.storagesync/storagesyncservices'\r\n\tor type =~ 'microsoft.recoveryservices/vaults'\r\n\tor type =~ 'microsoft.storage/storageaccounts'\r\n\tor type =~ 'microsoft.keyvault/vaults'\r\n| extend type = case(\r\n\ttype =~ 'microsoft.storagesync/storagesyncservices', 'Azure File Sync',\r\n\ttype =~ 'microsoft.recoveryservices/vaults', 'Azure Backup',\r\n\ttype =~ 'microsoft.storage/storageaccounts', 'Storage Accounts',\r\n\ttype =~ 'microsoft.keyvault/vaults', 'Key Vaults',\r\n\tstrcat(\"Not Translated: \", type))\r\n| extend Sku = case(\r\n\ttype !has 'Key Vaults', sku.name,\r\n\ttype =~ 'Key Vaults', properties.sku.name,\r\n\t' ')\r\n| extend Details = pack_all()\r\n| project Resource=id, type, kind, subscriptionId, resourceGroup, Sku, Details","size":2,"noDataMessage":"No resources found","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"paas"},{"parameterName":"paas","comparison":"isEqualTo","value":"storage"}],"name":"query - PaaS - Data Detailed","styleSettings":{"padding":"0 0 200px 0"}},{"type":1,"content":{"json":"### NoShow - End PaaS - Storage"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow End PaaS - Storage - Copy"},{"type":1,"content":{"json":"## End PaaS\r\n\r\n\r\n## Begin Networking"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow Monitoring Security"},{"type":1,"content":{"json":"## Networking Overview"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"network"},"name":"text - Networking Overview"},{"type":3,"content":{"version":"KqlItem/1.0","query":"where type has \"microsoft.network\"\r\n| extend type = case(\r\n\ttype == 'microsoft.network/networkinterfaces', \"NICs\",\r\n\ttype == 'microsoft.network/networksecuritygroups', \"NSGs\", \r\n\ttype == \"microsoft.network/publicipaddresses\", \"Public IPs\", \r\n\ttype == 'microsoft.network/virtualnetworks', \"vNets\",\r\n\ttype == 'microsoft.network/networkwatchers/connectionmonitors', \"Connection Monitors\",\r\n\ttype == 'microsoft.network/privatednszones', \"Private DNS\",\r\n\ttype == 'microsoft.network/virtualnetworkgateways', @\"vNet Gateways\",\r\n\ttype == 'microsoft.network/connections', \"Connections\",\r\n\ttype == 'microsoft.network/networkwatchers', \"Network Watchers\",\r\n\ttype == 'microsoft.network/privateendpoints', \"Private Endpoints\",\r\n\ttype == 'microsoft.network/localnetworkgateways', \"Local Network Gateways\",\r\n\ttype == 'microsoft.network/privatednszones/virtualnetworklinks', \"vNet Links\",\r\n\ttype == 'microsoft.network/dnszones', 'DNS Zones',\r\n\ttype == 'microsoft.network/networkwatchers/flowlogs', 'Flow Logs',\r\n\ttype == 'microsoft.network/routetables', 'Route Tables',\r\n\ttype == 'microsoft.network/loadbalancers', 'Load Balancers',\r\n\tstrcat(\"Not Translated: \", type))\r\n| summarize count() by type\r\n| where type !has \"Not Translated\"","size":2,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"count_","sortOrderField":2}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"network"},"name":"query - Networking Summary"},{"type":1,"content":{"json":"## Networking Details\r\n\r\n💡 select tab to view NSG Details\r\n\r\n💡 select 'View Details' to see full return from Azure Resource Graph"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"network"},"name":"text - Neworking Details"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"5e8a9d46-8041-44fe-96a2-3a606143b199","cellValue":"network","linkTarget":"parameter","linkLabel":"NSG","subTarget":"nsg","style":"link"},{"id":"11426c5c-1edb-41a5-bb7f-fbfb8bbc4bba","cellValue":"network","linkTarget":"parameter","linkLabel":"Unassociated NSGs","subTarget":"blanknsgs","style":"link"},{"id":"5c167305-3eff-4612-a28a-8be527307914","cellValue":"network","linkTarget":"parameter","linkLabel":"NSG Rules","subTarget":"nsgrules","style":"link"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"network"},"name":"links - Networking Details - Tabs"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources\r\n| where type =~ 'microsoft.network/networksecuritygroups' and isnull(properties.networkInterfaces) and isnull(properties.subnets)\r\n| project Resource=id, resourceGroup, subscriptionId, location","size":0,"noDataMessage":"No Unassociated NSGs Found","noDataMessageStyle":3,"showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"id","formatter":5},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}}],"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"count_","sortOrderField":2}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"network"},{"parameterName":"network","comparison":"isEqualTo","value":"blanknsgs"}],"name":"query - Networking Details - Unassociated NSGs","styleSettings":{"padding":"0 0 100px 0"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources\r\n    | where type =~ 'microsoft.network/networksecuritygroups'\r\n    | project id, nsgRules = parse_json(parse_json(properties).securityRules), networksecurityGroupName = name, subscriptionId, resourceGroup , location\r\n    | mvexpand nsgRule = nsgRules\r\n    | project id, location, access=nsgRule.properties.access,protocol=nsgRule.properties.protocol ,direction=nsgRule.properties.direction,provisioningState= nsgRule.properties.provisioningState ,priority=nsgRule.properties.priority, \r\n        sourceAddressPrefix = nsgRule.properties.sourceAddressPrefix, \r\n        sourceAddressPrefixes = nsgRule.properties.sourceAddressPrefixes,\r\n        destinationAddressPrefix = nsgRule.properties.destinationAddressPrefix, \r\n        destinationAddressPrefixes = nsgRule.properties.destinationAddressPrefixes, \r\n        networksecurityGroupName, networksecurityRuleName = tostring(nsgRule.name), \r\n        subscriptionId, resourceGroup,\r\n        destinationPortRanges = nsgRule.properties.destinationPortRanges,\r\n        destinationPortRange = nsgRule.properties.destinationPortRange,\r\n        sourcePortRanges = nsgRule.properties.sourcePortRanges,\r\n        sourcePortRange = nsgRule.properties.sourcePortRange\r\n| extend Details = pack_all()\r\n| project id, location, access, direction, subscriptionId, resourceGroup, Details","size":2,"showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"id","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"resourceGroup","formatter":0,"formatOptions":{"customColumnWidthSetting":"24.1429ch"}},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"id"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"count_","sortOrderField":2}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"network"},{"parameterName":"network","comparison":"isEqualTo","value":"nsgrules"}],"name":"query - Networking Details - NSG Rules","styleSettings":{"padding":"0 0 200px 0"}},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Subscriptions}"],"parameters":[{"id":"2a6c17b5-ef20-4ca7-a6f4-00901eb54ed1","version":"KqlParameterItem/1.0","name":"nsgWithTrafficAnalytics","label":"NSG With Flow Logs and Traffic Analytics","type":1,"query":"Resources\n| where type =~ 'Microsoft.Network/networkWatchers/flowlogs'\n| extend provisioningState = parse_json(properties).provisioningState \n| extend workspaceResourceId = tostring(parse_json(parse_json(parse_json(properties).flowAnalyticsConfiguration).networkWatcherFlowAnalyticsConfiguration).workspaceResourceId)\n| extend targetResourceId = iff(notempty(workspaceResourceId) and provisioningState == \"Succeeded\", tostring(parse_json(properties).targetResourceId), \"null\" ) \n| distinct targetResourceId\n","crossComponentResources":["{Subscriptions}"],"isHiddenWhenLocked":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"version":"KqlParameterItem/1.0","name":"nsgWithFlowLogs","label":"NSG With Flow Logs","type":1,"query":"Resources\n| where type =~ 'Microsoft.Network/networkWatchers/flowlogs'\n| extend provisioningState = parse_json(properties).provisioningState \n| extend targetResourceId = iff(provisioningState == \"Succeeded\", tostring(parse_json(properties).targetResourceId), \"null\" ) \n| distinct targetResourceId\n","crossComponentResources":["{Subscriptions}"],"isHiddenWhenLocked":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","id":"c8a786fc-40ff-4594-83b5-6952c6928523"}],"style":"above","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"network"},{"parameterName":"network","comparison":"isEqualTo","value":"nsgrules"}],"name":"query - Networking Details - NSG with Flow Logs and Traffic Analytics"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources\r\n| where type =~ 'microsoft.network/networksecuritygroups'\r\n| extend flowLogs = \"{nsgWithFlowLogs}\" has id\r\n| extend trafficAnalytics = \"{nsgWithTrafficAnalytics}\" has id\r\n| project subscriptionId, ['Resource group'] = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup), ['Network Security Group'] = id, [\"Location\"]=location, [\"Flow Logs\"]=flowLogs, [\"Traffic Analytics\"]=trafficAnalytics\r\n\r\n","size":2,"title":"Network Security Groups","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":15,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"subscriptionId","formatter":5,"formatOptions":{"linkTarget":"Resource"}},{"columnMatch":"Resource group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Flow Logs","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"1","representation":"success","text":"Enabled"},{"operator":"==","thresholdValue":"0","representation":"disabled","text":"Disabled"},{"operator":"Default","thresholdValue":null,"representation":"unknown","text":"{0}{1}"}]}},{"columnMatch":"Traffic Analytics","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"1","representation":"success","text":"Enabled"},{"operator":"==","thresholdValue":"0","representation":"disabled","text":"Disabled"},{"operator":"Default","thresholdValue":null,"representation":"unknown","text":"unknown"}]}},{"columnMatch":"Subscription","formatter":5,"formatOptions":{"linkTarget":"Resource"}},{"columnMatch":"Flow logs","formatter":11,"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Resource","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true}},"sortBy":[]},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"network"},{"parameterName":"network","comparison":"isEqualTo","value":"nsg"}],"name":"Network Security Groups"},{"type":1,"content":{"json":"## End Networking\r\n\r\n\r\n## Begin Monitoring & Security"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - End Networking"},{"type":1,"content":{"json":"## Monitor & Security  \r\n   \r\n   \r\n   \r\n### Workspaces Overview"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},"name":"text - Monitor & Security"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources \r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\nor type =~ 'microsoft.insights/components'\r\n| summarize count() by type\r\n| extend type = case(\r\ntype == 'microsoft.insights/components', \"Application Insights\",\r\ntype == 'microsoft.operationalinsights/workspaces', \"Log Analytics workspaces\",\r\nstrcat(type, type))","size":4,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","gridSettings":{"formatters":[{"columnMatch":"Solutions","formatter":5},{"columnMatch":"AzureSecurityCenter","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureSecurityCenterFree","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureSentinel","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureMonitorVMs","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"ServiceDesk","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureAutomation","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"ChangeTracking","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"UpdateManagement","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"UpdateCompliance","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureMonitorContainers","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"KeyVaultAnalytics","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"SQLHealthCheck","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}}]},"sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},"name":"query - Monitoring Security Overview - Copy - Copy"},{"type":1,"content":{"json":"### Azure Monitor Workbooks & Alerting Resources"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},"name":"text - Monitor & Security - Azure Monitor Alerts"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type has 'microsoft.insights/'\r\n     or type has 'microsoft.alertsmanagement/smartdetectoralertrules'\r\n     or type has 'microsoft.portal/dashboards'\r\n| where type != 'microsoft.insights/components'\r\n| extend type = case(\r\n \ttype == 'microsoft.insights/workbooks', \"Workbooks\",\r\n\ttype == 'microsoft.insights/activitylogalerts', \"Activity Log Alerts\",\r\n\ttype == 'microsoft.insights/scheduledqueryrules', \"Log Search Alerts\",\r\n\ttype == 'microsoft.insights/actiongroups', \"Action Groups\",\r\n\ttype == 'microsoft.insights/metricalerts', \"Metric Alerts\",\r\n\ttype =~ 'microsoft.alertsmanagement/smartdetectoralertrules','Smart Detection Rules',\r\n    type =~ 'microsoft.insights/webtests', 'URL Web Tests',\r\n    type =~ 'microsoft.portal/dashboards', 'Portal Dashboards',\r\n    type =~ 'microsoft.insights/datacollectionrules', 'Data Collection Rules',\r\nstrcat(\"Not Translated: \", type))\r\n| summarize count() by type","size":1,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","gridSettings":{"formatters":[{"columnMatch":"Solutions","formatter":5},{"columnMatch":"AzureSecurityCenter","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureSecurityCenterFree","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureSentinel","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureMonitorVMs","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"ServiceDesk","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureAutomation","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"ChangeTracking","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"UpdateManagement","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"UpdateCompliance","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureMonitorContainers","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"KeyVaultAnalytics","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"SQLHealthCheck","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}}]},"sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true,"sortCriteriaField":"count_","sortOrderField":2}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},"name":"query - Monitoring Security Overview - Copy"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"ed3b3650-dd46-4a66-9acd-cbda10b14c04","cellValue":"monitor","linkTarget":"parameter","linkLabel":"Active Alerts","subTarget":"alerts","preText":"Active Alerts","style":"link"},{"id":"9224d88a-9c0d-49de-8b24-38b3f8c380d3","cellValue":"monitor","linkTarget":"parameter","linkLabel":"Workbooks & Alerting Resources","subTarget":"alertresources","preText":"Monitor Resources","style":"link"},{"id":"b90eaf7d-647e-4b37-ae0a-6fc6a49ce07c","cellValue":"monitor","linkTarget":"parameter","linkLabel":"App Monitoring","subTarget":"apm","preText":"App Monitoring","style":"link"},{"id":"1b181560-7b87-4f30-886c-2054a3648401","cellValue":"monitor","linkTarget":"parameter","linkLabel":"Log Analytics","subTarget":"loganalytics","preText":"Log Analytics","style":"link"},{"id":"d19b8a04-9a79-40ca-90a6-7ebc1be7fe75","cellValue":"monitor","linkTarget":"parameter","linkLabel":"Security Score","subTarget":"security","preText":"Security Score","style":"link"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},"name":"links - Monitor & Security - Tabs"},{"type":1,"content":{"json":"### NoShow - Begin - Monitor & Security - Active Alerts"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow - Begin Active Alerts"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AlertsManagementResources\r\n| extend AlertStatus = properties.essentials.monitorCondition\r\n| extend AlertState = properties.essentials.alertState\r\n| extend AlertTime = properties.essentials.startDateTime\r\n| extend AlertSuppressed = properties.essentials.actionStatus.isSuppressed\r\n| extend Severity = properties.essentials.severity\r\n| where AlertStatus == 'Fired'\r\n| extend Details = pack_all()\r\n| project id, name, subscriptionId, resourceGroup, AlertStatus, AlertState, AlertTime, AlertSuppressed, Severity, Details","size":2,"showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"id","formatter":5},{"columnMatch":"name","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"name"}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"alerts"}],"name":"query - Monitor & Security - Active Alerts"},{"type":1,"content":{"json":"### NoShow - End - Monitor & Security - Active Alerts"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow - End Active Alerts"},{"type":1,"content":{"json":"### NoShow - Begin Monitor & Security - Alerting Resources"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow - Begin Alerting Resources"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type has 'microsoft.insights/'\r\n     or type has 'microsoft.alertsmanagement/smartdetectoralertrules'\r\n    or type has 'microsoft.portal/dashboards'\r\n| where type != 'microsoft.insights/components'\r\n| extend type = case(\r\n \ttype == 'microsoft.insights/workbooks', \"Workbooks\",\r\n\ttype == 'microsoft.insights/activitylogalerts', \"Activity Log Alerts\",\r\n\ttype == 'microsoft.insights/scheduledqueryrules', \"Log Search Alerts\",\r\n\ttype == 'microsoft.insights/actiongroups', \"Action Groups\",\r\n\ttype == 'microsoft.insights/metricalerts', \"Metric Alerts\",\r\n\ttype =~ 'microsoft.alertsmanagement/smartdetectoralertrules','Smart Detection Rules',\r\n    type =~ 'microsoft.portal/dashboards', 'Portal Dashboards',\r\n\tstrcat(\"Not Translated: \", type))\r\n| extend Enabled = case(\r\n\ttype =~ 'Smart Detection Rules', properties.state,\r\n\ttype != 'Smart Detection Rules', properties.enabled,\r\n\tstrcat(\"Not Translated: \", type))\r\n| extend WorkbookType = iif(type =~ 'Workbooks', properties.category, ' ')\r\n| extend Details = pack_all()\r\n| project name, type, subscriptionId, location, resourceGroup, Enabled, WorkbookType, Details","size":2,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"name","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}},{"columnMatch":"id","formatter":5}],"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"name"}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"alertresources"}],"name":"query - Monitor & Security - Alerting Resources"},{"type":1,"content":{"json":"### NoShow - End - Monitor & Security - Alerting Resources"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow - End Alerting Resources"},{"type":1,"content":{"json":"### NoShow - Begin - Monitor & Security - App Monitoring"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow - Begin App Monitoring"},{"type":3,"content":{"version":"KqlItem/1.0","query":"where type =~ 'microsoft.insights/components'\r\n| extend RetentionInDays = properties.RetentionInDays\r\n| extend IngestionMode = properties.IngestionMode\r\n| extend Details = pack_all()\r\n| project Resource=id, location, resourceGroup, subscriptionId, IngestionMode, RetentionInDays, Details","size":2,"exportedParameters":[{"fieldName":"Resource","parameterName":"appinsight","parameterType":5}],"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}},{"columnMatch":"id","formatter":5},{"columnMatch":"name","formatter":5}],"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Resource"}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"apm"}],"name":"query - Monitor & Security - App Monitoring"},{"type":1,"content":{"json":"### NoShow - End - Monitor & Security - App Monitoring"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow - End App Monitoring"},{"type":1,"content":{"json":"### NoShow - Begin - Monitor & Security - Log Analytics"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow - Begin - App Monitoring"},{"type":3,"content":{"version":"KqlItem/1.0","query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| extend Sku = properties.sku.name\r\n| extend RetentionInDays = properties.retentionInDays\r\n| extend Details = pack_all()\r\n| project Workspace=id, resourceGroup, location, subscriptionId, Sku, RetentionInDays, Details","size":0,"exportedParameters":[{"fieldName":"workspace","parameterName":"workspace","parameterType":5}],"showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Workspace","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}}],"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Workspace"}},"sortBy":[]},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"loganalytics"}],"name":"query - Monitoring Security Overview - Copy"},{"type":1,"content":{"json":"### Log Analytics workspaces with enabled Solutions\r\n\r\n💡 Select workspace to see data tables and resources logging to that workspace\r\n"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"loganalytics"}],"name":"text - Monitor & Security - workspace details"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type == \"microsoft.operationsmanagement/solutions\"\r\n| project Solution=plan.name, Workspace=tolower(tostring(properties.workspaceResourceId)), subscriptionId\r\n\t| join kind=leftouter(\r\n\t\tresources\r\n\t\t| where type =~ 'microsoft.operationalinsights/workspaces'\r\n\t\t| project Workspace=tolower(tostring(id)),subscriptionId) on Workspace\r\n| summarize Solutions = strcat_array(make_list(Solution), \",\") by Workspace, subscriptionId\r\n| extend AzureSecurityCenter = iif(Solutions has 'Security','Enabled','Not Enabled')\r\n| extend AzureSecurityCenterFree = iif(Solutions has 'SecurityCenterFree','Enabled','Not Enabled')\r\n| extend AzureSentinel = iif(Solutions has \"SecurityInsights\",'Enabled','Not Enabled')\r\n| extend AzureMonitorVMs = iif(Solutions has \"VMInsights\",'Enabled','Not Enabled')\r\n| extend ServiceDesk = iif(Solutions has \"ITSM Connector\",'Enabled','Not Enabled')\r\n| extend AzureAutomation = iif(Solutions has \"AzureAutomation\",'Enabled','Not Enabled')\r\n| extend ChangeTracking = iif(Solutions has 'ChangeTracking','Enabled','Not Enabled')\r\n| extend UpdateManagement = iif(Solutions has 'Updates','Enabled','Not Enabled')\r\n| extend UpdateCompliance = iif(Solutions has 'WaaSUpdateInsights','Enabled','Not Enabled')\r\n| extend AzureMonitorContainers = iif(Solutions has 'ContainerInsights','Enabled','Not Enabled')\r\n| extend KeyVaultAnalytics = iif(Solutions has 'KeyVaultAnalytics','Enabled','Not Enabled')\r\n| extend SQLHealthCheck = iif(Solutions has 'SQLAssessment','Enabled','Not Enabled')","size":0,"exportedParameters":[{"fieldName":"Workspace","parameterName":"workspace","parameterType":5}],"showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Workspace","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"Solutions","formatter":5},{"columnMatch":"AzureSecurityCenter","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureSecurityCenterFree","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureSentinel","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureMonitorVMs","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"ServiceDesk","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureAutomation","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"ChangeTracking","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"UpdateManagement","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"UpdateCompliance","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"AzureMonitorContainers","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"KeyVaultAnalytics","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}},{"columnMatch":"SQLHealthCheck","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Not Enabled","representation":"disabled","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Available","text":"{0}{1}"}]}}],"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Workspace"}},"sortBy":[]},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"loganalytics"}],"name":"query - Monitoring Security Overview"},{"type":1,"content":{"json":"\r\n\r\n💡 Workspace table usage for selected workspace on the left, resources reported to selected workspace on the right."},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"loganalytics"}],"name":"text - Monitor & Security - workspace table usage"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Usage\r\n| summarize Size = sum(Quantity) by ['Table Name'] = DataType\r\n| sort by Size desc","size":2,"noDataMessageStyle":5,"timeContext":{"durationMs":86400000},"exportedParameters":[{"fieldName":"workspace","parameterName":"workspace","parameterType":5}],"showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Size","formatter":3,"formatOptions":{"palette":"orange","customColumnWidthSetting":"341px"},"numberFormat":{"unit":38,"options":{"style":"decimal"}}}],"rowLimit":500,"filter":true},"sortBy":[]},"customWidth":"50","conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"loganalytics"}],"name":"query - Monitoring Security - Workspace Usage - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"search * | distinct _ResourceId, SubscriptionId","size":2,"noDataMessageStyle":5,"timeContext":{"durationMs":86400000},"exportedParameters":[{"fieldName":"workspace","parameterName":"workspace","parameterType":5}],"showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{workspace}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"_ResourceId","formatter":5},{"columnMatch":"SubscriptionId","formatter":5}],"rowLimit":500,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["SubscriptionId"],"expandTopLevel":true,"finalBy":"_ResourceId"}},"sortBy":[]},"customWidth":"50","conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"loganalytics"}],"name":"query - Monitoring Security - Workspace Usage"},{"type":1,"content":{"json":"### NoShow - End - Monitor & Security - Log Analytics"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow - End - App Monitoring"},{"type":1,"content":{"json":"### NoShow - Begin - Monitor & Security - Security"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow - Begin - App Monitoring - Security"},{"type":1,"content":{"json":"### Azure Security Center Secure Store by Subscription"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"security"}],"name":"text - Monitor & Security - Secure Score Text"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\r\n| where type == \"microsoft.security/securescores\"\r\n| extend subscriptionSecureScore = round(100 * bin((todouble(properties.score.current))/ todouble(properties.score.max), 0.001))\r\n| where subscriptionSecureScore > 0\r\n| project subscriptionSecureScore, subscriptionId\r\n| order by subscriptionSecureScore asc","size":0,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"subscriptionSecureScore","formatter":8,"formatOptions":{"min":0,"max":100,"palette":"redGreen"},"numberFormat":{"unit":1,"options":{"style":"decimal","useGrouping":false}}}],"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"subscriptionSecureScore"}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"security"}],"name":"query - Monitor & Security - Security Scores"},{"type":1,"content":{"json":"### Azure Security Center Secure Controls Score by Controls\r\n\r\nlists all security controls, the amount of unhealthy resources, their current score and their max score"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"security"}],"name":"text - Monitor & Security - Secure Score Text - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityResources \r\n| where type == 'microsoft.security/securescores/securescorecontrols' \r\n| extend SecureControl = properties.displayName, unhealthy = properties.unhealthyResourceCount, currentscore = properties.score.current, maxscore = properties.score.max, subscriptionId\r\n| project SecureControl , unhealthy, currentscore, maxscore, subscriptionId","size":3,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true,"customColumnWidthSetting":"45ch"}},{"columnMatch":"SecureControl","formatter":5},{"columnMatch":"unhealthy","formatter":8,"formatOptions":{"min":0,"palette":"greenRed"}},{"columnMatch":"currentscore","formatter":8,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":1,"options":{"style":"decimal"}}},{"columnMatch":"maxscore","formatter":8,"formatOptions":{"palette":"blue"}},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"subscriptionSecureScore","formatter":8,"formatOptions":{"min":0,"max":100,"palette":"redGreen"},"numberFormat":{"unit":1,"options":{"style":"decimal","useGrouping":false}}}],"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"SecureControl"}}},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"monitor"},{"parameterName":"monitor","comparison":"isEqualTo","value":"security"}],"name":"query - Monitor & Security - Security Scores - Copy"},{"type":1,"content":{"json":"### NoShow - End - Monitor & Security - Security"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow - End - App Monitoring - Security - Copy"},{"type":1,"content":{"json":"## End Monitoring & Security\r\n\r\n## Begin Tagged Resoruces"},"conditionalVisibility":{"parameterName":"noshow","comparison":"isEqualTo","value":"noshow"},"name":"text - NoShow End Monitoring"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Subscriptions}"],"parameters":[{"id":"f89867f4-907a-49cd-add8-bded49c43bed","version":"KqlParameterItem/1.0","name":"Environment","type":5,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"resources   \r\n| where tags.Environment != ''   \r\n| distinct tostring(tags.Environment)","crossComponentResources":["{Subscriptions}"],"value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::1","value::all"],"showDefault":false},"timeContext":{"durationMs":86400000},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"ef32b148-7ea7-4af4-aaf7-b6a87f2d00d7","version":"KqlParameterItem/1.0","name":"Application","type":5,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"resources \r\n| where tags.Environment in~ ({Environment}) or '*' in~ ({Environment})\r\n| where tags.Application != ''   \r\n| distinct tostring(tags.Application)  ","crossComponentResources":["{Subscriptions}"],"value":null,"typeSettings":{"additionalResourceOptions":["value::1","value::all"],"showDefault":false},"timeContext":{"durationMs":86400000},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"}],"style":"pills","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"tags"},"name":"parameters - Tagged Resources"},{"type":1,"content":{"json":"## Showing Resources for {Environment} and Application(s) {Application}"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"tags"},"name":"text - Show Text for Tagged Selections"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type != 'microsoft.network/networkinterfaces'\r\n| where type != 'microsoft.compute/disks'\r\n| where tags.Environment in~ ({Environment}) or '*' in~ ({Environment})\r\n| where tags.Application in~ ({Application}) or '*' in~ ({Application})\r\n| extend type = case(\r\ntype =~ 'microsoft.network/networksecuritygroups', \"NSGs\", \r\ntype =~ \"microsoft.network/publicipaddresses\", \"Public IPs\", \r\ntype =~ 'microsoft.network/virtualnetworks', \"vNets\",\r\ntype =~ 'microsoft.network/networkwatchers/connectionmonitors', \"Connection Monitors\",\r\ntype =~ 'microsoft.network/privatednszones', \"Private DNS\",\r\ntype =~ 'microsoft.network/virtualnetworkgateways', \"vNet Gateways\",\r\ntype =~ 'microsoft.network/connections', \"Connections\",\r\ntype =~ 'microsoft.network/networkwatchers', \"Network Watchers\",\r\ntype =~ 'microsoft.network/privateendpoints', \"Private Endpoints\",\r\ntype =~ 'microsoft.network/localnetworkgateways', \"Local Network Gateways\",\r\ntype =~ 'microsoft.network/privatednszones/virtualnetworklinks', \"vNet Links\",\r\ntype =~ 'microsoft.web/serverfarms', \"App Service Plans\",\r\nkind == 'functionapp', \"Azure Functions\", \r\nkind == \"api\", \"API Apps\", \r\ntype =~ 'microsoft.web/sites', \"App Services\",\r\ntype =~ \"microsoft.compute/virtualmachines\", \"Azure Compute\",\r\ntype =~ \"microsoft.logic/workflows\", \"LogicApps\",\r\ntype =~ 'microsoft.keyvault/vaults', \"Key Vaults\",\r\ntype =~ 'microsoft.keyvault/vaults', \"Hybrid Compute\",\r\ntype =~ 'microsoft.storage/storageaccounts', \"Storage Accounts\",\r\ntype =~ 'microsoft.compute/availabilitysets', 'Availability Sets',\r\ntype =~ 'microsoft.insights/components','Application Insights',\r\ntype =~ 'microsoft.desktopvirtualization/applicationgroups', 'WVD Application Groups',\r\ntype =~ 'microsoft.desktopvirtualization/workspaces', 'WVD Workspaces',\r\ntype =~ 'microsoft.desktopvirtualization/hostpools', 'WVD Hostpools',\r\nstrcat(\"Not Translated: \", type))\r\n| summarize count() by type\r\n\r\n\r\n","size":0,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"tags"},"name":"query - Tagged Resources"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type != 'microsoft.network/networkinterfaces'\r\n| where type != 'microsoft.compute/disks'\r\n| where tags.Environment in~ ({Environment}) or '*' in~ ({Environment})\r\n| where tags.Application in~ ({Application}) or '*' in~ ({Application})\r\n| extend type = case(\r\ntype =~ 'microsoft.network/networksecuritygroups', \"NSGs\", \r\ntype =~ \"microsoft.network/publicipaddresses\", \"Public IPs\", \r\ntype =~ 'microsoft.network/virtualnetworks', \"vNets\",\r\ntype =~ 'microsoft.network/networkwatchers/connectionmonitors', \"Connection Monitors\",\r\ntype =~ 'microsoft.network/privatednszones', \"Private DNS\",\r\ntype =~ 'microsoft.network/virtualnetworkgateways', \"vNet Gateways\",\r\ntype =~ 'microsoft.network/connections', \"Connections\",\r\ntype =~ 'microsoft.network/networkwatchers', \"Network Watchers\",\r\ntype =~ 'microsoft.network/privateendpoints', \"Private Endpoints\",\r\ntype =~ 'microsoft.network/localnetworkgateways', \"Local Network Gateways\",\r\ntype =~ 'microsoft.network/privatednszones/virtualnetworklinks', \"vNet Links\",\r\ntype =~ 'microsoft.web/serverfarms', \"App Service Plans\",\r\nkind == 'functionapp', \"Azure Functions\", \r\nkind == \"api\", \"API Apps\", \r\ntype =~ 'microsoft.web/sites', \"App Services\",\r\ntype =~ \"microsoft.compute/virtualmachines\", \"Azure Compute\",\r\ntype =~ \"microsoft.logic/workflows\", \"LogicApps\",\r\ntype =~ 'microsoft.keyvault/vaults', \"Key Vaults\",\r\ntype =~ 'microsoft.keyvault/vaults', \"Hybrid Compute\",\r\ntype =~ 'microsoft.storage/storageaccounts', \"Storage Accounts\",\r\ntype =~ 'microsoft.compute/availabilitysets', 'Availability Sets',\r\ntype =~ 'microsoft.insights/components','Application Insights',\r\ntype =~ 'microsoft.desktopvirtualization/applicationgroups', 'WVD Application Groups',\r\ntype =~ 'microsoft.desktopvirtualization/workspaces', 'WVD Workspaces',\r\ntype =~ 'microsoft.desktopvirtualization/hostpools', 'WVD Hostpools',\r\nstrcat(\"Not Translated: \", type))\r\n| extend Details = pack_all()\r\n| project id, subscriptionId, type, location, resourceGroup, Details\r\n\r\n\r\n","size":0,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","linkIsContextBlade":false,"showIcon":true}},{"columnMatch":"id","formatter":5},{"columnMatch":"subscriptionId","formatter":5},{"columnMatch":"Details","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkLabel":"🔍 View Details","linkIsContextBlade":true}},{"columnMatch":"tenantId","formatter":5}],"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"id"}},"tileSettings":{"titleContent":{"columnMatch":"type","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":true}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"tags"},"name":"query - Tagged Resources - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Resources\r\n| where tags.Environment in~ ({Environment}) or '*' in~ ({Environment})\r\n| where tags.Application in~ ({Application}) or '*' in~ ({Application})\r\n| summarize count() by type","size":0,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"tabs"},"name":"query - Tagged Resources Summary"},{"type":1,"content":{"json":"## NoShow - End Tagged Resources\r\n\r\n\r\n## NoShow - Begin Untagged Resources"},"conditionalVisibility":{"parameterName":"noShow","comparison":"isEqualTo","value":"noShow"},"name":"text - NoShow Begin Untagged Resources"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Subscriptions}"],"parameters":[{"id":"2ca6744f-0d53-48a0-ad15-95f6dbe5aa9d","version":"KqlParameterItem/1.0","name":"ResourceType","type":7,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"resources | where tags == ''\r\n| distinct type","crossComponentResources":["{Subscriptions}"],"value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::1","value::all"],"showDefault":false},"timeContext":{"durationMs":86400000},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"}],"style":"pills","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"notag"},"name":"parameters - Untagged Resource Type"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources | where tags == ''\r\n| where type in~ ({ResourceType}) or '*' in~ ({ResourceType})\r\n| project Name=id, subscriptionId\r\n","size":3,"showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"Name","formatter":5},{"columnMatch":"subscriptionId","formatter":5}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["subscriptionId"],"expandTopLevel":true,"finalBy":"Name"}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"notag"},"name":"query - Untagged Resources"}],"isLocked":false,"fallbackResourceIds":["Azure Monitor"]}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FAzureInventory.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## DataCollectionHealth
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/DataCollectionHealth.json)

### Workbook details

> Description: This workbook will get a report on Data Collection Health.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"06dc7f3f-e2c6-445e-83a8-f20c990ac319","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Overview","subTarget":"WorkspaceInfo","style":"link"},{"id":"1797baab-64cc-4a91-bbc0-0963239440ee","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Data collection anomalies","subTarget":"anomalies","style":"link"},{"id":"9aeefefa-b950-47fe-9e29-f21aa3e300e6","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Agents info","subTarget":"agents","style":"link"}]},"name":"links - 19"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"ccd5adcd-8d59-4cfe-99ec-98075de2e253","version":"KqlParameterItem/1.0","name":"DefaultSubscription_Internal","type":1,"isRequired":true,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| take 1\r\n| project subscriptionId","crossComponentResources":["value::selected"],"isHiddenWhenLocked":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"1ca69445-60fc-4806-b43d-ac7e6aad630a","version":"KqlParameterItem/1.0","name":"Subscription","type":6,"query":"summarize by subscriptionId\r\n| project value = strcat(\"/subscriptions/\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)\r\n","crossComponentResources":["value::selected"],"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"queryType":1,"resourceType":"microsoft.resourcegraph/resources","value":"/subscriptions/3c1bb38c-82e3-4f8d-a115-a7110ba70d05"},{"id":"e94aafa3-c5d9-4523-89f0-4e87aa754511","version":"KqlParameterItem/1.0","name":"Workspace","type":5,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\n| project id","crossComponentResources":["{Subscription}"],"value":"/subscriptions/<subs_ID>/resourcegroups/<rg_name>/providers/microsoft.operationalinsights/workspaces/<workspace_name>","typeSettings":{"resourceTypeFilter":{"microsoft.operationalinsights/workspaces":true},"additionalResourceOptions":[]},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"eafaa0ec-7c3a-4ee5-babe-9850080c909d","version":"KqlParameterItem/1.0","name":"resourceGroup","type":1,"query":"resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| where id == \"{Workspace}\"\r\n| project resourceGroup","crossComponentResources":["value::selected"],"isHiddenWhenLocked":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"c4b69c01-2263-4ada-8d9c-43433b739ff3","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}],"allowCustom":false},"value":{"durationMs":604800000}},{"id":"27308a9d-46a2-4fca-8035-e813201fb4f8","version":"KqlParameterItem/1.0","name":"GiBperday","type":1,"query":"union withsource = tt *\r\n| where TimeGenerated > startofday({TimeRange:start}) and TimeGenerated < startofday({TimeRange:end})\r\n// Only look at chargeable Tables\r\n| where _IsBillable == True\r\n| summarize\r\nTotalGBytes =round(sum(_BilledSize/(1024*1024*1024)),2)\r\nby bin(TimeGenerated, 1d)//, Solution=tt\r\n| summarize round(avg(TotalGBytes),2)\r\n","crossComponentResources":["{Workspace}"],"isHiddenWhenLocked":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"c71f3009-a3f4-4aa5-aaf0-d0f667100e56","version":"KqlParameterItem/1.0","name":"Help","label":"Show Help","type":10,"description":"This will show some help information to help you understand the page you are on","isRequired":true,"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"jsonData":"[{ \"value\": \"Yes\", \"label\": \"Yes\"},\r\n {\"value\": \"No\", \"label\": \"No\", \"selected\":true }]"}],"style":"above","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces' \r\n| where id has \"{Workspace}\"\r\n| extend state = trim(' ', tostring(properties.provisioningState))\r\n\t\t,sku   = trim(' ', tostring(properties.sku.name))\r\n        ,skuUpdate = trim(' ', tostring(properties.sku.lastSkuUpdate))\r\n\t\t,retentionDays = trim(' ', tostring(properties.retentionInDays))\r\n\t\t,dailyquotaGB  = trim(' ', tostring(properties.workspaceCapping.dailyQuotaGb))\r\n| extend dailyquotaGB = iif(dailyquotaGB !=-1.0, dailyquotaGB,\"Not set\")\r\n| extend skuUpdate    = iif(strlen(skuUpdate) > 0, skuUpdate,\"Unknown\")\r\n| extend sentinel     = iif(toint(retentionDays) < 90,\"If you have Sentinel, you can change your retention to 90days (free)?\",\"\")\r\n| project ['Workspace Name']=id, ['Resource Group']=resourceGroup, location, ['Data Retention(days)']=retentionDays, ['Last known SKU update']=skuUpdate, ['Daily Data Cap']=dailyquotaGB, ['License']=sku, ['Notes'] = sentinel","size":4,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"Data Retention(days)","formatter":0,"formatOptions":{"showIcon":true},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Last known SKU update","formatter":18,"formatOptions":{"showIcon":true,"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"is Empty","thresholdValue":"\" \"","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"success","text":"{0}{1}"}]}},{"columnMatch":"Daily Data Cap","formatter":18,"formatOptions":{"showIcon":true,"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"not set","representation":"Unavailable","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"1","text":"{0}{1}"}]}},{"columnMatch":"Data Retention","formatter":0,"formatOptions":{"showIcon":true},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}}],"sortBy":[{"itemKey":"$gen_link_Workspace Name_0","sortOrder":1}]},"sortBy":[{"itemKey":"$gen_link_Workspace Name_0","sortOrder":1}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},"name":"query - 18"},{"type":1,"content":{"json":"# Overview"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},"showPin":true,"name":"text - 0 - Copy"},{"type":1,"content":{"json":"\r\nThis section shows the general status of data ingestion in the selected workspace.\r\n\r\nPlease select the *Subscription* and *Workspace* you wish to view, and the *TimeRange* to define the scope."},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"}],"showPin":true,"name":"text - 0 - Copy - Copy"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"### Columns explained\r\n- **Table name**: the name of the Log Analytics workspace table. The list of tables is updated dynamically.\r\n- **Table size**: the total size of the data stored in the table for the specified time range.\r\n- **Table entries**: the total number of events stored in the table for the specified time range. \r\n- **Size per entry**: Average size of each event.\r\n- **Is billable**: indicates if the table is billable or free (True/False).\r\n\r\nSelect a table name from the list in order to filter the charts below.","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 8"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource=_TableName *\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize Entries = count(), Size = sum(_BilledSize), last_log = datetime_diff(\"second\",now(), max(TimeGenerated)), estimate  = sumif(_BilledSize, _IsBillable==true)  by _TableName, _IsBillable\r\n| project ['Table Name'] = _TableName, ['Table Size'] = Size, ['Table Entries'] = Entries,\r\n          ['Size per Entry'] = 1.0 * Size / Entries, ['IsBillable'] = _IsBillable\r\n| order by ['Table Size']  desc\r\n\r\n ","size":0,"showAnalytics":true,"title":"{Workspace:name} workspace status for {TimeRange:label}","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Table Name","formatter":0,"formatOptions":{"customColumnWidthSetting":"15%"}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"purpleRed","customColumnWidthSetting":"24%"},"numberFormat":{"unit":2,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"grayBlue","customColumnWidthSetting":"24%"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"turquoise","customColumnWidthSetting":"24%"},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"IsBillable","formatter":1,"formatOptions":{"customColumnWidthSetting":"10%"}},{"columnMatch":"Last Record Received","formatter":8,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":24,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":2}}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Trend","formatter":10,"formatOptions":{"palette":"redGreen"}}],"filter":true,"labelSettings":[{"columnId":"Table Name","label":"Table name"},{"columnId":"Table Size","label":"Table size","comment":"Capacity of the Table"},{"columnId":"Table Entries","label":"Table entries","comment":"Count of Rows in the Table"},{"columnId":"Size per Entry","label":"Size per entry","comment":"Capacity of the Rows"},{"columnId":"IsBillable","label":"Is billable"}]},"sortBy":[]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},"showPin":true,"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource = _TableName *\r\n| where '{Table}' == 'All Tables' or _TableName == '{Table}'\r\n| make-series TableSize = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n| mvexpand TableSize to typeof(real), TimeGenerated to typeof(datetime) limit 1000\r\n| project TimeGenerated, ['{Table}'] = TableSize","size":0,"showAnalytics":true,"title":"{TimeRange:label}: number of events","color":"green","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Namespace","exportParameterName":"Namespace","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart","gridSettings":{"formatters":[{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue","showIcon":true}}],"filter":true}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},"name":"query - 6"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource = _TableName *\r\n| where '{Table}' == 'All Tables' or _TableName == '{Table}'\r\n| make-series TableSize = sum(_BilledSize) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} \r\n| mvexpand TableSize to typeof(real), TimeGenerated to typeof(datetime) limit 1000\r\n| project TimeGenerated, ['{Table}'] = TableSize","size":0,"showAnalytics":true,"title":"{TimeRange:label}: table volume ","color":"blue","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Namespace","exportParameterName":"Namespace","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart","gridSettings":{"formatters":[{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue","showIcon":true}}],"filter":true}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},"name":"query - 7"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource= _TableName *\r\n| where '{Table}' == 'All Tables' or _TableName == '{Table}'\r\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), Type\r\n| project Type, TimeGenerated, count_\r\n\r\n\r\n","size":1,"showAnalytics":true,"title":"{TimeRange:label}: number of events, by table (Time Brush enabled)","color":"blue","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"tbMthlyUsage","exportFieldName":"Namespace","exportParameterName":"Namespace","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"barchart","gridSettings":{"formatters":[{"columnMatch":"Average Events per Second (eps)","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumSignificantDigits":3}}},{"columnMatch":"Minimum eps","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":3}}},{"columnMatch":"Maximum eps","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","maximumSignificantDigits":3}}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue"},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue"}}],"filter":true},"sortBy":[],"chartSettings":{"seriesLabelSettings":[{"seriesName":"Other","color":"green"}],"xSettings":{},"ySettings":{}}},"customWidth":"100","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},"name":"query - 7 - mthly table usage "},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource = _TableName *\r\n| where '{Table}' == 'All Tables' or _TableName == '{Table}'\r\n| summarize count()  by bin(TimeGenerated, {tbMthlyUsage:grain}), Type\r\n| project ['Table name'] = Type, ['Time generated'] = TimeGenerated, ['Number of events'] = count_\r\n\r\n\r\n","size":1,"showAnalytics":true,"title":"Number of events over selected time: {tbMthlyUsage:label}","color":"blue","timeContext":{"durationMs":0},"timeContextFromParameter":"tbMthlyUsage","timeBrushParameterName":"tbMthlyUsage","exportFieldName":"Namespace","exportParameterName":"Namespace","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Number of events","formatter":8,"formatOptions":{"min":0,"palette":"greenBlue"}},{"columnMatch":"count_","formatter":8,"formatOptions":{"palette":"greenRed"}},{"columnMatch":"Average Events per Second (eps)","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumSignificantDigits":3}}},{"columnMatch":"Minimum eps","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":3}}},{"columnMatch":"Maximum eps","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","maximumSignificantDigits":3}}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue"},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue"}}],"filter":true},"sortBy":[],"chartSettings":{"seriesLabelSettings":[{"seriesName":"Other","color":"green"}],"xSettings":{},"ySettings":{}}},"customWidth":"100","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},"name":"query - 7 - mthly table usage  - Copy"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},"name":"group - workspaceInfo"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Events per second (EPS)"},"name":"text - 30"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"b170eaf0-d2d9-4a9b-ab4a-bed71b6347bc","version":"KqlParameterItem/1.0","name":"EPStimerange","label":"Select EPS time range","type":4,"description":"Used to calculate Events Per Second (EPS) over a selected time range","isRequired":true,"value":{"durationMs":86400000},"typeSettings":{"selectableValues":[{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000}],"allowCustom":false},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange"}],"style":"above","queryType":0,"resourceType":"microsoft.insights/components"},"customWidth":"20","name":"parameters - 29"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource=_TableName *\r\n| where _TimeReceived  {EPStimerange:Label}\r\n| summarize count() , Size = sum(_BilledSize) by bin(_TimeReceived, 1m), Type, _IsBillable\r\n| extend counttemp =count_ / 60\r\n| summarize \r\n           ['Average Events per Second (eps)'] = avg(counttemp), ['Minimum eps']=min (counttemp),\r\n           ['Maximum eps']=max(counttemp)\r\n  by ['Table Name']=Type\r\n| order  by ['Average Events per Second (eps)'] desc\r\n","size":0,"showAnalytics":true,"title":"{EPStimerange:label}: events per second (EPS), by table","color":"blue","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Table Name","formatter":0,"formatOptions":{"customColumnWidthSetting":"20%"}},{"columnMatch":"Average Events per Second (eps)","formatter":3,"formatOptions":{"palette":"greenBlue","customColumnWidthSetting":"25%"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumSignificantDigits":3}}},{"columnMatch":"Minimum eps","formatter":3,"formatOptions":{"palette":"greenBlue","customColumnWidthSetting":"25%"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":3}}},{"columnMatch":"Maximum eps","formatter":3,"formatOptions":{"palette":"greenBlue","customColumnWidthSetting":"25%"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":3}}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue"},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue"}}],"filter":true,"sortBy":[{"itemKey":"$gen_bar_Average Events per Second (eps)_1","sortOrder":2}],"labelSettings":[{"columnId":"Table Name","label":"Table name"},{"columnId":"Average Events per Second (eps)","label":"Average events per second (EPS)"},{"columnId":"Minimum eps","label":"Lowest EPS","comment":"Lowest EPS measured over the specified time period"},{"columnId":"Maximum eps","label":"Highest EPS","comment":"Highest EPS measured over the specified time period"}]},"sortBy":[{"itemKey":"$gen_bar_Average Events per Second (eps)_1","sortOrder":2}]},"customWidth":"100","name":"query - 7 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"CommonSecurityLog\r\n| where _TimeReceived  {EPStimerange:Label}\r\n| summarize count() by bin(_TimeReceived, 1m), Type, DeviceVendor\r\n| extend counttemp = todouble(count_ / 60)\r\n| summarize ['Events per Second (eps)'] = avg(counttemp) by DeviceVendor\r\n| order  by ['Events per Second (eps)'] desc","size":1,"showAnalytics":true,"title":"{EPStimerange:label}: average EPS in CommonSecurityLog (CEF), by device vendor","color":"blue","timeContext":{"durationMs":86400000},"timeContextFromParameter":"EPStimerange","exportFieldName":"Namespace","exportParameterName":"Namespace","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Events per Second (eps)","formatter":3,"formatOptions":{"palette":"turquoise","customColumnWidthSetting":"50%"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumSignificantDigits":3}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue"},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue"}}],"filter":true,"sortBy":[{"itemKey":"$gen_bar_Events per Second (eps)_1","sortOrder":1}],"labelSettings":[{"columnId":"DeviceVendor","label":"Device Vendor"},{"columnId":"Events per Second (eps)","label":"Events per second (EPS)"}]},"sortBy":[{"itemKey":"$gen_bar_Events per Second (eps)_1","sortOrder":1}]},"customWidth":"50","name":"query - 7 - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"CommonSecurityLog\r\n| where _TimeReceived  {EPStimerange:Label}\r\n| summarize count() by bin(_TimeReceived, 1m), Type, _ResourceId\r\n| extend counttemp =count_ / 60\r\n| summarize ['Events per Second (eps)'] = avg(counttemp) by Computer = _ResourceId\r\n| order  by ['Events per Second (eps)'] desc","size":1,"showAnalytics":true,"title":"{EPStimerange:label}: average EPS in CommonSecurityLog (CEF), by computer","color":"blue","timeContext":{"durationMs":86400000},"timeContextFromParameter":"EPStimerange","exportFieldName":"Namespace","exportParameterName":"Namespace","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Events per Second (eps)","formatter":3,"formatOptions":{"palette":"blue","customColumnWidthSetting":"20%"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumSignificantDigits":3}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue"},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue"}}],"filter":true,"labelSettings":[{"columnId":"Events per Second (eps)","label":"Events per second (EPS)"}]},"sortBy":[]},"customWidth":"50","name":"query - 7 - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Syslog\r\n| where _TimeReceived  {EPStimerange:Label}\r\n| summarize count() by bin(_TimeReceived, 1m), Type, _ResourceId\r\n| extend counttemp =count_ / 60\r\n| summarize ['Events per Second (eps)'] = avg(counttemp) by Computer = _ResourceId\r\n| order  by ['Events per Second (eps)'] desc","size":1,"showAnalytics":true,"title":"{EPStimerange:label}: average EPS in Syslog, by computer","color":"blue","timeContext":{"durationMs":86400000},"timeContextFromParameter":"EPStimerange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Events per Second (eps)","formatter":3,"formatOptions":{"palette":"gray","customColumnWidthSetting":"50%"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumSignificantDigits":3}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue"},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue"}}],"filter":true,"labelSettings":[{"columnId":"Events per Second (eps)","label":"Events per second (EPS)"}]},"sortBy":[]},"customWidth":"50","name":"query - 7 - Copy - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource = _TableName *\r\n| where '{Table}' == 'All Tables' or _TableName == '{Table}'\r\n| where _TimeReceived  > startofday(ago(7d))\r\n| summarize count()  by bin(_TimeReceived, {TimeRange:grain}), Type\r\n| project Type, _TimeReceived, count_\r\n\r\n\r\n","size":0,"showAnalytics":true,"title":"Total events collected over time, by table name, for the last 7 days","color":"blue","timeContext":{"durationMs":604800000},"exportFieldName":"Namespace","exportParameterName":"Namespace","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart","gridSettings":{"formatters":[{"columnMatch":"Average Events per Second (eps)","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumSignificantDigits":3}}},{"columnMatch":"Minimum eps","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":3}}},{"columnMatch":"Maximum eps","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","maximumSignificantDigits":3}}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue"},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue"}}],"filter":true},"sortBy":[],"chartSettings":{"seriesLabelSettings":[{"seriesName":"Other","color":"green"}],"xSettings":{},"ySettings":{}}},"customWidth":"100","name":"query - 7 - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource = _TableName *\r\n| where '{Table}' == 'All Tables' or _TableName == '{Table}'\r\n| summarize count()  by bin(_TimeReceived, {TimeRange:grain}), Type\r\n| project Type, _TimeReceived, count_\r\n\r\n\r\n","size":1,"showAnalytics":true,"title":"Total events collected over time, by table name, for the last 30 days","color":"blue","timeContext":{"durationMs":2592000000},"exportFieldName":"Namespace","exportParameterName":"Namespace","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart","gridSettings":{"formatters":[{"columnMatch":"Average Events per Second (eps)","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumSignificantDigits":3}}},{"columnMatch":"Minimum eps","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":3}}},{"columnMatch":"Maximum eps","formatter":3,"formatOptions":{"palette":"redGreen"},"numberFormat":{"unit":0,"options":{"style":"decimal","maximumSignificantDigits":3}}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue"},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue"}}],"rowLimit":1000,"filter":true,"sortBy":[{"itemKey":"Type","sortOrder":1}]},"sortBy":[{"itemKey":"Type","sortOrder":1}],"chartSettings":{"seriesLabelSettings":[{"seriesName":"Other","color":"green"}],"xSettings":{},"ySettings":{}}},"customWidth":"100","name":"query - 7 - Copy - Copy - Copy"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},"name":"group - eps"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"---\r\n## Last event received"},"name":"text - 4"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"7e985447-1426-44cc-9c80-75aad9458b93","version":"KqlParameterItem/1.0","name":"LastLogRecivedThreshold","label":"Last log received threshold","type":2,"description":"Select the last log recived threshold, to filter the table below","isRequired":true,"value":"3600","typeSettings":{"additionalResourceOptions":[],"showDefault":false},"jsonData":"[{\"value\":\"0\",\"label\":\"None\"},{\"value\":\"3600\",\"label\":\"1h\"},{\"value\":\"21600\",\"label\":\"6h\"},{\"value\":\"43200\",\"label\":\"12h\"}, {\"value\":\"86400\",\"label\":\"1d\"},{\"value\":\"172800\",\"label\":\"2d\"},{\"value\":\"604800\",\"label\":\"7d\"}]","timeContext":{"durationMs":86400000}}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 8"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource = _TableName *\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize last_log = datetime_diff(\"second\",now(), max(TimeGenerated))  by _TableName\r\n| where last_log > {LastLogRecivedThreshold}\r\n| project ['Table Name'] = _TableName,  ['Last Record Received'] =  last_log \r\n | order by ['Last Record Received']  desc\r\n\r\n ","size":0,"showAnalytics":true,"title":"Last data received, by table","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Last Record Received","formatter":8,"formatOptions":{"palette":"orangeRed"},"numberFormat":{"unit":24,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":2}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"coldHot"},"numberFormat":{"unit":2,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange"},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"IsBillable","formatter":18,"formatOptions":{"thresholdsOptions":"colors","thresholdsGrid":[{"operator":"==","thresholdValue":"True","representation":"green","text":"{0}{1}"},{"operator":"==","thresholdValue":"False","representation":"blueDark","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"blue","text":"{0}{1}"}]}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Trend","formatter":10,"formatOptions":{"palette":"redGreen"}}],"filter":true,"sortBy":[{"itemKey":"$gen_heatmap_Last Record Received_1","sortOrder":2}],"labelSettings":[{"columnId":"Table Name","label":"Table name"},{"columnId":"Last Record Received","label":"Last record received","comment":"When did the last record arrive?"}]},"sortBy":[{"itemKey":"$gen_heatmap_Last Record Received_1","sortOrder":2}]},"customWidth":"50","showPin":true,"name":"query - 2 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"CommonSecurityLog\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize last_log = datetime_diff(\"second\",now(), max(TimeGenerated))  by DeviceVendor\r\n| where last_log > {LastLogRecivedThreshold}\r\n| project ['Device Vendor'] = DeviceVendor,  ['Last Record Received'] =  last_log \r\n | order by ['Last Record Received']  desc\r\n\r\n ","size":0,"showAnalytics":true,"title":"Last data received, by CEF device vendor","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Last Record Received","formatter":8,"formatOptions":{"palette":"orangeRed"},"numberFormat":{"unit":24,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":2}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"coldHot"},"numberFormat":{"unit":2,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange"},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"IsBillable","formatter":18,"formatOptions":{"thresholdsOptions":"colors","thresholdsGrid":[{"operator":"==","thresholdValue":"True","representation":"green","text":"{0}{1}"},{"operator":"==","thresholdValue":"False","representation":"blueDark","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"blue","text":"{0}{1}"}]}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Trend","formatter":10,"formatOptions":{"palette":"redGreen"}}],"filter":true,"labelSettings":[{"columnId":"Device Vendor","label":"Device vendor"},{"columnId":"Last Record Received","label":"Last record received","comment":"When did the last record arrive?"}]},"sortBy":[]},"customWidth":"50","showPin":true,"name":"query - 2 - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"CommonSecurityLog\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize last_log = datetime_diff(\"second\",now(), max(TimeGenerated))  by _ResourceId, Computer\r\n| where last_log > {LastLogRecivedThreshold}\r\n| project ['Azure resource'] = _ResourceId, Computer,  ['Last Record Received'] =  last_log \r\n | order by ['Last Record Received']  desc\r\n ","size":0,"showAnalytics":true,"title":"CommonSecurityLog (CEF): Last data received, by computer","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Last Record Received","formatter":8,"formatOptions":{"palette":"orangeRed"},"numberFormat":{"unit":24,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":2}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"coldHot"},"numberFormat":{"unit":2,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange"},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"IsBillable","formatter":18,"formatOptions":{"thresholdsOptions":"colors","thresholdsGrid":[{"operator":"==","thresholdValue":"True","representation":"green","text":"{0}{1}"},{"operator":"==","thresholdValue":"False","representation":"blueDark","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"blue","text":"{0}{1}"}]}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Trend","formatter":10,"formatOptions":{"palette":"redGreen"}}],"filter":true,"labelSettings":[{"columnId":"Computer"},{"columnId":"Last Record Received","label":"Last record received"}]},"sortBy":[]},"customWidth":"50","showPin":true,"name":"query - 2 - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Syslog\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize last_log = datetime_diff(\"second\",now(), max(TimeGenerated))  by _ResourceId, Computer\r\n| where last_log > {LastLogRecivedThreshold}\r\n| project ['Azure resource'] = _ResourceId, Computer,  ['Last Record Received'] =  last_log \r\n | order by ['Last Record Received']  desc\r\n\r\n ","size":0,"showAnalytics":true,"title":"Syslog: Last data received, by computer","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Last Record Received","formatter":8,"formatOptions":{"palette":"orangeRed"},"numberFormat":{"unit":24,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":2}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"coldHot"},"numberFormat":{"unit":2,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange"},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"IsBillable","formatter":18,"formatOptions":{"thresholdsOptions":"colors","thresholdsGrid":[{"operator":"==","thresholdValue":"True","representation":"green","text":"{0}{1}"},{"operator":"==","thresholdValue":"False","representation":"blueDark","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"blue","text":"{0}{1}"}]}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Trend","formatter":10,"formatOptions":{"palette":"redGreen"}}],"filter":true,"labelSettings":[{"columnId":"Computer"},{"columnId":"Last Record Received","label":"Last record received"}]},"sortBy":[]},"customWidth":"50","showPin":true,"name":"query - 2 - Copy - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize last_log = datetime_diff(\"second\",now(), max(TimeGenerated))  by _ResourceId, Computer\r\n| where last_log > {LastLogRecivedThreshold}\r\n| project ['Azure resource'] = _ResourceId, Computer,  ['Last Record Received'] =  last_log \r\n | order by ['Last Record Received']  desc\r\n ","size":0,"showAnalytics":true,"title":"SecurityEvent: Last data received, by computer","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Last Record Received","formatter":8,"formatOptions":{"palette":"orangeRed"},"numberFormat":{"unit":24,"options":{"style":"decimal","useGrouping":false,"maximumSignificantDigits":2}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"coldHot"},"numberFormat":{"unit":2,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange"},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"IsBillable","formatter":18,"formatOptions":{"thresholdsOptions":"colors","thresholdsGrid":[{"operator":"==","thresholdValue":"True","representation":"green","text":"{0}{1}"},{"operator":"==","thresholdValue":"False","representation":"blueDark","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"blue","text":"{0}{1}"}]}},{"columnMatch":"Estimated Table Price","formatter":3,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Table Trend","formatter":10,"formatOptions":{"palette":"redGreen"}}],"filter":true,"labelSettings":[{"columnId":"Computer"},{"columnId":"Last Record Received","label":"Last record received","comment":"When did the last record arrive?"}]},"sortBy":[]},"customWidth":"50","showPin":true,"name":"query - 2 - Copy - Copy - Copy - Copy - Copy"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WorkspaceInfo"},"name":"group - latency"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"---"},"name":"text - 7"},{"type":1,"content":{"json":"# Data collection anomalies view:\r\n"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"anomalies"},"name":"text - 10"},{"type":1,"content":{"json":"In this section you will be able to detect anomalies in the data collection process. \r\nEach tab presents anomalies for a particular table.\r\nThe anomlies are calculated using the **series_decompose_anomalies()** function that returns an **anomaly score**. [Learn more about this function](https://docs.microsoft.com/azure/data-explorer/kusto/query/series-decompose-anomaliesfunction).\r\n\r\n#### Parameters:\r\n- **AnomaliesTimeRange**: This time picker applies only to the data collection anomalies view.\r\n- **SampleInterval**: The time interval in which data is sampled in the given time range. The anomaly score is calculated only on the last interval's data.\r\n- **PositiveAlertThreshold**: This value defines the positive **anomaly score** threshold. Accepts decimal values.\r\n- **NegativeAlertThreshold**: This value defines the negative **anomaly score** threshold. Accepts decimal values.\r\n\r\n","style":"info"},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"anomalies"},{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"}],"name":"text - 10 - Copy"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"2308c1ae-92f4-44c9-a6e2-a09a8302f4ca","version":"KqlParameterItem/1.0","name":"AnomaliesTimeRange","label":"Time Range","type":4,"description":"This time picker applies only to the data collection anomalies view.","isRequired":true,"value":{"durationMs":1209600000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}],"allowCustom":true},"timeContext":{"durationMs":0},"timeContextFromParameter":"EPStimerange"},{"id":"8991a3f1-5fb9-4f6b-b140-f573c9300e7c","version":"KqlParameterItem/1.0","name":"SampleInterval","label":"Sample Interval","type":2,"description":"The time interval in which data is sampled in the given time range. The anomaly score is calculated only on the last interval's data.","typeSettings":{"additionalResourceOptions":[]},"jsonData":"[{ \"value\": \"5m\", \"label\": \"5m\" }, { \"value\": \"1h\", \"label\": \"1h\" }, { \"value\": \"1d\", \"label\": \"1d\" , \"selected\":true }, { \"value\": \"7d\", \"label\": \"7d\" , \"selected\":true },{ \"value\": \"14d\", \"label\": \"14d\"}]","timeContext":{"durationMs":0},"timeContextFromParameter":"EPStimerange"},{"id":"1961884d-dc42-4a2d-9462-bf0f183063b2","version":"KqlParameterItem/1.0","name":"PositiveAlertThreshold","label":"Positive Alert Threshold","type":1,"description":"This value defines the positive anomaly score threshold. Accepts decimal values. ","isRequired":true,"value":"2.0","timeContext":{"durationMs":0},"timeContextFromParameter":"EPStimerange"},{"id":"7b805478-0db9-4fe8-b0b0-90e6a5332451","version":"KqlParameterItem/1.0","name":"NegativeAlertThreshold","label":"Negative Alert Threshold","type":1,"description":"This value defines the negative anomaly score threshold. Accepts decimal values. ","isRequired":true,"value":"-2.0","timeContext":{"durationMs":0},"timeContextFromParameter":"EPStimerange"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 0"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"fe57bc7c-82df-4d94-bcfd-7f5713db71fc","cellValue":"AnomaliesTab","linkTarget":"parameter","linkLabel":"General","subTarget":"General","style":"link"},{"id":"68179146-d2dc-4b53-8091-4fefee8dee00","cellValue":"AnomaliesTab","linkTarget":"parameter","linkLabel":"Common Event Format (CEF)","subTarget":"CEF","style":"link"},{"id":"c2f485d4-a9b2-489b-b1cc-fa211de20bd2","cellValue":"AnomaliesTab","linkTarget":"parameter","linkLabel":"Security Event","subTarget":"SecurityEvents","style":"link"},{"id":"6808e012-fd1e-451c-8036-3cf97571cde7","cellValue":"AnomaliesTab","linkTarget":"parameter","linkLabel":"Syslog","subTarget":"Syslog","style":"link"},{"id":"b996ab73-96a2-4c0d-9fe7-7f326178e602","cellValue":"AnomaliesTab","linkTarget":"parameter","linkLabel":"Azure Activity","subTarget":"AzureActivity","style":"link"},{"id":"ceaf1500-6658-4ce0-aa65-35eac464706d","cellValue":"AnomaliesTab","linkTarget":"parameter","linkLabel":"Azure Diagnostics","subTarget":"AzureDiagnostics","style":"link"},{"id":"3a161dfa-3b19-41bf-a82c-f3e69a0dede3","cellValue":"AnomaliesTab","linkTarget":"parameter","linkLabel":"Office Activity","subTarget":"OfficeActivity","style":"link"},{"id":"dbc065b2-644e-408b-a085-9b07a45e1d3c","cellValue":"AnomaliesTab","linkTarget":"parameter","linkLabel":"AWS CloudTrail","subTarget":"CloudTrail","style":"link"}]},"name":"links - 2"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Tables detected anomalies","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource = _TableName *\r\n| make-series count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value}  by _TableName\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(count_, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project [\"Table Name\"] = _TableName, expectedCounts=baseline[-1], actualCount=count_[-1], Score = score[-1]","size":0,"showAnalytics":true,"title":"Click on the table name to drill down","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"Score","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}},{"columnMatch":"score","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}}],"filter":true,"labelSettings":[{"columnId":"expectedCounts","label":"Excepted amount of events"},{"columnId":"actualCount","label":"Actual amount of events"},{"columnId":"Score"}]}},"customWidth":"50","showPin":true,"name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource = _TableName *\r\n| where _TableName == '{Table}'\r\n| make-series count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value}\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(count_, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| project-away anomalies, score\r\n| render timechart ","size":0,"title":"Anomaly graph for the selected table","timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"customWidth":"50","conditionalVisibility":{"parameterName":"Table","comparison":"isNotEqualTo","value":"All"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource= _TableName *\r\n| where _TableName == '{Table}'\r\n| make-series Trend = count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value}  by _TableName, _ResourceId, SourceSystem\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Trend, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project _ResourceId, SourceSystem, expectedCounts=baseline[-1], actualCount=Trend[-1], score = round(todouble(score[-1]),2), Trend, Baselaine = baseline","size":0,"title":"Anomalies by source system and resource","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"score","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"2","text":"{0}{1}"}]},"numberFormat":{"unit":0,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"min":0,"palette":"blue"}},{"columnMatch":"Baselaine","formatter":21,"formatOptions":{"min":0,"palette":"purple"}}],"filter":true,"labelSettings":[{"columnId":"_ResourceId","label":"Resource ID"},{"columnId":"SourceSystem","label":"Source system"},{"columnId":"expectedCounts","label":"Excepted amount of events"},{"columnId":"actualCount","label":"Actual amount of events"},{"columnId":"score","label":"Score"},{"columnId":"Trend"},{"columnId":"Baselaine","label":"Baseline"}]}},"conditionalVisibility":{"parameterName":"Table","comparison":"isNotEqualTo","value":"All"},"name":"query - 1 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Usage\r\n| make-series Sum = sum(Quantity) on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value}  by DataType\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Sum, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project TableName = DataType, expectedCounts=baseline[-1], actualCount=Sum[-1], Score = score[-1]","size":0,"showAnalytics":true,"title":"Click on the table name to drill down","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","exportFieldName":"TableName","exportParameterName":"TableName","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"Score","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}},{"columnMatch":"score","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}}],"filter":true,"labelSettings":[{"columnId":"TableName","label":"Table name"},{"columnId":"expectedCounts","label":"Excepted amount of events"},{"columnId":"actualCount","label":"Actual amount of events"},{"columnId":"Score"}]}},"customWidth":"50","conditionalVisibility":{"parameterName":"display","comparison":"isEqualTo","value":"1"},"showPin":true,"name":"query - 1 - Copy"}]},"conditionalVisibility":{"parameterName":"AnomaliesTab","comparison":"isEqualTo","value":"General"},"name":"Tables detected anomalies"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Common Event Format (CEF) anomalies","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"CommonSecurityLog\r\n| make-series count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} \r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(count_, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| project-away anomalies, score\r\n| render timechart ","size":0,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"customWidth":"50","name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"CommonSecurityLog\r\n| make-series Trend = count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} by DeviceVendor\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Trend, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project ['Device Vendor'] = DeviceVendor, ['Expected counts']=baseline[-1], ['Actual count']=Trend[-1], Score = score[-1], Trend, Baseline = baseline","size":0,"showAnalytics":true,"title":"Detections by vendor","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","maximumFractionDigits":2}}},{"columnMatch":"score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"min":0,"palette":"blue"}},{"columnMatch":"Baseline","formatter":21,"formatOptions":{"min":0,"palette":"turquoise"}}]}},"customWidth":"50","showPin":true,"name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"CommonSecurityLog\r\n| make-series Trend = count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} by DeviceVendor, DeviceProduct, _ResourceId, Computer\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Trend, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project DeviceVendor,  DeviceProduct, Machime = _ResourceId, [\"Computer Name\"] = Computer, expectedCounts=baseline[-1], actualCount=Trend[-1], score = score[-1], Trend, Baseline = baseline","size":0,"showAnalytics":true,"title":"Detections by vendor, product and machine","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":0},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"actualCount","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true}}},{"columnMatch":"score","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"max":0,"palette":"pink"}},{"columnMatch":"Baseline","formatter":21,"formatOptions":{"min":0,"palette":"purple"}}],"labelSettings":[{"columnId":"DeviceVendor","label":"Device vendor"},{"columnId":"DeviceProduct","label":"Device product"},{"columnId":"Machime","label":"Machine"},{"columnId":"expectedCounts","label":"Expected count"},{"columnId":"actualCount","label":"Actual count"},{"columnId":"score","label":"Score"},{"columnId":"Trend"},{"columnId":"Baseline"}]}},"showPin":true,"name":"query - 2"}]},"conditionalVisibility":{"parameterName":"AnomaliesTab","comparison":"isEqualTo","value":"CEF"},"name":"CEF"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Security Events anomalies","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| make-series count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} \r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(count_, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| project-away anomalies, score\r\n| render timechart ","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| make-series Trend = count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} by _ResourceId, Computer\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Trend, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project Machine = _ResourceId, [\"Computer Name\"] = Computer, expectedCounts=baseline[-1], actualCount=Trend[-1], score = score[-1], Trend, Baseline = baseline","size":0,"showAnalytics":true,"title":"Detections by machine","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":0},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"actualCount","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true}}},{"columnMatch":"score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"max":0,"palette":"pink"}},{"columnMatch":"Baseline","formatter":21,"formatOptions":{"min":0,"palette":"purple"}}],"labelSettings":[{"columnId":"Machine"},{"columnId":"expectedCounts","label":"Expected event count"},{"columnId":"actualCount","label":"Actual event count"},{"columnId":"score","label":"Score"},{"columnId":"Trend"},{"columnId":"Baseline"}]}},"showPin":true,"name":"query - 2"}]},"conditionalVisibility":{"parameterName":"AnomaliesTab","comparison":"isEqualTo","value":"SecurityEvents"},"name":"Security Events"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Syslog anomalies","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"Syslog\r\n| make-series count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} \r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(count_, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| project-away anomalies, score\r\n| render timechart ","size":0,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Syslog\r\n| make-series Trend = count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} by _ResourceId, Computer, SourceSystem\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Trend, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project Machine = _ResourceId, [\"Computer Name\"] = Computer, ['Source System'] = SourceSystem, expectedCounts=baseline[-1], actualCount=Trend[-1], Score = score[-1], Trend, Baseline = baseline","size":0,"showAnalytics":true,"title":"Detections by machine","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":0},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"actualCount","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true}}},{"columnMatch":"Score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"min":0,"palette":"blue"}},{"columnMatch":"Baseline","formatter":21,"formatOptions":{"min":0,"palette":"turquoise"}},{"columnMatch":"score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}}],"labelSettings":[{"columnId":"Machine"},{"columnId":"expectedCounts","label":"Expected event count"},{"columnId":"actualCount","label":"Actual event count"},{"columnId":"Score"},{"columnId":"Trend"},{"columnId":"Baseline"}]}},"showPin":true,"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"AnomaliesTab","comparison":"isEqualTo","value":"Syslog"},"name":"Syslog"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Azure activity anomalies","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity\r\n| make-series Trend = count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} by _ResourceId, ResourceGroup\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Trend, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project ['Resource group'] = ResourceGroup, ['Resource'] = _ResourceId, expectedCounts=baseline[-1], actualCount=Trend[-1], Score = score[-1], Trend, Baseline = baseline","size":0,"showAnalytics":true,"title":"Detections by resource - select a row to filter the graph","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","exportFieldName":"Resource","exportParameterName":"ResourceID","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"actualCount","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true}}},{"columnMatch":"Score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"min":0,"palette":"blue"}},{"columnMatch":"Baseline","formatter":21,"formatOptions":{"min":0,"palette":"turquoise"}},{"columnMatch":"score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}}],"labelSettings":[{"columnId":"expectedCounts","label":"Expected event count"},{"columnId":"actualCount","label":"Actual event count"},{"columnId":"Score"},{"columnId":"Trend"},{"columnId":"Baseline"}]}},"showPin":true,"name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity\r\n| where _ResourceId == '{ResourceID}' or '{ResourceID}' == \"All\"\r\n| make-series count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} \r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(count_, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| project-away anomalies, score\r\n| render timechart ","size":0,"showAnalytics":true,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"showPin":true,"name":"query - 0"}]},"conditionalVisibility":{"parameterName":"AnomaliesTab","comparison":"isEqualTo","value":"AzureActivity"},"name":"AzureActivity"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Azure activity anomalies","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| make-series Trend = count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} by ResourceType\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Trend, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project ['Resource type'] = ResourceType, expectedCounts=baseline[-1], actualCount=Trend[-1], Score = score[-1], Trend, Baseline = baseline","size":0,"showAnalytics":true,"title":"Detections by resource type - select a row to filter the graph","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","exportFieldName":"Resource type","exportParameterName":"ResourceType","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"actualCount","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true}}},{"columnMatch":"Score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"min":0,"palette":"blue"}},{"columnMatch":"Baseline","formatter":21,"formatOptions":{"min":0,"palette":"turquoise"}},{"columnMatch":"score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}}],"labelSettings":[{"columnId":"expectedCounts","label":"Expected event count"},{"columnId":"actualCount","label":"Actual event count"},{"columnId":"Score"},{"columnId":"Trend"},{"columnId":"Baseline"}]}},"showPin":true,"name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where ResourceType == '{ResourceType}' or  'All' == '{ResourceType}'\r\n| make-series count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} \r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(count_, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| project-away anomalies, score\r\n| render timechart ","size":0,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureDiagnostics\r\n| where ResourceType == '{ResourceType}'\r\n| make-series Trend = count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} by _ResourceId, ResourceType\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Trend, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project ['Resource'] = _ResourceId, ['Resource type'] = ResourceType, expectedCounts=baseline[-1], actualCount=Trend[-1], Score = score[-1], Trend, Baseline = baseline","size":0,"showAnalytics":true,"title":"Detections by resource","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","exportFieldName":"Resource Type","exportParameterName":"ResourceType","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"actualCount","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true}}},{"columnMatch":"Score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"min":0,"palette":"blue"}},{"columnMatch":"Baseline","formatter":21,"formatOptions":{"min":0,"palette":"turquoise"}},{"columnMatch":"score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}}],"labelSettings":[{"columnId":"expectedCounts","label":"Expected event count"},{"columnId":"actualCount","label":"Actual event count"},{"columnId":"Score"},{"columnId":"Trend"},{"columnId":"Baseline"}]}},"conditionalVisibility":{"parameterName":"ResourceType","comparison":"isNotEqualTo","value":"All"},"showPin":true,"name":"query - 1 - Copy"}]},"conditionalVisibility":{"parameterName":"AnomaliesTab","comparison":"isEqualTo","value":"AzureDiagnostics"},"name":"AzureActivity - Copy"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Office activity anomalies","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity\r\n| make-series count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} \r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(count_, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| project-away anomalies, score\r\n| render timechart ","size":0,"showAnalytics":true,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"showPin":true,"name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity\r\n| make-series Trend = count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} by OfficeWorkload\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Trend, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project ['Office workload'] = OfficeWorkload, expectedCounts=baseline[-1], actualCount=Trend[-1], Score = score[-1], Trend, Baseline = baseline","size":0,"showAnalytics":true,"title":"Detections by Office workload type","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","exportFieldName":"OfficeWorkload","exportParameterName":"OfficeWorkload","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"actualCount","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true}}},{"columnMatch":"Score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"min":0,"palette":"blue"}},{"columnMatch":"Baseline","formatter":21,"formatOptions":{"min":0,"palette":"turquoise"}},{"columnMatch":"score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}}],"labelSettings":[{"columnId":"expectedCounts","label":"Expected event count"},{"columnId":"actualCount","label":"Actual event count"},{"columnId":"Score"},{"columnId":"Trend"},{"columnId":"Baseline"}]}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"AnomaliesTab","comparison":"isEqualTo","value":"OfficeActivity"},"name":"Office Activity"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"AWS CloudTrail anomalies","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"AWSCloudTrail\r\n| make-series count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} \r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(count_, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| project-away anomalies, score\r\n| render timechart ","size":0,"showAnalytics":true,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"showPin":true,"name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AWSCloudTrail\r\n| make-series Trend = count() on TimeGenerated from {AnomaliesTimeRange:start} to {AnomaliesTimeRange:end} step {SampleInterval:value} by AWSRegion\r\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Trend, 1.5, 7, 'linefit', 1, 'ctukey', 0.01)\r\n| where anomalies[-1] == 1 or anomalies[-1] == -1  \r\n| extend Score = score[-1]\r\n| where Score >= {PositiveAlertThreshold:value} or Score <= {NegativeAlertThreshold:value}\r\n| project ['AWS region'] = AWSRegion, expectedCounts=baseline[-1], actualCount=Trend[-1], Score = score[-1], Trend, Baseline = baseline","size":0,"showAnalytics":true,"title":"Detections by AWS region","noDataMessage":"No anomalies found","noDataMessageStyle":3,"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"AnomaliesTimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"expectedCounts","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"actualCount","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true}}},{"columnMatch":"Score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"min":0,"palette":"blue"}},{"columnMatch":"Baseline","formatter":21,"formatOptions":{"min":0,"palette":"turquoise"}},{"columnMatch":"score","formatter":0,"formatOptions":{},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}}],"labelSettings":[{"columnId":"expectedCounts","label":"Expected event count"},{"columnId":"actualCount","label":"Actual event count"},{"columnId":"Score"},{"columnId":"Trend"},{"columnId":"Baseline"}]}},"showPin":true,"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"AnomaliesTab","comparison":"isEqualTo","value":"CloudTrail"},"name":"AWS CloudTrail"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"anomalies"},"name":"Data collection anomalies - Copy"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"# Agent information view"},"name":"text - 13"},{"type":1,"content":{"json":"### Make sure to select your machines' enviroment: \r\n- Azure managed machines - show statistics for Azure VMs or Azure Arc managed servers\r\n- All machines - show statistics for all machines, including non-Azure servers reporting via the Microsoft Monitoring Agent (MMA)"},"name":"text - 5"},{"type":1,"content":{"json":"#### This tab shows you information about the health of the Log Analytics agents installed on your various machines, whether Azure VM, other cloud VM, on-premises VM, or physical. You can see the following information:\r\n- Location\r\n- Heartbeat status\r\n- Available memory and disk space\r\n- Action audit\r\n\r\n### You can filter any of these displays by log type (table name) and by specific machines."},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 13 - Copy"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"4cfd60bb-7de0-46c1-9cae-7a933948bf8d","cellValue":"OnPrem","linkTarget":"parameter","linkLabel":"Azure managed machines","subTarget":"No","preText":"Azure VMs","style":"link"},{"id":"d2fed116-caff-483f-bbad-ba07302f1777","cellValue":"OnPrem","linkTarget":"parameter","linkLabel":"All machines","subTarget":"Yes","style":"link"}]},"name":"links - 19"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Workspace}"],"parameters":[{"id":"d2922a2e-e093-47eb-862f-50a647e3f30d","version":"KqlParameterItem/1.0","name":"TableName","label":"Table name filter","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"union withsource=_TableName *\r\n| summarize by _TableName","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"","showDefault":false},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"c6e118c5-f30b-4d06-a5a6-59645318df64","version":"KqlParameterItem/1.0","name":"VMfilter","label":"Machine name filter","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"union withsource=_TableName *\r\n| where _TableName in ({TableName})\r\n| where _ResourceId contains \"virtualmachines\"\r\n| where _ResourceId != \" \"\r\n| summarize by value = _ResourceId\r\n| extend label = extract(\".*/([^/]+)\",1, value) ","crossComponentResources":["{Workspace}"],"value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"showDefault":false},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 11"},{"type":1,"content":{"json":"Select a location to filter the display below.","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 15"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat\r\n| where tolower(ResourceId) in ({VMfilter})\r\n| summarize dcount(Computer) by RemoteIPCountry, Computer","size":0,"title":"Computers' location","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"regionName","exportParameterName":"regionName","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"map","mapSettings":{"locInfo":"CountryRegion","locInfoColumn":"RemoteIPCountry","sizeSettings":"dcount_Computer","sizeAggregation":"Sum","legendMetric":"dcount_Computer","legendAggregation":"Sum","itemColorSettings":{"nodeColorField":"dcount_Computer","colorAggregation":"Sum","type":"heatmap","heatmapPalette":"orangeBlue","heatmapMin":0}}},"customWidth":"50","name":"query - 7"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat\r\n| where tolower(ResourceId) in ({VMfilter})\r\n| where RemoteIPCountry == \"{regionName}\" or \"{regionName}\" == \"All\"\r\n| summarize AggregatedValue = dcount(Computer) by [\"OS\"]=iff(isempty(OSName), OSType, OSName)","size":0,"title":"Computer OS","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"OS","formatter":1},"leftContent":{"columnMatch":"AggregatedValue","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"customWidth":"50","name":"query - 9"},{"type":1,"content":{"json":"## Computer heartbeat tracking: {TimeRange}"},"name":"text - 11"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Subscription}"],"parameters":[{"id":"e0fb3c9a-f42f-4dfb-a86c-f4dd36584904","version":"KqlParameterItem/1.0","name":"UnhealthyCriteria","label":"Unhealthy definition","type":2,"isRequired":true,"typeSettings":{"additionalResourceOptions":[]},"jsonData":"[\r\n    { \"value\":\"1m\", \"label\":\"1 minute without heartbeat\", \"selected\":false },\r\n    { \"value\":\"5m\", \"label\":\"5 minutes without heartbeat\", \"selected\":false },\r\n    { \"value\":\"30m\", \"label\":\"30 minutes without heartbeat\", \"selected\":false },\r\n    { \"value\":\"1h\", \"label\":\"1 hour without heartbeat\", \"selected\":true },\r\n    { \"value\":\"2h\", \"label\":\"2 hours without heartbeat\", \"selected\":false },\r\n    { \"value\":\"8h\", \"label\":\"8 hours without heartbeat\", \"selected\":false },\r\n    { \"value\":\"1d\", \"label\":\"1 day without heartbeat\", \"selected\":false },\r\n    { \"value\":\"2d\", \"label\":\"2 days without heartbeat\", \"selected\":false },\r\n    { \"value\":\"7d\", \"label\":\"7 days without heartbeat\", \"selected\":false }\r\n]","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","value":"30m"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 13"},{"type":1,"content":{"json":"Select a computer from the table to measure the heartbeat and latency of a specific computer. The latency is measured by comparing the result of the **ingestion_time()** function to the value of the **TimeGenerated** property.","style":"info"},"name":"text - 15 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat\r\n| where tolower(ResourceId) in ({VMfilter})\r\n| where TimeGenerated {TimeRange:query}\r\n| where RemoteIPCountry == \"{regionName}\" or \"{regionName}\" == \"All\"\r\n| summarize LastHeartbeat = max(TimeGenerated) by Computer\r\n| extend State = iff(LastHeartbeat < ago({UnhealthyCriteria}), 'Unhealthy', 'Healthy')\r\n| extend TimeFromNow = now() - LastHeartbeat\r\n| extend [\"TimeAgo\"] = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| join (\r\nHeartbeat\r\n| where TimeGenerated {TimeRange:query}\r\n| extend Packed = pack_all()\r\n) on Computer\r\n| where TimeGenerated == LastHeartbeat\r\n| join (\r\nHeartbeat\r\n| where TimeGenerated {TimeRange:query}\r\n| make-series InternalTrend=iff(count() > 0, 1, 0) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {UnhealthyCriteria} by Computer\r\n| extend Trend=array_slice(InternalTrend, array_length(InternalTrend) - 30, array_length(InternalTrend)-1)\r\n| extend (s_min, s_minId, s_max, s_maxId, s_avg, s_var, s_stdev) = series_stats(Trend)\r\n| project Computer, Trend, s_avg\r\n) on Computer\r\n| order by State, s_avg asc, TimeAgo\r\n| project [\"_ComputerName_\"] = Computer, [\"Computer\"]=strcat('🖥️ ', Computer), State, [\"Environment\"] = iff(ComputerEnvironment == \"Azure\", ComputerEnvironment, Category), [\"OS\"]=iff(isempty(OSName), OSType, OSName), [\"Azure Resource\"]=ResourceId, [\"Time\"]=strcat('🕒 ', TimeAgo), [\"Heartbeat Trend\"]=Trend, [\"Details\"]=Packed, [\"Computer Region\"] = RemoteIPCountry","size":0,"showAnalytics":true,"title":"{TimeRange:label}: all agent heartbeat data ","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"_ComputerName_","exportParameterName":"ComputerName","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"_ComputerName_","formatter":5},{"columnMatch":"Computer","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"State","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Healthy","representation":"Available","text":"{0}{1}"},{"operator":"==","thresholdValue":"Unhealthy","representation":"warning","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":null,"text":"{0}{1}"}]}},{"columnMatch":"Environment","formatter":18,"formatOptions":{"thresholdsOptions":"colors","thresholdsGrid":[{"operator":"==","thresholdValue":"Azure","text":"{0}{1}"},{"operator":"==","thresholdValue":"Direct Agent","representation":"magenta","text":"{0}{1}"},{"operator":"==","thresholdValue":"SCOM Agent","representation":"purple","text":"{0}{1}"},{"operator":"==","thresholdValue":"SCOM Management Server","representation":"gray","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"blue","text":"{0}{1}"}]},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Heartbeat Trend","formatter":10,"formatOptions":{"palette":"redGreen"}},{"columnMatch":"Details","formatter":5}],"filter":true,"sortBy":[{"itemKey":"$gen_thresholds_State_2","sortOrder":2}],"labelSettings":[{"columnId":"_ComputerName_"},{"columnId":"Computer"},{"columnId":"State","label":"Health status"},{"columnId":"Environment"},{"columnId":"OS"},{"columnId":"Azure Resource","label":"Azure resource"},{"columnId":"Time","label":"Time of last heartbeat"},{"columnId":"Heartbeat Trend","label":"Heartbeat history"},{"columnId":"Details"},{"columnId":"Computer Region","label":"Computer region"}]},"sortBy":[{"itemKey":"$gen_thresholds_State_2","sortOrder":2}]},"showPin":true,"name":"query - 16"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat  \r\n| where Computer startswith \"{ComputerName}\"\r\n| summarize ['Heartbeats per hour'] = count() by bin(TimeGenerated,1h) ","size":0,"title":"Heartbeats per hour: {ComputerName}","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"categoricalbar","chartSettings":{"showLegend":true}},"customWidth":"50","conditionalVisibility":{"parameterName":"ComputerName","comparison":"isNotEqualTo","value":"All"},"name":"query - 13"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat  \r\n| where Computer startswith \"{ComputerName}\"\r\n| extend E2EIngestionLatency = todouble(datetime_diff(\"Second\",ingestion_time(),TimeGenerated))/60 \r\n| extend AgentLatency        = todouble(datetime_diff(\"Second\",_TimeReceived,TimeGenerated))/60 \r\n| summarize avg(E2EIngestionLatency),avg(AgentLatency) by bin(TimeGenerated,1h) \r\n| project TimeGenerated, ['End-to-end latency'] = avg_E2EIngestionLatency, ['Agent Latency'] = avg_AgentLatency\r\n","size":0,"title":"Average heartbeat latency: {ComputerName}","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"timechart","gridSettings":{"formatters":[{"columnMatch":"avgE2E","formatter":0,"formatOptions":{"showIcon":true},"numberFormat":{"unit":0,"options":{"style":"decimal"}}}]},"tileSettings":{"showBorder":false},"chartSettings":{"showLegend":true,"ySettings":{"unit":24,"min":null,"max":null}}},"customWidth":"50","conditionalVisibility":{"parameterName":"ComputerName","comparison":"isNotEqualTo","value":"All"},"name":"query - 14"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Operation\r\n| where tolower(_ResourceId) in ({VMfilter})\r\n| where Computer != \"\" and Computer == \"{ComputerName}\" or \"{ComputerName}\" == \"All\"\r\n| summarize Failers = countif(OperationStatus == \"Failed\" or OperationStatus == \"Failure\"), Errors = countif(OperationStatus == \"Error\"), Warnings = countif(OperationStatus == \"Warning\") by Computer\r\n| order by Failers, Errors, Warnings","size":0,"title":"Operation status","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Computer","exportParameterName":"SelectedComputer","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Failers","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"Errors","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"Warnings","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"OperationStatus","formatter":0,"formatOptions":{"aggregation":"Count"}},{"columnMatch":"Count","formatter":0,"formatOptions":{"aggregation":"Sum"}}],"filter":true,"labelSettings":[{"columnId":"Computer"},{"columnId":"Failers","label":"Failures"},{"columnId":"Errors"},{"columnId":"Warnings"}]},"chartSettings":{"showLegend":true}},"customWidth":"50","name":"query - 13 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Operation\r\n| where tolower(_ResourceId) in ({VMfilter})\r\n| where Computer != \"\" and Computer startswith \"{ComputerName}\" or \"{ComputerName}\" == \"All\"\r\n| where Computer == \"{SelectedComputer}\" or \"{SelectedComputer}\" == \"All\"\r\n| summarize count() by OperationStatus, bin(TimeGenerated, {TimeRange:grain})","size":0,"title":"Operation status over time for computer: {SelectedComputer}","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart","gridSettings":{"formatters":[{"columnMatch":"Failers","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"Errors","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"Warnings","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"OperationStatus","formatter":0,"formatOptions":{"aggregation":"Count"}},{"columnMatch":"Count","formatter":0,"formatOptions":{"aggregation":"Sum"}}],"filter":true},"chartSettings":{"seriesLabelSettings":[{"seriesName":"Warning","color":"orange"},{"seriesName":"Error","color":"grayBlue"},{"seriesName":"Succeeded","color":"lightBlue"},{"seriesName":"Failed","label":"Failure","color":"magenta"},{"seriesName":"Success","label":"Succeeded","color":"lightBlue"},{"seriesName":"Failure","color":"magenta"}]}},"customWidth":"50","name":"query - 13 - Copy - Copy"},{"type":1,"content":{"json":"---\r\n\r\n## Computer and agent activity status \r\nBased on Log Analytics **Operation** table"},"name":"text - 15 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Operation\r\n| where tolower(_ResourceId) in ({VMfilter})\r\n| where Computer != \"\" and Computer startswith \"{ComputerName}\" or \"{ComputerName}\" == \"All\"\r\n| where Computer == \"{SelectedComputer}\" or \"{SelectedComputer}\" == \"All\"\r\n| project TimeGenerated, Computer, OperationStatus, OperationCategory, Detail, Solution\r\n| order by TimeGenerated","size":0,"showAnalytics":true,"title":"Operations full info over selected time: {TimeBrush:label}","timeContext":{"durationMs":604800000,"endTime":"2020-11-02T09:00:00.000Z"},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"OperationStatus","formatter":0,"formatOptions":{"aggregation":"Count"}},{"columnMatch":"Failers","formatter":8,"formatOptions":{"palette":"coldHot"}},{"columnMatch":"Errors","formatter":8,"formatOptions":{"palette":"coldHot"}},{"columnMatch":"Warnings","formatter":8,"formatOptions":{"palette":"coldHot"}},{"columnMatch":"Count","formatter":0,"formatOptions":{"aggregation":"Sum"}}],"filter":true,"labelSettings":[{"columnId":"TimeGenerated","label":"Time generated"},{"columnId":"Computer"},{"columnId":"OperationStatus","label":"Activity status"},{"columnId":"OperationCategory","label":"Activity category"},{"columnId":"Detail"},{"columnId":"Solution"}]},"chartSettings":{"showLegend":true}},"showPin":true,"name":"query - 13 - Copy - Copy"},{"type":1,"content":{"json":"---\r\n\r\n## Machine resources status"},"name":"text - 15"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Perf\r\n| where tolower(_ResourceId) in ({VMfilter})\r\n| where Computer != \"\" and Computer == \"{ComputerName}\" or \"{ComputerName}\" == \"All\"\r\n//| where TimeGenerated > ago(1h)\r\n| where ObjectName == \"Memory\" and\r\n(CounterName == \"Available MBytes Memory\" or // the name used in Linux records\r\nCounterName == \"Available MBytes\") // the name used in Windows records\r\n| project TimeGenerated, CounterName, CounterValue, Computer\r\n| make-series Trend = avg(CounterValue) default = 0 on TimeGenerated from ago(30d) to now() step 1d by Computer\r\n| project Computer, [\"Current Available Space MBytes\"] = todouble(Trend[-1]), Trend\r\n| order by [\"Current Available Space MBytes\"] asc\r\n","size":0,"title":"Available memory in MB","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Current Available Space MBytes","formatter":8,"formatOptions":{"palette":"turquoise"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":21,"formatOptions":{"min":0,"palette":"blue"}}],"sortBy":[{"itemKey":"$gen_heatmap_Current Available Space MBytes_1","sortOrder":1}],"labelSettings":[{"columnId":"Computer"},{"columnId":"Current Available Space MBytes","label":"Current available memory (MB)"},{"columnId":"Trend"}]},"sortBy":[{"itemKey":"$gen_heatmap_Current Available Space MBytes_1","sortOrder":1}]},"customWidth":"50","name":"query - 10"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Perf\r\n| where tolower(_ResourceId) in ({VMfilter})\r\n| where Computer != \"\" and Computer == \"{ComputerName}\" or \"{ComputerName}\" == \"All\"\r\n//| where TimeGenerated > ago(1h)\r\n| where ObjectName == \"LogicalDisk\" or // the object name used in Windows records\r\nObjectName == \"Logical Disk\" // the object name used in Linux records\r\n| where CounterName == \"Free Megabytes\"\r\n| project TimeGenerated, CounterName, CounterValue, Computer, InstanceName\r\n| make-series Trend = avg(CounterValue) default = 0 on TimeGenerated from ago(30d) to now() step 1d by Computer, InstanceName\r\n| project Computer, [\"Current Available Space MBytes\"] = todouble(Trend[-1]), Trend, InstanceName\r\n| order by [\"Current Available Space MBytes\"] asc\r\n","size":0,"title":"Available disk / filesystem space in MB","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Computer","formatter":5},{"columnMatch":"Current Available Space MBytes","formatter":8,"formatOptions":{"min":0,"palette":"green","aggregation":"Sum"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":21,"formatOptions":{"min":0,"palette":"blue","aggregation":"Sum"}}],"hierarchySettings":{"treeType":1,"groupBy":["Computer"]},"sortBy":[{"itemKey":"$gen_heatmap_Current Available Space MBytes_2","sortOrder":1}],"labelSettings":[{"columnId":"Computer"},{"columnId":"Current Available Space MBytes","label":"Current available disk space (MB)"},{"columnId":"Trend"},{"columnId":"InstanceName","label":"Disk / filesystem"}]},"sortBy":[{"itemKey":"$gen_heatmap_Current Available Space MBytes_2","sortOrder":1}]},"customWidth":"50","name":"query - 10 - Copy"}]},"conditionalVisibility":{"parameterName":"OnPrem","comparison":"isEqualTo","value":"No"},"name":"Azure VMs"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Workspace}"],"parameters":[{"id":"d2922a2e-e093-47eb-862f-50a647e3f30d","version":"KqlParameterItem/1.0","name":"TableName","label":"Table name filter","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"union withsource= _TableName *\r\n| where Computer != \"\"\r\n| summarize by [\"Table name\"] = _TableName","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"","showDefault":false},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"c6e118c5-f30b-4d06-a5a6-59645318df64","version":"KqlParameterItem/1.0","name":"VMfilter","label":"Machine name filter","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"union withsource= _TableName *\r\n| where _TableName in ({TableName})\r\n| where Computer != \"\"\r\n| summarize by value = Computer\r\n| extend label = value","crossComponentResources":["{Workspace}"],"value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"showDefault":false},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 11"},{"type":1,"content":{"json":"Select a location to filter the display below.","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 15"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat\r\n| where Computer in ({VMfilter})\r\n| summarize dcount(Computer) by RemoteIPCountry, Computer","size":0,"title":"Computers' location","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"regionName","exportParameterName":"regionName","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"map","mapSettings":{"locInfo":"CountryRegion","locInfoColumn":"RemoteIPCountry","sizeSettings":"dcount_Computer","sizeAggregation":"Sum","legendMetric":"dcount_Computer","legendAggregation":"Sum","itemColorSettings":{"nodeColorField":"dcount_Computer","colorAggregation":"Sum","type":"heatmap","heatmapPalette":"orangeBlue","heatmapMin":0}}},"customWidth":"50","name":"query - 7"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat\r\n| where Computer in ({VMfilter})\r\n| where RemoteIPCountry == \"{regionName}\" or \"{regionName}\" == \"All\"\r\n| summarize AggregatedValue = dcount(Computer) by [\"OS\"]=iff(isempty(OSName), OSType, OSName)","size":0,"title":"Computer OS","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"OS","formatter":1},"leftContent":{"columnMatch":"AggregatedValue","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"customWidth":"50","name":"query - 9"},{"type":1,"content":{"json":"## Computer heartbeat tracking: {TimeRange}"},"name":"text - 11"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Subscription}"],"parameters":[{"id":"e0fb3c9a-f42f-4dfb-a86c-f4dd36584904","version":"KqlParameterItem/1.0","name":"UnhealthyCriteria","label":"Unhealthy definition","type":2,"isRequired":true,"typeSettings":{"additionalResourceOptions":[]},"jsonData":"[\r\n    { \"value\":\"1m\", \"label\":\"1 minute without heartbeat\", \"selected\":false },\r\n    { \"value\":\"5m\", \"label\":\"5 minutes without heartbeat\", \"selected\":false },\r\n    { \"value\":\"30m\", \"label\":\"30 minutes without heartbeat\", \"selected\":false },\r\n    { \"value\":\"1h\", \"label\":\"1 hour without heartbeat\", \"selected\":true },\r\n    { \"value\":\"2h\", \"label\":\"2 hours without heartbeat\", \"selected\":false },\r\n    { \"value\":\"8h\", \"label\":\"8 hours without heartbeat\", \"selected\":false },\r\n    { \"value\":\"1d\", \"label\":\"1 day without heartbeat\", \"selected\":false },\r\n    { \"value\":\"2d\", \"label\":\"2 days without heartbeat\", \"selected\":false },\r\n    { \"value\":\"7d\", \"label\":\"7 days without heartbeat\", \"selected\":false }\r\n]","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","value":"30m"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 13"},{"type":1,"content":{"json":"Select a computer from the table to measure the heartbeat and latency of a specific computer. The latency is measured by comparing the result of the **ingestion_time()** function to the value of the **TimeGenerated** property.","style":"info"},"name":"text - 15 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat\r\n| where Computer in ({VMfilter})\r\n| where TimeGenerated {TimeRange:query}\r\n| where RemoteIPCountry == \"{regionName}\" or \"{regionName}\" == \"All\"\r\n| summarize LastHeartbeat = max(TimeGenerated) by Computer\r\n| extend State = iff(LastHeartbeat < ago({UnhealthyCriteria}), 'Unhealthy', 'Healthy')\r\n| extend TimeFromNow = now() - LastHeartbeat\r\n| extend [\"TimeAgo\"] = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| join (\r\nHeartbeat\r\n| where TimeGenerated {TimeRange:query}\r\n| extend Packed = pack_all()\r\n) on Computer\r\n| where TimeGenerated == LastHeartbeat\r\n| join (\r\nHeartbeat\r\n| where TimeGenerated {TimeRange:query}\r\n| make-series InternalTrend=iff(count() > 0, 1, 0) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {UnhealthyCriteria} by Computer\r\n| extend Trend=array_slice(InternalTrend, array_length(InternalTrend) - 30, array_length(InternalTrend)-1)\r\n| extend (s_min, s_minId, s_max, s_maxId, s_avg, s_var, s_stdev) = series_stats(Trend)\r\n| project Computer, Trend, s_avg\r\n) on Computer\r\n| order by State, s_avg asc, TimeAgo\r\n| project [\"_ComputerName_\"] = Computer, [\"Computer\"]=strcat('🖥️ ', Computer), State, [\"Environment\"] = iff(ComputerEnvironment == \"Azure\", ComputerEnvironment, Category), [\"OS\"]=iff(isempty(OSName), OSType, OSName), [\"Azure Resource\"]=ResourceId, [\"Time\"]=strcat('🕒 ', TimeAgo), [\"Heartbeat Trend\"]=Trend, [\"Details\"]=Packed, [\"Computer Region\"] = RemoteIPCountry","size":0,"showAnalytics":true,"title":"{TimeRange:label}: all agent heartbeat data ","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"_ComputerName_","exportParameterName":"ComputerName","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"_ComputerName_","formatter":5},{"columnMatch":"Computer","formatter":0,"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"State","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Healthy","representation":"Available","text":"{0}{1}"},{"operator":"==","thresholdValue":"Unhealthy","representation":"warning","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":null,"text":"{0}{1}"}]}},{"columnMatch":"Environment","formatter":18,"formatOptions":{"thresholdsOptions":"colors","thresholdsGrid":[{"operator":"==","thresholdValue":"Azure","text":"{0}{1}"},{"operator":"==","thresholdValue":"Direct Agent","representation":"magenta","text":"{0}{1}"},{"operator":"==","thresholdValue":"SCOM Agent","representation":"purple","text":"{0}{1}"},{"operator":"==","thresholdValue":"SCOM Management Server","representation":"gray","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"blue","text":"{0}{1}"}]},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"Heartbeat Trend","formatter":10,"formatOptions":{"palette":"redGreen"}},{"columnMatch":"Details","formatter":5}],"filter":true,"sortBy":[{"itemKey":"$gen_thresholds_State_2","sortOrder":2}],"labelSettings":[{"columnId":"_ComputerName_"},{"columnId":"Computer"},{"columnId":"State","label":"Health status"},{"columnId":"Environment"},{"columnId":"OS"},{"columnId":"Azure Resource","label":"Azure resource"},{"columnId":"Time","label":"Time of last heartbeat"},{"columnId":"Heartbeat Trend","label":"Heartbeat history"},{"columnId":"Details"},{"columnId":"Computer Region","label":"Computer region"}]},"sortBy":[{"itemKey":"$gen_thresholds_State_2","sortOrder":2}]},"showPin":true,"name":"query - 16"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat  \r\n| where Computer startswith \"{ComputerName}\"\r\n| summarize ['Heartbeats per hour'] = count() by bin(TimeGenerated,1h) ","size":0,"title":"Heartbeats per hour: {ComputerName}","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"categoricalbar","chartSettings":{"showLegend":true}},"customWidth":"50","conditionalVisibility":{"parameterName":"ComputerName","comparison":"isNotEqualTo","value":"All"},"name":"query - 13"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat  \r\n| where Computer startswith \"{ComputerName}\"\r\n| extend E2EIngestionLatency = todouble(datetime_diff(\"Second\",ingestion_time(),TimeGenerated))/60 \r\n| extend AgentLatency        = todouble(datetime_diff(\"Second\",_TimeReceived,TimeGenerated))/60 \r\n| summarize avg(E2EIngestionLatency),avg(AgentLatency) by bin(TimeGenerated,1h) \r\n| project TimeGenerated, ['End-to-end latency'] = avg_E2EIngestionLatency, ['Agent Latency'] = avg_AgentLatency\r\n","size":0,"title":"Average heartbeat latency: {ComputerName}","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"timechart","gridSettings":{"formatters":[{"columnMatch":"avgE2E","formatter":0,"formatOptions":{"showIcon":true},"numberFormat":{"unit":0,"options":{"style":"decimal"}}}]},"tileSettings":{"showBorder":false},"chartSettings":{"showLegend":true,"ySettings":{"unit":24,"min":null,"max":null}}},"customWidth":"50","conditionalVisibility":{"parameterName":"ComputerName","comparison":"isNotEqualTo","value":"All"},"name":"query - 14"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Operation\r\n| where Computer in ({VMfilter})\r\n| where Computer != \"\" and Computer == \"{ComputerName}\" or \"{ComputerName}\" == \"All\"\r\n| summarize Failers = countif(OperationStatus == \"Failed\" or OperationStatus == \"Failure\"), Errors = countif(OperationStatus == \"Error\"), Warnings = countif(OperationStatus == \"Warning\") by Computer\r\n| order by Failers, Errors, Warnings","size":0,"title":"Operation status","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Computer","exportParameterName":"SelectedComputer","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Failers","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"Errors","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"Warnings","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"OperationStatus","formatter":0,"formatOptions":{"aggregation":"Count"}},{"columnMatch":"Count","formatter":0,"formatOptions":{"aggregation":"Sum"}}],"filter":true,"labelSettings":[{"columnId":"Computer"},{"columnId":"Failers","label":"Failures"},{"columnId":"Errors"},{"columnId":"Warnings"}]},"chartSettings":{"showLegend":true}},"customWidth":"50","name":"query - 13 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Operation\r\n| where Computer in ({VMfilter})\r\n| where Computer != \"\" and Computer startswith \"{ComputerName}\" or \"{ComputerName}\" == \"All\"\r\n| where Computer == \"{SelectedComputer}\" or \"{SelectedComputer}\" == \"All\"\r\n| summarize count() by OperationStatus, bin(TimeGenerated, {TimeRange:grain})","size":0,"title":"Operation status over time for computer: {SelectedComputer}","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart","gridSettings":{"formatters":[{"columnMatch":"Failers","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"Errors","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"Warnings","formatter":8,"formatOptions":{"palette":"purple"}},{"columnMatch":"OperationStatus","formatter":0,"formatOptions":{"aggregation":"Count"}},{"columnMatch":"Count","formatter":0,"formatOptions":{"aggregation":"Sum"}}],"filter":true},"chartSettings":{"seriesLabelSettings":[{"seriesName":"Warning","color":"orange"},{"seriesName":"Error","color":"grayBlue"},{"seriesName":"Succeeded","color":"lightBlue"},{"seriesName":"Failed","label":"Failure","color":"magenta"},{"seriesName":"Success","label":"Succeeded","color":"lightBlue"},{"seriesName":"Failure","color":"magenta"}]}},"customWidth":"50","name":"query - 13 - Copy - Copy"},{"type":1,"content":{"json":"---\r\n\r\n## Computer and agent activity status \r\nBased on Log Analytics **Operation** table"},"name":"text - 15 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Operation\r\n| where Computer in ({VMfilter})\r\n| where Computer != \"\" and Computer startswith \"{ComputerName}\" or \"{ComputerName}\" == \"All\"\r\n| where Computer == \"{SelectedComputer}\" or \"{SelectedComputer}\" == \"All\"\r\n| project TimeGenerated, Computer, OperationStatus, OperationCategory, Detail, Solution\r\n| order by TimeGenerated","size":0,"showAnalytics":true,"title":"Operations full info over selected time: {TimeBrush:label}","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"OperationStatus","formatter":0,"formatOptions":{"aggregation":"Count"}},{"columnMatch":"Failers","formatter":8,"formatOptions":{"palette":"coldHot"}},{"columnMatch":"Errors","formatter":8,"formatOptions":{"palette":"coldHot"}},{"columnMatch":"Warnings","formatter":8,"formatOptions":{"palette":"coldHot"}},{"columnMatch":"Count","formatter":0,"formatOptions":{"aggregation":"Sum"}}],"filter":true,"labelSettings":[{"columnId":"TimeGenerated","label":"Time generated"},{"columnId":"Computer"},{"columnId":"OperationStatus","label":"Activity status"},{"columnId":"OperationCategory","label":"Activity category"},{"columnId":"Detail"},{"columnId":"Solution"}]},"chartSettings":{"showLegend":true}},"showPin":true,"name":"query - 13 - Copy - Copy"},{"type":1,"content":{"json":"---\r\n\r\n## Machine resources status"},"name":"text - 15"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Perf\r\n| where Computer in ({VMfilter})\r\n| where Computer != \"\" and Computer == \"{ComputerName}\" or \"{ComputerName}\" == \"All\"\r\n//| where TimeGenerated > ago(1h)\r\n| where ObjectName == \"Memory\" and\r\n(CounterName == \"Available MBytes Memory\" or // the name used in Linux records\r\nCounterName == \"Available MBytes\") // the name used in Windows records\r\n| project TimeGenerated, CounterName, CounterValue, Computer\r\n| make-series Trend = avg(CounterValue) default = 0 on TimeGenerated from ago(30d) to now() step 1d by Computer\r\n| project Computer, [\"Current Available Space MBytes\"] = todouble(Trend[-1]), Trend\r\n| order by [\"Current Available Space MBytes\"] asc\r\n","size":0,"title":"Available memory in MB","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Current Available Space MBytes","formatter":8,"formatOptions":{"palette":"turquoise"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":21,"formatOptions":{"min":0,"palette":"blue"}}],"sortBy":[{"itemKey":"$gen_heatmap_Current Available Space MBytes_1","sortOrder":1}],"labelSettings":[{"columnId":"Computer"},{"columnId":"Current Available Space MBytes","label":"Current available memory (MB)"},{"columnId":"Trend"}]},"sortBy":[{"itemKey":"$gen_heatmap_Current Available Space MBytes_1","sortOrder":1}]},"customWidth":"50","name":"query - 10"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Perf\r\n| where Computer in ({VMfilter})\r\n| where Computer != \"\" and Computer == \"{ComputerName}\" or \"{ComputerName}\" == \"All\"\r\n//| where TimeGenerated > ago(1h)\r\n| where ObjectName == \"LogicalDisk\" or // the object name used in Windows records\r\nObjectName == \"Logical Disk\" // the object name used in Linux records\r\n| where CounterName == \"Free Megabytes\"\r\n| project TimeGenerated, CounterName, CounterValue, Computer, InstanceName\r\n| make-series Trend = avg(CounterValue) default = 0 on TimeGenerated from ago(30d) to now() step 1d by Computer, InstanceName\r\n| project Computer, [\"Current Available Space MBytes\"] = todouble(Trend[-1]), Trend, InstanceName\r\n| order by [\"Current Available Space MBytes\"] asc\r\n","size":0,"title":"Available disk / filesystem space in MB","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Computer","formatter":5},{"columnMatch":"Current Available Space MBytes","formatter":8,"formatOptions":{"min":0,"palette":"green","aggregation":"Sum"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":2}}},{"columnMatch":"Trend","formatter":21,"formatOptions":{"min":0,"palette":"blue","aggregation":"Sum"}}],"hierarchySettings":{"treeType":1,"groupBy":["Computer"]},"sortBy":[{"itemKey":"$gen_heatmap_Current Available Space MBytes_2","sortOrder":1}],"labelSettings":[{"columnId":"Computer"},{"columnId":"Current Available Space MBytes","label":"Current available disk space (MB)"},{"columnId":"Trend"},{"columnId":"InstanceName","label":"Disk / filesystem"}]},"sortBy":[{"itemKey":"$gen_heatmap_Current Available Space MBytes_2","sortOrder":1}]},"customWidth":"50","name":"query - 10 - Copy"}]},"conditionalVisibility":{"parameterName":"OnPrem","comparison":"isEqualTo","value":"Yes"},"name":"All machins"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"agents"},"name":"Agents info"}],"fromTemplateId":"Data-collection-health-monitoring","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FDataCollectionHealth.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## EventAnalyzer
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/EventAnalyzer.json)

### Workbook details

> Description: This workbook will get a report on a specific event.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Event Analyzer\n---\n\nEvent Analyzer is a visualizing workbook to explore and audit Windows Event Log and explore all events details and attributes for viewing, analyzing and monitoring events recorded in Microsoft Windows event logs. The analyzer speeds up the analysis of event logs (security, application, system, setup, directory service, DNS and others)."},"name":"text - 2"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["value::all"],"parameters":[{"id":"6bdfb4ab-a58b-4035-bfca-4b4bdb67aa60","version":"KqlParameterItem/1.0","name":"DefaultWorkspace","type":5,"isRequired":true,"value":"/subscriptions/<subs_ID>/resourcegroups/<rg_name>/providers/microsoft.operationalinsights/workspaces/<workspace_name>","isHiddenWhenLocked":true,"typeSettings":{"resourceTypeFilter":{"microsoft.operationalinsights/workspaces":true},"additionalResourceOptions":[]},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","resourceType":"microsoft.insights/components"},{"id":"66c96524-06de-4fb2-be22-3314ff7f96b0","version":"KqlParameterItem/1.0","name":"ContextFree","type":1,"query":"{\"version\":\"1.0.0\",\"content\":\"\\\"{DefaultWorkspace}\\\"\",\"transformers\":null}","isHiddenWhenLocked":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":8},{"id":"9ecea5c4-8730-4503-a052-95a2418ddd70","version":"KqlParameterItem/1.0","name":"Selection","type":1,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| extend match = strcat(\"'\", id, \"'\") =~ \"{DefaultWorkspace:value}\"\r\n| order by match desc, name asc\r\n| take 1\r\n| project value = tostring(pack('sub', subscriptionId, 'rg', resourceGroup, 'ws', id))","crossComponentResources":["value::all"],"isHiddenWhenLocked":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":1,"resourceType":"microsoft.resourcegraph/resources"}],"style":"above","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"conditionalVisibility":{"parameterName":"_","comparison":"isEqualTo","value":"_"},"name":"parameters - 3"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Subscriptions}"],"parameters":[{"id":"401c9381-d3bc-4594-be03-c322c0c6a135","version":"KqlParameterItem/1.0","name":"Subscriptions","type":6,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"summarize by subscriptionId\r\n| project value = strcat('/subscriptions/', subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ todynamic('{Selection}').sub, true, false)","crossComponentResources":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"]},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"8f5a2b0e-71bf-49f4-b570-c3d84c7cc7f6","version":"KqlParameterItem/1.0","name":"Workspaces","type":7,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| summarize by id, name\r\n| project id, selected = iff(id =~ todynamic('{Selection}').ws, true, false)","crossComponentResources":["{Subscriptions}"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"bcb5eb6b-b6a8-47c4-95a2-87753cb10ea8","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"value":{"durationMs":86400000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}]},"resourceType":"microsoft.insights/components"},{"id":"1c1b8f51-b434-468a-b256-29826c15d9e1","version":"KqlParameterItem/1.0","name":"TestConnectivity","type":1,"query":"InsightsMetrics\r\n| where TimeGenerated {TimeRange}\r\n| take 1","isHiddenWhenLocked":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"above","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 2"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit File Share","subTarget":"1","preText":"","style":"link"},{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit File System","subTarget":"2","style":"link"},{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit Filtering Platform Connection","subTarget":"3","style":"link"},{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit Handle Manipulation","subTarget":"4","style":"link"},{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit Kernel Object","subTarget":"5","style":"link"},{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit Other Object Access Events","subTarget":"6","style":"link"},{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit Registry","subTarget":"7","style":"link"},{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit Removable Storage","subTarget":"8","style":"link"},{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit SAM","subTarget":"9","style":"link"},{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit Policy Change","subTarget":"10","style":"link"},{"cellValue":"Tab","linkTarget":"parameter","linkLabel":"Audit Sensitive Privilege Use","subTarget":"11","style":"link"}]},"name":"links - 4"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","loadType":"always","items":[{"type":1,"content":{"json":"Events:\r\n- A network share object was accessed\r\n- A network share object was added\r\n- A network share object was modified\r\n- A network share object was deleted\r\n- SPN check for SMB/SMB2 failed"},"name":"text - 1","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (5140, 5142, 5143, 5144, 5168)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":1,"showAnnotations":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Account","formatter":1},"leftContent":{"columnMatch":"Task","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"graphSettings":{"type":0,"topContent":{"columnMatch":"Account","formatter":1},"centerContent":{"columnMatch":"Task","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{"xAxis":"TimeGenerated","yAxis":["EventID"],"showLegend":true,"xSettings":{},"ySettings":{}}},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (5140, 5142, 5143, 5144, 5168)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":0,"timeContext":{"durationMs":86400000},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"filter":true}},"showPin":false,"name":"query - 0"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"1"},"name":"AuditFileShare"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","loadType":"always","items":[{"type":1,"content":{"json":"Events:  \r\n- A handle to an object was requested \r\n- The handle to an object was closed \r\n- An object was deleted- An attempt was made to access an object\r\n- An attempt was made to create a hard link- The state of a transaction has changed \r\n- A file was virtualized\r\n- Permissions on an object were changed"},"name":"text - 1","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4656, 4658, 4660, 4663, 4664, 4985, 5051, 4670)\r\n| project TimeGenerated, Account , AccountType , Computer , EventSourceName , Channel , Task , EventData , EventID , Activity ","size":1,"showAnnotations":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart","chartSettings":{"showLegend":true,"xSettings":{},"ySettings":{}}},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4656, 4658, 4660, 4663, 4664, 4985, 5051, 4670)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":0,"timeContext":{"durationMs":86400000},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"name":"query - 0"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"2"},"name":"AuditFileSystem","styleSettings":{"showBorder":true}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","loadType":"always","items":[{"type":1,"content":{"json":"Events:\r\n - The handle to an object was closed\r\n - An attempt was made to duplicate a handle to an object"},"name":"text - 0","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4658, 4690)\r\n| project TimeGenerated, Account , AccountType , Computer , EventSourceName , Channel , Task , EventData , EventID , Activity ","size":1,"showAnnotations":true,"timeContext":{"durationMs":2592000000},"timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4658, 4690)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"4"},"name":"AuditHandleManipulation","styleSettings":{"showBorder":true}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","loadType":"always","items":[{"type":1,"content":{"json":"Events:\r\n- The Windows Firewall Service blocked an application from accepting incoming connections on the network\r\n- The Windows Filtering Platform blocked a packet\r\n- A more restrictive Windows Filtering Platform filter has blocked a packet\r\n- The Windows Filtering Platform has permitted an application or service to listen on a port for incoming connections\r\n- The Windows Filtering Platform has blocked an application or service from listening on a port for incoming connections\r\n- The Windows Filtering Platform has permitted a connection\r\n- The Windows Filtering Platform has blocked a connection\r\n- The Windows Filtering Platform has permitted a bind to a local port\r\n- The Windows Filtering Platform has blocked a bind to a local port"},"name":"text - 0","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (5031, 5150, 5151, 5154, 5155, 5156, 5157, 5158, 5159)\r\n| project TimeGenerated, Account , AccountType , Computer , EventSourceName , Channel , Task , EventData , EventID , Activity","size":1,"showAnnotations":true,"timeContext":{"durationMs":2592000000},"timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (5031, 5150, 5151, 5154, 5155, 5156, 5157, 5158, 5159)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"3"},"name":"AuditFilterPlatformConnection","styleSettings":{"showBorder":true}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","loadType":"always","items":[{"type":1,"content":{"json":"Events:\r\n- A handle to an object was requested\r\n- The handle to an object was closed\r\n- An object was deleted\r\n- An attempt was made to access an object"},"name":"text - 0","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4656, 4658, 4660, 4663)\r\n| project TimeGenerated, Account , AccountType , Computer , EventSourceName , Channel , Task , EventData , EventID , Activity ","size":1,"showAnnotations":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4656, 4658, 4660, 4663)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"5"},"name":"AuditKernelObject","styleSettings":{"showBorder":true}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","loadType":"always","items":[{"type":1,"content":{"json":"Events:\r\n-  An application attempted to access a blocked ordinal through the TBS\r\n- Indirect access to an object was requested\r\n- The Windows Filtering Platform has detected a DoS attack and entered a defensive mode; packets associated with this attack will be discarded\r\n- The DoS attack has subsided and normal processing is being resumed\r\n- A scheduled task was created\r\n- A scheduled task was deleted\r\n- A scheduled task was enabled\r\n- A scheduled task was disabled\r\n- A scheduled task was updated\r\n- An object in the COM+ Catalog was modified\r\n- An object was deleted from the COM+ Catalog\r\n- An object was added to the COM+ Catalog"},"name":"text - 0","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4671, 4691, 5148, 5149, 4698, 4699, 4700, 4701, 4702, 5888, 5889, 5890)\r\n| project TimeGenerated, Account , AccountType , Computer , EventSourceName , Channel , Task , EventData , EventID , Activity \r\n| top 1000 by TimeGenerated desc","size":1,"showAnnotations":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TImeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Account","formatter":1},"leftContent":{"columnMatch":"EventID","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4671, 4691, 5148, 5149, 4698, 4699, 4700, 4701, 4702, 5888, 5889, 5890)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TImeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"6"},"name":"AuditOtherObject","styleSettings":{"showBorder":true}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"Events:\r\n- An attempt was made to access an object\r\n- A handle to an object was requested\r\n- The handle to an object was closed\r\n- An object was deleted\r\n- A registry value was modified\r\n- A registry key was virtualized\r\n- Permissions on an object were changed"},"name":"text - 0","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4663, 4656, 4658, 4660, 4657, 5039, 4670)\r\n| project TimeGenerated, Account , AccountType , Computer , EventSourceName , Channel , Task , EventData , EventID , Activity \r\n| top 1000 by TimeGenerated desc","size":1,"showAnnotations":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4663, 4656, 4658, 4660, 4657, 5039, 4670)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"7"},"name":"AuditRegistry","styleSettings":{"showBorder":true}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","loadType":"always","items":[{"type":1,"content":{"json":"Events:\r\n- A handle to an object was requested\r\n- The handle to an object was closed\r\n- An attempt was made to access an object"},"name":"text - 0","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4656, 4658, 4663)\r\n| project TimeGenerated, Account , AccountType , Computer , EventSourceName , Channel , Task , EventData , EventID , Activity \r\n| top 1000 by TimeGenerated desc","size":4,"showAnnotations":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4656, 4658, 4663)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"8"},"name":"AuditRemovable","styleSettings":{"showBorder":true}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","loadType":"always","items":[{"type":1,"content":{"json":"Events:\r\n- A handle to an object was requested"},"name":"text - 0","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID == 4661\r\n| project TimeGenerated, Account , AccountType , Computer , EventSourceName , Channel , Task , EventData , EventID , Activity ","size":1,"showAnnotations":true,"timeContext":{"durationMs":2592000000},"timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID == 4661\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"9"},"name":"AuditSAM","styleSettings":{"showBorder":true}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","loadType":"always","items":[{"type":1,"content":{"json":"Events:\r\n- The audit policy (SACL) on an object was changed\r\n- System audit policy was changed\r\n- Auditing settings on object were changed\r\n- The Per-user audit policy table was created\r\n- The CrashOnAuditFail value has changed\r\n- Auditing settings on object were changed\r\n- Special Groups Logon table modified\r\n- Per User Audit Policy was changed\r\n- An attempt was made to register a security event source\r\n- An attempt was made to unregister a security event source"},"name":"text - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4715, 4719, 4817, 4902, 4906, 4907, 4908, 4912, 4904, 4905)\r\n| project TimeGenerated, Account , AccountType , Computer , EventSourceName , Channel , Task , EventData , EventID , Activity \r\n| top 1000 by TimeGenerated desc","size":1,"showAnnotations":true,"timeContext":{"durationMs":2592000000},"timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4715, 4719, 4817, 4902, 4906, 4907, 4908, 4912, 4904, 4905)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"10"},"name":"AuditPolicyChange","styleSettings":{"showBorder":true}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","loadType":"always","items":[{"type":1,"content":{"json":"Events:\r\n- A privileged service was called\r\n- An operation was attempted on a privileged object\r\n-  The state of a transaction has changed"},"name":"text - 0","styleSettings":{"showBorder":true}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4673, 4674, 4985)\r\n| project TimeGenerated, Account , Computer , EventData , EventID , Activity ","size":1,"showAnnotations":true,"timeContext":{"durationMs":2592000000},"timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID in (4673, 4674, 4985)\r\n| project Account , Computer , EventData , EventID , Activity ","size":1,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"11"},"name":"AuditSensitive","styleSettings":{"showBorder":true}}],"styleSettings":{"progressStyle":"loader"},"fromTemplateId":"sentinel-EventAnalyzerWorkbook","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FEventAnalyzer.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## ExchangeOnline
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/ExchangeOnline.json)

### Workbook details

> Description: This workbook will get a report on Exchange Online.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","query":"","crossComponentResources":[],"parameters":[{"id":"fd258da3-1556-41fc-b428-17122a3c8662","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"isRequired":true,"value":{"durationMs":7776000000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}],"allowCustom":true}},{"id":"69330e1e-2163-4a9c-aaba-4709b3dd8fd4","version":"KqlParameterItem/1.0","name":"Operations","label":"Activities","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"OfficeActivity\r\n| where OfficeWorkload == 'Exchange' \r\n| summarize Count = count() by Operation\r\n| order by Count desc, Operation asc\r\n| project Value = Operation, Label = strcat(Operation, ' - ', Count)","value":null,"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 1"},{"type":1,"content":{"json":"## Overview "},"name":"text - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity\r\n| where OfficeWorkload == 'Exchange'\r\n//| extend OperationType = case( Operation contains \r\n| where \"{Operations:lable}\" == \"All\" or \"{Operations:lable}\" == \"All\" or Operation in ({Operations})\r\n| summarize count() by Operation, bin(TimeGenerated, 1d)","size":0,"exportToExcelOptions":"visible","title":"Activities, by time","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"barchart"},"customWidth":"70","name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where OfficeWorkload == 'Exchange' \r\n| where \"{Operations:lable}\" == \"All\" or Operation in ({Operations})\r\n| summarize count() by UserType \r\n//| order by count_","size":0,"exportToExcelOptions":"visible","title":"User type activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"30","name":"query - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = OfficeActivity\r\n| where OfficeWorkload == 'Exchange' \r\n| where \"{Operations:lable}\" == \"All\" or Operation in ({Operations});\r\nlet appData = data\r\n| summarize TotalCount = count() by UserId\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on bin(TimeGenerated, 1d) in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by UserId\r\n    | project-away TimeGenerated) on UserId\r\n| order by TotalCount desc, UserId asc\r\n| project UserId, TotalCount, Trend\r\n| serialize Id = row_number();\r\ndata\r\n| summarize TotalCount = count() by Operation , UserId\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on bin(TimeGenerated, 1d) in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by UserId, Operation\r\n    | project-away TimeGenerated) on UserId, Operation\r\n| order by TotalCount desc, UserId asc\r\n| project UserId, Operation, TotalCount, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on UserId\r\n| project Id, Name = Operation, Type = 'Operation', ['Operation Count'] = TotalCount, Trend, ParentId = Id1\r\n| union (appData \r\n    | project Id, Name = UserId, Type = 'UserId', ['Operation Count'] = TotalCount, Trend )\r\n| order by ['Operation Count'] desc, Name asc","size":0,"exportParameterName":"OperationInfo","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\"}","exportToExcelOptions":"visible","title":"User activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Type","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Operation Count","formatter":3,"formatOptions":{"palette":"lightBlue","showIcon":true}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue","showIcon":true}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name"},"labelSettings":[]}},"customWidth":"70","name":"query - 4"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where OfficeWorkload == 'Exchange' and UserType == 'Admin' \r\n| where \"{Operations:lable}\" == \"All\" or Operation in ({Operations})\r\n| summarize count() by Operation ","size":0,"exportToExcelOptions":"visible","title":"Admin activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"30","name":"query - 15"},{"type":1,"content":{"json":"---\r\n## Suspicious activities\r\n\r\n## External access activities"},"name":"text - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Exchange activities that are performed by actors outside your organization - external\r\nlet OI = dynamic({OperationInfo});\r\nOfficeActivity\r\n| where (OI.Type==\"*\" or (OI.Type == 'UserId' and OI.Name == UserId) or (OI.Type == 'Operation' and OI.Name == Operation))\r\n| where OfficeWorkload == 'Exchange'\r\n| where \"{Operations:lable}\" == \"All\" or Operation in ({Operations})\r\n| where ExternalAccess == 'True' \r\n| summarize count() by Operation\r\n | sort by count_","size":2,"exportToExcelOptions":"visible","title":"External access activities, by activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"40","name":"query - 6"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Exchange activities that are performed by actors outside your organization - external\r\nlet OI = dynamic({OperationInfo});\r\nOfficeActivity\r\n| where OfficeWorkload == 'Exchange'\r\n| where (OI.Type==\"*\" or (OI.Type == 'UserId' and OI.Name == UserId) or (OI.Type == 'Operation' and OI.Name == Operation))\r\n| where \"{Operations:lable}\" == \"All\" or Operation in ({Operations})\r\n| where ExternalAccess == 'True' \r\n| summarize Amount = count() by Operation, UserId, UserType, bin(TimeGenerated, 1h)\r\n| project Amount, Activity = Operation, UserId, UserType, TimeGenerated\r\n| order by Amount desc","size":0,"exportToExcelOptions":"visible","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Amount","formatter":8,"formatOptions":{"palette":"magenta","showIcon":true,"aggregation":"Sum"}},{"columnMatch":"Activity","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"UserId","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"UserType","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}},{"columnMatch":"TimeGenerated","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"$gen_group","formatter":0,"formatOptions":{"showIcon":true}}],"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["Activity","UserId"]},"labelSettings":[]}},"customWidth":"60","name":"query - 7"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Hard delete operations over time\r\nOfficeActivity\r\n| where OfficeWorkload == 'Exchange' and Operation contains 'HardDelete'\r\n| summarize count() by bin_at(TimeGenerated, 1d, now()), UserId","size":0,"exportToExcelOptions":"visible","title":"Hard delete activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"barchart"},"name":"query - 8"},{"type":1,"content":{"json":"---\r\n# Mailbox activities"},"name":"text - 9"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let OperationsData = OfficeActivity\r\n| where Operation in (\"Set-Mailbox\", \"Log-on\", 'Add-MailboxPermission', 'UpdateFolderPermissions', 'Remove-MailboxPermission')\r\n| extend Category = case( Operation == \"Set-Mailbox\", \"Mailbox creation\",\r\n                                Operation == \"Log-on\", \"Log-in\",\r\n                                Operation == \"Add-MailboxPermission\" or Operation == \"UpdateFolderPermissions\" or Operation == \"Remove-MailboxPermission\", \"Permission activities\",\r\n                                \"\");\r\nOperationsData\r\n| summarize Count = count() by Category\r\n| join kind = inner (OperationsData\r\n | make-series Trend = count() default = 0 on bin(TimeGenerated, 1d) from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Category)\r\n on Category\r\n | project-away Category1, TimeGenerated\r\n| extend Categorys = Category\r\n| union (\r\n OperationsData\r\n | summarize Count = count() \r\n | extend jkey = 1\r\n | join kind=inner (OperationsData\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n | extend jkey = 1) on jkey\r\n | extend Category = 'All', Categorys = '*' \r\n)\r\n| order by Count desc\r\n| take 10","size":4,"exportToExcelOptions":"visible","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Category","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"secondaryContent":{"columnMatch":"Trend","formatter":9,"formatOptions":{"palette":"gray","showIcon":true}},"showBorder":false}},"name":"query - 15"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Mailbox Logins by hour\r\nOfficeActivity\r\n| where OfficeWorkload == 'Exchange' and Operation == 'MailboxLogin'\r\n| summarize Logins = count() by bin_at(TimeGenerated, 1h, now())\r\n","size":0,"exportToExcelOptions":"visible","title":"Mailbox logins, by hour","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"customWidth":"70","name":"query - 10"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//The type of mailbox access. (type of user who accessed the mailbox) \r\nOfficeActivity \r\n| where OfficeWorkload == 'Exchange' and Operation == 'MailboxLogin' \r\n| summarize count() by Logon_Type","size":0,"exportToExcelOptions":"visible","title":"Mailbox logins, by user type","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"30","name":"query - 11"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where OfficeWorkload == 'Exchange' and Operation == 'Set-Mailbox' \r\n| project TimeGenerated , UserId , UserType  \r\n","size":0,"exportToExcelOptions":"visible","title":"New mailboxes created","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true,"labelSettings":[]}},"customWidth":"70","name":"query - 12"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Mailbox permissions changes\r\nOfficeActivity\r\n| where OfficeWorkload == 'Exchange' and Operation in ('Add-MailboxPermission', 'UpdateFolderPermissions', 'Remove-MailboxPermission')\r\n| summarize count() by Operation\r\n| sort by count_","size":0,"exportToExcelOptions":"visible","title":"Mailbox permissions changes","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"30","name":"query - 13"}],"styleSettings":{},"fromTemplateId":"sentinel-ExchangeOnline","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FExchangeOnline.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## IdentityAccess
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/IdentityAccess.json)

### Workbook details

> Description: This workbook will get a report on Identity Access.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":""},"name":"text - 1"},{"type":9,"content":{"version":"KqlParameterItem/1.0","query":"","crossComponentResources":[],"parameters":[{"id":"80e332f7-8176-461f-b27a-0a52242fe6c9","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"isRequired":true,"value":{"durationMs":86400000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}],"allowCustom":true}},{"id":"5a93ede8-361d-4cc6-93f8-967dfc355143","version":"KqlParameterItem/1.0","name":"Activity","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityEvent\r\n| summarize Count = count() by Activity\r\n| order by Count desc, Activity asc\r\n| project Value = Activity, Label = strcat(Activity, ' - ', Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SecurityEvent\r\n| where \"{Activity:lable}\" == \"All\" or Activity in ({Activity});\r\ndata\r\n| summarize Count = count() by Activity\r\n| join kind = fullouter (datatable(Activity:string)['Medium', 'high', 'low']) on Activity\r\n| project Activity = iff(Activity == '', Activity1, Activity), Count = iff(Activity == '', 0, Count)\r\n| join kind = inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Activity)\r\n on Activity\r\n| project-away Activity1, TimeGenerated\r\n| extend Activitys = Activity\r\n| union (\r\n data \r\n | summarize Count = count() \r\n | extend jkey = 1\r\n | join kind=inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n | extend jkey = 1) on jkey\r\n | extend Activity = 'All', Activitys = '*' \r\n)\r\n| order by Count desc\r\n| take 10","size":4,"exportFieldName":"Activity","exportParameterName":"ActivityPiker","exportDefaultValue":"All","exportToExcelOptions":"visible","title":"Top 10 activities - click to filter by activity","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Activity","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"secondaryContent":{"columnMatch":"Trend","formatter":9,"formatOptions":{"palette":"lightBlue","showIcon":true}},"showBorder":false}},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SecurityEvent\r\n| where \"{Activity:lable}\" == \"All\" or Activity in ({Activity})\r\n| where Activity == '{ActivityPiker}' or '{ActivityPiker}' == \"All\" and AccountType == 'User'\r\n| extend Name = extract(@'^(.*\\\\)?([^@]*)(@.*)?$', 2, tolower(Account));\r\nlet appData = data\r\n| summarize TotalCount = count() by Name\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Name\r\n    | project-away TimeGenerated) on Name\r\n| order by TotalCount desc, Name asc\r\n| project Name, TotalCount, Trend\r\n| serialize Id = row_number();\r\ndata\r\n| summarize TotalCount = count() by Activity , Name\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Name, Activity\r\n    | project-away TimeGenerated) on Name, Activity\r\n| order by TotalCount desc, Name asc\r\n| project Name, Activity, TotalCount, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on Name\r\n| project Id, Name = Activity, Type = 'Activity', ['Activity Count'] = TotalCount, Trend, ParentId = Id1\r\n| union (appData \r\n    | project Id, Name = Name, Type = 'Computer', ['Activity Count'] = TotalCount, Trend )\r\n| order by ['Activity Count'] desc, Name asc","size":0,"exportParameterName":"Userinfo","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\"}","exportToExcelOptions":"visible","title":"User activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Type","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Activity Count","formatter":8,"formatOptions":{"min":0,"palette":"blueGreen","showIcon":true}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"palette":"greenDark","showIcon":true}},{"columnMatch":"IpAddress","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Account","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Names Count","formatter":0,"formatOptions":{"showIcon":true}}],"filter":true,"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name"},"labelSettings":[]}},"customWidth":"50","name":"query - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//let Users = dynamic({Userinfo});\r\nlet data = SecurityEvent\r\n| where \"{Activity:lable}\" == \"All\" or Activity in ({Activity})\r\n| where Activity == '{ActivityPiker}' or '{ActivityPiker}' == \"All\" and AccountType == 'Machine'\r\n| extend user = extract(@'^(.*\\\\)?([^@]*)(@.*)?$', 2, tolower(Account))\r\n| where dynamic({Userinfo}).Type == '*' or (dynamic({Userinfo}).Type == 'Computer' and user == dynamic({Userinfo}).Name);\r\nlet appData = data\r\n| summarize TotalCount = count() by Computer\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Computer\r\n    | project-away TimeGenerated) on Computer\r\n| order by TotalCount desc, Computer asc\r\n| project Computer, TotalCount, Trend\r\n| serialize Id = row_number();\r\ndata\r\n| summarize TotalCount = count() by Activity , Computer\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Computer, Activity\r\n    | project-away TimeGenerated) on Computer, Activity\r\n| order by TotalCount desc, Computer asc\r\n| project Computer, Activity, TotalCount, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on Computer\r\n| project Id, Name = Activity, Type = 'Activity', ['Activity Count'] = TotalCount, Trend, ParentId = Id1\r\n| union (appData \r\n    | project Id, Name = Computer, Type = 'Computer', ['Activity Count'] = TotalCount, Trend )\r\n| order by ['Activity Count'] desc, Name asc","size":0,"exportFieldName":"","exportParameterName":"MachineInfo","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\"}","exportToExcelOptions":"visible","title":"Machine activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Type","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Activity Count","formatter":8,"formatOptions":{"min":0,"palette":"blue","showIcon":true}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"showIcon":true}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name"},"labelSettings":[]}},"customWidth":"50","name":"query - 4"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let Users = dynamic({Userinfo});\r\nlet Machines = dynamic({MachineInfo});\r\nSecurityEvent\r\n| where \"{Activity:lable}\" == \"All\" or Activity in ({Activity})\r\n| where Activity == '{ActivityPiker}' or '{ActivityPiker}' == \"All\"\r\n| extend Name = extract(@'^(.*\\\\)?([^@]*)(@.*)?$', 2, tolower(Account))\r\n| where (Users.Type == '*' or (Users.Type == 'Computer' and Name == Users.Name)) and (Machines.Type == '*' or (Machines.Type == 'Computer' and Computer == Machines.Name))\r\n| extend Status = iif(Activity contains \"success\",\"✔️ Success\" , iif(Activity contains \"faile\", \"❌Faile\", \"none\"))\r\n| summarize Count = count() by Name, Computer,AccountType, Activity, IpAddress , Process, CallerProcessId, CallerProcessName, CommandLine, FilePath, IpPort,GroupMembership, Status, bin(TimeGenerated, 1d), Detalis=\"more details\"\r\n| project  Name, Computer,AccountType, Activity, IpAddress, CallerProcessId, CallerProcessName, CommandLine, FilePath, IpPort, Process, GroupMembership, Status, TimeGenerated, Count, Detalis\r\n| order by Count\r\n","size":0,"exportParameterName":"Info","exportDefaultValue":"\"*\"","exportToExcelOptions":"visible","title":"Full details","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Computer","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"AccountType","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Activity","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"IpAddress","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"CallerProcessId","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"CallerProcessName","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"CommandLine","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"FilePath","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"IpPort","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Process","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"GroupMembership","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Status","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"TimeGenerated","formatter":6,"formatOptions":{"showIcon":true}},{"columnMatch":"Count","formatter":8,"formatOptions":{"min":0,"palette":"greenBlue","showIcon":true}},{"columnMatch":"Detalis","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true,"showIcon":true}},{"columnMatch":"NumberOfProcess","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"detalis","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true,"showIcon":true}},{"columnMatch":"count_","formatter":0,"formatOptions":{"showIcon":true}}],"rowLimit":1000,"filter":true,"labelSettings":[]}},"name":"query - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let Users = dynamic({Userinfo});\r\nlet Info = dynamic({Info});\r\nlet Machines = dynamic({MachineInfo});\r\nSecurityEvent\r\n| where Info == \"*\" or Process == Info.Process\r\n| where Process != \"\" and Process != \"-\"\r\n| where \"{Activity:lable}\" == \"All\" or Activity in ({Activity})\r\n| where Activity == '{ActivityPiker}' or '{ActivityPiker}' == \"All\"\r\n| extend Name = extract(@'^(.*\\\\)?([^@]*)(@.*)?$', 2, tolower(Account))\r\n| where (Users.Type == '*' or (Users.Type == 'Computer' and Name == Users.Name)) and (Machines.Type == '*' or (Machines.Type == 'Computer' and Computer == Machines.Name))\r\n| summarize Count = count() by Process, bin(TimeGenerated, 1h)","size":0,"exportToExcelOptions":"visible","title":"Processes","color":"lightBlue","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"areachart"},"customWidth":"30","name":"query - 6"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let Users = dynamic({Userinfo});\r\nlet Info = dynamic({Info});\r\nlet Machines = dynamic({MachineInfo});\r\nSecurityEvent\r\n| where Process != \"\" and Process != \"-\"\r\n| where \"{Activity:lable}\" == \"All\" or Activity in ({Activity})\r\n| where Activity == '{ActivityPiker}' or '{ActivityPiker}' == \"All\"\r\n| where Info == \"*\" or Process == Info.Process\r\n| extend user = extract(@'^(.*\\\\)?([^@]*)(@.*)?$', 2, tolower(Account))\r\n| where (Users.Type == '*' or (Users.Type == 'Computer' and user == Users.Name)) and (Machines.Type == '*' or (Machines.Type == 'Computer' and Computer == Machines.Name))\r\n| summarize Count = count() by Process, Activity, user, Computer, bin(TimeGenerated, 1h)\r\n| order by TimeGenerated, Count","size":0,"exportToExcelOptions":"visible","title":"Processes details","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true,"labelSettings":[]}},"customWidth":"70","name":"query - 8"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let Users = dynamic({Userinfo});\r\nlet Info = dynamic({Info});\r\nlet Machines = dynamic({MachineInfo});\r\nSecurityEvent\r\n| where LogonTypeName != \"\"\r\n| where \"{Activity:lable}\" == \"All\" or Activity in ({Activity})\r\n| where Activity == '{ActivityPiker}' or '{ActivityPiker}' == \"All\"\r\n| where Info == \"*\" or Activity == Info.Activity\r\n| extend user = extract(@'^(.*\\\\)?([^@]*)(@.*)?$', 2, tolower(Account))\r\n| where (Users.Type == '*' or (Users.Type == 'Computer' and user == Users.Name)) and (Machines.Type == '*' or (Machines.Type == 'Computer' and Computer == Machines.Name))\r\n| summarize Count = count() by LogonTypeName = strcat( \"Logon type: \", LogonTypeName), Activity, user\r\n| order by Count","size":0,"exportToExcelOptions":"visible","title":"Logon activity types","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"LogonTypeName","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Activity","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"user","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Count","formatter":8,"formatOptions":{"min":0,"palette":"green","showIcon":true,"aggregation":"Sum"}},{"columnMatch":"$gen_group","formatter":0,"formatOptions":{"showIcon":true}}],"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["LogonTypeName","Activity"],"expandTopLevel":false},"labelSettings":[]}},"customWidth":"70","name":"query - 7"}],"styleSettings":{},"fromTemplateId":"sentinel-IdentityAndAccess","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FIdentityAccess.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## IncidentOverview
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/IncidentOverview.json)

### Workbook details

> Description: This workbook will get a report on a specific incident.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"# Incident Overview"},"customWidth":"35","name":"Headline"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Subscription}"],"parameters":[{"id":"9a199167-2dde-49dd-8f01-23e9d1fa8151","version":"KqlParameterItem/1.0","name":"InternalWSs","type":1,"isRequired":true,"query":"SecurityIncident\r\n| take 1\r\n| parse IncidentUrl with * \"/workspaces/\" Workspace \"/\" *\r\n| project Workspace","isHiddenWhenLocked":true,"timeContext":{"durationMs":2592000000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"7806fefd-432f-4828-9756-8c0be5c08d07","version":"KqlParameterItem/1.0","name":"InternalSub","type":1,"isRequired":true,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| take 1\r\n| project subscriptionId","crossComponentResources":["value::selected"],"isHiddenWhenLocked":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"55d3ab63-6e1f-4d02-8d9e-2225526689c7","version":"KqlParameterItem/1.0","name":"Subscription","type":6,"isRequired":true,"query":"summarize by subscriptionId\r\n| project value = strcat(\"/subscriptions/\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{InternalSub}', true, false)","typeSettings":{"additionalResourceOptions":["value::1"],"showDefault":false},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","defaultValue":"value::1","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"95a45501-31b5-4ea2-bcb3-eb208e0080e2","version":"KqlParameterItem/1.0","name":"Workspace","type":5,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"//resources | where type =~ 'Microsoft.operationsmanagement/solutions' | where name contains //'SecurityInsights' | project id //= tostring(properties.workspaceResourceId)\r\n\r\nwhere type =~ 'microsoft.operationalinsights/workspaces'\r\n| project value =id, label = name, selected = iff(name =~ '{InternalWSs}', true, false)\r\n\r\n\r\n","crossComponentResources":["value::all"],"typeSettings":{"additionalResourceOptions":[]},"timeContextFromParameter":"TimeRange","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"7d597ad7-4a2a-45ed-a4fe-7ee32de0fc22","version":"KqlParameterItem/1.0","name":"TimeRange","label":"Incident Creation Time","type":4,"isRequired":true,"value":{"durationMs":2592000000},"typeSettings":{"selectableValues":[{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2592000000}],"allowCustom":true}},{"id":"3a87d4f7-42cc-4c62-b543-6b5d9ab8cf27","version":"KqlParameterItem/1.0","name":"Severity","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityIncident\r\n| summarize Count = count(IncidentNumber) by Severity\r\n| project Value = Severity, Label = strcat(Severity, \": \", Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"81085d3a-5aca-488e-b7c6-ecf1167e59f7","version":"KqlParameterItem/1.0","name":"Tactics","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityIncident\r\n| extend Tactics = todynamic(AdditionalData.tactics)\r\n| mvexpand Tactics to typeof(string)\r\n| summarize Count=count(IncidentNumber) by Tactics\r\n| project Value = Tactics, Label = strcat(Tactics, \": \", Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"0f9efb0d-ac34-41d0-8a19-165840eb2a71","version":"KqlParameterItem/1.0","name":"Owner","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityIncident\r\n| extend owner = tostring(Owner.assignedTo) \r\n| summarize Count=count(IncidentNumber) by Owner= case(owner==\"\", \"Unassigned\",owner)\r\n| project Value = Owner, Label = strcat(Owner, \": \", Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"cf86113b-59ad-4fc9-aeb7-9b44e230641e","version":"KqlParameterItem/1.0","name":"Product","label":"Product Name","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityIncident\r\n| extend Product = tostring(parse_json(tostring(AdditionalData.alertProductNames))[0]) \r\n| summarize Count=count(IncidentNumber) by Product\r\n| project Value = Product, Label = strcat(Product, \": \", Count)\r\n","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"1fea48e7-99b2-4664-8eb6-bd35fc4efaf0","version":"KqlParameterItem/1.0","name":"resourceGroup","type":1,"query":"resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| where id == \"{Workspace:lable}\"\r\n| project resourceGroup","crossComponentResources":["{Subscription}"],"isHiddenWhenLocked":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources"}],"style":"pills","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"customWidth":"65","name":"parameters - 6"},{"type":1,"content":{"json":"The Incident Overview workbook is designed to assist in triaging and investigation by providing in-depth information about the incident, including:\r\n* General information\r\n* Entity data\r\n* Triage time (time between incident creation and first response)\r\n* Mitigation time (time between incident creation and closing)\r\n* Comments\r\n\r\nCustomize this workbook by saving and editing it. \r\nYou can reach this workbook template from the incidents panel as well. Once you have customized it, the link from the incident panel will open the customized workbook instead of the template.\r\n","style":"info"},"customWidth":"100","name":"Info"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"9aec751b-07bd-43ba-80b9-f711887dce45","version":"KqlParameterItem/1.0","name":"IncidentNumber","label":"Incident Number","type":1,"value":"","timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"customWidth":"50","name":"parameters - 6 - Copy"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"f978edb2-9886-4bff-8e12-8280800321c3","version":"KqlParameterItem/1.0","name":"IncidentID","label":"Incident Name","type":1,"query":"SecurityIncident\r\n| where IncidentNumber == {IncidentNumber}\r\n| take 1\r\n| project IncidentName\r\n","value":null,"isHiddenWhenLocked":true,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"3b8e6cdd-4578-49cb-a515-1f9dec104fd7","version":"KqlParameterItem/1.0","name":"RuleId","type":1,"query":"SecurityIncident\r\n| where IncidentNumber == {IncidentNumber}\r\n| summarize arg_max(TimeGenerated, RelatedAnalyticRuleIds) by IncidentNumber\r\n| project RelatedAnalyticRuleIds","value":null,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","label":"Rule Id"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"conditionalVisibility":{"parameterName":"IncidentNumber","comparison":"isEqualTo","value":"e"},"customWidth":"50","name":"Invisible parameters"},{"type":1,"content":{"json":"## General Incident Information "},"customWidth":"67","name":"Headline - general info"},{"type":1,"content":{"json":"## Closing Classifications of Similar Incidents\r\nClosing classifications of incidents that where created from the same rule in the past month "},"customWidth":"33","name":"Headline - classification"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\r\n| where IncidentNumber == '{IncidentNumber}' \r\n| summarize arg_max(TimeGenerated,CreatedTime,Status, Severity, Owner, AdditionalData, IncidentUrl, Comments, Classification,ClassificationReason, ClassificationComment,Labels, Title, AlertIds) by IncidentNumber\r\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\r\n| extend Tactics = todynamic(AdditionalData.tactics)\r\n| extend Owner = todynamic(Owner.assignedTo), IncidentCreated = format_datetime(CreatedTime,'yy-MM-dd HH:mm')\r\n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\r\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \r\n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\r\n| extend Tags = extract_all('labelName\":\"(.*?)\"',tostring(Labels))\r\n| extend Owner = case(tostring(todynamic(Owner.assignedTo))==\"\", \"Unassigned\",tostring(todynamic(Owner.assignedTo))), Products = strcat_array(AdditionalData.alertProductNames, \", \"), Alerts = tostring(AdditionalData.alertsCount), Bookmarks = tostring(AdditionalData.bookmarksCount), Comments = tostring(AdditionalData.commentsCount), Tactics = strcat_array(AdditionalData.tactics, \", \"), Labels = strcat_array(Tags, \", \")\r\n| mvexpand AlertIds to typeof(string)\r\n| join kind=leftouter\r\n(SecurityAlert\r\n| summarize arg_max(TimeGenerated,AlertName, Description, AlertType, Entities)by SystemAlertId) on $left.AlertIds == $right.SystemAlertId\r\n| summarize AlertName = makelist(AlertName), AlertType = makelist(AlertType) by Comments, Labels, Title, Products, AlertsCount = Alerts, Bookmarks, Status, Severity, Owner, IncidentCreated, ClassificationComment, Classification, ClassificationReason \r\n| extend AlertNames = strcat_array(AlertName, \", \"), AlertTypes = strcat_array(AlertType, \", \")\r\n| project packed = pack_all()\r\n| mv-expand packed\r\n| parse tostring(packed) with * '\"' Field '\":\"' Value '\"}'\r\n| where Field in ('Severity', 'Owner','Status', 'AlertsCount','Products','Title', 'IncidentCreated', 'Labels','Bookmarks', 'AlertNames', 'AlertsType', 'Classification','ClassificationComment','ClassificationReason')\r\n| extend Field1 = case(Field== \"IncidentCreated\", \"Time created\", Field == \"AlertsCount\", \"Alert count\", Field == \"ClassificationComment\", \"Classification Comment\", Field == \"ClassificationReason\", \"Classification Reason\", Field == \"AlertNames\", \"Alert Names\", Field)\r\n| extend Order = case(Field==\"Title\", 1,Field==\"IncidentCreated\", 2,Field==\"Severity\", 3,Field==\"Status\", 4,Field==\"Owner\", 5,Field==\"Products\", 6,Field==\"AlertsType\",6,Field==\"AlertsCount\", 7,Field==\"Bookmarks\", 8, Field==\"Labels\", 9,Field==\"Classification\", 10,Field==\"ClassificationReason\",11, 100)\r\n","size":0,"noDataMessage":"Enter an incident number","noDataMessageStyle":5,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"Field1","formatter":1,"numberFormat":{"unit":0,"options":{"style":"decimal"}}},"leftContent":{"columnMatch":"Value","formatter":1},"showBorder":false,"sortCriteriaField":"Order","sortOrderField":1,"size":"auto"}},"customWidth":"66","name":"general info"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let alertText =  strcat_array(dynamic([{RuleId}]),\",\");\r\nlet getAmountOfIncidentForRuleId = (classification:string){\r\n    SecurityIncident\r\n    | where TimeGenerated >= ago(30d)\r\n    | where Classification == classification\r\n    | mv-expand AlertId=AlertIds\r\n    | extend AlertId=tostring(AlertId)\r\n    | join  (SecurityAlert| where TimeGenerated >=ago(30d)) on $left.AlertId==$right.SystemAlertId\r\n    | mv-expand RuleId=RelatedAnalyticRuleIds\r\n    | extend RuleId=iff(ProductName!= 'Azure Sentinel', ProductName,RuleId)\r\n    | summarize counter=count() by RuleIdentifier=tostring(RuleId)\r\n    | extend RuleId=RuleIdentifier\r\n    | project-away RuleIdentifier\r\n};\r\nlet falsePositiveClassificationTable = getAmountOfIncidentForRuleId(\"FalsePositive\") | extend FalsePositiveCounter=counter | project-away counter;\r\nlet undeterminedClassificationTable = getAmountOfIncidentForRuleId(\"Undetermined\") | extend UndeterminedCounter=counter | project-away counter;\r\nlet benignPositiveClassificationTable = getAmountOfIncidentForRuleId(\"BenignPositive\") | extend BenignPositiveCounter=counter | project-away counter;\r\nlet truePositiveClassificationTable = getAmountOfIncidentForRuleId(\"TruePositive\") | extend TruePositiveCounter=counter | project-away counter;\r\nlet closedIncidentTable = SecurityIncident| where TimeGenerated >= ago(30d) |where Status == \"Closed\" | mv-expand AlertId=AlertIds| extend AlertId=tostring(AlertId)| join  SecurityAlert on $left.AlertId==$right.SystemAlertId| mv-expand RelatedAnalyticRuleIds| extend RuleId= iff(ProductName == 'Azure Sentinel', tostring(RelatedAnalyticRuleIds), ProductName);\r\nlet joinByRuleId = (T:(RuleId:string), S:(RuleId:string)){\r\n    T \r\n    | join kind=fullouter S on $left.RuleId == $right.RuleId\r\n    | extend RuleId= iff(RuleId == '', RuleId1,RuleId)\r\n    | project-away RuleId1\r\n};\r\njoinByRuleId(joinByRuleId(joinByRuleId(joinByRuleId(falsePositiveClassificationTable, undeterminedClassificationTable) , benignPositiveClassificationTable), truePositiveClassificationTable),closedIncidentTable)\r\n| join kind=leftouter  (SecurityAlert\r\n| where TimeGenerated >= ago(30d)\r\n| where ProductName  ==  'Azure Sentinel'\r\n| extend RuleId = parsejson( tostring(todynamic(ExtendedProperties)['Analytic Rule Ids']))\r\n| mv-expand RuleId=RuleId\r\n| extend RuleId=tostring(RuleId)\r\n| extend RuleName=  tostring(todynamic(ExtendedProperties)['Analytic Rule Name'])\r\n| project RuleId,RuleName\r\n| distinct RuleId,RuleName)\r\n on $left.RuleId==$right.RuleId\r\n| extend RuleName=iff(isempty(RuleName),RuleId,RuleName)\r\n| project-away RuleId1\r\n| where alertText has RuleId \r\n| summarize dcount(IncidentNumber) by Classification","size":0,"noDataMessage":"No recent closed incident were found","noDataMessageStyle":4,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"piechart","sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"Field1","formatter":1,"numberFormat":{"unit":0,"options":{"style":"decimal"}}},"leftContent":{"columnMatch":"Value","formatter":1},"showBorder":false,"sortCriteriaField":"Order","sortOrderField":1,"size":"auto"},"chartSettings":{"createOtherGroup":null}},"customWidth":"34","name":"Closing classification"},{"type":1,"content":{"json":"## Incident Entities"},"name":"text - 2 - Copy - Copy - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"path\":\"/subscriptions/{Subscription:id}/resourceGroups/{resourceGroup}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/incidents/{IncidentID}/entities\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2019-01-01-preview\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.metaData\",\"columns\":[]}}]}","size":2,"noDataMessage":"No entities were found","noDataMessageStyle":4,"queryType":12,"visualization":"piechart","sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"entityKind","formatter":12,"formatOptions":{"palette":"blue"}},"leftContent":{"columnMatch":"count","formatter":1,"numberFormat":{"unit":0,"options":{"style":"decimal"}}},"showBorder":false,"sortCriteriaField":"Order","sortOrderField":1,"size":"auto"}},"customWidth":"30","name":"Entities"},{"type":3,"content":{"version":"KqlItem/1.0","query":"{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"path\":\"/subscriptions/{Subscription:id}/resourceGroups/{resourceGroup}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/incidents/{IncidentID}/entities\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2019-01-01-preview\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.entities\",\"columns\":[{\"path\":\"$.kind\",\"columnid\":\"Kind\"},{\"path\":\"$.properties.friendlyName\",\"columnid\":\"Name\"}]}}]}","size":2,"noDataMessage":"No entities were found","noDataMessageStyle":4,"queryType":12,"visualization":"table","gridSettings":{"hierarchySettings":{"treeType":1,"groupBy":["Kind"],"expandTopLevel":true}},"sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"kind","formatter":1,"numberFormat":{"unit":0,"options":{"style":"decimal"}}},"subtitleContent":{"columnMatch":"properties","formatter":1},"showBorder":false,"sortCriteriaField":"kind","sortOrderField":1,"size":"auto"}},"customWidth":"70","name":"Entities List"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Recent activities"},"name":"text - 2 - Copy - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| where IncidentNumber == '{IncidentNumber}' or '{IncidentNumber}' ==  ''\n| order by LastModifiedTime \n| project LastModifiedTime,IncidentNumber, Title, Product, IncidentUrl, ModifiedBy,Status, Severity\n| take 250\n\n\n","size":1,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"IncidentUrl","formatter":7,"formatOptions":{"linkTarget":"Url","linkLabel":"Go to incident >"}}],"labelSettings":[{"columnId":"LastModifiedTime","label":"Last Modified Time"},{"columnId":"IncidentNumber","label":"Incident Number"},{"columnId":"Title"},{"columnId":"Product"},{"columnId":"IncidentUrl","label":"Link to incident"},{"columnId":"ModifiedBy","label":"Modified By"},{"columnId":"Status"},{"columnId":"Severity"}]},"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"IncidentNumber","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"name":"query - 2 - Copy - Copy - Copy - Copy"}]},"name":"Incidents tactic over time"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Incident's Comments"},"name":"text - 2 - Copy - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| summarize arg_max(TimeGenerated,Status, Severity, Owner, AdditionalData, IncidentUrl, Comments) by IncidentNumber\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| where IncidentNumber == '{IncidentNumber}' or '{IncidentNumber}' ==  ''\n| mvexpand Comments to typeof(string)\n| extend Message = extract('message\":\"(.*?)\"',1,tostring(Comments)), Author = extract('name\":\"(.*?)\"',1,tostring(Comments)), CreatedTimeUTC = extract('createdTimeUtc\":\"(.*?)\"',1,tostring(Comments))\n| project CreatedTimeUTC, Author, Message\n| take 250\n\n\n","size":1,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"IncidentUrl","formatter":7,"formatOptions":{"linkTarget":"Url","linkLabel":"Go to incident >"}}]},"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"IncidentNumber","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"name":"query - 2 - Copy - Copy - Copy - Copy"}]},"name":"Incidents tactic over time - Copy"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Time to closure\r\nThe mean time between the incident creation and first modification by owner\r\n\r\n"},"name":"text - 2 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where IncidentNumber == '{IncidentNumber}' or '{IncidentNumber}' ==  ''\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize arg_max(TimeGenerated,*) by IncidentNumber \n| where isnotnull(ClosedTime)\n| extend TimeToClosure =  (ClosedTime - CreatedTime)/1h\n","size":1,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","exportFieldName":"series","exportParameterName":"Status","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"IncidentNumber","formatter":1},"leftContent":{"columnMatch":"TimeToClosure","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":26,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":3}}},"showBorder":false}},"name":"query - 2 - Copy"}]},"name":"Time to mitigate","styleSettings":{"margin":"0","padding":"0"}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Time to triage \r\nThe mean time between the incident creation and first modification by owner\r\n\r\n"},"name":"text - 2 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where IncidentNumber == '{IncidentNumber}' or '{IncidentNumber}' ==  ''\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| where ModifiedBy != 'Incident created from alert'\n| summarize arg_max(LastModifiedTime,*) by IncidentNumber \n| where isnotnull(FirstModifiedTime)\n| extend TimeToTriage =  FirstModifiedTime - CreatedTime\n| project IncidentNumber, MeanToTriage = TimeToTriage/1h\n","size":1,"timeContext":{"durationMs":94608000000,"endTime":"2023-06-01T17:13:00.000Z"},"exportFieldName":"series","exportParameterName":"Status","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"IncidentNumber","formatter":1},"leftContent":{"columnMatch":"MeanToTriage","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":26,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":3}}},"showBorder":false}},"name":"query - 2 - Copy"}]},"name":"Time to close","styleSettings":{"margin":"0","padding":"0"}}],"fromTemplateId":"sentinel-IncidentOverview","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FIncidentOverview.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## InsecureProtocol
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/InsecureProtocol.json)

### Workbook details

> Description: This workbook will get a report on Insecure Protocols.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Insecure Protocols\n"},"name":"text - 2"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"6b543dcb-ffbe-4fca-80d7-68d15257c377","version":"KqlParameterItem/1.0","name":"DefaultSubscription_Internal","type":1,"isRequired":true,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| take 1\r\n| project subscriptionId","crossComponentResources":["value::selected"],"isHiddenWhenLocked":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"959662e2-5c74-4876-b5c7-0aaeb2de2ca5","version":"KqlParameterItem/1.0","name":"Subscription","type":6,"query":"resources\r\n| summarize by subscriptionId\r\n| project value = strcat(\"/subscriptions/\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)","crossComponentResources":["value::selected"],"typeSettings":{"additionalResourceOptions":[]},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"d0ab5058-af8c-4ea2-b4a4-8d836769d278","version":"KqlParameterItem/1.0","name":"Workspace","type":5,"query":"resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| project id","crossComponentResources":["{Subscription}"],"value":null,"typeSettings":{"additionalResourceOptions":[]},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"020de58b-73ca-47fe-838e-bc3ac7afaef6","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"isRequired":true,"value":{"durationMs":604800000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}],"allowCustom":true}},{"id":"39b2b987-3569-4bc8-96b4-85c43f1c275b","version":"KqlParameterItem/1.0","name":"Help","label":"Show Help","type":10,"description":"Toggle to show Help for each tab.","isRequired":true,"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"jsonData":"[\r\n { \"value\": \"Yes\", \"label\": \"Yes\"},\r\n {\"value\": \"No\", \"label\": \"No\", \"selected\":true },\r\n { \"value\": \"Change Log\", \"label\": \"Change Log\"}\r\n]\r\n"}],"style":"above","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 7"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"d227db69-0ed6-4a0c-8b32-52d63b6abb97","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Summary","subTarget":"Summary","style":"link"},{"id":"c98966ad-34ee-4d5e-a887-9d9016bbe936","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"LDAP","subTarget":"LDAP","preText":"LDAP","style":"link"},{"id":"04f95974-97a2-43ac-a2b8-f82fd53b1569","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"NTLM","subTarget":"NTLM","style":"link"},{"id":"c044c677-3a45-4d4c-941d-3f0e1e48f11c","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"SMB","subTarget":"SMB","style":"link"},{"id":"337ad651-be31-42a7-8ff0-be12c2a4bc6c","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Kerberos","subTarget":"Kerberos","style":"link"},{"id":"21019a79-11e5-48e4-97b6-19062f7901c1","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"WDigest","subTarget":"WDigest","style":"link"},{"id":"da0803ba-fee6-4d54-9e66-b9b8611198b7","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"AAD Legacy Auth ","subTarget":"AADLegacy","style":"link"},{"id":"da70784a-a74b-4272-9b79-2ee727f8081f","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Vulnerable Secure Channel","subTarget":"NetlogonSC","style":"link"}]},"name":"links - 34"},{"type":1,"content":{"json":"### Change Log\r\nBrian Delaney, Clive Watson, Jon Shectman - Microsoft <br>\r\n\t\r\n\tVersion v2.0\r\n\tFiltered Legacy Authentication to success only\r\n\tAdded Export/Open Query buttons to detailed views\r\n\tReogranized Insecure LDAP\r\n\tFixed TimeRange in NTLM query to follow parameter selection\r\n\tOther minor improvements\r\n\r\n\tVersion v1.9\r\n\tUpdated AAD Legacy Auth (Exchange ActiveSync)\r\n\r\n\tVersion v1.8\r\n\tAdded Vulnerable Netlogon Secure Channel\r\n\tAdded Legacy Authentication to Summary\r\n\tFixed reporting of Weak Kerberos Cipher in summary\r\n\t\r\n\t\r\n\tVersion v1.7\r\n\tAdded Tabs\r\n\tFixed a bug\r\n\tAdded Timebrushing and Groupings\r\n\tAdded Help sections","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Change Log"},"customWidth":"30","name":"text - 24"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Group: Summary","items":[{"type":1,"content":{"json":"### Welcome to Insecure Protocols Workbook\r\nThis workbook will help you audit and remove Insecure Protocols from your Active Directory and Azure Active Directory estates.<br>\r\nFor more information about this workbook (and for help with audit settings), navigate to [here](https://aka.ms/sentinelipsetup).<br>\r\nFor help as you navigate this workbook, toggle Show Help at the page top.","style":"info"},"customWidth":"70","conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 24 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let scEvents = dynamic([5827, 5828, 5829, 5830, 5831]);\r\nlet legacyAuth = SigninLogs\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize Count=count() by Protocol=\"AAD Legacy Auth\";\r\nSecurityEvent\r\n| parse EventData with * '\"TicketEncryptionType\">' TicketEncryptionType '<' *\r\n| union Event\r\n| where (EventID == 2889) or (EventID == 3000 and EventLog == 'Microsoft-Windows-SMBServer/Audit') or (EventID == 4624 and AuthenticationPackageName == 'NTLM' and LmPackageName == 'NTLM V1' and Account !contains 'ANONYMOUS LOGON') or ((EventID == 4624 or EventID == 4776) and Level == 8 and PackageName contains 'WDigest') or (EventID == 4768 or EventID == 4769) and Level == 8 and (TicketEncryptionType != \"0x12\" and TicketEncryptionType != \"0x11\") or ((EventLog =~ \"System\" and Source =~ \"NETLOGON\") and EventID in (scEvents))\r\n| summarize Count=count() by bin(TimeGenerated, {TimeRange:grain}), tostring(EventID)\r\n//| extend Protocol=replace(tostring(4776), 'WDigest', replace(tostring(4768), 'Kerberos weak cipher', replace(tostring(4769), 'Kerberos weak cipher', replace(tostring(2889), 'Insecure LDAP', replace(tostring(4624), 'NTLM v1', replace(tostring(3000), 'SMB v1', tostring(EventID)))))))\r\n| extend Protocol = case(EventID == 4776, \"WDigest\", EventID == 4768 or EventID == 4769, \"Weak Kerberos Cipher\", EventID == 2889, \"Insecure LDAP\", EventID == 4624, \"NTLM v1\", EventID == 3000, \"SMBv1\", EventID in (scEvents), \"Vulnerable Secure Channel\", \"Unknown\")\r\n| project Protocol, Count\r\n| union legacyAuth\r\n| sort by Count desc\r\n","size":0,"title":"Summary of Insecure Protocols: {TimeRange:label}","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"series","exportParameterName":"SelectedProtocol","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"piechart","gridSettings":{"sortBy":[{"itemKey":"Count","sortOrder":2}]},"sortBy":[{"itemKey":"Count","sortOrder":2}]},"customWidth":"40","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Summary"},"name":"IPbyTypePie"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let scEvents = dynamic([5827, 5828, 5829, 5830, 5831]);\r\nlet legacyAuth = SigninLogs\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize Count=count() by bin(TimeGenerated, {TimeRange:grain}), Protocol=\"AAD Legacy Auth\";\r\nSecurityEvent\r\n| parse EventData with * '\"TicketEncryptionType\">' TicketEncryptionType '<' *\r\n| union Event\r\n| where (EventID == 2889) or (EventID == 3000 and EventLog == 'Microsoft-Windows-SMBServer/Audit') or (EventID == 4624 and AuthenticationPackageName == 'NTLM' and LmPackageName == 'NTLM V1' and Account !contains 'ANONYMOUS LOGON') or ((EventID == 4624 or EventID == 4776) and Level == 8 and PackageName contains 'WDigest') or (EventID == 4768 or EventID == 4769) and Level == 8 and (TicketEncryptionType != \"0x12\" and TicketEncryptionType != \"0x11\") or ((EventLog =~ \"System\" and Source =~ \"NETLOGON\") and EventID in (scEvents))\r\n| summarize Count=count() by bin(TimeGenerated, {TimeRange:grain}), tostring(EventID)\r\n//| extend Protocol=replace(tostring(4776), 'WDigest', replace(tostring(4768), 'Kerberos weak cipher', replace(tostring(4769), 'Kerberos weak cipher', replace(tostring(2889), 'Insecure LDAP', replace(tostring(4624), 'NTLM v1', replace(tostring(3000), 'SMB v1', tostring(EventID)))))))\r\n| extend Protocol = case(EventID == 4776, \"WDigest\", EventID == 4768 or EventID == 4769, \"Weak Kerberos Cipher\", EventID == 2889, \"Insecure LDAP\", EventID == 4624, \"NTLM v1\", EventID == 3000, \"SMBv1\", EventID in (scEvents), \"Vulnerable Secure Channel\", \"Unknown\")\r\n| project Protocol, Count, TimeGenerated\r\n| union legacyAuth\r\n| where Protocol =~ \"{SelectedProtocol}\" or \"{SelectedProtocol}\" =~ \"All\"\r\n| sort by Count desc\r\n","size":0,"title":"Summary of Insecure Protocols: {TimeRange:label}","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"barchart","gridSettings":{"sortBy":[{"itemKey":"Count","sortOrder":2}]},"sortBy":[{"itemKey":"Count","sortOrder":2}]},"customWidth":"60","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Summary"},"name":"IPbyTypeandTimeBar"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let scEvents = dynamic([5827, 5828, 5829, 5830, 5831]);\r\nlet legacyAuth = SigninLogs\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize FirstOccurance=min(TimeGenerated), LastOccurance=max(TimeGenerated), Count=count() by Protocol=\"AAD Legacy Auth\";\r\nSecurityEvent\r\n| parse EventData with * '\"TicketEncryptionType\">' TicketEncryptionType '<' *\r\n| union Event\r\n| where (EventID == 2889) or (EventID == 3000 and EventLog == 'Microsoft-Windows-SMBServer/Audit') or (EventID == 4624 and AuthenticationPackageName == 'NTLM' and LmPackageName == 'NTLM V1' and Account !contains 'ANONYMOUS LOGON') or ((EventID == 4624 or EventID == 4776) and Level == 8 and PackageName contains 'WDigest') or (EventID == 4768 or EventID == 4769) and Level == 8 and (TicketEncryptionType != \"0x12\" and TicketEncryptionType != \"0x11\") or ((EventLog =~ \"System\" and Source =~ \"NETLOGON\") and EventID in (scEvents))\r\n| summarize FirstOccurance=min(TimeGenerated), LastOccurance=max(TimeGenerated), Count=count() by tostring(EventID)\r\n//| extend Protocol=replace(tostring(4776), 'WDigest', replace(tostring(4768), 'Kerberos weak cipher', replace(tostring(4769), 'Kerberos weak cipher', replace(tostring(2889), 'Insecure LDAP', replace(tostring(4624), 'NTLM v1', replace(tostring(3000), 'SMB v1', tostring(EventID)))))))\r\n| extend Protocol = case(EventID == 4776, \"WDigest\", EventID == 4768 or EventID == 4769, \"Weak Kerberos Cipher\", EventID == 2889, \"Insecure LDAP\", EventID == 4624, \"NTLM v1\", EventID == 3000, \"SMBv1\", EventID in (scEvents), \"Vulnerable Secure Channel\", \"Unknown\")\r\n| summarize FirstOccurance=min(FirstOccurance), LastOccurance=max(LastOccurance), Count=sum(Count) by Protocol\r\n| union legacyAuth\r\n| sort by Count desc\r\n","size":1,"title":"Summary of Insecure Protobols found in: {TimeRange:label}","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","sortBy":[],"tileSettings":{"showBorder":false},"graphSettings":{"type":0,"topContent":{"columnMatch":"TableName","formatter":1,"formatOptions":{"showIcon":true}},"centerContent":{"columnMatch":"Normal EventID","formatter":1,"formatOptions":{"showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"nodeIdField":"excellent_ok","sourceIdField":"TableName","targetIdField":"excellent_ok","edgeLabel":"excellent_ok","nodeSize":null,"staticNodeSize":100,"colorSettings":null,"groupByField":"TableName","hivesMargin":5},"chartSettings":{"group":"Crucial EventID","createOtherGroup":null}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Summary"},"name":"SummaryByIP"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Summary"},"name":"group - Summary"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Group: Insecure LDAP","items":[{"type":1,"content":{"json":"### LDAP Help File\r\n\r\n**Protocol Risk**\r\n\t* Clients are returning unsigned traffic, which is susceptible to replay or attacker-in-the-middle attacks.\r\n\t* This may result in nefarious activity, such as modified packets, in which a server or even a person makes decisions based on forged data.\r\n\t* The organization is exposing its highly-privileged authentication principals' credentials – such as the ones for those that belong to the Domain Admins group. With a simple network capture, an attacker can steal these credentials and achieve an escalation path or even a domain dominance type scenario. In the case of simple binds, the organization is exposing plaintext authentication credentials.\r\n\r\n**Auditing Settings**\r\n\t* Set auditing for 2889 on every DC - In the registry key “HKLM\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Diagnostics” set a DWORD with name \"16 LDAP Interface Events” to a value of “2\"\r\n\t* In Log Analytics/Sentinel, set log collection from the Directory Service log.\r\n\r\n**Mitigation Planning**\r\n\t* Work with application owners, vendors, and users to use LDAP over TLS (LDAPS://) – ports 636 and 3269.\r\n\t* Once there is no more 2889 insecure LDAP traffic, set the DCs to no longer accept it. GPO: Computer Configuration\\Windows Settings\\Security Settings\\Local Policies\\Security Options\r\n\t* If this is not possible, you can secure the entire exchange with IPSec. However, you will not be able to disallow insecure LDAP at the DCs; so using LDAPS is recommended.\r\n\r\n**Data Filters**\r\n\t* Account\r\n\t* Account timebrush\r\n\t* IP\r\n\t* IP timebrush","style":"info"},"customWidth":"100","conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 11"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event \r\n | where EventID == 2889 \r\n | parse ParameterXml with * '><Param>' Account '</' *\r\n | parse ParameterXml with * '<Param>' IPAddress ':' * \r\n | parse kind = regex ParameterXml with * '</Param><Param>' * '</Param><Param>' BindingType '</Param>'\r\n | extend Title = \"Number of events\"\r\n | summarize QueryCount = count(EventID) by Title//, NumberOfIPs = dcount(IPAddress), NumberOfAccounts = dcount(Account)","size":4,"timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Title","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"QueryCount","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":false}},"customWidth":"20","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"LDAP"},"name":"query - 9"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event \r\n | where EventID == 2889 \r\n | parse ParameterXml with * '><Param>' Account '</' *\r\n | parse ParameterXml with * '<Param>' IPAddress ':' * \r\n | parse kind = regex ParameterXml with * '</Param><Param>' * '</Param><Param>' BindingType '</Param>'\r\n | extend Title = \"Number of Accounts\"\r\n | summarize QueryCount = dcount(Account) by Title//, NumberOfIPs = dcount(IPAddress), NumberOfAccounts = dcount(Account)","size":4,"timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Title","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"QueryCount","formatter":12,"formatOptions":{"min":0,"palette":"purple","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"showBorder":false}},"customWidth":"20","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"LDAP"},"name":"query - 10"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event \r\n | where EventID == 2889 \r\n | parse ParameterXml with * '><Param>' Account '</' *\r\n | parse ParameterXml with * '<Param>' IPAddress ':' * \r\n | parse kind = regex ParameterXml with * '</Param><Param>' * '</Param><Param>' BindingType '</Param>'\r\n | extend Title = \"Number of IP Addresses\"\r\n | summarize QueryCount =  dcount(IPAddress) by Title//, NumberOfIPs = dcount(IPAddress), NumberOfAccounts = dcount(Account)","size":4,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Title","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"QueryCount","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":false}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"LDAP"},"name":"query - 9 - Copy"},{"type":1,"content":{"json":"\r\n### By Account\r\n---"},"name":"text - 12"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event \r\n | where EventID == 2889 \r\n | parse ParameterXml with * '><Param>' Account '</' *\r\n | parse ParameterXml with * '<Param>' IPAddress ':' * \r\n | parse kind = regex ParameterXml with * '</Param><Param>' * '</Param><Param>' BindingType '</Param>'\r\n | summarize QueryCount = count(EventID) by Account, IPAddress\r\n | order by QueryCount\r\n","size":0,"title":"By Account - click to filter","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Account","exportParameterName":"Account","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"QueryCount","formatter":4,"formatOptions":{"min":1,"palette":"orange","showIcon":true}},{"columnMatch":"TimeGenerated","formatter":4,"formatOptions":{"showIcon":true}}],"sortBy":[{"itemKey":"$gen_bar_QueryCount_2","sortOrder":2}],"labelSettings":[{"columnId":"Account"},{"columnId":"IPAddress","label":"Source IP"},{"columnId":"QueryCount","label":"Number of Insecure Binds"}]},"sortBy":[{"itemKey":"$gen_bar_QueryCount_2","sortOrder":2}]},"customWidth":"20","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"LDAP"},"name":"LDAP by Account"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event \r\n | where EventID == 2889 \r\n | parse ParameterXml with * '><Param>' Account '</' *\r\n | parse ParameterXml with * '<Param>' IPAddress ':' * \r\n | parse kind = regex ParameterXml with * '</Param><Param>' * '</Param><Param>' BindingType '</Param>'\r\n | extend TimeFromNow = now() - TimeGenerated\r\n | extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n | where Account == '{Account:escape}' or  '{Account:escape}' == \"All\"\r\n | summarize count() by Account, bin(TimeGenerated, {TimeRange:grain})","size":0,"title":"Account events over time - select timebrush","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"LDAPTimebrushAccount","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart"},"customWidth":"30","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"LDAP"},"name":"query - 11"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event \r\n | where EventID == 2889 \r\n | parse ParameterXml with * '><Param>' Account '</' *\r\n | parse ParameterXml with * '<Param>' IPAddress ':' * \r\n | parse kind = regex ParameterXml with * '</Param><Param>' * '</Param><Param>' BindingType '</Param>'\r\n | extend TimeFromNow = now() - TimeGenerated\r\n | extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n | where Account == '{Account:escape}' or  '{Account:escape}' == \"All\"\r\n | extend BindingType = case(BindingType==0,\"Unsigned\",BindingType==1,\"Simple\",\"Unknown\")\r\n | project Account, IPAddress, Computer, RenderedDescription, UserName, EventID, BindingType, Time_of_Bind=TimeAgo","size":0,"showAnalytics":true,"title":"Account Details","timeContext":{"durationMs":0},"timeContextFromParameter":"LDAPTimebrushAccount","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Account","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true,"showIcon":true}},{"columnMatch":"RenderedDescription","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"UserName","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"EventID","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"labelSettings":[{"columnId":"Account"},{"columnId":"IPAddress","label":"Source IP"},{"columnId":"Computer","label":"Domain Controller"},{"columnId":"Time_of_Bind","label":"Binding Time"}]}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"LDAP"},"name":"query - 7"},{"type":1,"content":{"json":"### By Source IP\r\n---"},"name":"text - 13"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event \r\n | where EventID == 2889 \r\n | parse ParameterXml with * '><Param>' Account '</' *\r\n | parse ParameterXml with * '<Param>' IPAddress ':' * \r\n | parse kind = regex ParameterXml with * '</Param><Param>' * '</Param><Param>' BindingType '</Param>'\r\n | summarize QueryCount = count(EventID) by IPAddress, Account\r\n","size":0,"title":"By Source IP - click to filter","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"IPAddress","exportParameterName":"IPAddress","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Account","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}},{"columnMatch":"QueryCount","formatter":4,"formatOptions":{"min":1,"palette":"blueDark","showIcon":true,"aggregation":"Sum"}},{"columnMatch":"Account Count","formatter":4,"formatOptions":{"min":0,"palette":"blue","showIcon":true,"aggregation":"Unique"}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"magenta","showIcon":true}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Computer","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}},{"columnMatch":"LDAPClient","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}}],"sortBy":[{"itemKey":"$gen_bar_QueryCount_2","sortOrder":2}],"labelSettings":[{"columnId":"IPAddress","label":"Source IP"},{"columnId":"Account"},{"columnId":"QueryCount","label":"Number of Insedcure Binds"}]},"sortBy":[{"itemKey":"$gen_bar_QueryCount_2","sortOrder":2}]},"customWidth":"20","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"LDAP"},"name":"query - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event \r\n | where EventID == 2889 \r\n | parse ParameterXml with * '><Param>' Accounts '</' *\r\n | parse ParameterXml with * '<Param>' IPAddress ':' * \r\n | parse kind = regex ParameterXml with * '</Param><Param>' * '</Param><Param>' BindingType '</Param>'\r\n | extend TimeFromNow = now() - TimeGenerated\r\n | extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n | where IPAddress == '{IPAddress:escape}' or '{IPAddress:escape}' == \"All\"\r\n | summarize count() by IPAddress, bin(TimeGenerated, {TimeRange:grain})","size":0,"title":"IP addresses events over time - select timebrush","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"LDAPTimebrushIP","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart"},"customWidth":"30","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"LDAP"},"name":"query - 12"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event \r\n | where EventID == 2889 \r\n | parse ParameterXml with * '><Param>' Accounts '</' *\r\n | parse ParameterXml with * '<Param>' IPAddress ':' * \r\n | parse kind = regex ParameterXml with * '</Param><Param>' * '</Param><Param>' BindingType '</Param>'\r\n | extend TimeFromNow = now() - TimeGenerated\r\n | extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n | where IPAddress == '{IPAddress:escape}' or '{IPAddress:escape}' == \"All\"\r\n | extend BindingType = case(BindingType==0,\"Unsigned\",BindingType==1,\"Simple\",\"Unknown\")\r\n | project IPAddress, Accounts, Computer, RenderedDescription, UserName, EventID, BindingType, Time_of_Bind=TimeAgo","size":0,"showAnalytics":true,"title":"Source IP Details","timeContext":{"durationMs":0},"timeContextFromParameter":"LDAPTimebrushIP","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"IPAddress","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true,"showIcon":true}},{"columnMatch":"RenderedDescription","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"UserName","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"EventID","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"LDAP"},"name":"query - 8"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"LDAP"},"name":"group - LDAP"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Group: NTLMv1","items":[{"type":1,"content":{"json":"### NTLM Help File\r\n\r\n**Protocol Risk**\r\n\t* It is far less complex for an attacker to anticipate the challenge length in NTLMv1, as it is always a 16-byte random number. NTLMv2, on the other hand, uses a challenge of variable length.\r\n\t* Recall also that NTLMv1 uses DES encryption, whereas NTLMv2 uses the stronger HMAC-MD5. As of now, it’s less likely that an attacker can successfully brute-force HMAC-MD5.\r\n\t* Also, because NTLMv1 is so much less secure, the only protocols that Windows Defender Credential Guard supports are Kerberos and NTLMv2. You’ll have to address the sources of NTLMv1 before using Credential Guard.\r\n\r\n**Auditing Settings**\r\n\t* Set auditing for 4624 and 4625, and also for 4776 via Group Policy.\r\n\t\t* Windows Settings/Security Settings/Advanced Audit Configuration/Account Logon/Logon/Logoff/Audit Credential Validation with value of “Success, Failure.”\r\n\t\t* Windows Settings/Security Settings/Advanced Audit Configuration/(Logon/Logoff)/Audit Logoff with value of \"Success, Failure.\"\r\n\t\t* Windows Settings/Security Settings/Advanced Audit Configuration/(Logon/Logoff)/Audit Logon with value of \"Success, Failure.\"\r\n\r\n**Mitigation Planning**\r\n\t* Work with application owners and vendors to use a more secure protocol like Kerberos or NTLMv2.\r\n\t* Where unsupported operating systems, old applications or outdated appliances cannot use Kerberos or NTLMv2, work with decision makers to understand the risks to the organization.\r\n\t* Create a plan to remove the problem devices, applications and appliances from the network.\r\n\r\n**Data Filters**\r\n\t* Source and server\r\n\t* Timebrush\r\n\t* NTLM v1 event details by time","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent \r\n| where EventID == 4624 \r\n| where AuthenticationPackageName == 'NTLM' \r\n| where LmPackageName == 'NTLM V1'  \r\n| where Account !contains 'ANONYMOUS LOGON' \r\n| summarize Count = count() by WorkstationName, Computer \r\n| project WorkstationName, Computer, Count\r\n| order by Count desc\r\n","size":0,"title":"NTLM v1 events, by Source and server - click to filter","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"","exportParameterName":"WorkstationName","exportDefaultValue":"{\"WorkstationName\":\"All\"}","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"WorkstationName","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Computer","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}},{"columnMatch":"Count","formatter":4,"formatOptions":{"min":0,"palette":"blue","showIcon":true,"aggregation":"Sum"}}],"hierarchySettings":{"treeType":1,"groupBy":["WorkstationName"]},"sortBy":[{"itemKey":"Computer","sortOrder":2}]},"sortBy":[{"itemKey":"Computer","sortOrder":2}],"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"WorkstationName","formatter":1},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"NTLM"},"name":"query - 6"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent \r\n| where EventID == 4624 \r\n| where AuthenticationPackageName == 'NTLM' \r\n| where LmPackageName == 'NTLM V1'  \r\n| where Account !contains 'ANONYMOUS LOGON' \r\n| where '{WorkstationName:escape}' contains \"All\" or '{WorkstationName:escape}' contains WorkstationName\r\n| summarize Count=count() by WorkstationName, Day=bin(TimeGenerated, {TimeRange:grain}) ","size":0,"title":"NTLM v1 events, by time","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"NTLMTimebrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart"},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"NTLM"},"name":"query - 15"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent \r\n| where EventID == 4624 \r\n| where AuthenticationPackageName == 'NTLM' \r\n| where LmPackageName == 'NTLM V1'  \r\n| where Account !contains 'ANONYMOUS LOGON' \r\n| where '{WorkstationName:escape}' contains \"All\" or ('{WorkstationName:escape}' contains WorkstationName and '{WorkstationName:escape}' contains Computer)\r\n| summarize Count = count() by Account, WorkstationName, DC=Computer, LogonProcessName, TargetDomainName, TargetAccount, IpAddress\r\n| sort by Count desc  ","size":0,"showAnalytics":true,"title":"NTLM v1 events details","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Count","formatter":8,"formatOptions":{"palette":"greenRed","showIcon":true}}],"filter":true}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"NTLM"},"name":"query - 16"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"NTLM"},"name":"Group - NTLM"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Group: SMBv1","items":[{"type":1,"content":{"json":"### SMB Help File\r\n\r\n**Protocol Risk**\r\n\t* The security built into SMBv2 and SMBv3 is primarily around protecting against security downgrade attacks (Pre-authentication Integrity, Secure Dialect Negotiation) and attacker-in-the-middle attacks (Encryption, Insecure guest auth blocking). SMB1 simply doesn’t know about or contain any of these protections.\r\n\t* If you have SMBv1 enabled on your file servers or domain controllers, then an attacker-in-the-middle can simply block SMB2/3 and force a downgrade attack. The net effect here will be that your computer(s) will gracefully flip over to SMBv1, thereby exposing the exchange’s data.\r\n\t* SMBv1 continues to be a primary component in destructive ransomware attacks.\r\n\r\n**Auditing Settings**\r\n\t* On the servers that you will audit, run the following Powershell command to enable auditing: Set-SmbServerConfiguration –AuditSmb1Access $true\r\n\t* Note that this auditing is only supported on Sever 2016/Windows 10 and Server 2012 R2/Windcows 8.1 via an update.\r\n\t* Finally, in the Log Analytics configuration, you will need to set “Collect events from the following event logs” to Microsoft-Windows-SMBServer/Audit and set the log type to INFORMATION.\"\r\n\r\n**Mitigation Planning**\r\n\t* Work with application owners and vendors to use a more secure SMB version, such as SMBv2 or SMBv3.\r\n\t* Once there is no more SMBv1, set the DCs to no longer accept it. Registry key: HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters\r\n\tSet this to a value SMB1 REG_DWORD: 0 = Disabled.\r\n\r\n**Data Filters**\r\n\t* Events by client \r\n\t* Server timebrush\r\n\t* Events by server","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 4"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = Event\r\n| where EventID == 3000 and EventLog == 'Microsoft-Windows-SMBServer/Audit' \r\n| parse ParameterXml with * '<Param>' ClientAddress '</' * \r\n| extend Client = replace(@'>', @'', replace(@'\\]', @'', replace(@'\\[', @'', replace(@'<!\\[CDATA', @'', ClientAddress))));\r\ndata\r\n| summarize Count = count() by Client\r\n| join kind = fullouter (datatable(Client:string)['Medium', 'high', 'low']) on Client\r\n| project Client = iff(Client == '', Client1, Client), Count = iff(Client == '', 0, Count)\r\n| join kind = inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Client)\r\n on Client\r\n| project-away Client1, TimeGenerated\r\n| extend Clients = Client\r\n| union (\r\n data \r\n | summarize Count = count() \r\n | extend jkey = 1\r\n | join kind=inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n | extend jkey = 1) on jkey\r\n | extend Client = 'All', Clients = '*' \r\n)\r\n| order by Count desc\r\n| take 10\r\n","size":4,"title":"SMB v1 events, by client - click to filter","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Client","exportParameterName":"ClientFilter","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Client","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"secondaryContent":{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"purple","showIcon":true}},"showBorder":false}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"SMB"},"name":"query - 18"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event\r\n| where EventID == 3000 and EventLog == 'Microsoft-Windows-SMBServer/Audit'\r\n| parse ParameterXml with * '<Param>' ClientAddress '</' *\r\n| extend Client = replace(@'>', @'', replace(@'\\]', @'', replace(@'\\[', @'', replace(@'<!\\[CDATA', @'', ClientAddress))))\r\n| where Client == '{ClientFilter}' or '{ClientFilter}' == \"All\"\r\n| summarize Count=count() by Client, SMBServer=Computer, ParameterXml, RenderedDescription, EventData\r\n| sort by Count desc","size":1,"showAnalytics":true,"title":"SMB v1 event details, by client","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"barchart","gridSettings":{"formatters":[{"columnMatch":"Client","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true,"showIcon":true}},{"columnMatch":"SMBServer","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}},{"columnMatch":"ParameterXml","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"RenderedDescription","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"EventData","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Count","formatter":8,"formatOptions":{"min":0,"palette":"greenBlue","showIcon":true,"aggregation":"Sum"}},{"columnMatch":"$gen_group","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true,"showIcon":true}}],"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["Client"]}}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"SMB"},"name":"query - 20"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event \r\n| where EventID == 3000 and EventLog == 'Microsoft-Windows-SMBServer/Audit' \r\n| parse ParameterXml with * '<Param>' ClientAddress '</' * \r\n| extend Client = replace(@'>', @'', replace(@'\\]', @'', replace(@'\\[', @'', replace(@'<!\\[CDATA', @'', ClientAddress)))) \r\n| where Client == '{ClientFilter}' or '{ClientFilter}' == \"All\"\r\n| summarize Count=count() by bin(TimeGenerated, 1h) , SMBServer=Computer \r\n\r\n","size":0,"title":"SMB v1 events, by time","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"SMBtimebrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"timechart"},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"SMB"},"name":"query - 19"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Event\r\n| where EventID == 3000 and EventLog == 'Microsoft-Windows-SMBServer/Audit'\r\n| parse ParameterXml with * '<Param>' ClientAddress '</' *\r\n| extend Client = replace(@'>', @'', replace(@'\\]', @'', replace(@'\\[', @'', replace(@'<!\\[CDATA', @'', ClientAddress))))\r\n| where Client == '{ClientFilter}' or '{ClientFilter}' == \"All\"\r\n| summarize Count=count() by Client, SMBServer=Computer, ParameterXml, RenderedDescription, EventData\r\n| sort by Count desc","size":0,"showAnalytics":true,"title":"SMBv1 events, by server","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Client","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true,"showIcon":true}},{"columnMatch":"SMBServer","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}},{"columnMatch":"ParameterXml","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"RenderedDescription","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"EventData","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Count","formatter":8,"formatOptions":{"min":0,"palette":"greenBlue","showIcon":true,"aggregation":"Sum"}},{"columnMatch":"$gen_group","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true,"showIcon":true}}],"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["Client"]}}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"SMB"},"name":"query - 20 - Copy"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"SMB"},"name":"group - SMBv1"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Group: Kerberos Ciphers","items":[{"type":1,"content":{"json":"### Kerberos Help File\r\n\r\n**Protocol Risk**\r\n\t\r\n\tWhen weak cipher suites are permitted for the Kerberos protocol, attackers can leverage encryption downgrades to their advantage and make the protocol easier to compromise.\r\n\tPossible encryption types:\r\n\t* DES_CBC_CRC | Weak\r\n\t* DES_CBC_MD5 | Weak\r\n\t* RC4_HMAC_MD5 | Moderate\r\n\t* AES128_HMAC_SHA1 | Strong\r\n\t* AES256_HMAC_SHA1 | Strong\r\n\t\r\n\tStarting in Windows Server 2008 / Windows Vista, AES encryption has been available for the Kerberos protocol. At present, all supported versions of Windows have DES encryption for Kerberos disabled by default. While DES can be enabled for backward compatibility, doing so will open up an attack vector.\r\n\r\n**Auditing Settings**\r\n\t\r\n\tUnder Account Logon, set the following audit settings to Success, Failure\r\n\t\t* Audit Kerberos Authentication Service\r\n\t\t* Audit Kerberos Service Ticket Operations\r\n\tUnder Logon/Logoff set the following settings to Success, Failure\r\n\t\t* Audit Logon\r\n\r\n**Mitigation Planning**\r\n\t* Weak Kerberos Ciphers can be caused by downlevel Operating Systems (Client or Server), Account Configuration issues, Trust Configuration Issues or 3rd party OS/Software configuration.\r\n\t* Look for patterns in the data that will help identify the cause of the weak cipher, such as accessing a common service, or a common set of workstations.\r\n\t* Once identified, work with the OS/Account/Trust owners to remediate the requirement for the weak cipher.\r\n\t* When the weak ciphers have been eliminated from the environment, disable them across your Windows Computers in the policy Computer Configuration\\Windows Settings\\Security Setting\\Local Policies\\Security Options\\Network security: Configure encryption types allowed for Kerberos.\r\n\r\n**Data Filters**\r\n\t* Timebrush\r\n\t* Weak ciphers event details\r\n\t* Weak ciphers event details by account\r\n\r\n** References **\r\n- [Network security: Configure encryption types allowed for Kerberos](https://docs.microsoft.com/windows/security/threat-protection/security-policy-settings/network-security-configure-encryption-types-allowed-for-kerberos)\r\n- [Advanced Security Audit Policy Settings](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn319056%28v=ws.11%29)\r\n","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 4","styleSettings":{"margin":"5"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID == 4768 or EventID == 4769\r\n| where Level == 8\r\n| parse EventData with * '\"TicketEncryptionType\">' TicketEncryptionType '<' *\r\n| where TicketEncryptionType != \"0x12\" and TicketEncryptionType != \"0x11\" //AES128/256, this filter needs to be activated\r\n| parse EventData with * '\"IpAddress\">' IpAddress '<' *\r\n| parse EventData with * '\"TargetUserName\">' TargetUserName '<' *\r\n| parse EventData with * '\"ServiceName\">' ServiceName '<' *\r\n| extend Cipher=replace('0x18$', 'RC4-HMAC-EXP', replace('0x12$', 'AES256-CTS-HMAC-SHA1', replace('0x11$', 'AES128-CTS-HMAC-SHA1', replace('0x1$', 'DES_CBC_CRC', replace('0x2$', 'DES_CBC_MD4', replace('0x7$', 'DES3_CBC_SHA1', replace('0x5$', 'DES3_CBC_MD5', replace('0x3$', 'DES_CBC_MD5', replace('0x17$', 'RC4_HMAC', TicketEncryptionType)))))))))\r\n| summarize Count=count() by Cipher\r\n","size":0,"title":"Kerberos weak ciphers - click to filter","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Cipher","exportParameterName":"CipherParameter","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Count","formatter":4,"formatOptions":{"min":1,"palette":"blue"}}]},"graphSettings":{"type":0,"topContent":{"columnMatch":"Cipher","formatter":1},"centerContent":{"columnMatch":"Count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Kerberos"},"name":"query - 22 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID == 4768 or EventID == 4769\r\n| where Level == 8\r\n| parse EventData with * '\"TicketEncryptionType\">' TicketEncryptionType '<' *\r\n| where TicketEncryptionType != \"0x12\" and TicketEncryptionType != \"0x11\" //AES128/256, this filter needs to be activated\r\n| parse EventData with * '\"IpAddress\">' IpAddress '<' *\r\n| parse EventData with * '\"TargetUserName\">' TargetUserName '<' *\r\n| parse EventData with * '\"ServiceName\">' ServiceName '<' *\r\n| extend Cipher=replace('0x18$', 'RC4-HMAC-EXP', replace('0x12$', 'AES256-CTS-HMAC-SHA1', replace('0x11$', 'AES128-CTS-HMAC-SHA1', replace('0x1$', 'DES_CBC_CRC', replace('0x2$', 'DES_CBC_MD4', replace('0x7$', 'DES3_CBC_SHA1', replace('0x5$', 'DES3_CBC_MD5', replace('0x3$', 'DES_CBC_MD5', replace('0x17$', 'RC4_HMAC', TicketEncryptionType)))))))))\r\n| where Cipher == '{CipherParameter}' or '{CipherParameter}' == \"All\"\r\n| summarize Count=count() by Cipher, IpAddress, TargetUserName , ServiceName, Computer, Activity\r\n| sort by Count desc\r\n","size":0,"title":"Kerberos weak ciphers event details - filtered by cipher","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"TargetUserName","exportParameterName":"targetUserNameKerberosParameter","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Cipher","formatter":5,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true}},{"columnMatch":"IpAddress","formatter":5},{"columnMatch":"ServiceName","formatter":5},{"columnMatch":"Computer","formatter":5},{"columnMatch":"Count","formatter":8,"formatOptions":{"min":0,"palette":"greenRed"}}],"filter":true}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Kerberos"},"name":"query - 23 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID == 4768 or EventID == 4769\r\n| where Level == 8\r\n| parse EventData with * '\"TicketEncryptionType\">' TicketEncryptionType '<' *\r\n| where TicketEncryptionType != \"0x12\" and TicketEncryptionType != \"0x11\" //AES128/256, this filter needs to be activated\r\n| parse EventData with * '\"IpAddress\">' IpAddress '<' *\r\n| parse EventData with * '\"TargetUserName\">' TargetUserName '<' *\r\n| parse EventData with * '\"ServiceName\">' ServiceName '<' *\r\n| extend Cipher=replace('0x18$', 'RC4-HMAC-EXP', replace('0x12$', 'AES256-CTS-HMAC-SHA1', replace('0x11$', 'AES128-CTS-HMAC-SHA1', replace('0x1$', 'DES_CBC_CRC', replace('0x2$', 'DES_CBC_MD4', replace('0x7$', 'DES3_CBC_SHA1', replace('0x5$', 'DES3_CBC_MD5', replace('0x3$', 'DES_CBC_MD5', replace('0x17$', 'RC4_HMAC', TicketEncryptionType)))))))))\r\n| summarize Count=count() by Cipher, bin(TimeGenerated, 1h)\r\n","size":0,"title":"Kerberos weak ciphers - select to timebrush","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"KeberosTimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Kerberos"},"name":"query - 22"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID == 4768 or EventID == 4769\r\n| where Level == 8\r\n| parse EventData with * '\"TicketEncryptionType\">' TicketEncryptionType '<' *\r\n| where TicketEncryptionType != \"0x12\" and TicketEncryptionType != \"0x11\" //AES128/256, this filter needs to be activated\r\n| parse EventData with * '\"IpAddress\">' IpAddress '<' *\r\n| parse EventData with * '\"TargetUserName\">' TargetUserName '<' *\r\n| parse EventData with * '\"ServiceName\">' ServiceName '<' *\r\n| extend Cipher=replace('0x18$', 'RC4-HMAC-EXP', replace('0x12$', 'AES256-CTS-HMAC-SHA1', replace('0x11$', 'AES128-CTS-HMAC-SHA1', replace('0x1$', 'DES_CBC_CRC', replace('0x2$', 'DES_CBC_MD4', replace('0x7$', 'DES3_CBC_SHA1', replace('0x5$', 'DES3_CBC_MD5', replace('0x3$', 'DES_CBC_MD5', replace('0x17$', 'RC4_HMAC', TicketEncryptionType)))))))))\r\n| summarize Count=count() by Cipher, IpAddress, TargetUserName , ServiceName, Computer, Activity\r\n| sort by Count desc\r\n","size":0,"showAnalytics":true,"title":"Kerberos weak ciphers event details: {KeberosTimeBrush:label} - select TargetUserName for details","timeContext":{"durationMs":0},"timeContextFromParameter":"KeberosTimeBrush","exportFieldName":"TargetUserName","exportParameterName":"targetUserNameKerberosParameter","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Cipher","formatter":5,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true}},{"columnMatch":"IpAddress","formatter":5},{"columnMatch":"ServiceName","formatter":5},{"columnMatch":"Computer","formatter":5},{"columnMatch":"Count","formatter":8,"formatOptions":{"min":0,"palette":"greenRed"}}],"filter":true}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Kerberos"},"name":"query - 23"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID == 4768 or EventID == 4769\r\n| where Level == 8\r\n| parse EventData with * '\"TicketEncryptionType\">' TicketEncryptionType '<' *\r\n| where TicketEncryptionType != \"0x12\" and TicketEncryptionType != \"0x11\" //AES128/256, this filter needs to be activated\r\n| parse EventData with * '\"IpAddress\">' IpAddress '<' *\r\n| extend IpAddress = tostring(split(IpAddress,\"f:\").[1])\r\n| parse EventData with * '\"TargetUserName\">' TargetUserName '<' *\r\n| parse EventData with * '\"ServiceName\">' ServiceName '<' *\r\n| extend Cipher=replace('0x18$', 'RC4-HMAC-EXP', replace('0x12$', 'AES256-CTS-HMAC-SHA1', replace('0x11$', 'AES128-CTS-HMAC-SHA1', replace('0x1$', 'DES_CBC_CRC', replace('0x2$', 'DES_CBC_MD4', replace('0x7$', 'DES3_CBC_SHA1', replace('0x5$', 'DES3_CBC_MD5', replace('0x3$', 'DES_CBC_MD5', replace('0x17$', 'RC4_HMAC', TicketEncryptionType)))))))))\r\n//| where TargetUserName in ('{targetUserNameKerberosParameter}')\r\n| where TargetUserName == '{targetUserNameKerberosParameter:escape}' or  '{targetUserNameKerberosParameter:escape}' == \"All\"\r\n| summarize OldestRecord = min(TimeGenerated), NewestRecord = max(TimeGenerated), Count=count() by TargetUserName, Cipher, IpAddress , ServiceName, Computer, Activity\r\n| sort by Count desc\r\n","size":0,"showAnalytics":true,"title":"Kerberos weak ciphers event details: {targetUserNameKerberosParameter}, {KeberosTimeBrush:label}","timeContext":{"durationMs":0},"timeContextFromParameter":"KeberosTimeBrush","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Cipher","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true}},{"columnMatch":"EventData","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true}},{"columnMatch":"Count","formatter":8,"formatOptions":{"min":0,"palette":"greenRed"}}],"filter":true,"labelSettings":[{"columnId":"TargetUserName"},{"columnId":"Cipher"},{"columnId":"IpAddress"},{"columnId":"ServiceName"},{"columnId":"Computer"}]},"sortBy":[]},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Kerberos"},"name":"query - 23 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where EventID == 4768 or EventID == 4769\r\n| where Level == 8\r\n| parse EventData with * '\"TicketEncryptionType\">' TicketEncryptionType '<' *\r\n| where TicketEncryptionType != \"0x12\" and TicketEncryptionType != \"0x11\" //AES128/256, this filter needs to be activated\r\n| parse EventData with * '\"IpAddress\">' IpAddress '<' *\r\n| extend IpAddress = tostring(split(IpAddress,\"f:\").[1])\r\n| parse EventData with * '\"TargetUserName\">' TargetUserName '<' *\r\n| parse EventData with * '\"ServiceName\">' ServiceName '<' *\r\n| extend Cipher=replace('0x18$', 'RC4-HMAC-EXP', replace('0x12$', 'AES256-CTS-HMAC-SHA1', replace('0x11$', 'AES128-CTS-HMAC-SHA1', replace('0x1$', 'DES_CBC_CRC', replace('0x2$', 'DES_CBC_MD4', replace('0x7$', 'DES3_CBC_SHA1', replace('0x5$', 'DES3_CBC_MD5', replace('0x3$', 'DES_CBC_MD5', replace('0x17$', 'RC4_HMAC', TicketEncryptionType)))))))))\r\n| summarize OldestRecord = min(TimeGenerated), NewestRecord = max(TimeGenerated), Count=count() by TargetUserName, Cipher, IpAddress , ServiceName, Computer, Activity\r\n| sort by Count desc\r\n","size":0,"showAnalytics":true,"title":"Kerberos weak ciphers event details unfiltered","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Cipher","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true}},{"columnMatch":"EventData","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true}},{"columnMatch":"Count","formatter":8,"formatOptions":{"min":0,"palette":"greenRed"}}],"filter":true,"labelSettings":[{"columnId":"TargetUserName"},{"columnId":"Cipher"},{"columnId":"IpAddress"},{"columnId":"ServiceName"},{"columnId":"Computer"}]},"sortBy":[]},"conditionalVisibilities":[{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Kerberos"},{"parameterName":"targetUserNameKerberosParameter","comparison":"isNotEqualTo"}],"name":"query - 23 - Copy - Copy"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Kerberos"},"name":"Group - Kerberos"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Group: WDigest","items":[{"type":1,"content":{"json":"### WDigest Help File\r\n\r\n**Protocol Risk**\r\n\t* WDigest is a deprecated protocol. It injects plain-text passwords into memory.\r\n\t* Attackers can simply read the plaintext passwords using commodity tools.\r\n\t* Also, because WDigest is so much less secure, it is not supported in Windows Defender Credential Guard. You’ll have to address the sources of WDigest before using Credential Guard.\r\n\r\n**Auditing Settings**\r\n\t* Set auditing for 4776 (non-Kerberos logon) – Windows Settings/Security Settings/Advanced Audit Configuration/Account Logon/ Logon/Logoff/Audit Credential Validation with value of “Success, Failure.”\r\n\r\n**Mitigation Planning**\r\n\t* Work with application owners and vendors to use a more secure protocol like NTLMv2 or Kerberos.\r\n\t* Once there is no more Digest, set the DCs to no longer accept it. Registry (may be done via GP Preferences): HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest\\ “UseLogonCredential\r\n\t* Set this to a value of 0. A restart is required.\r\n\r\n**Data Filters**\r\n\t* Account workstation\r\n\t* Workstation over time\r\n\t* Account timebrush\r\n","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SecurityEvent \r\n| where EventID == 4624 or EventID == 4776 \r\n| where Level == 8 \r\n| where PackageName contains 'WDigest';\r\nlet appData = data\r\n| summarize TotalCount = count() by TargetAccount\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by TargetAccount\r\n    | project-away TimeGenerated) on TargetAccount\r\n| order by TotalCount desc, TargetAccount asc\r\n| project TargetAccount, TotalCount, Trend\r\n| serialize Id = row_number();\r\ndata\r\n| summarize TotalCount = count() by Workstation , TargetAccount\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by TargetAccount, Workstation\r\n    | project-away TimeGenerated) on TargetAccount, Workstation\r\n| order by TotalCount desc, TargetAccount asc\r\n| project TargetAccount, Workstation, TotalCount, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on TargetAccount\r\n| project Id, Name = Workstation, Type = 'Workstation', ['TargetAccounts Count'] = TotalCount, Trend,  ParentId = Id1\r\n| union (appData \r\n    | project Id, Name = TargetAccount, Type = 'TargetAccount', ['TargetAccounts Count'] = TotalCount,  Trend)\r\n| order by ['TargetAccounts Count'] desc, Name asc\r\n","size":0,"title":"WDigest, by account workstation - click to filter","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportParameterName":"WDigest","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\"}","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"TargetAccounts Count","formatter":8,"formatOptions":{"min":0,"palette":"blue","showIcon":true}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"min":0,"palette":"orange","showIcon":true}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}}],"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name"}},"graphSettings":{"type":0,"topContent":{"columnMatch":"Name","formatter":1},"centerContent":{"columnMatch":"Id","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WDigest"},"name":"query - 25"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({WDigest});\r\nSecurityEvent \r\n| where EventID == 4624 or EventID == 4776 \r\n| where Level == 8 \r\n| where PackageName contains 'WDigest' \r\n| where (details.Type == 'Workstation' and details.Name == Workstation) or (details.Type == 'TargetAccount' and details.Name == TargetAccount) or (details.Type == '*')\r\n| summarize Count=count() by Workstation,  bin(TimeGenerated, 1h)","size":0,"title":"WDigest Workstation over Time","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"wDigestTimeBrushAccount","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart"},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WDigest"},"name":"query - 26"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({WDigest});\r\nSecurityEvent\r\n| where EventID == 4624 or EventID == 4776\r\n| where Level == 8\r\n| where PackageName contains 'WDigest'\r\n| where (details.Type == 'Workstation' and details.Name == Workstation) or (details.Type == 'TargetAccount' and details.Name == TargetAccount) or (details.Type == '*')\r\n| summarize Count=count() by TargetAccount, Workstation, WDigestServer=Computer , Activity\r\n| sort by Count desc","size":0,"showAnalytics":true,"title":"WDigest Account over time {{wDigestTimeBrushAccount:label})","timeContext":{"durationMs":0},"timeContextFromParameter":"wDigestTimeBrushAccount","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Count","formatter":4,"formatOptions":{"min":0,"palette":"coldHot","showIcon":true}}],"filter":true}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WDigest"},"name":"query - 27"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"WDigest"},"name":"WDigest"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Group: AAD Legacy Auth","items":[{"type":1,"content":{"json":"### AAD Legacy Auth Help File\r\n\r\n**Protocol Risk**\r\n\t* Legacy authentication protocols like POP, SMTP, IMAP, and MAPI can't enforce MFA, making them preferred entry points for adversaries attacking your organization.\r\n\t* The numbers on legacy authentication from an analysis of Azure Active Directory (Azure AD) traffic are stark:\r\n\t\t* More than 99 percent of password spray attacks use legacy authentication protocols\r\n\t\t* More than 97 percent of credential stuffing attacks use legacy authentication\r\n\t\t* Azure AD accounts in organizations that have disabled legacy authentication experience 67 percent fewer compromises than those where legacy authentication is enabled\r\n\r\n**Legacy Authentication Protocols**\r\nThe following options are considered legacy authentication protocols\r\n\t* Authenticated SMTP - Used by POP and IMAP client's to send email messages.\r\n\t* Autodiscover - Used by Outlook and EAS clients to find and connect to mailboxes in Exchange Online.\r\n\t* Exchange ActiveSync (EAS) - Used to connect to mailboxes in Exchange Online.\r\n\t* Exchange Online PowerShell - Used to connect to Exchange Online with remote PowerShell. If you block Basic authentication for Exchange Online PowerShell, you need to use the Exchange Online PowerShell Module to connect. For instructions, see Connect to Exchange Online PowerShell using multi-factor authentication.\r\n\t* Exchange Web Services (EWS) - A programming interface that's used by Outlook, Outlook for Mac, and third-party apps.\r\n\t* IMAP4 - Used by IMAP email clients.\r\n\t* MAPI over HTTP (MAPI/HTTP) - Used by Outlook 2010 and later.\r\n\t* Offline Address Book (OAB) - A copy of address list collections that are downloaded and used by Outlook.\r\n\t* Outlook Anywhere (RPC over HTTP) - Used by Outlook 2016 and earlier.\r\n\t* Outlook Service - Used by the Mail and Calendar app for Windows 10.\r\n\t* POP3 - Used by POP email clients.\r\n\t* Reporting Web Services - Used to retrieve report data in Exchange Online.\r\n\t* Other clients - Other protocols identified as utilizing legacy authentication.\r\n\r\n**Mitigation Planning**\r\n\t* Before you can block legacy authentication in your directory, you need to first understand if your users have apps that use legacy authentication and how it affects your overall directory.\r\n\t* Azure AD supports several of the most widely used authentication and authorization protocols including legacy authentication. Legacy authentication refers to protocols that use basic authentication. Typically, these protocols can't enforce any type of second factor authentication. * Examples for apps that are based on legacy authentication are:\r\n\t\t* Older Microsoft Office apps\r\n\t\t* Apps using mail protocols like POP, IMAP, and SMTP\r\n\t\t* Single factor authentication (for example, username and password) is not enough these days.\r\n\t\t* Passwords are bad as they are easy to guess and we (humans) are bad at choosing good passwords. Passwords are also vulnerable to a variety of attacks like phishing and password spray. One of the easiest things you can do to protect against password threats is to implement MFA. With MFA, even if an attacker gets in possession of a user's password, the password alone is not sufficient to successfully authenticate and access the data.\r\n\r\n\tHow can you prevent apps using legacy authentication from accessing your tenant's resources? The recommendation is to just block them with a Conditional Access policy. If necessary, you allow only certain users and specific network locations to use apps that are based on legacy authentication.\r\n\r\n**Data Filters**\r\n\t* Account\r\n\t* IP address\r\n\t* Account timebrush\r\n\t* IP timebrush\r\n\t* Auth type\r\n\t* Country/region\r\n\t* Full details\r\n\r\n** References   **\r\n- [How to: Block legacy authentication to Azure AD with Conditional Access](https://docs.microsoft.com/azure/active-directory/conditional-access/block-legacy-authentication#:~:text=To%20give%20your%20users%20easy%20access%20to%20your,environments%20a%20common%20requirement%20to%20address%20identity%20theft)","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 9"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize Count=count() by UserPrincipalName, ClientAppUsed //doughnut\r\n| order by Count desc","size":0,"title":"Legacy authentications, by account","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"UserPrincipalName","exportParameterName":"UserPrincipalName","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"count_","formatter":4,"formatOptions":{"min":1,"palette":"blue"}}],"filter":true},"sortBy":[]},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AADLegacy"},"name":"query - 29"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize Count=count() by IPAddress,ClientAppUsed //doughnut\r\n| order by Count desc","size":0,"title":"Legacy authentications, by IP address","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"count_","formatter":4,"formatOptions":{"min":1,"palette":"orange"}}],"filter":true}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AADLegacy"},"name":"query - 30"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize count() by UserPrincipalName, bin(TimeGenerated, {TimeRange:grain})\r\n| order by count_\r\n","size":1,"title":"Account events over time - select timebrush","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"AADTimebrushAccount","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart","gridSettings":{"formatters":[{"columnMatch":"CountryOrRegion","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"ClientAppUsed","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}},{"columnMatch":"count_","formatter":4,"formatOptions":{"min":0,"palette":"purple","showIcon":true,"aggregation":"Sum"}}],"hierarchySettings":{"treeType":1,"groupBy":["CountryOrRegion"]},"labelSettings":[{"columnId":"CountryOrRegion"},{"columnId":"ClientAppUsed"},{"columnId":"count_","label":"Count"}]}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AADLegacy"},"name":"query - 31 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\r\n| where TimeGenerated between ({AADTimebrushAccount:start}..({AADTimebrushAccount:end}+{AADTimebrushAccount:grain}))\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize Count=count() by UserPrincipalName, ClientAppUsed\r\n","size":1,"title":"Account events over time ({AADTimebrushAccount:label})","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"count_","formatter":4,"formatOptions":{"min":0,"palette":"blue","aggregation":"Sum"}}]}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AADLegacy"},"name":"query - 26"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize count() by IPAddress, bin(TimeGenerated, {TimeRange:grain})\r\n| order by count_\r\n","size":1,"title":"IPAddresses over time - select timebrush","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"AADTimebrushIPAddress","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart","gridSettings":{"formatters":[{"columnMatch":"CountryOrRegion","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"ClientAppUsed","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}},{"columnMatch":"count_","formatter":4,"formatOptions":{"min":0,"palette":"purple","showIcon":true,"aggregation":"Sum"}}],"hierarchySettings":{"treeType":1,"groupBy":["CountryOrRegion"]},"labelSettings":[{"columnId":"CountryOrRegion"},{"columnId":"ClientAppUsed"},{"columnId":"count_","label":"Count"}]}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AADLegacy"},"name":"IP Timebrush"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\r\n| where TimeGenerated between ({AADTimebrushAccount:start}..({AADTimebrushAccount:end}+{AADTimebrushAccount:grain}))\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize Count=count() by IPAddress, ClientAppUsed\r\n| order by Count\r\n","size":1,"title":"IP events over time ({AADTimebrushIPAddress:label})","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"count_","formatter":4,"formatOptions":{"min":0,"palette":"blue","aggregation":"Sum"}}],"sortBy":[{"itemKey":"IPAddress","sortOrder":2}]},"sortBy":[{"itemKey":"IPAddress","sortOrder":2}]},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AADLegacy"},"name":"query - 26 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize count() by ClientAppUsed, UserPrincipalName //bar","size":0,"title":"Legacy authentications, by authentication type","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"ClientAppUsed","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"UserPrincipalName","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}},{"columnMatch":"count_","formatter":4,"formatOptions":{"min":0,"palette":"gray","showIcon":true,"aggregation":"Sum"}}],"hierarchySettings":{"treeType":1,"groupBy":["ClientAppUsed"]},"labelSettings":[{"columnId":"ClientAppUsed"},{"columnId":"UserPrincipalName"},{"columnId":"count_","label":"Count"}]}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AADLegacy"},"name":"query - 32"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| summarize count() by tostring(CountryOrRegion=LocationDetails.countryOrRegion), ClientAppUsed //bar\r\n| order by count_\r\n","size":0,"title":"Legacy authentications, by country/region","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"CountryOrRegion","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"ClientAppUsed","formatter":0,"formatOptions":{"showIcon":true,"aggregation":"Unique"}},{"columnMatch":"count_","formatter":4,"formatOptions":{"min":0,"palette":"purple","showIcon":true,"aggregation":"Sum"}}],"hierarchySettings":{"treeType":1,"groupBy":["CountryOrRegion"]},"labelSettings":[{"columnId":"CountryOrRegion"},{"columnId":"ClientAppUsed"},{"columnId":"count_","label":"Count"}]}},"customWidth":"50","conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AADLegacy"},"name":"query - 31"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SigninLogs\r\n| where ResultType == 0\r\n| where ClientAppUsed !contains \"Browser\" and ClientAppUsed !contains \"Mobile Apps and Desktop clients\"\r\n| extend mergeCountry = toupper(LocationDetails.countryOrRegion)\r\n| summarize  IPaddress = make_set(IPAddress), Count=count() by UserPrincipalName,  ClientAppUsed, tostring(CountryOrRegion=mergeCountry) //table\r\n| order by Count desc","size":0,"showAnalytics":true,"title":"Legacy authentications details","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Count","formatter":8,"formatOptions":{"palette":"coldHot"}}],"filter":true},"sortBy":[]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AADLegacy"},"name":"query - 33"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AADLegacy"},"name":"group - AAD"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Group: Vulnerable Secure Channel","items":[{"type":1,"content":{"json":"### Vulnerable Netlogon Secure Channel Help\r\n\r\n**Protocol Risk**\r\n\t* An elevation of privilege vulnerability exists when an attacker establishes a vulnerable Netlogon secure channel connection to a domain controller\r\n\t* An attacker who successfully exploited the vulnerability could run a specially crafted application on a device on the network\r\n\r\n**Auditing Settings**\r\n\t* Apply relevant update from CVE-2020-1472 to enable logging\r\n\t* In Log Analytics/Sentinel, set log collection to include Warning and Errors from the System Event log\r\n\r\n**Mitigation Planning**\r\n\t* Review All Connections with an Insecure Netlogon Secure Channel\r\n\t* Enforcement Mode is scheduled to be enabled on February 9, 2021\r\n\t* Prior to Enforcement Mode enablement, ensure that all Netlogon clients are upgraded\r\n\t* If upgrade is not possible at this time, grant an exemption in the Group Policy: Domain controller: Allow vulnerable Netlogon secure channel connections\r\n\t* To enter Enforcement Mode ahead of schedule, configure the REG_DWORD FullSecureChannelProtection in key HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\Netlogon\\Parameters to a value of 1\r\n\r\n**Data Filters**\r\n\t* Machine\r\n\t* ClientIP\r\n\t* Status\r\n\r\n** References   **\r\n- [How to manage the changes in Netlogon secure channel connections associated with CVE-2020-1472](https://support.microsoft.com/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc)","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"text - 9 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let scEvents = dynamic([5827, 5828, 5829, 5830, 5831]);\r\nEvent\r\n| where EventID in (scEvents)\r\n| where EventLog =~ \"System\" and Source =~ \"NETLOGON\"\r\n| extend Status = case(EventID == 5827 or EventID == 5828, \"Connection Denied\", EventID == 5829, \"Connection Allowed - Enforcement Mode Off\", EventID == 5830 or EventID == 5831, \"Connection Allowed - Policy\", \"Unknown\")\r\n| summarize Count=count() by Status\r\n| sort by Count desc","size":4,"title":"Secure Channel Status - click to filter","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Status","exportParameterName":"Status","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Status","formatter":1},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"customWidth":"50","name":"query - 4"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let scEvents = dynamic([5827, 5828, 5829, 5830, 5831]);\r\nEvent\r\n| where EventID in (scEvents)\r\n| where EventLog =~ \"System\" and Source =~ \"NETLOGON\"\r\n| extend Status = case(EventID == 5827 or EventID == 5828, \"Connection Denied\", EventID == 5829, \"Connection Allowed - Enforcement Mode Off\", EventID == 5830 or EventID == 5831, \"Connection Allowed - Policy\", \"Unknown\")\r\n| summarize Count=count() by bin(TimeGenerated, {TimeRange:grain}), Status","size":1,"title":"Secure Channel by Time","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"customWidth":"50","name":"query - 8"},{"type":1,"content":{"json":"### Machine Accounts \r\n---"},"name":"text - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let scEvents = dynamic([5827, 5829, 5830]);\r\nEvent\r\n| where EventID in (scEvents)\r\n| where EventLog =~ \"System\" and Source =~ \"NETLOGON\"\r\n| parse ParameterXml with \"<Param>\" Machine \"</P\" * \"<Param>\" Domain \"</P\" * \"<Param>\" AccountType \"</P\" * \"<Param>\" OperatingSystem \"</P\" *\r\n| extend Status = case(EventID == 5827 or EventID == 5828, \"Connection Denied\", EventID == 5829, \"Connection Allowed - Enforcement Mode Off\", EventID == 5830 or EventID == 5831, \"Connection Allowed - Policy\", \"Unknown\")\r\n| where Status =~ \"{Status}\" or \"{Status}\" =~ \"All\"\r\n| summarize Count=count() by Machine, Status\r\n| order by Count desc","size":0,"title":"By Machine - click to filter","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Machine","exportParameterName":"Machine","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Count","formatter":4,"formatOptions":{"min":1,"palette":"orange"}}]},"sortBy":[]},"customWidth":"30","name":"By Machine"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let scEvents = dynamic([5827, 5829, 5830]);\r\nEvent\r\n| where EventID in (scEvents)\r\n| where EventLog =~ \"System\" and Source =~ \"NETLOGON\"\r\n| parse ParameterXml with \"<Param>\" Machine \"</P\" * \"<Param>\" Domain \"</P\" * \"<Param>\" AccountType \"</P\" * \"<Param>\" OperatingSystem \"</P\" *\r\n| where Machine =~ \"{Machine}\" or \"{Machine}\" =~ \"All\"\r\n| extend Status = case(EventID == 5827 or EventID == 5828, \"Connection Denied\", EventID == 5829, \"Connection Allowed - Enforcement Mode Off\", EventID == 5830 or EventID == 5831, \"Connection Allowed - Policy\", \"Unknown\")\r\n| where Status =~ \"{Status}\" or \"{Status}\" =~ \"All\"\r\n| summarize FirstOccurance=min(TimeGenerated), LastOccurance=max(TimeGenerated), Count=count() by DomainController=Computer, Machine, Domain, AccountType, OperatingSystem, EventID, Status\r\n","size":0,"showAnalytics":true,"title":"Machine Account Connections","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"customWidth":"70","name":"query - 0"},{"type":1,"content":{"json":"### Trust Accounts\r\n---"},"name":"text - 6"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let scEvents = dynamic([5828, 5831]);\r\nEvent\r\n| where EventID in (scEvents)\r\n| where EventLog =~ \"System\" and Source =~ \"NETLOGON\"\r\n| parse ParameterXml with \"<Param>\" AccountType \"</P\" * \"<Param>\" TrustName \"</P\" * \"<Param>\" TrustTarget \"</P\" * \"<Param>\" ClientIP \"</P\" *\r\n| extend Status = case(EventID == 5827 or EventID == 5828, \"Connection Denied\", EventID == 5829, \"Connection Allowed - Enforcement Mode Off\", EventID == 5830 or EventID == 5831, \"Connection Allowed - Policy\", \"Unknown\")\r\n| where Status =~ \"{Status}\" or \"{Status}\" =~ \"All\"\r\n| summarize Count=count() by ClientIP, Status\r\n| order by Count desc","size":0,"title":"By Trust Account - click to filter","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"ClientIP","exportParameterName":"ClientIP","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Count","formatter":4,"formatOptions":{"min":1,"palette":"orange"}}]}},"customWidth":"30","name":"query - 7"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let scEvents = dynamic([5828, 5831]);\r\nEvent\r\n| where EventID in (scEvents)\r\n| where EventLog =~ \"System\" and Source =~ \"NETLOGON\"\r\n| parse ParameterXml with \"<Param>\" AccountType \"</P\" * \"<Param>\" TrustName \"</P\" * \"<Param>\" TrustTarget \"</P\" * \"<Param>\" ClientIP \"</P\" *\r\n| where ClientIP =~ \"{ClientIP}\" or \"{ClientIP}\" =~ \"All\"\r\n| extend Status = case(EventID == 5827 or EventID == 5828, \"Connection Denied\", EventID == 5829, \"Connection Allowed - Enforcement Mode Off\", EventID == 5830 or EventID == 5831, \"Connection Allowed - Policy\", \"Unknown\")\r\n| where Status =~ \"{Status}\" or \"{Status}\" =~ \"All\"\r\n| summarize FirstOccurance=min(TimeGenerated), LastOccurance=max(TimeGenerated), Count=count() by DomainController=Computer, AccountType, TrustName, TrustTarget, ClientIP, EventID, Status","size":0,"showAnalytics":true,"title":"Trust Account Connections","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"sortBy":[{"itemKey":"ClientIP","sortOrder":1}]},"sortBy":[{"itemKey":"ClientIP","sortOrder":1}]},"customWidth":"70","name":"query - 0 - Copy"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"NetlogonSC"},"name":"NetlogonSC"}],"fromTemplateId":"sentinel-UserWorkbook","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FInsecureProtocol.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## MITRE
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/MITRE.json)

### Workbook details

> Description: This workbook will get a report on attacks using MITRE reference.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"3ac5e194-a6a4-4405-8370-6da952e8bc5b","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Overview","subTarget":"Overview","style":"link"},{"id":"1ba43bf0-5c1a-4081-b357-34f5389cf5f2","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"DataSource Statistics","subTarget":"DataSourceStatistics","style":"link"},{"id":"c5d475b0-86f9-4e78-8b32-d19631bc68de","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Azure Sentinel Github","subTarget":"AzureSentinelGithub","style":"link"},{"id":"90261d23-b3d6-4b6c-a22c-c74cfe8d2e23","cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Detection Platform Services","subTarget":"DetectionPlatformServices","style":"link"}]},"name":"links - 0"},{"type":1,"content":{"json":"## Overview\r\n\r\nThis workbook provides \r\n- Default Overview of DataSource Statistics from Usage Table and Detection coverage in existing Azure Sentinel Workspace from SecurityAlerts Table.\r\n\t- This can be changed to rules coverage by following Azure Sentinel API Notebook section, ingest rules data and point to new CustomLogs table \r\n\t- Refer Notebook section : [![nbviewer](https://raw.githubusercontent.com/jupyter/design/master/logos/Badges/nbviewer_badge.svg)](https://nbviewer.jupyter.org/github/Azure/Azure-Sentinel/blob/master/Sample%20Data/MITRE%20ATT%26CK/MITRE%20ATT%26CK%20for%20Azure%20Sentinel.ipynb#Retrieve-via-Azure-Sentinel-API---Experimental)\r\n- Global Detection Statistics available from Azure Sentinel Community Github\r\n- Other Microsoft Detection Platform Services (e.g. Azure Defender, AIP, MSDE, MCAS etc)\r\n\r\n"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Overview"},"name":"text - 1"},{"type":1,"content":{"json":"## Links and Resources\r\n\r\n- Azure Sentinel Github : https://github.com/Azure/Azure-Sentinel/\r\n- Azure Sentinel Fusion : https://docs.microsoft.com/en-us/azure/sentinel/fusion\r\n- Azure Defender: https://docs.microsoft.com/en-us/azure/security-center/alerts-reference\r\n- Azure Identity Protection (AIP): https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks\r\n- Microsoft Defender for Identity: https://docs.microsoft.com/en-us/advanced-threat-analytics/suspicious-activity-guide\r\n- Microsoft Cloud Application Security (MCAS) : https://docs.microsoft.com/en-us/cloud-app-security/investigate-anomaly-alerts"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Overview"},"name":"text - 2"},{"type":1,"content":{"json":"\r\n# ** Data Sources Available in Current Azure Sentinel **\r\n"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DataSourceStatistics"},"name":"text - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Usage \r\n| summarize SizeinMB = round(sum(Quantity),2) by DataType \r\n| sort by SizeinMB desc","size":0,"timeContext":{"durationMs":86400000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"categoricalbar"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DataSourceStatistics"},"name":"query - 4"},{"type":1,"content":{"json":"# Detections Coverage in Existing Azure Sentinel"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DataSourceStatistics"},"name":"text - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityAlert\r\n| where isnotempty(ProviderName)\r\n| summarize Count=dcount(AlertName) by ProviderName, VendorName","size":0,"timeContext":{"durationMs":2592000000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"ProviderName","formatter":1},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"graphSettings":{"type":0,"topContent":{"columnMatch":"ProviderName","formatter":1},"centerContent":{"columnMatch":"Count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DataSourceStatistics"},"customWidth":"50","name":"query - 6","styleSettings":{"maxWidth":"50"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityAlert\r\n| where isnotempty(ProviderName)\r\n| summarize Count=count() by ProviderName, VendorName, AlertName\r\n| sort by ProviderName","size":0,"timeContext":{"durationMs":86400000},"showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"rowLimit":500,"filter":true}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DataSourceStatistics"},"customWidth":"50","name":"query - 7","styleSettings":{"maxWidth":"50"}},{"type":1,"content":{"json":"## MITRE ATT&CK Coverage against Azure Sentinel Github\r\n\r\n# Links and Resources :\r\n- Tactics : https://attack.mitre.org/tactics/enterprise/\r\n- Enterprise Matrix : https://attack.mitre.org/matrices/enterprise/\r\n"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AzureSentinelGithub"},"name":"text - 8"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let SentinelGithub = (externaldata(MITREMatrix: string, Tactic: string, TechniqueId:string, TechniqueName:string, Platform: string , DetectionType: string , DetectionService: string , DetectionId: string, DetectionName: string, DetectionDescription: string, ConnectorId: string, DataTypes: string, Query: string , QueryFrequency: string , QueryPeriod:string , TriggerOperator: string, TriggerThreshold: string, DetectionSeverity: string, DetctionUrl: string, IngestedDate: string )\r\n[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/MITRE%20ATT%26CK/AzureSentinel.csv\"]\r\n);\r\nSentinelGithub\r\n| where isnotempty(Tactic)\r\n| summarize Count=dcount(DetectionName) by DetectionType","size":0,"title":"Query Type Breakdown","timeContext":{"durationMs":86400000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AzureSentinelGithub"},"customWidth":"50","name":"query - 10","styleSettings":{"maxWidth":"20"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"let SentinelGithub = (externaldata(MITREMatrix: string, Tactic: string, TechniqueId:string, TechniqueName:string, Platform: string , DetectionType: string , DetectionService: string , DetectionId: string, DetectionName: string, DetectionDescription: string, ConnectorId: string, DataTypes: string, Query: string , QueryFrequency: string , QueryPeriod:string , TriggerOperator: string, TriggerThreshold: string, DetectionSeverity: string, DetctionUrl: string, IngestedDate: string )\r\n[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/MITRE%20ATT%26CK/AzureSentinel.csv\"]\r\n);\r\nSentinelGithub\r\n| where isnotempty(Tactic)\r\n| extend Tactic = iff(Tactic==\"Privilege Escalation\",\"PrivilegeEscalation\",Tactic)\r\n| extend Tactic = iff(Tactic==\"Persistance\",\"Persistence\",Tactic)\r\n| extend Tactic = iff(Tactic==\"CommmandAndControl\",\"CommandAndControl\",Tactic)\r\n| extend Tactic = iff(Tactic==\"Defense Evasion\",\"DefenseEvasion\",Tactic)\r\n| extend Tactic = iff(Tactic in (\"IntialAccess\",\"InitalAccess\"),\"InitialAccess\",Tactic)\r\n| summarize Count=dcount(DetectionId) by Tactic\r\n| sort by Count desc","size":0,"title":"Tactic Level Breakdown","timeContext":{"durationMs":86400000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Tactic","formatter":1},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AzureSentinelGithub"},"customWidth":"50","name":"query - 9","styleSettings":{"maxWidth":"50"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"\r\nlet SentinelGithub = (externaldata(MITREMatrix: string, Tactic: string, TechniqueId:string, TechniqueName:string, Platform: string , DetectionType: string , DetectionService: string , DetectionId: string, DetectionName: string, DetectionDescription: string, ConnectorId: string, DataTypes: string, Query: string , QueryFrequency: string , QueryPeriod:string , TriggerOperator: string, TriggerThreshold: string, DetectionSeverity: string, DetctionUrl: string, IngestedDate: string )\r\n[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/MITRE%20ATT%26CK/AzureSentinel.csv\"]\r\n);\r\nSentinelGithub\r\n| where isnotempty(Platform)\r\n| summarize Count=dcount(DetectionId) by Platform\r\n| sort by Count desc","size":0,"title":"Platform Level Breakdown","timeContext":{"durationMs":86400000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"categoricalbar"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AzureSentinelGithub"},"customWidth":"100","name":"query - 12","styleSettings":{"maxWidth":"100"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"let SentinelGithub = (externaldata(MITREMatrix: string, Tactic: string, TechniqueId:string, TechniqueName:string, Platform: string , DetectionType: string , DetectionService: string , DetectionId: string, DetectionName: string, DetectionDescription: string, ConnectorId: string, DataTypes: string, Query: string , QueryFrequency: string , QueryPeriod:string , TriggerOperator: string, TriggerThreshold: string, DetectionSeverity: string, DetctionUrl: string, IngestedDate: string )\r\n[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/MITRE%20ATT%26CK/AzureSentinel.csv\"]\r\n);\r\nSentinelGithub\r\n| where isnotempty(Tactic) and isnotempty(Platform)\r\n| distinct Platform, DataTypes, DetectionType, DetectionName,DetctionUrl \r\n| sort by Platform asc, DetectionType asc","size":0,"title":"DataSource Level Breakdown","timeContext":{"durationMs":86400000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"rowLimit":9000,"filter":true}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"AzureSentinelGithub"},"customWidth":"100","name":"query - 11","styleSettings":{"maxWidth":"100"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"let MSFTServices = (externaldata(Alert: string, Description: string, Tactics:string, Severity:string, Provider:string, DetectionService: string)\r\n[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/MITRE%20ATT%26CK/MSFTAlerts.csv\"]\r\n);\r\nMSFTServices\r\n| summarize Count=count() by DetectionService\r\n| sort by Count desc","size":0,"title":"Detections by Microsoft Services","timeContext":{"durationMs":86400000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DetectionPlatformServices"},"customWidth":"50","name":"query - 13","styleSettings":{"maxWidth":"30"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"let MSFTServices = (externaldata(Alert: string, Description: string, Tactics:string, Severity:string, Provider:string, DetectionService: string)\r\n[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/MITRE%20ATT%26CK/MSFTAlerts.csv\"]\r\n);\r\nMSFTServices\r\n| where DetectionService == 'Azure Defender'\r\n| summarize Count=count() by Provider\r\n| sort by Count desc","size":0,"title":"ASC - Resource Type Breakdown","timeContext":{"durationMs":86400000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Provider","formatter":1},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DetectionPlatformServices"},"customWidth":"50","name":"query - 14","styleSettings":{"maxWidth":"70"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"let MSFTServices = (externaldata(Alert: string, Description: string, Tactics:string, Severity:string, Provider:string, DetectionService: string)\r\n[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/MITRE%20ATT%26CK/MSFTAlerts.csv\"]\r\n);\r\nMSFTServices\r\n","size":0,"title":"List of Alerts by Microsoft Services","timeContext":{"durationMs":86400000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"rowLimit":500,"filter":true}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"DetectionPlatformServices"},"name":"query - 15"}],"fromTemplateId":"sentinel-mitreattack","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FMITRE.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## O365
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/O365.json)

### Workbook details

> Description: This workbook will get a report on Office 365.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","query":"","crossComponentResources":[],"parameters":[{"id":"9dd762f8-8594-432f-b1dc-9561e0b799c6","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"isRequired":true,"value":{"durationMs":7776000000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}],"allowCustom":true}},{"id":"b3974da2-c8c3-4023-a7c4-a904f2daa904","version":"KqlParameterItem/1.0","name":"Workload","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"OfficeActivity\r\n| summarize Count= count() by OfficeWorkload\r\n| extend label = strcat(OfficeWorkload, \" - \", Count)\r\n| project OfficeWorkload, label","value":null,"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"b6db911d-6ecb-4a4f-812f-db1b1063813f","version":"KqlParameterItem/1.0","name":"UserType","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"OfficeActivity\r\n| summarize Count= count() by UserType\r\n| extend label = strcat(UserType, \" - \", Count)\r\n| project UserType, label","value":null,"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 1"},{"type":1,"content":{"json":"# General overview"},"name":"text - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity\r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| summarize count() by OfficeWorkload, bin_at(TimeGenerated, 1h, now())","size":0,"exportToExcelOptions":"visible","title":"Office activity, by workload","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"areachart"},"customWidth":"50","name":"office activity by workload"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| summarize count() by OfficeWorkload\r\n | sort by count_","size":0,"exportToExcelOptions":"visible","title":"Activity, by workload","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"25","name":"Activity by workload"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| where ItemType != '' \r\n| summarize count() by ItemType\r\n | sort by count_","size":0,"exportToExcelOptions":"visible","title":"Activity, by type","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"25","name":"Activity by type"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| summarize count() by UserType\r\n | sort by count_","size":0,"exportToExcelOptions":"visible","title":"Activity, by user type","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"25","name":"Activity by user type"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Admin operations ordered by number \r\nOfficeActivity \r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where UserType == 'Admin' \r\n| summarize count() by Operation \r\n| order by count_  \r\n","size":0,"exportToExcelOptions":"visible","title":"Admin activities, by type","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"customWidth":"25","name":"Admin activities by type"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity\r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| summarize Update = countif(Operation contains 'update'), Create = countif(Operation contains 'create'), Delete = countif(Operation contains 'delete'), Add = countif(Operation contains 'add') by bin_at(TimeGenerated, 1d, now())","size":0,"exportToExcelOptions":"visible","title":"Update, create, add, and delete activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"customWidth":"50","name":"activities over time per week"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| where TimeGenerated >= ago(14d) \r\n| where Operation contains 'group' \r\n| summarize count() by bin(TimeGenerated, 1d) \r\n| extend Week = iff(TimeGenerated>ago(7d), 'This Week', 'Last Week'), TimeGenerated = iff(TimeGenerated>ago(7d), TimeGenerated, TimeGenerated +7d)","size":0,"exportToExcelOptions":"visible","title":"Group activities, per week","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"customWidth":"25","name":"group activities"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| where TimeGenerated >= ago(14d) \r\n| where Operation contains 'user' \r\n| summarize count() by bin(TimeGenerated, 1d) \r\n| extend Week = iff(TimeGenerated>ago(7d), 'This Week', 'Last Week'), TimeGenerated = iff(TimeGenerated>ago(7d), TimeGenerated, TimeGenerated +7d) \r\n","size":0,"exportToExcelOptions":"visible","title":"User activities, per week","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"customWidth":"25","name":"User activities"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| where Operation contains 'Folder' \r\n| summarize count() by Operation\r\n | sort by count_","size":0,"exportToExcelOptions":"visible","title":"Folder changes","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"25","name":"Folder changes"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| where Operation contains 'File' \r\n| summarize count() by Operation\r\n | sort by count_","size":0,"exportToExcelOptions":"visible","title":"File changes","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"25","name":"File changes"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity\r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| top 100 by TimeGenerated\r\n| project TimeGenerated, RecordType, Operation, UserType, UserKey, OfficeWorkload, UserId, Parameters, SourceSystem","size":0,"exportToExcelOptions":"visible","title":"Recent activity","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true,"labelSettings":[]}},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = OfficeActivity\r\n| where '{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload}) \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType});\r\nlet appData = data\r\n| summarize TotalCount = count() by UserId\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on bin(TimeGenerated, 1d) in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by UserId\r\n    | project-away TimeGenerated) on UserId\r\n| order by TotalCount desc, UserId asc\r\n| project UserId, TotalCount, Trend\r\n| serialize Id = row_number();\r\ndata\r\n| summarize TotalCount = count() by Operation , UserId\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on bin(TimeGenerated, 1d) in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by UserId, Operation\r\n    | project-away TimeGenerated) on UserId, Operation\r\n| order by TotalCount desc, UserId asc\r\n| project UserId, Operation, TotalCount, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on UserId\r\n| project Id, Name = Operation, Type = 'Operation', ['Operation Count'] = TotalCount, Trend, ParentId = Id1\r\n| union (appData \r\n    | project Id, Name = UserId, Type = 'UserId', ['Operation Count'] = TotalCount, Trend )\r\n| order by ['Operation Count'] desc, Name asc","size":0,"exportToExcelOptions":"visible","title":"User activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Type","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Operation Count","formatter":3,"formatOptions":{"palette":"lightBlue","showIcon":true}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"palette":"lightBlue","showIcon":true}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name"},"labelSettings":[]}},"name":"Activity by users"},{"type":1,"content":{"json":"---\r\n# SharePoint & OneDrive"},"name":"text - 14"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Top sharepoint client IPS\r\nOfficeActivity\r\n| where ('{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload})) and OfficeWorkload in ('OneDrive', 'SharePoint') \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| summarize Number = count() by Operation\r\n| top 10 by Number","size":0,"exportToExcelOptions":"visible","title":"Top 10 activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"customWidth":"25","name":"Top 10 activities"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Files Downloaded by type\r\nOfficeActivity\r\n| where ('{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload})) and OfficeWorkload in ('OneDrive', 'SharePoint') \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| where Operation == 'FileDownloaded'\r\n| summarize count() by SourceFileExtension\r\n","size":0,"exportToExcelOptions":"visible","title":"Files downloaded, by extension","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"25","name":"Files downloaded by extension"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Files Uploaded by type \r\nOfficeActivity \r\n| where ('{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload})) and OfficeWorkload in ('OneDrive', 'SharePoint') \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| where Operation == 'FileUploaded' \r\n| summarize count() by SourceFileExtension\r\n | sort by count_","size":0,"exportToExcelOptions":"visible","title":"Files uploaded, by extension","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"25","name":"Files uploaded by extension"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Top sharepoint sites \r\nOfficeActivity \r\n| where ('{Workload:lable}'==\"All\" or OfficeWorkload in ({Workload})) and OfficeWorkload in ('OneDrive', 'SharePoint') \r\n| where '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| where Site_Url != ''\r\n| summarize Number = count() by Site_Url \r\n| top 10 by Number ","size":0,"exportToExcelOptions":"visible","title":"Top 10 sites","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Site_Url","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Number","formatter":3,"formatOptions":{"min":0,"palette":"lightBlue","showIcon":true}}],"labelSettings":[]},"tileSettings":{"titleContent":{"columnMatch":"Site_Url","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Number","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":false}},"customWidth":"25","name":"query - 18"},{"type":1,"content":{"json":"---\r\n# Exchange"},"name":"text - 20"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Mailbox Logins by hour\r\nOfficeActivity\r\n| where OfficeWorkload == 'Exchange' and ('{UserType:lable}'==\"All\" or UserType in ({UserType}))\r\n| where Operation == 'MailboxLogin'\r\n| summarize Logins = count() by bin_at(TimeGenerated, 1h, now())","size":0,"exportToExcelOptions":"visible","title":"Mailbox logins, by hour","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart"},"customWidth":"50","name":"Mailbox logins by hour"},{"type":3,"content":{"version":"KqlItem/1.0","query":"//Exchange operations that are performed by actors outside your organization - external\r\nOfficeActivity\r\n| where OfficeWorkload == 'Exchange' and '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| where ExternalAccess == 'True' \r\n| summarize count() by Operation\r\n | sort by count_","size":0,"exportToExcelOptions":"visible","title":"External access activities, by activities","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"25","name":"External access activities"},{"type":3,"content":{"version":"KqlItem/1.0","query":"OfficeActivity \r\n| where OfficeWorkload == 'Exchange' and  '{UserType:lable}'==\"All\" or UserType in ({UserType})\r\n| summarize count() by UserType \r\n | sort by count_","size":0,"exportToExcelOptions":"visible","title":"Activities, by user type","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"25","name":"Activities by user type"}],"styleSettings":{},"fromTemplateId":"sentinel-Office365","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FO365.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## PlaybooksHealth
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/PlaybooksHealth.json)

### Workbook details

> Description: This workbook will get a report on Playbook Health.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"156557ac-3688-4625-9405-496c6d3c4ee0","cellValue":"SelectedTab","linkTarget":"parameter","linkLabel":"Overview","subTarget":"Overview","preText":"Overview","style":"link"},{"id":"17915693-5dfd-4bb3-ad78-4b012becf2ce","cellValue":"SelectedTab","linkTarget":"parameter","linkLabel":"Activity","subTarget":"Activity","style":"link"},{"id":"fee66632-6572-466d-9461-63a7ccdabb61","cellValue":"SelectedTab","linkTarget":"parameter","linkLabel":"Billable Info","subTarget":"Billable Info","style":"link"}]},"name":"links - 1"},{"type":1,"content":{"json":"When choosing a workspace you should choose the workspace you set the \"diagnostics settings\" to send your logs to. In some cases it could be a different workspace than your Azure Sentinel workspace.\r\nWhen moving between the \"Overview\" tab to \"Activity\" or \"Billable Info\" tab for the first time, press the \"Refresh\" button to get results.","style":"info"},"name":"Diagnostics settings - help"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Subscription}"],"parameters":[{"id":"0e85e0e4-a7e8-4ea8-b291-e444c317843a","version":"KqlParameterItem/1.0","name":"ResourceTypes","label":"Resource types","type":7,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","value":["microsoft.logic/workflows"],"isHiddenWhenLocked":true,"typeSettings":{"additionalResourceOptions":[],"includeAll":true}},{"id":"1f74ed9a-e3ed-498d-bd5b-f68f3836a117","version":"KqlParameterItem/1.0","name":"Subscription","label":"Subscriptions","type":6,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"Resources\r\n| where type in~ ({ResourceTypes})\r\n| summarize Count = count() by subscriptionId\r\n| order by Count desc\r\n| extend Rank = row_number()\r\n| project value = subscriptionId, label = subscriptionId, selected = Rank == 1","crossComponentResources":["value::selected"],"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"173f251f-558e-415f-b5ca-f25cfa01f6ee","version":"KqlParameterItem/1.0","name":"Workspace","type":5,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"where type =~ \"microsoft.operationalinsights/workspaces\"\r\n| project id","crossComponentResources":["{Subscription}"],"value":[""],"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"defaultValue":"value::1","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"b616a3a3-4271-4208-b1a9-a92a78efed08","version":"KqlParameterItem/1.0","name":"ResourceGroups","label":"Resource groups","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"Resources\r\n| where type in~ ({ResourceTypes})\r\n| summarize Count = count() by subscriptionId, resourceGroup\r\n| order by Count desc\r\n| extend Rank = row_number()\r\n| project value = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup), label = resourceGroup, selected = false","crossComponentResources":["{Subscription}"],"value":[""],"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"f60ea0a0-3703-44ca-a59b-df0246423f41","version":"KqlParameterItem/1.0","name":"Resources","label":"Logic Apps","type":5,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"Resources\r\n| where type in~({ResourceTypes})\r\n| extend resourceGroupId = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\r\n| where resourceGroupId in~({ResourceGroups}) or '*' in~({ResourceGroups})\r\n| order by name asc\r\n| extend Rank = row_number()\r\n| project value = id, label = tostring(name), selected = Rank <= 10, group = resourceGroup","crossComponentResources":["{Subscription}"],"value":[""],"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"c0e1db28-a9e3-4f0d-b94d-a138d42b1cde","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"value":{"durationMs":259200000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000}],"allowCustom":true}},{"id":"662c4900-ffcf-4bc3-903d-472a1cc6e9e9","version":"KqlParameterItem/1.0","name":"Help","label":"Show Help","type":10,"description":"This will show some help information, in order to better use this workbook","isRequired":true,"typeSettings":{"additionalResourceOptions":[]},"jsonData":"[{ \"value\": \"Yes\", \"label\": \"Yes\"},\r\n {\"value\": \"No\", \"label\": \"No\", \"selected\":true }]","value":"Yes"}],"style":"above","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"name":"parameters - 0"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"#### Success and failure over time\r\n"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Overview"},"name":"text - 4"},{"type":1,"content":{"json":"\r\nIn this section, you will be able to drill down through \"time brushing\" a period of time in the line chart.  "},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Overview"},{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"}],"name":"text - 4 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let isResouceMatch=(ResourceToMatch:string){\r\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\",\");\r\n    iff(strcat(\"\",{ResourceGroups}) has \"*\",true, resourceGroupsText contains strcat(\"/resourceGroups/\",tolower(ResourceToMatch)))\r\n};\r\nlet isLAMatch=(LAToMatch:string){\r\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\",\");\r\n    iff(strcat(\"\",{Resources}) has \"*\",true, LAGroupsText contains strcat(\"/workflows/\",tolower(LAToMatch)))\r\n};\r\nAzureDiagnostics\r\n| where ResourceProvider == \"MICROSOFT.LOGIC\" and isResouceMatch(ResourceGroup)==true\r\n| where OperationName == \"Microsoft.Logic/workflows/workflowRunCompleted\"\r\n| where isLAMatch(resource_workflowName_s) == true\r\n| summarize count () by status_s\r\n","size":0,"timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"status_s","exportParameterName":"Status","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"piechart","chartSettings":{"seriesLabelSettings":[{"seriesName":"Failed","color":"red"},{"seriesName":"Succeeded","color":"green"}]}},"customWidth":"25","name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let isResouceMatch=(ResourceToMatch:string){\r\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\",\");\r\n    iff(strcat(\"\",{ResourceGroups}) has \"*\",true, resourceGroupsText contains strcat(\"/resourceGroups/\",tolower(ResourceToMatch)))\r\n};\r\nlet isLAMatch=(LAToMatch:string){\r\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\",\");\r\n    iff(strcat(\"\",{Resources}) has \"*\",true, LAGroupsText contains strcat(\"/workflows/\",tolower(LAToMatch)))\r\n};\r\nAzureDiagnostics\r\n| where ResourceProvider == \"MICROSOFT.LOGIC\" and isResouceMatch(ResourceGroup)==true\r\n| where OperationName == \"Microsoft.Logic/workflows/workflowRunCompleted\"\r\n| where isLAMatch(resource_workflowName_s) == true\r\n| summarize count() by status_s , bin(TimeGenerated, 1h)\r\n","size":0,"timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart","gridSettings":{"sortBy":[{"itemKey":"resource_workflowName_s","sortOrder":2}]},"sortBy":[{"itemKey":"resource_workflowName_s","sortOrder":2}],"chartSettings":{"seriesLabelSettings":[{"seriesName":"Failed","color":"red"},{"seriesName":"Succeeded","color":"green"}]}},"customWidth":"75","name":"query - 9"},{"type":1,"content":{"json":"#### Failure percentage per Logic App"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Overview"},"name":"Failure percentage"},{"type":1,"content":{"json":"\r\nIn this section you will be able to view built-in metrics. Failure percentage per Logic App, Run started, Run completed and Latency (Duration run time). "},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Overview"},{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"}],"name":"Failure percentage - Copy"},{"type":10,"content":{"chartId":"workbook38db0649-04fa-44d8-bb1b-ef4c90fb131f","version":"MetricsItem/2.0","size":0,"chartType":0,"resourceType":"microsoft.logic/workflows","metricScope":0,"resourceParameter":"Resources","resourceIds":["{Resources}"],"timeContextFromParameter":"TimeBrush","timeContext":{"durationMs":0},"metrics":[{"namespace":"microsoft.logic/workflows","metric":"microsoft.logic/workflows--RunFailurePercentage","aggregation":1},{"namespace":"microsoft.logic/workflows","metric":"microsoft.logic/workflows--RunsStarted","aggregation":1},{"namespace":"microsoft.logic/workflows","metric":"microsoft.logic/workflows--RunsCompleted","aggregation":1},{"namespace":"microsoft.logic/workflows","metric":"microsoft.logic/workflows--RunLatency","aggregation":4},{"namespace":"microsoft.logic/workflows","metric":"microsoft.logic/workflows--RunsSucceeded","aggregation":1}],"gridSettings":{"formatters":[{"columnMatch":"Subscription","formatter":15,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"Name","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"microsoft.logic/workflows--RunFailurePercentage","formatter":8,"formatOptions":{"min":10,"max":85,"palette":"greenRed"},"numberFormat":{"unit":1,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"microsoft.logic/workflows--RunFailurePercentage Timeline","formatter":21,"formatOptions":{"palette":"redBright"}},{"columnMatch":"microsoft.logic/workflows--RunsStarted","formatter":8,"formatOptions":{"palette":"blue"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"microsoft.logic/workflows--RunsStarted Timeline","formatter":5},{"columnMatch":"microsoft.logic/workflows--RunsCompleted","formatter":8,"formatOptions":{"palette":"blue"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"microsoft.logic/workflows--RunsCompleted Timeline","formatter":5},{"columnMatch":"microsoft.logic/workflows--RunLatency","formatter":8,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":24,"options":{"style":"decimal"}}},{"columnMatch":"microsoft.logic/workflows--RunLatency Timeline","formatter":5},{"columnMatch":"microsoft.logic/workflows--RunsSucceeded","formatter":8,"formatOptions":{"palette":"green"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"microsoft.logic/workflows--RunsSucceeded Timeline","formatter":21,"formatOptions":{"palette":"green"}},{"columnMatch":"microsoft.logic/workflows--RunSuccessLatency","formatter":8,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":24,"options":{"style":"decimal"}}},{"columnMatch":"microsoft.logic/workflows--RunSuccessLatency Timeline","formatter":5},{"columnMatch":"microsoft.logic/workflows--TotalBillableExecutions","formatter":8,"formatOptions":{"palette":"blue"},"numberFormat":{"unit":0,"options":{"style":"decimal"}}},{"columnMatch":"microsoft.logic/workflows--TotalBillableExecutions Timeline","formatter":5}],"rowLimit":10000,"sortBy":[{"itemKey":"$gen_heatmap_microsoft.logic/workflows--RunsStarted_4","sortOrder":2}],"labelSettings":[{"columnId":"microsoft.logic/workflows--RunFailurePercentage","label":"Run Failure Percentage (Sum)"},{"columnId":"microsoft.logic/workflows--RunFailurePercentage Timeline","label":"Run Failure Percentage Timeline"},{"columnId":"microsoft.logic/workflows--RunsStarted","label":"Runs Started (Sum)"},{"columnId":"microsoft.logic/workflows--RunsStarted Timeline","label":"Runs Started Timeline"},{"columnId":"microsoft.logic/workflows--RunsCompleted","label":"Runs Completed (Sum)"},{"columnId":"microsoft.logic/workflows--RunsCompleted Timeline","label":"Runs Completed Timeline"},{"columnId":"microsoft.logic/workflows--RunLatency","label":"Run Latency (Average)"},{"columnId":"microsoft.logic/workflows--RunLatency Timeline","label":"Run Latency Timeline"},{"columnId":"microsoft.logic/workflows--RunsSucceeded","label":"Runs Succeeded (Sum)"},{"columnId":"microsoft.logic/workflows--RunsSucceeded Timeline","label":"Runs Succeeded Timeline"}]},"sortBy":[{"itemKey":"$gen_heatmap_microsoft.logic/workflows--RunsStarted_4","sortOrder":2}],"showExportToExcel":true},"name":"metric - 2"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"#### Logic Apps by status\r\n"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Overview"},"name":"text - 8"},{"type":1,"content":{"json":"In this section by clicking one of the statuses, you can drill down to view Logic Apps by status. After choosing a specific Logic App you can then filter and view the status of the Logic Apps' trigger and actions."},"name":"text - 8 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let isResouceMatch=(ResourceToMatch:string){\r\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\",\");\r\n    iff(strcat(\"\",{ResourceGroups}) has \"*\",true, resourceGroupsText contains strcat(\"/resourceGroups/\",tolower(ResourceToMatch)))\r\n};\r\nlet isLAMatch=(LAToMatch:string){\r\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\",\");\r\n    iff(strcat(\"\",{Resources}) has \"*\",true, LAGroupsText contains strcat(\"/workflows/\",tolower(LAToMatch)))\r\n};\r\n\r\nAzureDiagnostics\r\n| where ResourceProvider == \"MICROSOFT.LOGIC\" and isResouceMatch(ResourceGroup) == true \r\n| where OperationName startswith \"Microsoft.Logic/workflows/workflowRun\" and isLAMatch(resource_workflowName_s) == true\r\n| make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by status_s\r\n|join(\r\nAzureDiagnostics\r\n| where ResourceProvider == \"MICROSOFT.LOGIC\" and isResouceMatch(ResourceGroup) == true\r\n| where OperationName startswith \"Microsoft.Logic/workflows/workflowRun\" and isLAMatch(resource_workflowName_s) == true\r\n| summarize count() by status_s\r\n) on status_s\r\n| where status_s != \"Running\"\r\n| order by status_s asc, count_\r\n| project status_s,Trend, count_\r\n\r\n\r\n\r\n\r\n\r\n","size":1,"showAnalytics":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","exportFieldName":"status_s","exportParameterName":"Status","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"status_s","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Failed","representation":"failed","text":"{0}{1}"},{"operator":"==","thresholdValue":"Running","representation":"pending","text":"{0}{1}"},{"operator":"==","thresholdValue":"Succeeded","representation":"success","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":null,"text":"{0}{1}"}]}},"leftContent":{"columnMatch":"count_","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"Blank","text":"{0}{1}"}]},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2,"maximumSignificantDigits":3}}},"secondaryContent":{"columnMatch":"Trend","formatter":10,"formatOptions":{"palette":"blue"}},"showBorder":false}},"name":"query - 13"},{"type":1,"content":{"json":"#### Logic Apps by status\r\n"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Overview"},"name":"Overview - Activities - Copy - Copy"},{"type":1,"content":{"json":"After clicking a specific Logic App you can then filter and view the status of the Logic Apps' trigger and actions."},"name":"Overview - Activities - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let isResouceMatch=(ResourceToMatch:string){\r\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\",\");\r\n    iff(strcat(\"\",{ResourceGroups}) has \"*\",true, resourceGroupsText contains strcat(\"/resourceGroups/\",tolower(ResourceToMatch)))\r\n};\r\nlet isLAMatch=(LAToMatch:string){\r\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\",\");\r\n    iff(strcat(\"\",{Resources}) has \"*\",true, LAGroupsText contains strcat(\"/workflows/\",tolower(LAToMatch)))\r\n};\r\n\r\nAzureDiagnostics\r\n| where ResourceProvider == \"MICROSOFT.LOGIC\" and isResouceMatch(ResourceGroup) == true \r\n| where OperationName startswith \"Microsoft.Logic/workflows/workflowRunCompleted\" and isLAMatch(resource_workflowName_s) == true\r\n| where status_s =='{Status}' or '{Status}' =='All'\r\n| make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by resource_workflowName_s, status_s, error_code_s\r\n|join(\r\nAzureDiagnostics\r\n| where ResourceProvider == \"MICROSOFT.LOGIC\" and isResouceMatch(ResourceGroup) == true \r\n| where OperationName startswith \"Microsoft.Logic/workflows/workflowRunCompleted\" and isLAMatch(resource_workflowName_s) == true\r\n| where status_s =='{Status}' or '{Status}' =='All'\r\n| summarize count() by resource_workflowName_s, status_s, error_code_s,ResourceGroup\r\n) on resource_workflowName_s, status_s\r\n| order by status_s asc, count_\r\n| project ResourceGroup, LogicApp = resource_workflowName_s, Status =status_s, Count = count_, Trend, Error = error_code_s\r\n\r\n\r\n","size":1,"showAnalytics":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","exportFieldName":"LogicApp","exportParameterName":"Logic","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"LogicApp","formatter":13,"formatOptions":{"linkColumn":"LogicApp","linkTarget":"Resource","linkIsContextBlade":true,"showIcon":true}},{"columnMatch":"Status","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Succedded","representation":"success","text":"{0}{1}"},{"operator":"==","thresholdValue":"Failed","representation":"failed","text":"{0}{1}"},{"operator":"==","thresholdValue":"Skipped","representation":"pending","text":"{0}{1}"},{"operator":"==","thresholdValue":"Running","representation":"1","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"success","text":"{0}{1}"}]}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"palette":"blue"}},{"columnMatch":"Count","formatter":8,"formatOptions":{"palette":"gray"}},{"columnMatch":"status_s","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Succedded","representation":"success","text":"{0}{1}"},{"operator":"==","thresholdValue":"Failed","representation":"failed","text":"{0}{1}"},{"operator":"==","thresholdValue":"Skipped","representation":"pending","text":"{0}{1}"},{"operator":"==","thresholdValue":"Running","representation":"1","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"success","text":"{0}{1}"}]}},{"columnMatch":"TimeGenerated","formatter":21,"formatOptions":{"palette":"blue"}},{"columnMatch":"count_","formatter":8,"formatOptions":{"palette":"gray"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}}],"filter":true},"sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"Action","formatter":1},"leftContent":{"columnMatch":"status_s","formatter":12,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2,"maximumSignificantDigits":3}}},"showBorder":false},"chartSettings":{"xAxis":"Resource","yAxis":["status_s","Trend"],"group":"status_s","createOtherGroup":50,"showLegend":true,"xSettings":{"numberFormatSettings":{"unit":17,"options":{"style":"decimal","useGrouping":true}}},"ySettings":{"numberFormatSettings":{"unit":17,"options":{"style":"decimal","useGrouping":true}}}}},"name":"query - 3"},{"type":1,"content":{"json":"#### Logic Apps' Trigger by status"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Overview"},"name":"Overview - Activities - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let isResouceMatch=(ResourceToMatch:string){\r\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\",\");\r\n    iff(strcat(\"\",{ResourceGroups}) has \"*\",true, resourceGroupsText contains strcat(\"/resourceGroups/\",tolower(ResourceToMatch)))\r\n};\r\nlet isLAMatch=(LAToMatch:string){\r\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\",\");\r\n    iff(strcat(\"\",{Resources}) has \"*\",true, LAGroupsText contains strcat(\"/workflows/\",tolower(LAToMatch)))\r\n};\r\n\r\nAzureDiagnostics\r\n| where ResourceProvider == \"MICROSOFT.LOGIC\" and isResouceMatch(ResourceGroup) == true \r\n| where OperationName startswith \"Microsoft.Logic/workflows/workflowTrigger\" and isLAMatch(resource_workflowName_s) == true\r\n| where resource_workflowName_s =='{Logic}' or '{Logic}' =='All'\r\n| make-series Trend = count() on TimeGenerated from {TimeBrush:start} to {TimeBrush:end} step {TimeBrush:grain} by resource_triggerName_s, status_s, resource_workflowName_s\r\n|join(\r\nAzureDiagnostics\r\n| where ResourceProvider == \"MICROSOFT.LOGIC\" and isResouceMatch(ResourceGroup) == true \r\n| where OperationName startswith \"Microsoft.Logic/workflows/workflowTrigger\" and isLAMatch(resource_workflowName_s) == true\r\n| summarize count() by resource_triggerName_s, status_s, resource_workflowName_s\r\n) on resource_triggerName_s, status_s, resource_workflowName_s\r\n| order by status_s asc, count_\r\n| where status_s != \"Running\" \r\n| project Trigger = resource_triggerName_s,LogicAppName = resource_workflowName_s,Status =status_s, Count = count_,Trend","size":1,"showAnalytics":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","exportFieldName":"status_s","exportParameterName":"Status","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Status","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Succeeded","representation":"success","text":"{0}{1}"},{"operator":"==","thresholdValue":"Failed","representation":"failed","text":"{0}{1}"},{"operator":"==","thresholdValue":"Skipped","representation":"1","text":"{0}{1}"},{"operator":"==","thresholdValue":"Running","representation":"pending","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"more","text":"{0}{1}"}]}},{"columnMatch":"Count","formatter":8,"formatOptions":{"palette":"gray"}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"palette":"blue"}},{"columnMatch":"status_s","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Succedded","representation":"success","text":"{0}{1}"},{"operator":"==","thresholdValue":"Failed","representation":"failed","text":"{0}{1}"},{"operator":"==","thresholdValue":"Skipped","representation":"1","text":"{0}{1}"},{"operator":"==","thresholdValue":"Running","representation":"pending","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"success","text":"{0}{1}"}]}},{"columnMatch":"TimeGenerated","formatter":21,"formatOptions":{"palette":"blue"}},{"columnMatch":"count_","formatter":8,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}}],"filter":true},"sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"Action","formatter":1},"leftContent":{"columnMatch":"status_s","formatter":12,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2,"maximumSignificantDigits":3}}},"showBorder":false},"chartSettings":{"xAxis":"Resource","yAxis":["status_s","Trend"],"group":"status_s","createOtherGroup":50,"showLegend":true,"xSettings":{"numberFormatSettings":{"unit":17,"options":{"style":"decimal","useGrouping":true}}},"ySettings":{"numberFormatSettings":{"unit":17,"options":{"style":"decimal","useGrouping":true}}}}},"name":"query - 3 - Copy"},{"type":1,"content":{"json":"#### Logic Apps' Action by status"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Overview"},"name":"Overview - Activities - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let isResouceMatch=(ResourceToMatch:string){\r\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\",\");\r\n    iff(strcat(\"\",{ResourceGroups}) has \"*\",true, resourceGroupsText contains strcat(\"/resourceGroups/\",tolower(ResourceToMatch)))\r\n};\r\nlet isLAMatch=(LAToMatch:string){\r\n    let LAGroupsText = strcat_array(dynamic([{Resources}]),\",\");\r\n    iff(strcat(\"\",{Resources}) has \"*\",true, LAGroupsText contains strcat(\"/workflows/\",tolower(LAToMatch)))\r\n};\r\n\r\nAzureDiagnostics\r\n| where ResourceProvider == \"MICROSOFT.LOGIC\" and isResouceMatch(ResourceGroup) == true \r\n| where OperationName startswith \"Microsoft.Logic/workflows/workflowAction\" and isLAMatch(resource_workflowName_s) == true\r\n| where resource_workflowName_s =='{Logic}' or '{Logic}' =='All'\r\n| make-series Trend = count() on TimeGenerated from {TimeBrush:start} to {TimeBrush:end} step {TimeBrush:grain} by Resource, status_s, resource_workflowName_s\r\n|join(\r\nAzureDiagnostics\r\n| where ResourceProvider == \"MICROSOFT.LOGIC\" and isResouceMatch(ResourceGroup) == true \r\n| where OperationName startswith \"Microsoft.Logic/workflows/workflowAction\" and isLAMatch(resource_workflowName_s) == true\r\n| summarize count() by Resource, status_s, resource_workflowName_s\r\n) on Resource, status_s, resource_workflowName_s\r\n| order by status_s asc, count_\r\n| where status_s != \"Running\"\r\n| project Action = Resource, LogicAppName = resource_workflowName_s, Status =status_s, Count = count_, Trend\r\n \r\n\r\n","size":1,"showAnalytics":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","exportFieldName":"status_s","exportParameterName":"Status","exportDefaultValue":"All","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Status","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Succeeded","representation":"success","text":"{0}{1}"},{"operator":"==","thresholdValue":"Failed","representation":"failed","text":"{0}{1}"},{"operator":"==","thresholdValue":"Skipped","representation":"1","text":"{0}{1}"},{"operator":"==","thresholdValue":"Running","representation":"pending","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"more","text":"{0}{1}"}]}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"palette":"blue"}},{"columnMatch":"Count","formatter":8,"formatOptions":{"palette":"gray"}},{"columnMatch":"status_s","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"Succeeded","representation":"success","text":"{0}{1}"},{"operator":"==","thresholdValue":"Failed","representation":"failed","text":"{0}{1}"},{"operator":"==","thresholdValue":"Skipped","representation":"1","text":"{0}{1}"},{"operator":"==","thresholdValue":"Running","representation":"pending","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"more","text":"{0}{1}"}]}},{"columnMatch":"TimeGenerated","formatter":21,"formatOptions":{"palette":"blue"}},{"columnMatch":"count_","formatter":8,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}}],"filter":true},"sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"Action","formatter":1},"leftContent":{"columnMatch":"status_s","formatter":12,"formatOptions":{"palette":"greenRed"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2,"maximumSignificantDigits":3}}},"showBorder":false},"chartSettings":{"xAxis":"Resource","yAxis":["status_s","Trend"],"group":"status_s","createOtherGroup":50,"showLegend":true,"xSettings":{"numberFormatSettings":{"unit":17,"options":{"style":"decimal","useGrouping":true}}},"ySettings":{"numberFormatSettings":{"unit":17,"options":{"style":"decimal","useGrouping":true}}}}},"name":"query - 3"}]},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Overview"},"name":"Playbooks by status "}]},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Overview"},"name":"Success and Failure over time"},{"type":1,"content":{"json":"In this section you can view Logic Apps activities by user or Logic App.\r\nData is queried from \"AzureActivity\" table. ","style":"info"},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Activity"},{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"}],"name":"Overview - Activities"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"#### Logic Apps activities by user"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Activity"},"name":"Overview - Activities - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let isResouceMatch=(ResourceToMatch:string){\r\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\",\");\r\n    iff(strcat(\"\",{ResourceGroups}) has \"*\",true, resourceGroupsText contains strcat(\"/resourceGroups/\",tolower(ResourceToMatch)))\r\n};\r\n\r\nlet ResourceOperations = AzureActivity\r\n| where ResourceProviderValue == \"Microsoft.Resources\" and isResouceMatch(ResourceGroup) == true\r\n| where Resource == \"Microsoft.EmptyWorkflow\";\r\nAzureActivity\r\n| where ResourceProviderValue == \"Microsoft.Logic\" and isResouceMatch(ResourceGroup) == true\r\n| union ResourceOperations\r\n| summarize count() by Caller, OperationName, CorrelationId, ResourceGroup\r\n| summarize Creations = countif(OperationName has \"Create\"), Deletions = countif(OperationName has \"Delete\"),  Updates = countif(OperationName has \"set\"), Enable = countif(OperationName has \"Enable\"), Disable = countif(OperationName has \"Disable\"), AllActivities = count() by PreformedBy = Caller, ResourceGroup","size":0,"showAnalytics":true,"timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Creations","formatter":8,"formatOptions":{"palette":"blueGreen"}},{"columnMatch":"Deletions","formatter":8,"formatOptions":{"palette":"orangeRed"}},{"columnMatch":"Updates","formatter":8,"formatOptions":{"palette":"blue"}},{"columnMatch":"Enable","formatter":8,"formatOptions":{"palette":"blueGreen"}},{"columnMatch":"Disable","formatter":8,"formatOptions":{"palette":"orangeRed"}},{"columnMatch":"AllActivities","formatter":8,"formatOptions":{"palette":"blue"}},{"columnMatch":"creations","formatter":8,"formatOptions":{"palette":"blueGreen"}}],"filter":true},"sortBy":[]},"showPin":false,"name":"query - 0"},{"type":1,"content":{"json":"#### API Connection activities by user"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Activity"},"name":"Overview - Activities - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let isResouceMatch=(ResourceToMatch:string){\r\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\",\");\r\n    iff(strcat(\"\",{ResourceGroups}) has \"*\",true, resourceGroupsText contains strcat(\"/resourceGroups/\",tolower(ResourceToMatch)))\r\n};\r\nAzureActivity\r\n| where ResourceProviderValue == \"Microsoft.Web\" and isResouceMatch(ResourceGroup)==true\r\n| summarize count() by Caller, OperationName, CorrelationId,ResourceGroup\r\n| summarize Creations = countif(OperationName has \"Create\"), Deletions = countif(OperationName has \"Delete\"),  Updates = countif(OperationName has \"set\"), AllActivities = count() by PreformedBy = Caller,ResourceGroup","size":1,"showAnalytics":true,"timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Creations","formatter":8,"formatOptions":{"palette":"blueGreen"}},{"columnMatch":"Deletions","formatter":8,"formatOptions":{"palette":"orangeRed"}},{"columnMatch":"Updates","formatter":8,"formatOptions":{"palette":"blue"}},{"columnMatch":"AllActivities","formatter":8,"formatOptions":{"palette":"blue"}},{"columnMatch":"creations","formatter":8,"formatOptions":{"palette":"blueGreen"}},{"columnMatch":"Disable","formatter":8,"formatOptions":{"palette":"orangeRed"}}],"filter":true},"sortBy":[]},"name":"query - 0 - Copy"},{"type":1,"content":{"json":"#### Logic Apps activities by Logic App and user"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Activity"},"name":"Overview - Activities - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let isResouceMatch=(ResourceToMatch:string){\r\n    let resourceGroupsText = strcat_array(dynamic([{ResourceGroups}]),\",\");\r\n    iff(strcat(\"\",{ResourceGroups}) has \"*\",true, resourceGroupsText contains strcat(\"/resourceGroups/\",tolower(ResourceToMatch)))\r\n};\r\nlet baseQuery = AzureActivity\r\n| where ResourceProviderValue == \"Microsoft.Logic\" and isResouceMatch(ResourceGroup)==true\r\n| extend parseName = tostring(todynamic(Authorization)[\"scope\"])\r\n| where parseName contains \"workflows\"\r\n| extend LogicAppName = tostring(split(split(parseName, 'workflows/')[1], '/')[0]) // parse LogicApp name\r\n| extend OperationType = iff ((OperationName has \"set\" and tostring(todynamic(Properties)[\"statusCode\"]) == \"Created\"), \"Create\", OperationName);\r\nlet UsersByLogicApp = baseQuery\r\n| summarize PerformedBy = make_set(Caller) by LogicAppName;\r\nlet operationsSummary = baseQuery\r\n| summarize count() by LogicAppName, CorrelationId, ResourceGroup, OperationType\r\n| summarize Creations = countif(OperationType == \"Create\"),Deletions = countif(OperationType has \"Delete\"),  Updates = countif(OperationType has \"set\"), Enable = countif(OperationType has \"Enable\"), Disable = countif(OperationType has \"Disable\"), AllActivities = count() by LogicAppName, ResourceGroup;\r\noperationsSummary\r\n| join (UsersByLogicApp) on LogicAppName\r\n| project-away LogicAppName1\r\n\r\n","size":0,"showAnalytics":true,"timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","showExportToExcel":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Creations","formatter":8,"formatOptions":{"palette":"blueGreen"}},{"columnMatch":"Deletions","formatter":8,"formatOptions":{"palette":"orangeRed"}},{"columnMatch":"Updates","formatter":8,"formatOptions":{"palette":"blue"}},{"columnMatch":"Enable","formatter":8,"formatOptions":{"palette":"blueGreen"}},{"columnMatch":"Disable","formatter":8,"formatOptions":{"palette":"orangeRed"}},{"columnMatch":"AllActivities","formatter":8,"formatOptions":{"palette":"blue"}}],"filter":true,"sortBy":[{"itemKey":"$gen_heatmap_Creations_2","sortOrder":2}]},"sortBy":[{"itemKey":"$gen_heatmap_Creations_2","sortOrder":2}]},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Activity"},"name":"group - 14"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"#### Billable information\r\n\r\n\r\n"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Billable Info"},"name":"Help -Billable"},{"type":1,"content":{"json":"In this section, you can view billable information regarding your Logic Apps. The data is based on Logic Apps' build-in metrics. To view the list of Logic Apps click the \">\" icon in the subscription column.\r\nBy using the calculator link you can insert the \"Total billable executions\" to estimate the cost of your Logic Apps.\r\nAt the top of the grid, you have the total billable executions for the whole subscription. https://azure.microsoft.com/en-us/pricing/details/logic-apps/\r\n\r\n"},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Billable Info"},{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"}],"name":"Help -Billable - Copy"},{"type":10,"content":{"chartId":"workbook757f2678-5866-4962-bef3-4b77db39d723","version":"MetricsItem/2.0","size":0,"chartType":0,"resourceType":"microsoft.logic/workflows","metricScope":0,"resourceParameter":"Resources","resourceIds":["{Resources}"],"timeContextFromParameter":"TimeRange","timeContext":{"durationMs":259200000},"metrics":[{"namespace":"microsoft.logic/workflows","metric":"microsoft.logic/workflows--BillableTriggerExecutions","aggregation":1},{"namespace":"microsoft.logic/workflows","metric":"microsoft.logic/workflows--BillableActionExecutions","aggregation":1},{"namespace":"microsoft.logic/workflows","metric":"microsoft.logic/workflows--TotalBillableExecutions","aggregation":1},{"namespace":"microsoft.logic/workflows","metric":"microsoft.logic/workflows--RunsStarted","aggregation":1}],"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Name","formatter":13},"leftContent":{"columnMatch":"Value","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":15,"formatOptions":{"linkTarget":null}},{"columnMatch":"Subscription","formatter":5},{"columnMatch":"Name","formatter":13,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"microsoft.logic/workflows--BillableTriggerExecutions","formatter":8,"formatOptions":{"palette":"blue"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}},{"columnMatch":"microsoft.logic/workflows--BillableTriggerExecutions Timeline","formatter":5},{"columnMatch":"microsoft.logic/workflows--BillableActionExecutions","formatter":8,"formatOptions":{"palette":"blue"},"numberFormat":{"unit":0,"options":{"style":"decimal"}}},{"columnMatch":"microsoft.logic/workflows--BillableActionExecutions Timeline","formatter":5},{"columnMatch":"microsoft.logic/workflows--TotalBillableExecutions","formatter":8,"formatOptions":{"palette":"blue","aggregation":"Sum"}},{"columnMatch":"microsoft.logic/workflows--TotalBillableExecutions Timeline","formatter":21,"formatOptions":{"palette":"blue"}},{"columnMatch":"microsoft.logic/workflows--RunsStarted","formatter":8,"formatOptions":{"palette":"blue"},"numberFormat":{"unit":0,"options":{"style":"decimal"}}},{"columnMatch":"microsoft.logic/workflows--RunsStarted Timeline","formatter":21,"formatOptions":{"palette":"blue"}},{"columnMatch":"RG","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"Sum","formatter":1,"formatOptions":{"aggregation":"Sum"},"numberFormat":{"unit":0,"options":{"style":"decimal","useGrouping":false}}}],"rowLimit":10000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["Subscription"]},"sortBy":[{"itemKey":"$gen_heatmap_microsoft.logic/workflows--TotalBillableExecutions_7","sortOrder":2}],"labelSettings":[{"columnId":"microsoft.logic/workflows--BillableTriggerExecutions","label":"Billable Trigger Executions (Sum)"},{"columnId":"microsoft.logic/workflows--BillableTriggerExecutions Timeline","label":"Billable Trigger Executions Timeline"},{"columnId":"microsoft.logic/workflows--BillableActionExecutions","label":"Billable Action Executions (Sum)"},{"columnId":"microsoft.logic/workflows--BillableActionExecutions Timeline","label":"Billable Action Executions Timeline"},{"columnId":"microsoft.logic/workflows--TotalBillableExecutions","label":"Total Billable Executions (Sum)"},{"columnId":"microsoft.logic/workflows--TotalBillableExecutions Timeline","label":"Total Billable Executions Timeline"},{"columnId":"microsoft.logic/workflows--RunsStarted","label":"Runs Started (Sum)"},{"columnId":"microsoft.logic/workflows--RunsStarted Timeline","label":"Runs Started Timeline"}]},"sortBy":[{"itemKey":"$gen_heatmap_microsoft.logic/workflows--TotalBillableExecutions_7","sortOrder":2}],"exportFieldName":"Total Billable Executions (Sum)","exportParameterName":"Total","exportDefaultValue":"All","showExportToExcel":true},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Billable Info"},"name":"Billable Metric"}]},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"Billable Info"},"name":"Billable Info"}],"fallbackResourceIds":[""],"fromTemplateId":"sentinel-PlaybooksHealth","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FPlaybooksHealth.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## SecurityAlerts
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/SecurityAlerts.json)

### Workbook details

> Description: This workbook will get a report on Security Alerts.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Security Alerts Dashboard\n---\n\nThis dashboard shows Azure Sentinel Security Alerts data by various views.\n\nNote: Not all Security Alerts are Incidients\n"},"name":"text - 2"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"08f97f34-6264-4fa3-90b5-16b89422d285","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"isRequired":true,"value":{"durationMs":1209600000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}]}},{"id":"cd98a9c7-5dbd-4f92-a967-7ed1c781132a","version":"KqlParameterItem/1.0","name":"AlertSeverity","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityAlert\r\n| summarize Count = count() by AlertSeverity\r\n| order by Count desc, AlertSeverity asc\r\n| project Value = AlertSeverity, Label = strcat(AlertSeverity, ' - ', Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"]},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"df0fbc31-ade1-4488-9109-a4f647ad8fe2","version":"KqlParameterItem/1.0","name":"ProductName","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityAlert\r\n| summarize Count = count() by ProductName\r\n| order by Count desc, ProductName asc\r\n| project Value = ProductName, Label = strcat(ProductName, ' - ', Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"]},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SecurityAlert\n| where \"{AlertSeverity:lable}\" == \"All\" or AlertSeverity in ({AlertSeverity})\n| where \"{ProductName:lable}\" == \"All\" or ProductName in ({ProductName});\ndata\n| summarize Count = count() by AlertSeverity\n| join kind = inner (data\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by AlertSeverity)\n on AlertSeverity\n | project-away TimeGenerated\n| extend AlertSeveritys = AlertSeverity\n| union (\n data \n | summarize Count = count() \n | extend jkey = 1\n | join kind=inner (data\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\n | extend jkey = 1) on jkey\n | extend AlertSeverity = 'All', AlertSeveritys = '*' \n)\n| extend Severity = iif(AlertSeverity == \"All\", 0,iif(AlertSeverity == \"High\", 1, iif(AlertSeverity == \"Medium\", 2, iif(AlertSeverity == \"Low\", 3, 4))))\n| order by Severity asc\n","size":3,"title":"Security Alerts by Severity","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"AlertSeverity","exportParameterName":"AlertSeverityPicker","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"AlertSeverity","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"secondaryContent":{"columnMatch":"Trend","formatter":9,"formatOptions":{"showIcon":true}},"showBorder":false,"sortOrderField":1}},"name":"SecurityAlertsbySeverity"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = SecurityAlert\r\n| where \"{AlertSeverity:lable}\" == \"All\" or AlertSeverity in ({AlertSeverity})\r\n| where \"{ProductName:lable}\" == \"All\" or ProductName in ({ProductName})\r\n| where AlertSeverity == '{AlertSeverityPicker}' or '{AlertSeverityPicker}' == \"All\";\r\ndata\r\n| summarize Count = count() by ProductName\r\n| join kind = inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ProductName)\r\n on ProductName\r\n | project-away TimeGenerated\r\n| extend ProductNames = ProductName\r\n| union (\r\n data \r\n | summarize Count = count() \r\n | extend jkey = 1\r\n | join kind=inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n | extend jkey = 1) on jkey\r\n | extend ProductName = 'All', ProductNames = '*' \r\n)\r\n| order by Count desc\r\n","size":3,"title":"Security Alerts by Product","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"ProductName","exportParameterName":"ProductNamePicker","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"ProductName","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"secondaryContent":{"columnMatch":"Trend","formatter":9,"formatOptions":{"showIcon":true}},"showBorder":false}},"name":"SecurityAlertsbyProduct"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityAlert\r\n| where \"{AlertSeverity:lable}\" == \"All\" or AlertSeverity in ({AlertSeverity})\r\n| where \"{ProductName:lable}\" == \"All\" or ProductName in ({ProductName})\r\n| where AlertSeverity == '{AlertSeverityPicker}' or '{AlertSeverityPicker}' == \"All\"\r\n| where ProductName == '{ProductNamePicker}' or '{ProductNamePicker}' == \"All\"\r\n| summarize count() by AlertSeverity, bin(TimeGenerated, 1d)","size":3,"title":"Security Alerts Over Time by Severity","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"linechart","chartSettings":{"seriesLabelSettings":[{"seriesName":"Medium","color":"orange"},{"seriesName":"Low","color":"yellow"},{"seriesName":"Informational","color":"gray"},{"seriesName":"High","color":"red"}]}},"name":"SecurityAlertsOverTimebySeverity"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityAlert\r\n| where \"{AlertSeverity:lable}\" == \"All\" or AlertSeverity in ({AlertSeverity})\r\n| where \"{ProductName:lable}\" == \"All\" or ProductName in ({ProductName})\r\n| where AlertSeverity == '{AlertSeverityPicker}' or '{AlertSeverityPicker}' == \"All\"\r\n| where ProductName == '{ProductNamePicker}' or '{ProductNamePicker}' == \"All\"\r\n| summarize count() by ProductName, bin(TimeGenerated, 1d)","size":3,"title":"Security Alerts Over Time by Product","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"unstackedbar","chartSettings":{"seriesLabelSettings":[{"seriesName":"Medium","color":"orange"},{"seriesName":"Low","color":"yellow"},{"seriesName":"Informational","color":"gray"},{"seriesName":"High","color":"red"}]}},"name":"SecurityAlertsOverTimebyProduct"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityAlert\r\n| where \"{AlertSeverity:lable}\" == \"All\" or AlertSeverity in ({AlertSeverity})\r\n| where \"{ProductName:lable}\" == \"All\" or ProductName in ({ProductName})\r\n| where AlertSeverity == '{AlertSeverityPicker}' or '{AlertSeverityPicker}' == \"All\"\r\n| where ProductName == '{ProductNamePicker}' or '{ProductNamePicker}' == \"All\"\r\n| extend Entities = iff(isempty(Entities), todynamic('[{\"dummy\" : \"\"}]'), todynamic(Entities))\r\n| mvexpand Entities\r\n| evaluate bag_unpack(Entities, \"Entity_\")\r\n| extend Entity_Type = columnifexists(\"Entity_Type\", \"\")\r\n| extend Entity_Name = columnifexists(\"Entity_Name\", \"\")\r\n| extend Entity_ResourceId = columnifexists(\"Entity_ResourceId\", \"\")\r\n| extend Entity_Directory = columnifexists(\"Entity_Directory\", \"\")\r\n| extend Entity_Value = columnifexists(\"Entity_Value\", \"\")\r\n| extend Entity_HostName = columnifexists(\"Entity_HostName\", \"\")\r\n| extend Entity_Address = columnifexists(\"Entity_Address\", \"\")\r\n| extend Entity_ProcessId = columnifexists(\"Entity_ProcessId\", \"\")\r\n| extend Entity_Url = columnifexists(\"Entity_Url\", \"\")\r\n| extend Target = iif(Entity_Type == \"account\", Entity_Name, iif(Entity_Type == \"azure-resource\", Entity_ResourceId, iif(Entity_Type == \"cloud-application\", Entity_Name, iif(Entity_Type == \"dns\", Entity_Name, iif(Entity_Type == \"file\", strcat(Entity_Directory, \"\\\\\", Entity_Name), iif(Entity_Type == \"filehash\", Entity_Value, iif(Entity_Type == \"host\", Entity_HostName, iif(Entity_Type == \"ip\" , Entity_Address, iif(Entity_Type == \"malware\", Entity_HostName, iif(Entity_Type == \"network-connection\", Entity_Name, iif(Entity_Type == \"process\", Entity_ProcessId, iif(Entity_Type == \"registry-key\", Entity_Name, iif(Entity_Type == \"registry-value\", Entity_Name, iif(Entity_Type == \"security-group\", Entity_Name, iif(Entity_Type == \"url\", Entity_Url, \"NoTarget\")))))))))))))))\r\n| where Entity_Type in (\"account\", \"host\", \"ip\", \"url\", \"azure-resource\", \"cloud-application\", \"dns\", \"file\", \"filehash\", \"malware\", \"network-connection\", \"process\", \"registry-key\", \"registry-value\", \"security-group\")\r\n| summarize count() by bin(TimeGenerated, 1d), Target, Entity_Type\r\n| project-away TimeGenerated\r\n| order by count_ desc\r\n\r\n","size":0,"title":"Top Entities in Security Alerts","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"TopEntitiesinSecurityAlerts"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityAlert\r\n| where \"{AlertSeverity:lable}\" == \"All\" or AlertSeverity in ({AlertSeverity})\r\n| where \"{ProductName:lable}\" == \"All\" or ProductName in ({ProductName})\r\n| where AlertSeverity == '{AlertSeverityPicker}' or '{AlertSeverityPicker}' == \"All\"\r\n| where ProductName == '{ProductNamePicker}' or '{ProductNamePicker}' == \"All\"\r\n| extend Entities = iff(isempty(Entities), todynamic('[{\"dummy\" : \"\"}]'), todynamic(Entities))\r\n| mvexpand Entities\r\n| evaluate bag_unpack(Entities, \"Entity_\")\r\n| extend Entity_Type = columnifexists(\"Entity_Type\", \"\")\r\n| where Entity_Type in (\"account\", \"alerts\", \"azure-resource\", \"cloud-application\", \"dns\", \"file\", \"filehash\", \"host\", \"host-logon-session\", \"ip\", \"malware\", \"network-connection\", \"process\", \"registry-key\", \"registry-value\", \"security-group\", \"SrvSvcSessionEntry\", \"url\")\r\n| summarize count() by Entity_Type\r\n| order by count_ desc","size":0,"title":"Count of Entities in Security Alerts by Type","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"unstackedbar"},"name":"CountofEntitiesinSecurityAlertsbyType"}],"fromTemplateId":"sentinel-AzureSentinelSecurityAlerts","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FSecurityAlerts.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## SecurityAlertsLighthouse
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/SecurityAlertsLighthouse.json)

### Workbook details

> Description: This workbook will get a report on Security Alerts Multi Tenant.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":"{\"json\":\"# Security Alerts multitenant dashboard\"}","name":"text - 0"},{"type":9,"content":"{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"92e95a8e-625d-46a5-99b0-377de489ac98\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Tenant\",\"type\":2,\"isRequired\":true,\"query\":\"Resources \\r\\n| distinct tenantId\",\"crossComponentResources\":[\"value::all\"],\"value\":\"4b2462a4-bbee-495a-a0e1-f23ae524cc9c\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::1\"]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"dd3214bb-bcb8-4350-9628-b7aafb1055ee\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"query\":\"resourcecontainers | where type == \\\"microsoft.resources/subscriptions\\\" and tenantId == \\\"{Tenant}\\\" | project id\",\"crossComponentResources\":[\"value::all\"],\"value\":\"/subscriptions/44e4eff8-1fcb-4a22-a7d6-992ac7286382\",\"typeSettings\":{\"additionalResourceOptions\":[]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"4a8a5f96-02a8-427e-af4b-5370a362c8d9\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources | where type =~ 'Microsoft.OperationalInsights/workspaces' | project id\",\"crossComponentResources\":[\"{Subscription}\"],\"value\":[\"/subscriptions/44e4eff8-1fcb-4a22-a7d6-992ac7286382/resourceGroups/SOC/providers/Microsoft.OperationalInsights/workspaces/CyberSecurityDemo\"],\"typeSettings\":{\"additionalResourceOptions\":[]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}","name":"parameters - 1"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert | project TimeGenerated, AlertName, AlertSeverity, Description, TenantId\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]}","name":"query - 2"}],"isLocked":false}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FSecurityAlertsLighthouse.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## SecurityOperationsEfficiency
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/SecurityOperationsEfficiency.json)

### Workbook details

> Description: This workbook will get a report on Security Operations Efficiency.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"# Security Operations Efficiency (Preview)"},"customWidth":"35","name":"Main headline"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["value::all"],"parameters":[{"id":"9a199167-2dde-49dd-8f01-23e9d1fa8151","version":"KqlParameterItem/1.0","name":"InternalWSs","type":1,"isRequired":true,"query":"SecurityIncident\r\n| take 1\r\n| parse IncidentUrl with * \"/workspaces/\" Workspace \"/\" *\r\n| project Workspace","isHiddenWhenLocked":true,"timeContext":{"durationMs":604800000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"7806fefd-432f-4828-9756-8c0be5c08d07","version":"KqlParameterItem/1.0","name":"InternalSub","type":1,"isRequired":true,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| take 1\r\n| project subscriptionId","crossComponentResources":["value::selected"],"isHiddenWhenLocked":true,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"55d3ab63-6e1f-4d02-8d9e-2225526689c7","version":"KqlParameterItem/1.0","name":"Subscription","type":6,"isRequired":true,"query":"summarize by subscriptionId\r\n| project value = strcat(\"/subscriptions/\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{InternalSub}', true, false)","crossComponentResources":["value::selected"],"typeSettings":{"additionalResourceOptions":[]},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"95a45501-31b5-4ea2-bcb3-eb208e0080e2","version":"KqlParameterItem/1.0","name":"Workspace","type":5,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"//resources | where type =~ 'Microsoft.operationsmanagement/solutions' | where name contains //'SecurityInsights' | project id //= tostring(properties.workspaceResourceId)\r\n\r\nwhere type =~ 'microsoft.operationalinsights/workspaces'\r\n| project value =id, label = name, selected = iff(name =~ '{InternalWSs}', true, false)\r\n\r\n\r\n","crossComponentResources":["value::all"],"typeSettings":{"additionalResourceOptions":[]},"timeContextFromParameter":"TimeRange","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"7d597ad7-4a2a-45ed-a4fe-7ee32de0fc22","version":"KqlParameterItem/1.0","name":"TimeRange","label":"Incident Creation Time","type":4,"isRequired":true,"value":{"durationMs":2592000000},"typeSettings":{"selectableValues":[{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2592000000}],"allowCustom":true}},{"id":"3a87d4f7-42cc-4c62-b543-6b5d9ab8cf27","version":"KqlParameterItem/1.0","name":"Severity","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityIncident\r\n| summarize Count = count(IncidentNumber) by Severity\r\n| project Value = Severity, Label = strcat(Severity, \": \", Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"81085d3a-5aca-488e-b7c6-ecf1167e59f7","version":"KqlParameterItem/1.0","name":"Tactics","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityIncident\r\n| extend Tactics = todynamic(AdditionalData.tactics)\r\n| mvexpand Tactics to typeof(string)\r\n| summarize Count=count(IncidentNumber) by Tactics\r\n| project Value = Tactics, Label = strcat(Tactics, \": \", Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"0f9efb0d-ac34-41d0-8a19-165840eb2a71","version":"KqlParameterItem/1.0","name":"Owner","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityIncident\r\n| extend owner = tostring(Owner.assignedTo) \r\n| summarize Count=count(IncidentNumber) by Owner= case(owner==\"\", \"Unassigned\",owner)\r\n| project Value = Owner, Label = strcat(Owner, \": \", Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"cf86113b-59ad-4fc9-aeb7-9b44e230641e","version":"KqlParameterItem/1.0","name":"Product","label":"Product Name","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityIncident\r\n| extend Product = tostring(parse_json(tostring(AdditionalData.alertProductNames))[0]) \r\n| summarize Count=count(IncidentNumber) by Product\r\n| project Value = Product, Label = strcat(Product, \": \", Count)\r\n","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"*"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"customWidth":"65","name":"parameters - 6"},{"type":1,"content":{"json":"## Incidents created over time"},"customWidth":"67","name":"Incidents over time - headline"},{"type":1,"content":{"json":"## Incidents by closing classification"},"customWidth":"32","name":"Incidents by classification - headline"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident \n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| summarize arg_max(TimeGenerated, Status, Severity, Owner, AdditionalData,CreatedTime) by IncidentNumber\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize count() by bin(CreatedTime, 1h)\n\n\n\n","size":1,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TimeBrush","exportFieldName":"CreatedTime","exportParameterName":"TimePicker","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"unstackedbar","gridSettings":{"sortBy":[{"itemKey":"CreatedTime","sortOrder":2}]},"sortBy":[{"itemKey":"CreatedTime","sortOrder":2}],"chartSettings":{"seriesLabelSettings":[{"seriesName":"count_","label":"Incidents"}]}},"customWidth":"67","name":"Incidents over time "},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where CreatedTime >= {TimeBrush:start} and CreatedTime <= {TimeBrush:end}\n| where Status == 'Closed'\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| extend feedback =strcat(Classification,\" \",ClassificationReason)\n| summarize dcount(IncidentNumber) by feedback\n","size":1,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"piechart"},"customWidth":"33","name":"Incidents by classification - headline"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident \n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| summarize arg_max(TimeGenerated,Status, Severity, Owner, AdditionalData) by IncidentNumber\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize dcount(IncidentNumber) by Severity","size":1,"title":"Incidents created by severity","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"piechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Classification","formatter":1},"leftContent":{"columnMatch":"dcount_IncidentNumber","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{"seriesLabelSettings":[{"seriesName":"Informational","color":"gray"},{"seriesName":"Low","color":"yellow"},{"seriesName":"Medium","color":"orange"},{"seriesName":"High","color":"red"}]}},"customWidth":"22","name":"By severity"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| summarize arg_max(TimeGenerated, Status, Severity, Owner, AdditionalData) by IncidentNumber\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize count() by case(tostring(Owner)==\"\", \"Unassigned\",tostring(Owner))\n\n","size":1,"title":"Incidents created by owner","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"piechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Classification","formatter":1},"leftContent":{"columnMatch":"dcount_IncidentNumber","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"customWidth":"22","name":"By owner"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| summarize arg_max(TimeGenerated, Status, Severity, Owner, AdditionalData) by IncidentNumber\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize count() by Status\n","size":1,"title":"Incidents created by status","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"piechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Classification","formatter":1},"leftContent":{"columnMatch":"dcount_IncidentNumber","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"customWidth":"22","name":"By status"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where FirstModifiedTime  >= {TimeRange:start} and FirstModifiedTime  <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize arg_max(LastModifiedTime,*) by IncidentNumber \n| extend TimeToTriage =  (FirstModifiedTime - CreatedTime)/1h\n| summarize 50th_Percentile=percentile(TimeToTriage, 50) \n","size":1,"title":"Mean time to triage","timeContext":{"durationMs":94608000000,"endTime":"2023-06-01T16:58:00.000Z"},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"formatter":1},"leftContent":{"columnMatch":"50th_Percentile","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":26,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":3}}},"showBorder":false,"size":"auto"}},"customWidth":"17","name":"MTTT"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where ClosedTime >= {TimeRange:start} and ClosedTime <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize arg_max(TimeGenerated,*) by IncidentNumber \n| extend TimeToClosure =  (ClosedTime - CreatedTime)/1h\n| summarize 50th_Percentile=percentile(TimeToClosure, 50)","size":1,"title":"Mean time to closure ","timeContext":{"durationMs":94608000000,"endTime":"2023-06-01T16:33:00.000Z"},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"Classification","formatter":1,"formatOptions":{}},"leftContent":{"columnMatch":"50th_Percentile","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":26,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":3}}},"showBorder":false,"size":"auto"}},"customWidth":"17","name":"MTTM"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Incidents created by severity over time "},"name":"text - 2 - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident \n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize Incidents=dcount(IncidentNumber) by Severity, bin(CreatedTime, 1d)","size":1,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart"},"name":"query - 2 - Copy - Copy"}]},"name":"Incidents severity over time"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Incidents created by owner over time "},"name":"text - 2 - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident \n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize Incidents=dcount(IncidentNumber) by case(tostring(Owner)==\"\", \"Unassigned\",tostring(Owner)), bin(CreatedTime, 1d)\n","size":1,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart"},"name":"query - 2 - Copy - Copy - Copy"}]},"name":"Incident owner over time"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Incidents created by status over time"},"name":"text - 2 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident \n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize Incidents=dcount(IncidentNumber) by Status, bin(CreatedTime, 1d)","size":1,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","exportFieldName":"series","exportParameterName":"Status","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart"},"name":"query - 2 - Copy"}]},"name":"Incident status over time","styleSettings":{"margin":"0","padding":"0"}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Incidents created by product over time"},"name":"text - 2 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident \n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize Incidents=dcount(IncidentNumber) by tostring(Product), bin(CreatedTime, 1d)","size":1,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","exportFieldName":"series","exportParameterName":"Status","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart"},"name":"query - 2 - Copy"}]},"name":"Incident status over time - Copy","styleSettings":{"margin":"0","padding":"0"}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Incidents created by tactics over time "},"name":"text - 2 - Copy - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident \n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| mvexpand Tactics to typeof(string)\n| summarize Incidents=dcount(IncidentNumber) by Tactics, bin(CreatedTime, 1d)","size":1,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"unstackedbar"},"name":"query - 2 - Copy - Copy - Copy - Copy"}]},"name":"Incidents tactic over time"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Incidents created by tags over time "},"name":"text - 2 - Copy - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident \n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| extend Tags = extract_all('labelName\":\"(.*?)\"',tostring(Labels))\n| mvexpand Tags to typeof(string)\n| summarize Incidents=dcount(IncidentNumber) by Tags, bin(CreatedTime, 1d)","size":1,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"unstackedbar"},"name":"query - 2 - Copy - Copy - Copy - Copy"}]},"name":"Incidents tactic over time - Copy"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Incidents created by name"},"name":"text - 2 - Copy - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident \n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| summarize arg_max(TimeGenerated, Status, Severity, Owner, AdditionalData,CreatedTime) by IncidentNumber, Title\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize count() by bin(CreatedTime, 1h), Title\n| order by count_ desc","size":1,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"piechart"},"name":"query - 2 - Copy - Copy - Copy - Copy"}]},"name":"Incidents tactic over time - Copy - Copy"}]},"customWidth":"50","name":"Over time left panel"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Time to triage\r\nThe time between the incident creation and first modification by percentiles"},"name":"text - 2 - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where FirstModifiedTime  >= {TimeRange:start} and FirstModifiedTime  <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize arg_max(LastModifiedTime,*) by IncidentNumber \n| extend TimeToTriage =  (FirstModifiedTime - CreatedTime)/1h\n| summarize 5th_Percentile=max_of(percentile(TimeToTriage, 5),0),50th_Percentile=percentile(TimeToTriage, 50), 90th_Percentile=percentile(TimeToTriage, 90),99th_Percentile=percentile(TimeToTriage, 99) by bin(FirstModifiedTime, 1d)\n","size":1,"aggregation":3,"timeContext":{"durationMs":94608000000,"endTime":"2023-06-01T16:45:00.000Z"},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart","chartSettings":{"ySettings":{"numberFormatSettings":{"unit":26,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":3}}}}},"name":"query - 2 - Copy - Copy"}]},"name":"Incidents severity over time"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Time to closure\r\nThe time between the incident creation and closure by percentiles\r\n\r\n"},"name":"text - 2 - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where ClosedTime  >= {TimeRange:start} and ClosedTime  <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize arg_max(LastModifiedTime,*) by IncidentNumber \n| extend TimeToClosure =  (ClosedTime - CreatedTime)/1h\n| summarize 5th_Percentile=percentile(TimeToClosure, 5),50th_Percentile=percentile(TimeToClosure, 50), 90th_Percentile=percentile(TimeToClosure, 90),99th_Percentile=percentile(TimeToClosure, 99) by bin(ClosedTime, 1d)\n","size":1,"aggregation":3,"timeContext":{"durationMs":94608000000,"endTime":"2023-06-01T16:47:00.000Z"},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart","gridSettings":{"sortBy":[{"itemKey":"percentile_MinToTriage_5","sortOrder":2}]},"sortBy":[{"itemKey":"percentile_MinToTriage_5","sortOrder":2}],"tileSettings":{"showBorder":false},"chartSettings":{"ySettings":{"numberFormatSettings":{"unit":26,"options":{"style":"decimal","useGrouping":true,"maximumFractionDigits":3}},"min":0}}},"name":"query - 2 - Copy - Copy - Copy"}]},"name":"Incident owner over time"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Mean time to closure per owner\r\nThe mean time between the incident creation and first modification by owner\r\n\r\n"},"name":"text - 2 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where CreatedTime >= {TimeBrush:start} and CreatedTime <= {TimeBrush:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n|where Status == 'Closed'  \n| extend Ownerr = case(tostring(Owner)==\"\", \"Unassigned\",tostring(Owner))\n| summarize arg_min(LastModifiedTime,*) by IncidentNumber, Owner = Ownerr\n| extend TimeToTriage = LastModifiedTime - CreatedTime, Owner\n| summarize avg(TimeToTriage/1h) by Owner\n","size":4,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","exportFieldName":"series","exportParameterName":"Status","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Owner","formatter":1,"formatOptions":{}},"leftContent":{"columnMatch":"avg_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":26,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":3}}},"showBorder":false}},"name":"query - 2 - Copy"}]},"name":"Incident status over time","styleSettings":{"margin":"0","padding":"0"}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Mean time to triage per owner\r\nThe mean time between the incident creation and first modification by owner\r\n\r\n"},"name":"text - 2 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize arg_max(FirstModifiedTime,*) by IncidentNumber \n| extend TimeToTriage =  FirstModifiedTime - CreatedTime\n| extend MinToTriage = TimeToTriage/1h\n| summarize avg(TimeToTriage/1h) by owner=case(tostring(Owner)==\"\", \"Unassigned\",tostring(Owner))\n\n","size":4,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","exportFieldName":"series","exportParameterName":"Status","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"owner","formatter":1},"leftContent":{"columnMatch":"avg_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":26,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":3}}},"showBorder":false}},"name":"query - 2 - Copy"}]},"name":"Incident status over time - Copy","styleSettings":{"margin":"0","padding":"0"}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Actions per user\r\nThe number of actions taken on incidents per incident modifier"},"name":"text - 2 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where CreatedTime >= {TimeBrush:start} and CreatedTime <= {TimeBrush:end}\n| where ModifiedBy !in(\"Alert Grouping\",\"Fusion\",\"Incident created from alert\")\n| where ModifiedBy !contains(\"Automation rule\")\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| summarize count() by ModifiedBy\n","size":4,"timeContext":{"durationMs":2592000000},"timeContextFromParameter":"TimeRange","exportFieldName":"series","exportParameterName":"Status","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"ModifiedBy","formatter":1,"formatOptions":{}},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"}},"showBorder":false,"sortCriteriaField":"count_","sortOrderField":2}},"name":"query - 2 - Copy"}]},"name":"Incident status over time - Copy","styleSettings":{"margin":"0","padding":"0"}},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Recent incident closing classification"},"name":"text - 2 - Copy - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| where Status == 'Closed'\n| order by LastModifiedTime \n| project LastModifiedTime,IncidentNumber, Title, Classification, ClassificationReason,ClassificationComment, Product, IncidentUrl, ModifiedBy,Status, Severity\n| take 250\n\n\n","size":1,"timeContext":{"durationMs":604800000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"IncidentUrl","formatter":7,"formatOptions":{"linkTarget":"Url","linkLabel":"Go to incident >"}}],"labelSettings":[{"columnId":"LastModifiedTime","label":"Last Modified Time"},{"columnId":"IncidentNumber","label":"Incident Number"},{"columnId":"Title"},{"columnId":"Classification"},{"columnId":"ClassificationReason","label":"Classification Reason"},{"columnId":"ClassificationComment","label":"Classification Comment"},{"columnId":"Product"},{"columnId":"IncidentUrl","label":"Link to incident"},{"columnId":"ModifiedBy","label":"Modified By"},{"columnId":"Status"},{"columnId":"Severity"}]},"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"IncidentNumber","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"name":"query - 2 - Copy - Copy - Copy - Copy"}]},"name":"Incidents tactic over time - Copy"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":1,"content":{"json":"## Recent activities"},"name":"text - 2 - Copy - Copy - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\n| where Severity in ({Severity}) or '{Severity:label}' ==  \"All\"\n| extend Tactics = todynamic(AdditionalData.tactics)\n| where Tactics in ({Tactics}) or '{Tactics:label}' ==  \"All\"\n| extend Owner = todynamic(Owner.assignedTo) \n| where Owner in ({Owner}) or '{Owner:label}' ==  \"All\"\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0])) \n| where Product in ({Product}) or '{Product:label}' ==  \"All\"\n| order by LastModifiedTime \n| project LastModifiedTime,IncidentNumber, Title, Product, IncidentUrl, ModifiedBy,Status, Severity\n| take 250\n\n\n","size":1,"timeContext":{"durationMs":86400000},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"IncidentUrl","formatter":7,"formatOptions":{"linkTarget":"Url","linkLabel":"Go to incident >"}}],"labelSettings":[{"columnId":"LastModifiedTime","label":"Last Modified Time"},{"columnId":"IncidentNumber","label":"Incident Number"},{"columnId":"Title"},{"columnId":"Product"},{"columnId":"IncidentUrl","label":"Link to incident"},{"columnId":"ModifiedBy","label":"Modified By"},{"columnId":"Status"},{"columnId":"Severity"}]},"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"IncidentNumber","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"name":"query - 2 - Copy - Copy - Copy - Copy"}]},"name":"Incidents tactic over time - Copy"}]},"customWidth":"50","name":"Over time right panel"}],"fromTemplateId":"sentinel-SecurityOperationsEfficiency","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FSecurityOperationsEfficiency.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## SecuritySOC
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/SecuritySOC.json)

### Workbook details

> Description: This workbook will get a report on Security Alerts for SOC Team.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":11,"content":{"version":"LinkItem/1.0",     "style":"tabs","links":[{"id":"bd1fe7f2-1d9e-4eb5-b689-9c0e62cda4af","cellValue":"Tab","linkTarget":"parameter",      "linkLabel":"Text, Grids, Tiles","subTarget":"Text","preText":"","style":"link"},      {"id":"d084ef2a-c7fa-4dd3-bb4c-c3c52d13e225","cellValue":"Tab","linkTarget":"parameter","linkLabel":"Charts and      Graphs","subTarget":"Charts","style":"link"},{"id":"732d5f9b-9c10-4c3e-91d6-8203b88928f0","cellValue":"Tab",     "linkTarget":"parameter","linkLabel":"Time Brushing","subTarget":"TB","style":"link"},     {"id":"d687003f-b2b9-4709-bbaf-746979868b29","cellValue":"Tab","linkTarget":"parameter","linkLabel":"Dynamic      Content","subTarget":"DC","style":"link"},{"id":"bba62313-af80-46ae-8dc8-a61534d54a42","cellValue":"Tab",   "linkTarget":"parameter","linkLabel":"Personalization","subTarget":"Personalization","style":"link"}]},      "name":"links - 1"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[     {"type":1,"content":{"json":"This is an example of text being put in a workbook. This workbook shows different types of      visualizations that can be achieved in Sentinel workbooks."},"name":"text - 0"},{"type":9,"content":  {"version":"KqlParameterItem/1.0","parameters":[{"id":"a39e8bae-dd20-4c06-85ca-83cea33a1fa2",      "version":"KqlParameterItem/1.0","name":"TimeParameter","label":"Time Parameter","type":4,"isRequired":true,    "value":{"durationMs":86400000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},      {"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},    {"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},     {"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}]}}],    "style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 1"},   {"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityAlert\r\n| take 20","size":0,"timeContext":   {"durationMs":86400000},"timeContextFromParameter":"TimeParameter","queryType":0,"resourceType":"microsoft.       operationalinsights/workspaces"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0",    "query":"Usage\r\n| summarize count() by DataType\r\n| sort by count_ desc","size":0,"timeContext":    {"durationMs":86400000},"timeContextFromParameter":"TimeParameter","queryType":0,"resourceType":"microsoft.        operationalinsights/workspaces","visualization":"tiles","tileSettings":{"showBorder":false,"titleContent":       {"columnMatch":"DataType","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":  {"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},       "name":"query - 3"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo","value":"Text"},    "name":"TGT"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,     "content":{"version":"KqlItem/1.0","query":"SecurityAlert\r\n| where TimeGenerated >= ago(90d)\r\n| summarize count()        by ProductName, bin(TimeGenerated,1d)","size":0,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces",      "visualization":"categoricalbar"},"name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0",        "query":"SecurityAlert\r\n| where TimeGenerated >= ago(90d)\r\n| summarize count() by ProductName, bin(TimeGenerated,1d)",      "size":0,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},   "customWidth":"33","name":"query - 4"},{"type":3,"content":{"version":"KqlItem/1.0",  "query":"SecurityAlert\r\n| where TimeGenerated >= ago(90d)\r\n| summarize count() by ProductName, bin(TimeGenerated,1d)",       "size":0,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"linechart"},  "customWidth":"66","name":"query - 5"},{"type":3,"content":{"version":"KqlItem/1.0",     "query":"SecurityAlert\r\n| where TimeGenerated >= ago(90d)\r\n| summarize count() by ProductName","size":0,      "queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"graph","graphSettings":       {"type":2,"topContent":{"columnMatch":"ProductName","formatter":1,"formatOptions":{"showIcon":true}},     "centerContent":{"columnMatch":"count_","formatter":1,"formatOptions":{"showIcon":true},"numberFormat":{"unit":17,   "options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"hivesContent":{"columnMatch":"ProductName",    "formatter":1,"formatOptions":{"showIcon":true}},"nodeIdField":"ProductName","nodeSize":null,"staticNodeSize":100,   "colorSettings":{"nodeColorField":"ProductName","type":1,"colorPalette":"pastel"},"groupByField":"ProductName",   "hivesMargin":5}},"name":"query - 3"}]},"conditionalVisibility":{"parameterName":"Tab","comparison":"isEqualTo",     "value":"Charts"},"name":"Charts"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable",     "items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityAlert\r\n| where TimeGenerated >= ago(90d)     \r\n| summarize count() by ProductName, bin(TimeGenerated,1d)","size":0,"title":"Time Brushing Example",    "timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces",      "visualization":"timechart"},"name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0",    "query":"SecurityAlert\r\n","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush",       "queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"query - 1"}]},"conditionalVisibility":     {"parameterName":"Tab","comparison":"isEqualTo","value":"TB"},"name":"TB"},{"type":12,"content":     {"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0",   "query":"SecurityAlert\r\n| extend Resource = ResourceId\r\n| summarize count() by Resource\r\n| sort by count_     desc\r\n","size":0,"title":"Machines with Alerts","timeContext":{"durationMs":2592000000},    "exportMultipleValues":true,"exportedParameters":[{"fieldName":"Resource","parameterName":"Resource"}],"queryType":0,       "resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true}},"customWidth":"25",   "name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let Resource_ = dynamic({Resource});    \r\nSecurityAlert\r\n| where ResourceId contains tostring(Resource_)\r\n| project TimeGenerated, Resource_, AlertName,       AlertSeverity, ProductName\r\n","size":0,"title":"Alerts per Resource","timeContext":{"durationMs":2592000000},      "queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"customWidth":"75","conditionalVisibility":      {"parameterName":"Resource","comparison":"isNotEqualTo"},"name":"query - 6"}]},"conditionalVisibility":     {"parameterName":"Tab","comparison":"isEqualTo","value":"DC"},"name":"DC"},{"type":12,"content":      {"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0",     "query":"SecurityRecommendation\r\n| where RecommendationState contains 'unhealthy'\r\n| extend Link = strcat('http://',     RecommendationLink)\r\n| project AssessedResourceId, RecommendationName, RecommendationState, RecommendationSeverity, Link",    "size":0,"timeContext":{"durationMs":2592000000},"queryType":0,"resourceType":"microsoft.operationalinsights/      workspaces"},"name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0",     "query":"SecurityRecommendation\r\n| where RecommendationState contains 'unhealthy'\r\n| extend Link = strcat('http://',       RecommendationLink)\r\n| project AssessedResourceId, RecommendationName, RecommendationState, RecommendationSeverity, Link",        "size":0,"timeContext":{"durationMs":2592000000},"queryType":0,"resourceType":"microsoft.operationalinsights/        workspaces","gridSettings":{"formatters":[{"columnMatch":"RecommendationSeverity","formatter":18,"formatOptions":      {"thresholdsOptions":"colors","thresholdsGrid":[{"operator":"==","thresholdValue":"High",     "representation":"redBright","text":"{0}{1}"},{"operator":"==","thresholdValue":"Medium",     "representation":"yellow","text":"{0}{1}"},{"operator":"==","thresholdValue":"Low","representation":"blue",    "text":"{0}{1}"},{"operator":"==","thresholdValue":"Informational","representation":"gray","text":"{0}{1}"},     {"operator":"Default","thresholdValue":null,"representation":"blue","text":"{0}{1}"}]}},{"columnMatch":"Link",      "formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true}}],"labelSettings":[        {"columnId":"AssessedResourceId","label":"Resource"},{"columnId":"RecommendationName","label":"Recommendation"},        {"columnId":"RecommendationState","label":"Status"},{"columnId":"RecommendationSeverity","label":"Severity"},       {"columnId":"Link"}]}},"name":"query - 5"}]},"conditionalVisibility":{"parameterName":"Tab",  "comparison":"isEqualTo","value":"Personalization"},"name":"Personalization"}],"isLocked":false,       "fallbackResourceIds":["/subscriptions/c3a3408b-632a-4df4-9c92-deded42a7e48/resourcegroups/accorinvest/providers/microsoft.  operationalinsights/workspaces/accorinvest"],"fromTemplateId":"sentinel-UserWorkbook"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FSecuritySOC.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## SecurityStatus
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/SecurityStatus.json)

### Workbook details

> Description: This workbook will get a report on Assets Security State.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["value::selected"],"parameters":[{"id":"688dc7cb-bea3-41ae-ae94-32d22e09568c","version":"KqlParameterItem/1.0","name":"DefaultWorkspace","type":5,"isRequired":true,"value":"value::1","isHiddenWhenLocked":true,"typeSettings":{"resourceTypeFilter":{"microsoft.operationalinsights/workspaces":true},"additionalResourceOptions":["value::1"]}},{"id":"c11b5651-cf86-4865-b23d-9ecc4f16b712","version":"KqlParameterItem/1.0","name":"ContextFree","type":1,"query":"{\"version\":\"1.0.0\",\"content\":\"\\\"{DefaultWorkspace}\\\"\"}","isHiddenWhenLocked":true,"queryType":8},{"id":"bbbc300a-6f91-4b2b-b4b5-842b4bf8577a","version":"KqlParameterItem/1.0","name":"Selection","type":1,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| extend match = strcat(\"'\", id, \"'\") =~ \"{DefaultWorkspace:value}\"\r\n| order by match desc, name asc\r\n| take 1\r\n| project value = tostring(pack('sub', subscriptionId, 'rg', resourceGroup, 'ws', id))","crossComponentResources":["value::selected"],"isHiddenWhenLocked":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources"}],"style":"above","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"conditionalVisibility":{"parameterName":"_","comparison":"isEqualTo","value":"_"},"name":"parameters - 0"},{"type":1,"content":{"json":"# Computer Security Status\r\n<br>\r\n### This report shows various security status messages from Azure Resource Graph and Log Analytics"},"conditionalVisibility":{"parameterName":"ContextFree","comparison":"isEqualTo","value":"value::1"},"name":"text - 1"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Workspaces}"],"parameters":[{"id":"1db5ee15-fe52-458b-91d1-7ee39d8c2cd3","version":"KqlParameterItem/1.0","name":"Subscriptions","type":6,"isRequired":true,"query":"summarize by subscriptionId\r\n| project value = strcat('/subscriptions/', subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ todynamic('{Selection}').sub, true, false)","crossComponentResources":["value::selected"],"typeSettings":{"additionalResourceOptions":[]},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"9732eff8-fb57-4cbd-8ade-5ae746f33760","version":"KqlParameterItem/1.0","name":"Workspaces","type":5,"isRequired":true,"query":"resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| summarize by id, name\r\n| project id, selected = iff(id =~ todynamic('{Selection}').ws, true, false)","crossComponentResources":["{Subscriptions}"],"value":"/subscriptions/<subs_ID>/resourcegroups/<rg_name>/providers/microsoft.operationalinsights/workspaces/<workspace_name>","typeSettings":{"resourceTypeFilter":{"microsoft.operationalinsights/workspaces":true},"additionalResourceOptions":[]},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"5f8cce4b-9c4c-47da-8683-7e5ccc9faed3","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"typeSettings":{"selectableValues":[{"durationMs":300000,"createdTime":"2018-10-04T22:01:18.372Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":900000,"createdTime":"2018-10-04T22:01:18.372Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":1800000,"createdTime":"2018-10-04T22:01:18.372Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":3600000,"createdTime":"2018-10-04T22:01:18.372Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":14400000,"createdTime":"2018-10-04T22:01:18.374Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":43200000,"createdTime":"2018-10-04T22:01:18.374Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":86400000,"createdTime":"2018-10-04T22:01:18.374Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":172800000,"createdTime":"2018-10-04T22:01:18.374Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":259200000,"createdTime":"2018-10-04T22:01:18.375Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":604800000,"createdTime":"2018-10-04T22:01:18.375Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":1209600000,"createdTime":"2018-10-04T22:01:18.375Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":2592000000,"createdTime":"2018-10-04T22:01:18.375Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":5184000000,"createdTime":"2018-10-04T22:01:18.375Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":7776000000,"createdTime":"2018-10-04T22:01:18.375Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false}],"allowCustom":true},"value":{"durationMs":604800000}},{"id":"d6de19ff-cde4-41c2-9fba-b441312ea5c9","version":"KqlParameterItem/1.0","name":"Test","type":1,"query":"Perf\r\n| where TimeGenerated {TimeRange}\r\n| take 1","crossComponentResources":["{Workspaces}"],"isHiddenWhenLocked":true,"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"4e5f340e-9ca8-4f16-aa10-48d30b486cce","version":"KqlParameterItem/1.0","name":"Computer","type":5,"query":"resources\r\n| where type == \"microsoft.compute/virtualmachines\" or type == \"microsoft.hybridcompute/machines\"\r\n| project name","crossComponentResources":["{Workspaces}"],"value":"default","typeSettings":{"additionalResourceOptions":[]},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"}],"style":"above","queryType":1,"resourceType":"microsoft.resourcegraph/resources"},"name":"parameters - 2"},{"type":1,"content":{"json":"⚠ A subscription has not yet been selected. Select a subscription under the `Subscriptions` dropdown or refresh the workbook."},"conditionalVisibility":{"parameterName":"Subscriptions","comparison":"isEqualTo","value":null},"name":"text - 29"},{"type":1,"content":{"json":"---"},"name":"text - 4"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Status","subTarget":"Status","style":"link"},{"cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Events","subTarget":"Events","style":"link"},{"cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Azure Arc","subTarget":"Arc","style":"link"}]},"name":"links - 20"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\r\n| where type == \"microsoft.security/securitystatuses\" or type == \"microsoft.security/securitystatuses/servers\" or type == \"microsoft.security/assessments\" \r\n//| where name startswith '{Computer}'\r\n| extend compute = tostring(properties.type)\r\n| where compute =~\"virtualmachine\"\r\n| summarize count() by name","size":4,"title":"Count of Computers with Securtity status info","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Workspaces}"],"visualization":"piechart","chartSettings":{"showMetrics":false}},"customWidth":"50","name":"query - 20 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource = Table_Name *\r\n| where Table_Name in (\"Syslog\",\"SecurityEvent\",\"CommonSecurityLog\")\r\n| summarize count(EventID) by Table_Name","size":4,"title":"Count of log entries by Type","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"piechart"},"customWidth":"50","name":"query - 20"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\r\n| where type == \"microsoft.security/securitystatuses\" or type == \"microsoft.security/securitystatuses/servers\" or type == \"microsoft.security/assessments\" \r\n| where name startswith '{Computer}'\r\n| extend p=array_length(properties.resourceDetails) \r\n| extend compute = tostring(properties.type)\r\n| where compute =~\"virtualmachine\"\r\n| mvexpand prop=properties.resourceDetails\r\n| project ComputerName = name, Resource= prop.name, Status = prop.value ","size":0,"title":"Security Status for {Computer}","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Workspaces}"],"gridSettings":{"formatters":[{"columnMatch":"ComputerName","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Resource","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Status","formatter":0,"formatOptions":{"showIcon":true}}]}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Status"},"name":"query - 7"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\r\n| where type == \"microsoft.security/assessments\"\r\n| where properties contains '{Computer}'\r\n| project Resource = properties.displayName, Status = trim(@\"[^\\w]+\",tostring(split(properties.status,\":\",1))), Location =  trim(@\"[^\\w]+\",tostring(split(properties.resourceDetails,\":\",1)))\r\n| extend Status  = iif(Status has \",\",trim(@\"[^\\w]+\",tostring(split(Status,\",\",0))),Status)\r\n| extend Location = iif(Location has \"\\\\\",trim(@\"[^\\w]+\",tostring(split(Location,\"\\\\\",0))),Location)\r\n| summarize count() by Status, tostring(Resource), Location","size":1,"title":"Security Asessment findings for {Computer}","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Workspaces}"],"visualization":"piechart","gridSettings":{"filter":true}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Status"},"name":"query - 18"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\r\n| where type == \"microsoft.security/assessments\"\r\n| where properties contains '{Computer}'\r\n| project Resource = properties.displayName, Status = trim(@\"[^\\w]+\",tostring(split(properties.status,\":\",1))), Location =  trim(@\"[^\\w]+\",tostring(split(properties.resourceDetails,\":\",1)))\r\n| extend Status   = iif(Status has \",\",trim(@\"[^\\w]+\",tostring(split(Status,\",\",0))),Status)\r\n| extend Location = iif(Location has \"\\\\\",trim(@\"[^\\w]+\",tostring(split(Location,\"\\\\\",0))),Location)\r\n| summarize count() by Status, tostring(Resource), Location\r\n| order by count_ desc","size":0,"title":"Security Asessment findings for {Computer}","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Workspaces}"],"gridSettings":{"filter":true,"sortBy":[{"itemKey":"Status","sortOrder":2}]},"sortBy":[{"itemKey":"Status","sortOrder":2}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Status"},"name":"query - 18 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityEvent\r\n| where Computer startswith \"{Computer}\"\r\n| summarize count() by Activity\r\n","size":1,"title":"Securtity Events for: {Computer} ","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"piechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Activity","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"graphSettings":{"type":0,"topContent":{"columnMatch":"Activity","formatter":1,"formatOptions":{"showIcon":true}},"centerContent":{"columnMatch":"count_","formatter":1,"formatOptions":{"showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"nodeIdField":"Activity","nodeSize":null,"staticNodeSize":100,"colorSettings":null,"hivesMargin":5}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Events"},"name":"query - 8"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Syslog\r\n| where Computer startswith \"{Computer}\"\r\n| summarize count() by Facility, SeverityLevel\r\n","size":1,"title":"Syslog for: {Computer}","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"piechart"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Events"},"name":"query - 10"},{"type":3,"content":{"version":"KqlItem/1.0","query":"CommonSecurityLog\r\n| where Computer startswith \"{Computer}\"\r\n| summarize count() by DeviceVendor, DeviceEventClassID, Message\r\n","size":1,"title":"CommonSecurityEvent (CEF) for: {Computer}","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"piechart"},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Events"},"name":"query - 11"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union isfuzzy=true     (W3CIISLog\r\n| extend TrafficDirection = \"InboundOrUnknown\", Country=RemoteIPCountry, Latitude=RemoteIPLatitude, Longitude=RemoteIPLongitude),     (DnsEvents\r\n| extend TrafficDirection = \"InboundOrUnknown\", Country= RemoteIPCountry, Latitude = RemoteIPLatitude, Longitude = RemoteIPLongitude),     (WireData\r\n| extend TrafficDirection = iff(Direction != \"Outbound\",\"InboundOrUnknown\", \"Outbound\"), Country=RemoteIPCountry, Latitude=RemoteIPLatitude, Longitude=RemoteIPLongitude),     (WindowsFirewall\r\n| extend TrafficDirection = iff(CommunicationDirection != \"SEND\",\"InboundOrUnknown\", \"Outbound\"), Country=MaliciousIPCountry, Latitude=MaliciousIPLatitude, Longitude=MaliciousIPLongitude),     (CommonSecurityLog\r\n| extend TrafficDirection = iff(CommunicationDirection != \"Outbound\",\"InboundOrUnknown\", \"Outbound\"), Country=MaliciousIPCountry, Latitude=MaliciousIPLatitude, Longitude=MaliciousIPLongitude, Confidence=ThreatDescription, Description=ThreatDescription),     (VMConnection\r\n| where Type == \"VMConnection\"\r\n| extend TrafficDirection = iff(Direction != \"outbound\",\"InboundOrUnknown\", \"Outbound\"), Country=RemoteCountry, Latitude=RemoteLatitude, Longitude=RemoteLongitude)\r\n| where isnotempty(MaliciousIP) and isnotempty(Country) and isnotempty(Latitude) and isnotempty(Longitude)\r\n| where Computer startswith \"{Computer}\"\r\n| summarize MaliciousIPcount = count(MaliciousIP) by Country//, Latitude, Longitude\r\n| order by MaliciousIPcount desc\r\n| top 10 by Country\r\n","size":0,"title":"Potential Locations for: {Computer}","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"map","gridSettings":{"sortBy":[{"itemKey":"MaliciousIPcount","sortOrder":2}]},"sortBy":[{"itemKey":"MaliciousIPcount","sortOrder":2}],"mapSettings":{"locInfo":"CountryRegion","locInfoColumn":"Country","latitude":"Latitude","longitude":"Longitude","sizeSettings":"MaliciousIPcount","sizeAggregation":"Sum","defaultSize":0,"labelSettings":"MaliciousIP","legendAggregation":"Sum","itemColorSettings":{"nodeColorField":"MaliciousIPcount","colorAggregation":"Sum","type":"heatmap","heatmapPalette":"greenRed"}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Events"},"name":"query - 14"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union isfuzzy=true     (W3CIISLog\r\n| extend TrafficDirection = \"InboundOrUnknown\", Country=RemoteIPCountry, Latitude=RemoteIPLatitude, Longitude=RemoteIPLongitude),     (DnsEvents\r\n| extend TrafficDirection = \"InboundOrUnknown\", Country= RemoteIPCountry, Latitude = RemoteIPLatitude, Longitude = RemoteIPLongitude),     (WireData\r\n| extend TrafficDirection = iff(Direction != \"Outbound\",\"InboundOrUnknown\", \"Outbound\"), Country=RemoteIPCountry, Latitude=RemoteIPLatitude, Longitude=RemoteIPLongitude),     (WindowsFirewall\r\n| extend TrafficDirection = iff(CommunicationDirection != \"SEND\",\"InboundOrUnknown\", \"Outbound\"), Country=MaliciousIPCountry, Latitude=MaliciousIPLatitude, Longitude=MaliciousIPLongitude),     (CommonSecurityLog\r\n| extend TrafficDirection = iff(CommunicationDirection != \"Outbound\",\"InboundOrUnknown\", \"Outbound\"), Country=MaliciousIPCountry, Latitude=MaliciousIPLatitude, Longitude=MaliciousIPLongitude, Confidence=ThreatDescription, Description=ThreatDescription),     (VMConnection\r\n| where Type == \"VMConnection\"\r\n| extend TrafficDirection = iff(Direction != \"outbound\",\"InboundOrUnknown\", \"Outbound\"), Country=RemoteCountry, Latitude=RemoteLatitude, Longitude=RemoteLongitude)\r\n| where isnotempty(MaliciousIP) and isnotempty(Country) and isnotempty(Latitude) and isnotempty(Longitude)\r\n| where Computer startswith \"{Computer}\"\r\n| summarize MaliciousIPcount = dcount(MaliciousIP), TableSource = make_set(Type) by Country, TrafficDirection\r\n| top 10 by MaliciousIPcount\r\n| order by MaliciousIPcount desc\r\n\r\n","size":0,"title":"Top10: Potential Locations for: {Computer}","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspaces}"],"visualization":"table","gridSettings":{"sortBy":[{"itemKey":"MaliciousIPcount","sortOrder":2}]},"sortBy":[{"itemKey":"MaliciousIPcount","sortOrder":2}],"mapSettings":{"locInfo":"CountryRegion","locInfoColumn":"Code","latitude":"Latitude","longitude":"Longitude","sizeSettings":"count_","sizeAggregation":"Sum","defaultSize":0,"labelSettings":"MaliciousIP","legendAggregation":"Sum","itemColorSettings":{"nodeColorField":"MaliciousIPcount","colorAggregation":"Sum","type":"heatmap","heatmapPalette":"greenRed"}}},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Events"},"name":"query - 14 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":" resources\r\n| where type == \"microsoft.hybridcompute/machines\"\r\n//| extend p=array_length(properties.provisioningState) \r\n| mvexpand prop=properties.provisioningState\r\n| project ComputerName = id,  Status = properties.status, State=prop, location, resourceGroup, type","size":1,"title":"All Azure Arc resources","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"sortBy":[]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Arc"},"name":"query - 18"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\r\n| where type == \"microsoft.security/assessments\"\r\n| where properties has '{Computer}'\r\n| project Resource = properties.displayName, Status = trim(@\"[^\\w]+\",tostring(split(properties.status,\":\",1))), Location =  trim(@\"[^\\w]+\",tostring(split(properties.resourceDetails,\":\",1)))\r\n| extend Status   = iif(Status has \",\",trim(@\"[^\\w]+\",tostring(split(Status,\",\",0))),Status)\r\n| extend Location = iif(Location has \"\\\\\",trim(@\"[^\\w]+\",tostring(split(Location,\"\\\\\",0))),Location)\r\n| where Location == \"OnPremise\"\r\n| summarize count() by Status, tostring(Resource), Location=\"Azure Arc\"\r\n| order by count_ desc","size":1,"title":"Azure Arc Security Status for: {Computer}","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscriptions}"],"gridSettings":{"formatters":[{"columnMatch":"Status","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Resource","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Location","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"id","formatter":7,"formatOptions":{"linkTarget":"Resource","showIcon":true}},{"columnMatch":"count_","formatter":0,"formatOptions":{"showIcon":true}}]},"sortBy":[]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Arc"},"name":"query - 18 - Copy"}],"fromTemplateId":"sentinel-SecurityStatus","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FSecurityStatus.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## SharepointOnedrive
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/SharepointOnedrive.json)

### Workbook details

> Description: This workbook will get a report on Sharepoint and Onedrive.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","query":"","crossComponentResources":[],"parameters":[{"id":"36a4172e-0e49-4884-b2a2-2281528a2ff4","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"isRequired":true,"value":{"durationMs":2592000000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}],"allowCustom":true}},{"id":"4e1b6539-9788-43e2-a283-4891f33f1677","version":"KqlParameterItem/1.0","name":"Operations","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"OfficeActivity\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint')\r\n| summarize Count = count() by Operation\r\n| order by Count desc, Operation asc\r\n| project Value = Operation, Label = strcat(Operation, ' - ', Count)","value":null,"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"e2b700d7-d218-47db-9521-52176ed43005","version":"KqlParameterItem/1.0","name":"Users","type":2,"isRequired":true,"multiSelect":true,"quote":"'","delimiter":",","query":"OfficeActivity\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint')\r\n| where Operation in ({Operations})\r\n| summarize Count = count() by UserId\r\n| order by Count desc, UserId asc\r\n| project Value = UserId, Label = strcat(UserId, ' - ', Count)","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 1"},{"type":1,"content":{"json":"## **General overview**"},"name":"text - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = OfficeActivity\r\n| where \"{Operations:lable}\"==\"All\" or Operation in ({Operations})\r\n| where \"{Users:lable}\"==\"All\" or UserId in ({Users})\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint');\r\ndata\r\n| summarize Count = count() by OfficeWorkload\r\n| join kind = fullouter (datatable(OfficeWorkload:string)['OneDrive', 'SharePoint']) on OfficeWorkload\r\n| project OfficeWorkload = iff(OfficeWorkload == '', OfficeWorkload1, OfficeWorkload), Count = iff(OfficeWorkload == '', 0, Count)\r\n| join kind = inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by OfficeWorkload)\r\n    on OfficeWorkload\r\n| project-away OfficeWorkload1, TimeGenerated\r\n| extend OfficeWorkload = OfficeWorkload\r\n| union (\r\n    data \r\n    | summarize Count = count() \r\n    | extend jkey = 1\r\n    | join kind=inner (data\r\n        | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n        | extend jkey = 1) on jkey\r\n    | extend OfficeWorkload = 'All', OfficeWorkloads = '*'    \r\n)\r\n| order by Count desc\r\n| take 10\r\n","size":4,"exportFieldName":"OfficeWorkload","exportParameterName":"SelectedWorkload","exportDefaultValue":"All","exportToExcelOptions":"visible","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"OfficeWorkload","formatter":1,"formatOptions":{"showIcon":true}},"leftContent":{"columnMatch":"Count","formatter":12,"formatOptions":{"palette":"auto","showIcon":true},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"secondaryContent":{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"coldHot","showIcon":true}},"showBorder":false}},"customWidth":"50","name":"query - 10"},{"type":1,"content":{"json":"## Operation summary"},"name":"text - 11"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = OfficeActivity\r\n| where \"{Operations:lable}\"==\"All\" or Operation in ({Operations})\r\n| where \"{Users:lable}\"==\"All\" or UserId in ({Users})\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint') and (\"{SelectedWorkload}\"==\"All\" or OfficeWorkload==\"{SelectedWorkload}\");\r\nlet appData = data\r\n| summarize TotalCount = count() by Operation\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Operation\r\n    | project-away TimeGenerated) on Operation\r\n| order by TotalCount desc, Operation asc\r\n| project Operation, TotalCount, Trend\r\n| serialize Id = row_number();\r\ndata\r\n| summarize TotalCount = count() by UserId , Operation\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Operation, UserId\r\n    | project-away TimeGenerated) on Operation, UserId\r\n| order by TotalCount desc, Operation asc\r\n| project Operation, UserId, TotalCount, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on Operation\r\n| project Id, Name = UserId, Type = 'UserId', ['Operations Count'] = TotalCount, Trend,  ParentId = Id1\r\n| union (appData \r\n    | project Id, Name = Operation, Type = 'Operation', ['Operations Count'] = TotalCount,  Trend)\r\n| order by ['Operations Count'] desc, Name asc","size":1,"exportParameterName":"OperationDetail","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\"}","showAnalytics":true,"showExportToExcel":true,"exportToExcelOptions":"visible","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Type","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Operations Count","formatter":8,"formatOptions":{"min":0,"palette":"orange","showIcon":true}},{"columnMatch":"Trend","formatter":9,"formatOptions":{"min":0,"palette":"gray","showIcon":true}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name"},"labelSettings":[]}},"name":"query - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({OperationDetail});\r\nOfficeActivity\r\n| where \"{Operations:lable}\"==\"All\" or Operation in ({Operations})\r\n| where \"{Users:lable}\"==\"All\" or UserId in ({Users})\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint') and (\"{SelectedWorkload}\"==\"All\" or OfficeWorkload==\"{SelectedWorkload}\")\r\n| where details.Type == '*' or (details.Type == 'Operation' and Operation == details.Name) or (details.Type == 'UserId' and UserId == details.Name)\r\n| summarize Amount = count() by Operation, bin_at(TimeGenerated, 1d, now()) \r\n| sort by Amount ","size":1,"exportDefaultValue":"*","showAnalytics":true,"exportToExcelOptions":"visible","title":"Activities over time","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"linechart"},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({OperationDetail});\r\nOfficeActivity \r\n| where \"{Operations:lable}\"==\"All\" or Operation in ({Operations})\r\n| where \"{Users:lable}\"==\"All\" or UserId in ({Users})\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint') and (\"{SelectedWorkload}\"==\"All\" or OfficeWorkload==\"{SelectedWorkload}\")\r\n| where Site_Url != '' \r\n| where details.Type == '*' or (details.Type == 'Operation' and Operation == details.Name) or (details.Type == 'UserId' and UserId == details.Name)\r\n| summarize Number = count() by Site_Url, UserId, Operation, TimeGenerated","size":0,"showAnalytics":true,"exportToExcelOptions":"visible","title":"Sites","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"50","name":"query - 4"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({OperationDetail});\r\nOfficeActivity \r\n| where \"{Operations:lable}\"==\"All\" or Operation in ({Operations})\r\n| where \"{Users:lable}\"==\"All\" or UserId in ({Users})\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint') and (\"{SelectedWorkload}\"==\"All\" or OfficeWorkload==\"{SelectedWorkload}\")\r\n| where details.Type == '*' or (details.Type == 'Operation' and Operation == details.Name) or (details.Type == 'UserId' and UserId == details.Name)\r\n| summarize Number = count() by ClientIP , UserId, Operation, bin(TimeGenerated, 1d)","size":0,"showAnalytics":true,"exportToExcelOptions":"visible","title":"IP addresses","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"50","name":"query - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({OperationDetail});\r\nOfficeActivity \r\n| where \"{Operations:lable}\"==\"All\" or Operation in ({Operations})\r\n| where \"{Users:lable}\"==\"All\" or UserId in ({Users})\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint') and (\"{SelectedWorkload}\"==\"All\" or OfficeWorkload==\"{SelectedWorkload}\")\r\n| where Site_Url != '' \r\n| where details.Type == '*' or (details.Type == 'Operation' and Operation == details.Name) or (details.Type == 'UserId' and UserId == details.Name)\r\n| summarize Number = count() by Site_Url, UserId, Operation, bin(TimeGenerated, 1d)\r\n| order by Number, TimeGenerated","size":1,"exportToExcelOptions":"visible","title":"Sites details","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true,"labelSettings":[]}},"customWidth":"50","name":"query - 6"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({OperationDetail});\r\nOfficeActivity \r\n| where \"{Operations:lable}\"==\"All\" or Operation in ({Operations})\r\n| where \"{Users:lable}\"==\"All\" or UserId in ({Users})\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint') and (\"{SelectedWorkload}\"==\"All\" or OfficeWorkload==\"{SelectedWorkload}\")\r\n| where details.Type == '*' or (details.Type == 'Operation' and Operation == details.Name) or (details.Type == 'UserId' and UserId == details.Name)\r\n| summarize Number = count() by ClientIP , UserId, Operation, bin(TimeGenerated, 1d)\r\n| order by Number, TimeGenerated","size":1,"exportToExcelOptions":"visible","title":"IP addresses details","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"filter":true,"labelSettings":[]}},"customWidth":"50","name":"query - 7"},{"type":1,"content":{"json":"## file operations"},"name":"text - 12"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let data = OfficeActivity\r\n| where \"{Operations:lable}\"==\"All\" or Operation in ({Operations})\r\n| where \"{Users:lable}\"==\"All\" or UserId in ({Users})\r\n| where Operation contains \"file\"\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint') and (\"{SelectedWorkload}\"==\"All\" or OfficeWorkload==\"{SelectedWorkload}\");\r\nlet appData = data\r\n| summarize TotalCount = count() by Operation\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Operation\r\n    | project-away TimeGenerated) on Operation\r\n| order by TotalCount desc, Operation asc\r\n| project Operation, TotalCount, Trend\r\n| serialize Id = row_number();\r\ndata\r\n| summarize TotalCount = count() by SourceFileExtension , Operation\r\n| join kind=inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Operation, SourceFileExtension\r\n    | project-away TimeGenerated) on Operation, SourceFileExtension\r\n| order by TotalCount desc, Operation asc\r\n| project Operation, SourceFileExtension, TotalCount, Trend\r\n| serialize Id = row_number(1000000)\r\n| join kind=inner (appData) on Operation\r\n| project Id, Name = SourceFileExtension, Type = 'SourceFileExtension', ['Operations Count'] = TotalCount, Trend,  ParentId = Id1\r\n| union (appData \r\n    | project Id, Name = Operation, Type = 'Operation', ['Operations Count'] = TotalCount,  Trend)\r\n| order by ['Operations Count'] desc, Name asc","size":0,"exportParameterName":"FileOperations","exportDefaultValue":"{ \"Name\":\"\", \"Type\":\"*\"}","exportToExcelOptions":"visible","title":"FIle operations","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Id","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"Name","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Type","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Operations Count","formatter":8,"formatOptions":{"min":0,"palette":"blue","showIcon":true}},{"columnMatch":"Trend","formatter":10,"formatOptions":{"min":0,"palette":"greenDark","showIcon":true}},{"columnMatch":"ParentId","formatter":5,"formatOptions":{"showIcon":true}}],"filter":true,"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Name"},"labelSettings":[]}},"name":"query - 8"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let details = dynamic({FileOperations});\r\nOfficeActivity \r\n| where \"{Operations:lable}\"==\"All\" or Operation in ({Operations})\r\n| where \"{Users:lable}\"==\"All\" or UserId in ({Users})\r\n| where OfficeWorkload in ('OneDrive', 'SharePoint') and (\"{SelectedWorkload}\"==\"All\" or OfficeWorkload==\"{SelectedWorkload}\")\r\n| where Site_Url != '' \r\n| where details.Type == '*' or (details.Type == 'Operation' and Operation == details.Name) or (details.Type == 'SourceFileExtension' and SourceFileExtension == details.Name)\r\n| summarize Number = count() by SourceFileName, SourceFileExtension, UserId, Operation, DestinationFileName, DestinationFileExtension, bin(TimeGenerated, 1d)\r\n| order by Number, TimeGenerated","size":0,"exportToExcelOptions":"visible","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"SourceFileName","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true,"showIcon":true}},{"columnMatch":"SourceFileExtension","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"UserId","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Operation","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"DestinationFileName","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"DestinationFileExtension","formatter":5,"formatOptions":{"showIcon":true}},{"columnMatch":"TimeGenerated","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Number","formatter":8,"formatOptions":{"palette":"lightBlue","showIcon":true}}],"labelSettings":[]}},"name":"query - 9"}],"styleSettings":{},"fromTemplateId":"sentinel-SharePointAndOneDrive","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FSharepointOnedrive.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## UEAB
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/UEAB.json)

### Workbook details

> Description: This workbook will get a report on user activity.

> Query:

```t
{"styleSettings":{},"fromTemplateId":"sentinel-UserAndEntityBehaviorAnalytics","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json","version":"Notebook/1.0","items":[{"type":1,"content":{"json":"# User and Entity Behavior Analytics\n---\n\nWelcome to the User and Entity Behavior Analytics workbook. The workbook provides a guided investigation\nfor entities based on open incidents, alerts and anomalies identified by the UEBA engine. "},"name":"text - 2"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"36cdaf52-4303-405d-ac9c-de2037db99c3","version":"KqlParameterItem/1.0","name":"TimeRange","label":"Time Range","type":4,"value":{"durationMs":2419200000},"typeSettings":{"selectableValues":[{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}]},"timeContext":{"durationMs":86400000}}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"SecurityIncident\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize hint.strategy = shuffle arg_max(LastModifiedTime, *) by IncidentNumber\r\n| where Status == \"New\" or Status == \"Active\"\r\n| summarize IncidentCount=count() \r\n| project \"Open Incidents\", IncidentCount","size":4,"timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Column1"},"leftContent":{"columnMatch":"IncidentCount","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":0,"options":{"style":"decimal"}}},"showBorder":false,"size":"auto"}},"customWidth":"10","name":"query - 16"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let TotalAlertsCount = SecurityIncident\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize hint.strategy = shuffle arg_max(LastModifiedTime, *) by IncidentNumber\r\n| where Status == \"New\" or Status == \"Active\"\r\n| mv-expand AlertIds\r\n| extend AlertId = tostring(AlertIds)\r\n| join kind= innerunique ( \r\nSecurityAlert | where TimeGenerated {TimeRange:query}) on $left.AlertId == $right.SystemAlertId\r\n| summarize hint.strategy = shuffle arg_max(TimeGenerated,*), NumberOfUpdates = count() by SystemAlertId\r\n| summarize AlertCount=count()\r\n| project \"Alert Count\",AlertCount;\r\nTotalAlertsCount\r\n","size":4,"timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"AlertCount","formatter":12,"formatOptions":{"palette":"auto"}},"showBorder":false,"size":"auto"}},"customWidth":"10","name":"query - 18"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let AnomalousSigninActivity = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Sign-in\"\r\n| where (UsersInsights.NewAccount == True or UsersInsights.DormantAccount == True) and (\r\n ActivityInsights.FirstTimeUserAccessedResource == True and ActivityInsights.ResourceUncommonlyAccessedAmongPeers == True\r\nor ActivityInsights.FirstTimeUserUsedApp  == True and ActivityInsights.AppUncommonlyUsedAmongPeers == False)\r\n| join (\r\nSigninLogs | where TimeGenerated {TimeRange:query} | where Status.errorCode == 0 or Status.errorCode == 0 and RiskDetail != \"none\"\r\n) on $left.SourceRecordId == $right._ItemId\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Successful Logon\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Valid Accounts\",\r\n         SubTechnique = \"\",\r\n         Description = \"Successful Sign-in with one or more of the following indications: sign by new or recently dormant accounts and sign in with resource for the first time (while none of their peers did) or to an app for the first time (while none of their peers did) or performed by a user with Risk indicaiton from AAD\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet critical = dynamic(['9b895d92-2cd3-44c7-9d02-a6ac2d5ea5c3','c4e39bd9-1100-46d3-8c65-fb160da0071f','158c047a-c907-4556-b7ef-446551a6b5f7','62e90394-69f5-4237-9190-012177145e10','d29b2b05-8046-44ba-8758-1e26182fcf32','729827e3-9c14-49f7-bb1b-9608f156bbb8','966707d0-3269-4727-9be2-8c3a10f19b9d','194ae4cb-b126-40b2-bd5b-6091b380977d','fe930be7-5e62-47db-91af-98c3a49a38b1']);\r\nlet high = dynamic(['cf1c38e5-3621-4004-a7cb-879624dced7c','7495fdc4-34c4-4d15-a289-98788ce399fd','aaf43236-0c0d-4d5f-883a-6955382ac081','3edaf663-341e-4475-9f94-5c398ef6c070','7698a772-787b-4ac8-901f-60d6b08affd2','b1be1c3e-b65d-4f19-8427-f6fa0d97feb9','9f06204d-73c1-4d4c-880a-6edb90606fd8','29232cdf-9323-42fd-ade2-1d097af3e4de','be2f45a1-457d-42af-a067-6ec1fa63bc45','7be44c8a-adaf-4e2a-84d6-ab2649e08a13','e8611ab8-c189-46e8-94e1-60213ab1f814']);\r\nlet AnomalousRoleAssignment = AuditLogs\r\n| where TimeGenerated  {TimeRange:query}\r\n| where OperationName == \"Add member to role\"\r\n| mv-expand TargetResources\r\n| extend RoleId = tostring(TargetResources.modifiedProperties[0].newValue)\r\n| where isnotempty(RoleId) and RoleId in (critical,high)\r\n| extend RoleName = tostring(TargetResources.modifiedProperties[1].newValue)\r\n| where isnotempty(RoleName)\r\n| extend TargetId = tostring(TargetResources.id)\r\n| extend Target = tostring(TargetResources.userPrincipalName)\r\n| join kind=inner ( BehaviorAnalytics\r\n     | where TimeGenerated  {TimeRange:query}\r\n     | where ActionType == \"Add member to role\"\r\n     | where UsersInsights.BlasrRadius == \"High\" or ActivityInsights.FirstTimeUserPerformedAction  == true\r\n) on $left._ItemId == $right.SourceRecordId\r\n| extend AnomalyName = \"Anomalous Role Assignemt\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Account Manipulation\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may manipulate accounts to maintain access to victim systems. These actions include adding new accounts to high privilleged groups. Dragonfly 2.0, for example, added newly created accounts to the administrators group to maintain elevated access.  The query below generates an output of all high Blast Radius users performing Add member to priveleged role, or ones that add users for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,RoleName,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority;let LogOns=materialize(\r\nBehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActivityType == \"LogOn\");\r\nlet AnomalousResourceAccess = LogOns\r\n| where ActionType == \"ResourceAccess\"\r\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\r\n| extend AnomalyName = \"Anomalous Resource Access\",\r\n         Tactic = \"Lateral Movement\",\r\n         Technique = \"\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversary may be trying to move through the environment. APT29 and APT32, for example, has used PtH & PtT techniques to lateral move around the network. The query below generates an output of all users performing an resource access (4624:3) to devices for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousRDPActivity = LogOns\r\n| where ActionType == \"RemoteInteractiveLogon\"\r\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\r\n| extend AnomalyName = \"Anomalous RDP Activity\",\r\n         Tactic = \"Lateral Movement\",\r\n         Technique = \"\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may use Valid Accounts to log into a computer using the Remote Desktop Protocol (RDP). The adversary may then perform actions as the logged-on user. FIN10, for example, has used RDP to move laterally to systems in the victim environment. The query below generates an output of all users performing a remote interactive logon (4624:10) to a device for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousLogintoDevices = LogOns\r\n| where ActionType == \"InteractiveLogon\"\r\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\r\n| where UsersInsights.DormantAccount == true or DevicesInsights.LocalAdmin == true\r\n| extend AnomalyName = \"Anomalous Login To Devices\",\r\n         Tactic = \"Privilege Escalation\",\r\n         Technique = \"Valid Accounts\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may steal the credentials of a specific user or service account using Credential Access techniques or capture credentials earlier in their reconnaissance process through social engineering for means of gaining Initial Access. APT33, for example, has used valid accounts for initial access and privilege escalation. The query below generates an output of all administator users performing an interactive logon (4624:2) to a device for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousPasswordReset = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Reset user password\"\r\n| where ActivityInsights.FirstTimeUserPerformedAction  == \"True\"\r\n| join (\r\nAuditLogs\r\n |  where TimeGenerated {TimeRange:query}\r\n |  where OperationName == \"Reset user password\"\r\n) on $left.SourceRecordId == $right._ItemId\r\n| mv-expand TargetResources\r\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Password Reset\",\r\n         Tactic = \"Impact\",\r\n         Technique = \"Account Access Removal\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may interrupt availability of system and network resources by inhibiting access to accounts utilized by legitimate users. Accounts may be deleted, locked, or manipulated (ex: changed credentials) to remove access to accounts. LockerGoga, for example, has been observed changing account passwords and logging off current users. The query below generates an output of all users performing Reset user password for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority\r\n| sort by TimeGenerated desc;\r\nlet AnomalousGeoLocationLogon = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Sign-in\"\r\n| where ActivityInsights.FirstTimeUserConnectedFromCountry == True and (ActivityInsights.FirstTimeConnectionFromCountryObservedInTenant == True or ActivityInsights.CountryUncommonlyConnectedFromAmongPeers == True)\r\n| join (\r\nSigninLogs\r\n |  where TimeGenerated {TimeRange:query}\r\n) on $left.SourceRecordId == $right._ItemId\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Successful Logon\",\r\n         Tactic = \"Initial Access\",\r\n         Technique = \"Valid Accounts\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may steal the credentials of a specific user or service account using Credential Access techniques or capture credentials earlier in their reconnaissance process through social engineering for means of gaining Initial Access. APT33, for example, has used valid accounts for initial access. The query below generates an output of successful Sign-in performed by a user from a new geo location he has never connected from before, and none of his peers as well.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousFailedLogon = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActivityType == \"LogOn\"\r\n| where UsersInsights.BlastRadius == \"High\"\r\n| join (\r\n  SigninLogs  \r\n     | where TimeGenerated {TimeRange:query}\r\n     | where Status.errorCode == 50126\r\n) on $left.SourceRecordId == $right._ItemId\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Failed Logon\",\r\n         Tactic = \"Credential Access\",\r\n         Technique = \"Brute Force\",\r\n         SubTechnique = \"Password Guessing\",\r\n         Description = \"Adversaries with no prior knowledge of legitimate credentials within the system or environment may guess passwords to attempt access to accounts. Emotet, for example, has been observed using a hard coded list of passwords to brute force user accounts. The query below generates an output of all users with 'High' BlastRadius that perform failed Sign-in:Invalid username or password.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousAADAccountManipulation = AuditLogs\r\n| where TimeGenerated {TimeRange:query}\r\n| where OperationName == \"Update user\"\r\n| mv-expand AdditionalDetails\r\n| where AdditionalDetails.key == \"UserPrincipalName\"\r\n| mv-expand TargetResources\r\n| extend RoleId = tostring(TargetResources.modifiedProperties[0].newValue)\r\n| where isnotempty(RoleId) and RoleId in (critical,high)\r\n| extend RoleName = tostring(TargetResources.modifiedProperties[1].newValue)\r\n| where isnotempty(RoleName)\r\n| extend TargetId = tostring(TargetResources.id)\r\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\r\n| join kind=inner ( \r\n    BehaviorAnalytics\r\n    | where TimeGenerated {TimeRange:query}\r\n    | where ActionType == \"Update user\"\r\n    | where UsersInsights.BlasrRadius == \"High\" or ActivityInsights.FirstTimeUserPerformedAction == true\r\n) on $left._ItemId == $right.SourceRecordId\r\n|  extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName) \r\n| extend AnomalyName = \"Anomalous Account Manipulation\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Account Manipulation\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may manipulate accounts to maintain access to victim systems. These actions include adding new accounts to high privilleged groups. Dragonfly 2.0, for example, added newly created accounts to the administrators group to maintain elevated access. The query below generates an output of all high Blast Radius users performing 'Update user' (name change) to priveleged role, or ones that changed users for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,RoleName,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; let AnomalousAADAccountCreation = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Add user\"\r\n| where ActivityInsights.FirstTimeUserPerformedAction == True or ActivityInsights.FirstTimeActionPerformedInTenant == True or ActivityInsights.ActionUncommonlyPerformedAmongPeers == true\r\n| join(\r\nAuditLogs\r\n    | where TimeGenerated {TimeRange:query} \r\n    | where OperationName == \"Add user\"\r\n) on $left.SourceRecordId == $right._ItemId\r\n| mv-expand TargetResources\r\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\r\n| extend DisplayName = tostring(UsersInsights.AccountDisplayName),\r\nUserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Account Creation\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Create Account\",\r\n         SubTechnique = \"Cloud Account\",\r\n         Description = \"Adversaries may create a cloud account to maintain access to victim systems. With a sufficient level of access, such accounts may be used to establish secondary credentialed access that does not require persistent remote access tools to be deployed on the system. The query below generates an output of all the users performing user creation for the first time and the target users that were created.\"\t\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority\r\n| sort by TimeGenerated desc;\r\nlet AnomalyTable = union kind=outer  AnomalousSigninActivity, AnomalousRoleAssignment, AnomalousResourceAccess, AnomalousRDPActivity, AnomalousPasswordReset, AnomalousLogintoDevices, AnomalousGeoLocationLogon, AnomalousAADAccountManipulation, AnomalousAADAccountCreation, AnomalousFailedLogon;\r\nAnomalyTable\r\n| summarize AnomaliesCount=count()\r\n| project \"Anomalies Count\", AnomaliesCount","size":4,"timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"AnomaliesCount","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}},"showBorder":false,"size":"auto"}},"customWidth":"10","name":"query - 17","styleSettings":{"margin":"12"}},{"type":3,"content":{"version":"KqlItem/1.0","query":"let AnomalousSigninActivity = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Sign-in\"\r\n| where (UsersInsights.NewAccount == True or UsersInsights.DormantAccount == True) and (\r\n ActivityInsights.FirstTimeUserAccessedResource == True and ActivityInsights.ResourceUncommonlyAccessedAmongPeers == True\r\nor ActivityInsights.FirstTimeUserUsedApp  == True and ActivityInsights.AppUncommonlyUsedAmongPeers == False)\r\n| join (\r\nSigninLogs | where TimeGenerated {TimeRange:query} | where Status.errorCode == 0 or Status.errorCode == 0 and RiskDetail != \"none\"\r\n) on $left.SourceRecordId == $right._ItemId\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Successful Logon\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Valid Accounts\",\r\n         SubTechnique = \"\",\r\n         Description = \"Successful Sign-in with one or more of the following indications: sign by new or recently dormant accounts and sign in with resource for the first time (while none of their peers did) or to an app for the first time (while none of their peers did) or performed by a user with Risk indicaiton from AAD\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet critical = dynamic(['9b895d92-2cd3-44c7-9d02-a6ac2d5ea5c3','c4e39bd9-1100-46d3-8c65-fb160da0071f','158c047a-c907-4556-b7ef-446551a6b5f7','62e90394-69f5-4237-9190-012177145e10','d29b2b05-8046-44ba-8758-1e26182fcf32','729827e3-9c14-49f7-bb1b-9608f156bbb8','966707d0-3269-4727-9be2-8c3a10f19b9d','194ae4cb-b126-40b2-bd5b-6091b380977d','fe930be7-5e62-47db-91af-98c3a49a38b1']);\r\nlet high = dynamic(['cf1c38e5-3621-4004-a7cb-879624dced7c','7495fdc4-34c4-4d15-a289-98788ce399fd','aaf43236-0c0d-4d5f-883a-6955382ac081','3edaf663-341e-4475-9f94-5c398ef6c070','7698a772-787b-4ac8-901f-60d6b08affd2','b1be1c3e-b65d-4f19-8427-f6fa0d97feb9','9f06204d-73c1-4d4c-880a-6edb90606fd8','29232cdf-9323-42fd-ade2-1d097af3e4de','be2f45a1-457d-42af-a067-6ec1fa63bc45','7be44c8a-adaf-4e2a-84d6-ab2649e08a13','e8611ab8-c189-46e8-94e1-60213ab1f814']);\r\nlet AnomalousRoleAssignment = AuditLogs\r\n| where TimeGenerated  {TimeRange:query}\r\n| where OperationName == \"Add member to role\"\r\n| mv-expand TargetResources\r\n| extend RoleId = tostring(TargetResources.modifiedProperties[0].newValue)\r\n| where isnotempty(RoleId) and RoleId in (critical,high)\r\n| extend RoleName = tostring(TargetResources.modifiedProperties[1].newValue)\r\n| where isnotempty(RoleName)\r\n| extend TargetId = tostring(TargetResources.id)\r\n| extend Target = tostring(TargetResources.userPrincipalName)\r\n| join kind=inner ( BehaviorAnalytics\r\n     | where TimeGenerated  {TimeRange:query}\r\n     | where ActionType == \"Add member to role\"\r\n     | where UsersInsights.BlasrRadius == \"High\" or ActivityInsights.FirstTimeUserPerformedAction  == true\r\n) on $left._ItemId == $right.SourceRecordId\r\n| extend AnomalyName = \"Anomalous Role Assignemt\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Account Manipulation\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may manipulate accounts to maintain access to victim systems. These actions include adding new accounts to high privilleged groups. Dragonfly 2.0, for example, added newly created accounts to the administrators group to maintain elevated access.  The query below generates an output of all high Blast Radius users performing Add member to priveleged role, or ones that add users for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,RoleName,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority;let LogOns=materialize(\r\nBehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActivityType == \"LogOn\");\r\nlet AnomalousResourceAccess = LogOns\r\n| where ActionType == \"ResourceAccess\"\r\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\r\n| extend AnomalyName = \"Anomalous Resource Access\",\r\n         Tactic = \"Lateral Movement\",\r\n         Technique = \"\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversary may be trying to move through the environment. APT29 and APT32, for example, has used PtH & PtT techniques to lateral move around the network. The query below generates an output of all users performing an resource access (4624:3) to devices for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousRDPActivity = LogOns\r\n| where ActionType == \"RemoteInteractiveLogon\"\r\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\r\n| extend AnomalyName = \"Anomalous RDP Activity\",\r\n         Tactic = \"Lateral Movement\",\r\n         Technique = \"\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may use Valid Accounts to log into a computer using the Remote Desktop Protocol (RDP). The adversary may then perform actions as the logged-on user. FIN10, for example, has used RDP to move laterally to systems in the victim environment. The query below generates an output of all users performing a remote interactive logon (4624:10) to a device for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousLogintoDevices = LogOns\r\n| where ActionType == \"InteractiveLogon\"\r\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\r\n| where UsersInsights.DormantAccount == true or DevicesInsights.LocalAdmin == true\r\n| extend AnomalyName = \"Anomalous Login To Devices\",\r\n         Tactic = \"Privilege Escalation\",\r\n         Technique = \"Valid Accounts\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may steal the credentials of a specific user or service account using Credential Access techniques or capture credentials earlier in their reconnaissance process through social engineering for means of gaining Initial Access. APT33, for example, has used valid accounts for initial access and privilege escalation. The query below generates an output of all administator users performing an interactive logon (4624:2) to a device for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousPasswordReset = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Reset user password\"\r\n| where ActivityInsights.FirstTimeUserPerformedAction  == \"True\"\r\n| join (\r\nAuditLogs\r\n |  where TimeGenerated {TimeRange:query}\r\n |  where OperationName == \"Reset user password\"\r\n) on $left.SourceRecordId == $right._ItemId\r\n| mv-expand TargetResources\r\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Password Reset\",\r\n         Tactic = \"Impact\",\r\n         Technique = \"Account Access Removal\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may interrupt availability of system and network resources by inhibiting access to accounts utilized by legitimate users. Accounts may be deleted, locked, or manipulated (ex: changed credentials) to remove access to accounts. LockerGoga, for example, has been observed changing account passwords and logging off current users. The query below generates an output of all users performing Reset user password for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority\r\n| sort by TimeGenerated desc;\r\nlet AnomalousGeoLocationLogon = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Sign-in\"\r\n| where ActivityInsights.FirstTimeUserConnectedFromCountry == True and (ActivityInsights.FirstTimeConnectionFromCountryObservedInTenant == True or ActivityInsights.CountryUncommonlyConnectedFromAmongPeers == True)\r\n| join (\r\nSigninLogs\r\n |  where TimeGenerated {TimeRange:query}\r\n) on $left.SourceRecordId == $right._ItemId\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Successful Logon\",\r\n         Tactic = \"Initial Access\",\r\n         Technique = \"Valid Accounts\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may steal the credentials of a specific user or service account using Credential Access techniques or capture credentials earlier in their reconnaissance process through social engineering for means of gaining Initial Access. APT33, for example, has used valid accounts for initial access. The query below generates an output of successful Sign-in performed by a user from a new geo location he has never connected from before, and none of his peers as well.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousFailedLogon = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActivityType == \"LogOn\"\r\n| where UsersInsights.BlastRadius == \"High\"\r\n| join (\r\n  SigninLogs  \r\n     | where TimeGenerated {TimeRange:query}\r\n     | where Status.errorCode == 50126\r\n) on $left.SourceRecordId == $right._ItemId\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Failed Logon\",\r\n         Tactic = \"Credential Access\",\r\n         Technique = \"Brute Force\",\r\n         SubTechnique = \"Password Guessing\",\r\n         Description = \"Adversaries with no prior knowledge of legitimate credentials within the system or environment may guess passwords to attempt access to accounts. Emotet, for example, has been observed using a hard coded list of passwords to brute force user accounts. The query below generates an output of all users with 'High' BlastRadius that perform failed Sign-in:Invalid username or password.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousAADAccountManipulation = AuditLogs\r\n| where TimeGenerated {TimeRange:query}\r\n| where OperationName == \"Update user\"\r\n| mv-expand AdditionalDetails\r\n| where AdditionalDetails.key == \"UserPrincipalName\"\r\n| mv-expand TargetResources\r\n| extend RoleId = tostring(TargetResources.modifiedProperties[0].newValue)\r\n| where isnotempty(RoleId) and RoleId in (critical,high)\r\n| extend RoleName = tostring(TargetResources.modifiedProperties[1].newValue)\r\n| where isnotempty(RoleName)\r\n| extend TargetId = tostring(TargetResources.id)\r\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\r\n| join kind=inner ( \r\n    BehaviorAnalytics\r\n    | where TimeGenerated {TimeRange:query}\r\n    | where ActionType == \"Update user\"\r\n    | where UsersInsights.BlasrRadius == \"High\" or ActivityInsights.FirstTimeUserPerformedAction == true\r\n) on $left._ItemId == $right.SourceRecordId\r\n|  extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName) \r\n| extend AnomalyName = \"Anomalous Account Manipulation\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Account Manipulation\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may manipulate accounts to maintain access to victim systems. These actions include adding new accounts to high privilleged groups. Dragonfly 2.0, for example, added newly created accounts to the administrators group to maintain elevated access. The query below generates an output of all high Blast Radius users performing 'Update user' (name change) to priveleged role, or ones that changed users for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,RoleName,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; let AnomalousAADAccountCreation = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Add user\"\r\n| where ActivityInsights.FirstTimeUserPerformedAction == True or ActivityInsights.FirstTimeActionPerformedInTenant == True or ActivityInsights.ActionUncommonlyPerformedAmongPeers == true\r\n| join(\r\nAuditLogs\r\n    | where TimeGenerated {TimeRange:query} \r\n    | where OperationName == \"Add user\"\r\n) on $left.SourceRecordId == $right._ItemId\r\n| mv-expand TargetResources\r\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\r\n| extend DisplayName = tostring(UsersInsights.AccountDisplayName),\r\nUserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Account Creation\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Create Account\",\r\n         SubTechnique = \"Cloud Account\",\r\n         Description = \"Adversaries may create a cloud account to maintain access to victim systems. With a sufficient level of access, such accounts may be used to establish secondary credentialed access that does not require persistent remote access tools to be deployed on the system. The query below generates an output of all the users performing user creation for the first time and the target users that were created.\"\t\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority\r\n| sort by TimeGenerated desc;\r\nlet AnomalyTable = union kind=outer  AnomalousSigninActivity, AnomalousRoleAssignment, AnomalousResourceAccess, AnomalousRDPActivity, AnomalousPasswordReset, AnomalousLogintoDevices, AnomalousGeoLocationLogon, AnomalousAADAccountManipulation, AnomalousAADAccountCreation, AnomalousFailedLogon;\r\n\r\n\r\nlet TotalAnomaliesCount = AnomalyTable\r\n| make-series count() default=0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step 1d\r\n| extend series = \"Anomalies Trend\"\r\n| project  series, count_, TimeGenerated ;\r\nlet TotalAlertsCount = SecurityIncident\r\n|  where TimeGenerated {TimeRange:query}\r\n| summarize hint.strategy = shuffle arg_max(LastModifiedTime, *) by IncidentNumber\r\n| where Status == \"New\" or Status == \"Active\"\r\n| mv-expand AlertIds\r\n| extend AlertId = tostring(AlertIds)\r\n| join kind= innerunique ( \r\nSecurityAlert |  where TimeGenerated {TimeRange:query}\r\n) on $left.AlertId == $right.SystemAlertId\r\n| summarize hint.strategy = shuffle arg_max(TimeGenerated,*), NumberOfUpdates = count() by SystemAlertId\r\n| make-series count() default=0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step 1d\r\n| extend series = \"Alerts Trend\"\r\n| project  series, count_, TimeGenerated ;\r\nlet TotalIncidentsCount=SecurityIncident\r\n| summarize hint.strategy = shuffle arg_max(LastModifiedTime, *) by IncidentNumber\r\n| where Status == \"New\" or Status == \"Active\"\r\n| make-series count() default=0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step 1d \r\n| extend series = \"Incidents Trend\"\r\n| project series, count_, TimeGenerated;\r\nTotalIncidentsCount | union TotalAlertsCount, TotalAnomaliesCount\r\n\r\n\r\n","size":1,"timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"linechart","chartSettings":{"seriesLabelSettings":[{"seriesName":"Incidents Trend","label":"Incidents Counts","color":"blue"},{"seriesName":"Alerts Trend","label":"Alerts Counts","color":"redBright"}]}},"customWidth":"70","name":"query - 19"},{"type":1,"content":{"json":"## Top users to investigate - by Incidents, alerts & anomalies\r\n---\r\n"},"name":"text - 3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let AnomalousSigninActivity = BehaviorAnalytics\n| where TimeGenerated {TimeRange:query}\n| where ActionType == \"Sign-in\"\n| where (UsersInsights.NewAccount == True or UsersInsights.DormantAccount == True) and (\n ActivityInsights.FirstTimeUserAccessedResource == True and ActivityInsights.ResourceUncommonlyAccessedAmongPeers == True\nor ActivityInsights.FirstTimeUserUsedApp  == True and ActivityInsights.AppUncommonlyUsedAmongPeers == False)\n| join (\nSigninLogs | where TimeGenerated {TimeRange:query} | where Status.errorCode == 0 or Status.errorCode == 0 and RiskDetail != \"none\"\n) on $left.SourceRecordId == $right._ItemId\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\n| extend AnomalyName = \"Anomalous Successful Logon\",\n         Tactic = \"Persistence\",\n         Technique = \"Valid Accounts\",\n         SubTechnique = \"\",\n         Description = \"Successful Sign-in with one or more of the following indications: sign by new or recently dormant accounts and sign in with resource for the first time (while none of their peers did) or to an app for the first time (while none of their peers did) or performed by a user with Risk indicaiton from AAD\"\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \nlet critical = dynamic(['9b895d92-2cd3-44c7-9d02-a6ac2d5ea5c3','c4e39bd9-1100-46d3-8c65-fb160da0071f','158c047a-c907-4556-b7ef-446551a6b5f7','62e90394-69f5-4237-9190-012177145e10','d29b2b05-8046-44ba-8758-1e26182fcf32','729827e3-9c14-49f7-bb1b-9608f156bbb8','966707d0-3269-4727-9be2-8c3a10f19b9d','194ae4cb-b126-40b2-bd5b-6091b380977d','fe930be7-5e62-47db-91af-98c3a49a38b1']);\nlet high = dynamic(['cf1c38e5-3621-4004-a7cb-879624dced7c','7495fdc4-34c4-4d15-a289-98788ce399fd','aaf43236-0c0d-4d5f-883a-6955382ac081','3edaf663-341e-4475-9f94-5c398ef6c070','7698a772-787b-4ac8-901f-60d6b08affd2','b1be1c3e-b65d-4f19-8427-f6fa0d97feb9','9f06204d-73c1-4d4c-880a-6edb90606fd8','29232cdf-9323-42fd-ade2-1d097af3e4de','be2f45a1-457d-42af-a067-6ec1fa63bc45','7be44c8a-adaf-4e2a-84d6-ab2649e08a13','e8611ab8-c189-46e8-94e1-60213ab1f814']);\nlet AnomalousRoleAssignment = AuditLogs\n| where TimeGenerated  {TimeRange:query}\n| where OperationName == \"Add member to role\"\n| mv-expand TargetResources\n| extend RoleId = tostring(TargetResources.modifiedProperties[0].newValue)\n| where isnotempty(RoleId) and RoleId in (critical,high)\n| extend RoleName = tostring(TargetResources.modifiedProperties[1].newValue)\n| where isnotempty(RoleName)\n| extend TargetId = tostring(TargetResources.id)\n| extend Target = tostring(TargetResources.userPrincipalName)\n| join kind=inner ( BehaviorAnalytics\n     | where TimeGenerated  {TimeRange:query}\n     | where ActionType == \"Add member to role\"\n     | where UsersInsights.BlasrRadius == \"High\" or ActivityInsights.FirstTimeUserPerformedAction  == true\n) on $left._ItemId == $right.SourceRecordId\n| extend AnomalyName = \"Anomalous Role Assignemt\",\n         Tactic = \"Persistence\",\n         Technique = \"Account Manipulation\",\n         SubTechnique = \"\",\n         Description = \"Adversaries may manipulate accounts to maintain access to victim systems. These actions include adding new accounts to high privilleged groups. Dragonfly 2.0, for example, added newly created accounts to the administrators group to maintain elevated access.  The query below generates an output of all high Blast Radius users performing Add member to priveleged role, or ones that add users for the first time.\"\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,RoleName,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority;let LogOns=materialize(\nBehaviorAnalytics\n| where TimeGenerated {TimeRange:query}\n| where ActivityType == \"LogOn\");\nlet AnomalousResourceAccess = LogOns\n| where ActionType == \"ResourceAccess\"\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\n| extend AnomalyName = \"Anomalous Resource Access\",\n         Tactic = \"Lateral Movement\",\n         Technique = \"\",\n         SubTechnique = \"\",\n         Description = \"Adversary may be trying to move through the environment. APT29 and APT32, for example, has used PtH & PtT techniques to lateral move around the network. The query below generates an output of all users performing an resource access (4624:3) to devices for the first time.\"\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \nlet AnomalousRDPActivity = LogOns\n| where ActionType == \"RemoteInteractiveLogon\"\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\n| extend AnomalyName = \"Anomalous RDP Activity\",\n         Tactic = \"Lateral Movement\",\n         Technique = \"\",\n         SubTechnique = \"\",\n         Description = \"Adversaries may use Valid Accounts to log into a computer using the Remote Desktop Protocol (RDP). The adversary may then perform actions as the logged-on user. FIN10, for example, has used RDP to move laterally to systems in the victim environment. The query below generates an output of all users performing a remote interactive logon (4624:10) to a device for the first time.\"\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \nlet AnomalousLogintoDevices = LogOns\n| where ActionType == \"InteractiveLogon\"\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\n| where UsersInsights.DormantAccount == true or DevicesInsights.LocalAdmin == true\n| extend AnomalyName = \"Anomalous Login To Devices\",\n         Tactic = \"Privilege Escalation\",\n         Technique = \"Valid Accounts\",\n         SubTechnique = \"\",\n         Description = \"Adversaries may steal the credentials of a specific user or service account using Credential Access techniques or capture credentials earlier in their reconnaissance process through social engineering for means of gaining Initial Access. APT33, for example, has used valid accounts for initial access and privilege escalation. The query below generates an output of all administator users performing an interactive logon (4624:2) to a device for the first time.\"\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \nlet AnomalousPasswordReset = BehaviorAnalytics\n| where TimeGenerated {TimeRange:query}\n| where ActionType == \"Reset user password\"\n| where ActivityInsights.FirstTimeUserPerformedAction  == \"True\"\n| join (\nAuditLogs\n |  where TimeGenerated {TimeRange:query}\n |  where OperationName == \"Reset user password\"\n) on $left.SourceRecordId == $right._ItemId\n| mv-expand TargetResources\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\n| extend AnomalyName = \"Anomalous Password Reset\",\n         Tactic = \"Impact\",\n         Technique = \"Account Access Removal\",\n         SubTechnique = \"\",\n         Description = \"Adversaries may interrupt availability of system and network resources by inhibiting access to accounts utilized by legitimate users. Accounts may be deleted, locked, or manipulated (ex: changed credentials) to remove access to accounts. LockerGoga, for example, has been observed changing account passwords and logging off current users. The query below generates an output of all users performing Reset user password for the first time.\"\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority\n| sort by TimeGenerated desc;\nlet AnomalousGeoLocationLogon = BehaviorAnalytics\n| where TimeGenerated {TimeRange:query}\n| where ActionType == \"Sign-in\"\n| where ActivityInsights.FirstTimeUserConnectedFromCountry == True and (ActivityInsights.FirstTimeConnectionFromCountryObservedInTenant == True or ActivityInsights.CountryUncommonlyConnectedFromAmongPeers == True)\n| join (\nSigninLogs\n |  where TimeGenerated {TimeRange:query}\n) on $left.SourceRecordId == $right._ItemId\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\n| extend AnomalyName = \"Anomalous Successful Logon\",\n         Tactic = \"Initial Access\",\n         Technique = \"Valid Accounts\",\n         SubTechnique = \"\",\n         Description = \"Adversaries may steal the credentials of a specific user or service account using Credential Access techniques or capture credentials earlier in their reconnaissance process through social engineering for means of gaining Initial Access. APT33, for example, has used valid accounts for initial access. The query below generates an output of successful Sign-in performed by a user from a new geo location he has never connected from before, and none of his peers as well.\"\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \nlet AnomalousFailedLogon = BehaviorAnalytics\n| where TimeGenerated {TimeRange:query}\n| where ActivityType == \"LogOn\"\n| where UsersInsights.BlastRadius == \"High\"\n| join (\n  SigninLogs  \n     | where TimeGenerated {TimeRange:query}\n     | where Status.errorCode == 50126\n) on $left.SourceRecordId == $right._ItemId\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\n| extend AnomalyName = \"Anomalous Failed Logon\",\n         Tactic = \"Credential Access\",\n         Technique = \"Brute Force\",\n         SubTechnique = \"Password Guessing\",\n         Description = \"Adversaries with no prior knowledge of legitimate credentials within the system or environment may guess passwords to attempt access to accounts. Emotet, for example, has been observed using a hard coded list of passwords to brute force user accounts. The query below generates an output of all users with 'High' BlastRadius that perform failed Sign-in:Invalid username or password.\"\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \nlet AnomalousAADAccountManipulation = AuditLogs\n| where TimeGenerated {TimeRange:query}\n| where OperationName == \"Update user\"\n| mv-expand AdditionalDetails\n| where AdditionalDetails.key == \"UserPrincipalName\"\n| mv-expand TargetResources\n| extend RoleId = tostring(TargetResources.modifiedProperties[0].newValue)\n| where isnotempty(RoleId) and RoleId in (critical,high)\n| extend RoleName = tostring(TargetResources.modifiedProperties[1].newValue)\n| where isnotempty(RoleName)\n| extend TargetId = tostring(TargetResources.id)\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\n| join kind=inner ( \n    BehaviorAnalytics\n    | where TimeGenerated {TimeRange:query}\n    | where ActionType == \"Update user\"\n    | where UsersInsights.BlasrRadius == \"High\" or ActivityInsights.FirstTimeUserPerformedAction == true\n) on $left._ItemId == $right.SourceRecordId\n|  extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName) \n| extend AnomalyName = \"Anomalous Account Manipulation\",\n         Tactic = \"Persistence\",\n         Technique = \"Account Manipulation\",\n         SubTechnique = \"\",\n         Description = \"Adversaries may manipulate accounts to maintain access to victim systems. These actions include adding new accounts to high privilleged groups. Dragonfly 2.0, for example, added newly created accounts to the administrators group to maintain elevated access. The query below generates an output of all high Blast Radius users performing 'Update user' (name change) to priveleged role, or ones that changed users for the first time.\"\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,RoleName,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; let AnomalousAADAccountCreation = BehaviorAnalytics\n| where TimeGenerated {TimeRange:query}\n| where ActionType == \"Add user\"\n| where ActivityInsights.FirstTimeUserPerformedAction == True or ActivityInsights.FirstTimeActionPerformedInTenant == True or ActivityInsights.ActionUncommonlyPerformedAmongPeers == true\n| join(\nAuditLogs\n    | where TimeGenerated {TimeRange:query} \n    | where OperationName == \"Add user\"\n) on $left.SourceRecordId == $right._ItemId\n| mv-expand TargetResources\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\n| extend DisplayName = tostring(UsersInsights.AccountDisplayName),\nUserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\n| extend AnomalyName = \"Anomalous Account Creation\",\n         Tactic = \"Persistence\",\n         Technique = \"Create Account\",\n         SubTechnique = \"Cloud Account\",\n         Description = \"Adversaries may create a cloud account to maintain access to victim systems. With a sufficient level of access, such accounts may be used to establish secondary credentialed access that does not require persistent remote access tools to be deployed on the system. The query below generates an output of all the users performing user creation for the first time and the target users that were created.\"\t\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority\n| sort by TimeGenerated desc;\nlet AnomalyTable = union kind=outer  AnomalousSigninActivity, AnomalousRoleAssignment, AnomalousResourceAccess, AnomalousRDPActivity, AnomalousPasswordReset, AnomalousLogintoDevices, AnomalousGeoLocationLogon, AnomalousAADAccountManipulation, AnomalousAADAccountCreation, AnomalousFailedLogon;\nlet TopUsersByAnomalies = AnomalyTable\n| summarize hint.strategy = shuffle AnomalyCount=count() by UserName, UserPrincipalName, tostring(UsersInsights.OnPremSid), tostring(UsersInsights.AccountObjectId)\n| project Name=tolower(UserName),UPN=tolower(UserPrincipalName), AadUserId=UsersInsights_AccountObjectId, Sid=UsersInsights_OnPremSid, AnomalyCount\n| sort by AnomalyCount desc;\nlet TopUsersByIncidents = SecurityIncident\n| where TimeGenerated {TimeRange:query} \n| summarize hint.strategy = shuffle arg_max(LastModifiedTime, *) by IncidentNumber\n| where Status == \"New\" or Status == \"Active\"\n| mv-expand AlertIds\n| extend AlertId = tostring(AlertIds)\n| join kind= innerunique ( \nSecurityAlert | where TimeGenerated {TimeRange:query} \n) on $left.AlertId == $right.SystemAlertId\n| summarize hint.strategy = shuffle arg_max(TimeGenerated,*), NumberOfUpdates = count() by SystemAlertId\n| mv-expand todynamic(Entities)\n| where Entities[\"Type\"] =~ \"account\"\n| extend  Name = tostring(tolower(Entities[\"Name\"])), NTDomain = tostring(Entities[\"NTDomain\"]), UPNSuffix = tostring(Entities[\"UPNSuffix\"]), AadUserId = tostring(Entities[\"AadUserId\"]), AadTenantId = tostring(Entities[\"AadTenantId\"]), \n Sid = tostring(Entities[\"Sid\"]), IsDomainJoined = tobool(Entities[\"IsDomainJoined\"]) , Host = tostring(Entities[\"Host\"])\n| extend UPN = iff(Name != \"\" and UPNSuffix != \"\", strcat(Name, \"@\", UPNSuffix), \"\")\n| union TopUsersByAnomalies\n| extend \n        AadPivot = iff(isempty(AadUserId),iff(isempty(Sid),Name,Sid),AadUserId),\n        SidPivot = iff(isempty(Sid),iff(isempty(AadUserId),Name,AadUserId),Sid),\n        UPNExists = iff(isempty(UPN), false,true),\n        NameExists = iff(isempty(Name), false,true),\n        SidExists = iff(isempty(Sid), false,true),\n        AADExists = iff(isempty(AadUserId), false,true)\n| summarize hint.strategy = shuffle IncidentCount=dcount(IncidentNumber,4),AlertCount=dcountif(AlertId,isnotempty(AlertId),4),AnomalyCount=sum(AnomalyCount),any(Title, Severity, Status, StartTime, IncidentNumber, IncidentUrl, Owner), UPNAnchor=anyif(UPN, UPNExists == true),NameAnchor=anyif(Name, NameExists == true),AadAnchor=anyif(AadUserId, AADExists == true), SidAnchor=anyif(Sid, SidExists == true) , any(SidPivot) by AadPivot\n| summarize hint.strategy = shuffle IncidentCount=sum(IncidentCount),AlertCount=sum(AlertCount),AnomalyCount=sum(AnomalyCount), UPNAnchor=anyif(UPNAnchor, isempty(UPNAnchor) == false),NameAnchor=anyif(NameAnchor, isempty(NameAnchor) == false),AadAnchor=anyif(AadAnchor, isempty(AadAnchor) == false), SidAnchor=anyif(SidAnchor, isempty(SidAnchor) == false), any(any_Title,any_Severity,any_StartTime, any_IncidentNumber, any_IncidentUrl) by any_SidPivot\n| summarize hint.strategy = shuffle IncidentCount=sum(IncidentCount), AlertCount=sum(AlertCount),AnomalyCount=sum(AnomalyCount), UPNAnchor=anyif(UPNAnchor, isempty(UPNAnchor) == false),AadAnchor=anyif(AadAnchor, isempty(AadAnchor) == false), SidAnchor=anyif(SidAnchor, isempty(SidAnchor) == false), any(any_any_Title, any_any_Severity,any_any_StartTime, any_any_IncidentNumber, any_any_IncidentUrl) by NameAnchor\n| project [\"UserName\"]=NameAnchor,IncidentCount, AlertCount,AnomalyCount, [\"AadUserId\"]=AadAnchor,[\"OnPremSid\"]=SidAnchor , [\"UserPrincipalName\"]=UPNAnchor;\nTopUsersByIncidents\n| sort by IncidentCount, AlertCount, AnomalyCount desc\n","size":1,"showAnalytics":true,"timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","exportedParameters":[{"fieldName":"UserPrincipalName","parameterName":"SelectedUser","parameterType":1},{"fieldName":"UserName","parameterName":"UserName","parameterType":1,"defaultValue":"None"},{"fieldName":"AadUserId","parameterName":"UserObjectId","parameterType":1},{"fieldName":"OnPremSid","parameterName":"UserSid","parameterType":1},{"fieldName":"AnomalyCount","parameterName":"AnomalyCount","parameterType":1,"defaultValue":"0"}],"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"IncidentCount","formatter":8,"formatOptions":{"palette":"redDark"}}],"filter":true,"sortBy":[{"itemKey":"AnomalyCount","sortOrder":2}]},"sortBy":[{"itemKey":"AnomalyCount","sortOrder":2}]},"name":"query - 2"},{"type":1,"content":{"json":"Select a user to view Incidents & Alerts & Anomalies breakdown","style":"upsell"},"conditionalVisibility":{"parameterName":"UserName","comparison":"isEqualTo","value":"None"},"name":"text - 6"},{"type":1,"content":{"json":"## Incidents Breakdown: [{SelectedUser}]()\r\n---\r\n"},"conditionalVisibility":{"parameterName":"UserName","comparison":"isNotEqualTo","value":"None"},"name":"text - 4"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"f3097a1b-3aad-4a82-8a8a-19e2725b4ecb","version":"KqlParameterItem/1.0","name":"Severity","type":2,"multiSelect":true,"quote":"'","delimiter":",","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"jsonData":"[\"Low\",\"Medium\",\"High\"]","timeContext":{"durationMs":86400000}},{"id":"994e7321-0462-4367-aae3-a69c6d61bf26","version":"KqlParameterItem/1.0","name":"Status","type":2,"multiSelect":true,"quote":"'","delimiter":",","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"jsonData":"[\"New\",\"Active\"]","timeContext":{"durationMs":86400000}},{"id":"774bfc35-07c1-4680-b305-a65606439a53","version":"KqlParameterItem/1.0","name":"Owner","type":2,"multiSelect":true,"quote":"'","delimiter":",","query":"SecurityIncident\r\n| summarize arg_max(LastModifiedTime, *) by IncidentNumber\r\n| where Status == \"New\" or Status == \"Active\"\r\n| where isnotempty(Owner.assignedTo) \r\n| distinct tostring(Owner.assignedTo)\r\n","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"timeContext":{"durationMs":5184000000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"conditionalVisibility":{"parameterName":"UserName","comparison":"isNotEqualTo","value":"None"},"name":"parameters - 14"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let GetUserAlert = SecurityAlert\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize arg_max(TimeGenerated,*) by SystemAlertId\r\n| where Entities contains \"account\"\r\n| extend SelectedAccountUPN = tolower(tostring('{SelectedUser}')),\r\n         SelectedName = tolower(tostring('{UserName}')),\r\n         SelectAAD = tolower(tostring('{UserObjectId}')),\r\n         SelectSID = tolower(tostring('{UserSid}'))\r\n| mv-expand todynamic(Entities)\r\n| where Entities[\"Type\"] =~ \"account\"\r\n| extend  Name = tostring(tolower(Entities[\"Name\"])), NTDomain = tostring(Entities[\"NTDomain\"]), UPNSuffix = tostring(Entities[\"UPNSuffix\"]), AadUserId = tostring(Entities[\"AadUserId\"]), AadTenantId = tostring(Entities[\"AadTenantId\"]), \r\n Sid = tostring(Entities[\"Sid\"]), IsDomainJoined = tobool(Entities[\"IsDomainJoined\"]) , Host = tostring(Entities[\"Host\"])\r\n| extend UPN = iff(Name != \"\" and UPNSuffix != \"\", strcat(Name, \"@\", UPNSuffix), \"\")\r\n| where (Name == SelectedName and SelectedName != \"\" ) or (UPN == SelectedAccountUPN and SelectedAccountUPN != \"\") or (AadUserId == SelectAAD and SelectAAD != \"\") or (Sid == SelectSID and SelectSID != \"\")\r\n| serialize Id = tostring(row_number())\r\n| project TimeGenerated, Title=DisplayName, Sid,Severity=AlertSeverity, Description, ProviderName, ProductName, SystemAlertId, Id;\r\nlet MapAlertsToIncidents = SecurityIncident\r\n| where TimeGenerated {TimeRange:query}\r\n| summarize arg_max(LastModifiedTime, *) by IncidentNumber\r\n| where Status == \"New\" or Status == \"Active\"\r\n| serialize Id = tostring(IncidentNumber)\r\n| mv-expand AlertIds\r\n| extend AlertId = tostring(AlertIds)\r\n| join kind=innerunique (GetUserAlert) on $left.AlertId == $right.SystemAlertId\r\n| project TimeGenerated=TimeGenerated1, Title=Title1, Severity=Severity1,Description=Description1,  ProviderName, ProductName, SystemAlertId,Id=Id1,ParentId=Id, IncidentNumber;\r\nlet IncidentAlertsCount = MapAlertsToIncidents\r\n| summarize AlertCount=count() by IncidentNumber\r\n| join kind=innerunique (SecurityIncident \r\n| where TimeGenerated {TimeRange:query}\r\n| summarize arg_max(LastModifiedTime, *) by IncidentNumber\r\n) on $left.IncidentNumber == $right.IncidentNumber\r\n| extend SecOpsOwner = Owner.assignedTo\r\n| project TimeGenerated, Title,Severity,Description,AlertCount,Status,Owner=SecOpsOwner,BookmarkIds,Comments,Labels,IncidentUrl,Id=tostring(IncidentNumber),ParentId=\"root\";\r\nlet IncidentsAndAlertsForUser = MapAlertsToIncidents \r\n| union IncidentAlertsCount;\r\nIncidentsAndAlertsForUser\r\n| where (Severity == {Severity:value} or {Severity:value} == 'All') and (Status == {Status:value} or {Status:value} == 'All') and (Owner == {Owner:value} or {Owner:value} == 'All')\r\n| sort by AlertCount desc\r\n| project TimeGenerated, Title, AlertCount, Description, Severity, Status, Owner, BookmarkIds, Comments, Labels, IncidentUrl, Id, ParentId\r\n\r\n\r\n\r\n","size":1,"showAnalytics":true,"noDataMessage":"No incidents associated with this user","noDataMessageStyle":3,"timeContext":{"durationMs":2419200000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"AlertCount","formatter":8,"formatOptions":{"palette":"grayBlue"}},{"columnMatch":"Severity","formatter":18,"formatOptions":{"thresholdsOptions":"colors","thresholdsGrid":[{"operator":"==","thresholdValue":"Low","representation":"yellow","text":"{0}{1}"},{"operator":"==","thresholdValue":"Medium","representation":"orange","text":"{0}{1}"},{"operator":"==","thresholdValue":"High","representation":"redBright","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"blue","text":"{0}{1}"}]}},{"columnMatch":"Id","formatter":5},{"columnMatch":"Comments","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkIsContextBlade":true}},{"columnMatch":"Labels","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkIsContextBlade":true}},{"columnMatch":"IncidentUrl","formatter":7,"formatOptions":{"linkTarget":"Url"}},{"columnMatch":"ParentId","formatter":5}],"rowLimit":500,"filter":true,"hierarchySettings":{"idColumn":"Id","parentColumn":"ParentId","treeType":0,"expanderColumn":"Title"}},"sortBy":[]},"conditionalVisibility":{"parameterName":"UserName","comparison":"isNotEqualTo","value":"None"},"name":"query - 6 - Copy"},{"type":1,"content":{"json":"## Anomalies Breakdown: [{SelectedUser}]()\r\n---\r\n"},"conditionalVisibility":{"parameterName":"UserName","comparison":"isNotEqualTo","value":"None"},"name":"text - 4 - Copy"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"98f0e009-27e3-451d-a105-5c40bc269c52","version":"KqlParameterItem/1.0","name":"AnomalyName","label":" Anoamly Name","type":2,"multiSelect":true,"quote":"'","delimiter":",","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"jsonData":"[\"Anomalous Account Creation\",\r\n\"Anomalous Account Manipulation\",\r\n\"Anomalous Failed Logon\",\r\n\"Anomalous Geo Location Logon\",\r\n\"Anomalous Login to Devices\",\r\n\"Anomalous Password Reset\",\r\n\"Anomalous RDP Activity\",\r\n\"Anomalous Resource Access\",\r\n\"Anomalous Role Assignment\",\r\n\"Anomalous Sign-in Activity\"\r\n]","timeContext":{"durationMs":1209600000},"timeContextFromParameter":"TimeRange"},{"id":"d3c089ab-a356-40e6-af42-d33759981503","version":"KqlParameterItem/1.0","name":"Tactic","type":2,"multiSelect":true,"quote":"'","delimiter":",","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"jsonData":"[\"Initial Access\",\"Execution\",\"Persistence\",\"Privilege Escalation\",\"Defense Evasion\",\"Credential Access\",\"Discovery\",\"Lateral Movement\",\"Collection\", \"Command and Control\", \"Exfiltration\",\"Impact\"]\r\n\r\n\r\n","timeContext":{"durationMs":1209600000},"timeContextFromParameter":"TimeRange"},{"id":"f84c4293-3f2b-44aa-9b0e-402d449e8b6c","version":"KqlParameterItem/1.0","name":"AnomalyScore","label":"Anomaly Score","type":2,"multiSelect":true,"quote":"'","delimiter":",","value":["value::all"],"typeSettings":{"additionalResourceOptions":["value::all"],"selectAllValue":"All"},"jsonData":"[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\"]","timeContext":{"durationMs":7776000000},"timeContextFromParameter":"TimeRange"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"conditionalVisibility":{"parameterName":"UserName","comparison":"isNotEqualTo","value":"None"},"name":"parameters - 15"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let AnomalousSigninActivity = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Sign-in\"\r\n| where (UsersInsights.NewAccount == True or UsersInsights.DormantAccount == True) and (\r\n ActivityInsights.FirstTimeUserAccessedResource == True and ActivityInsights.ResourceUncommonlyAccessedAmongPeers == True\r\nor ActivityInsights.FirstTimeUserUsedApp  == True and ActivityInsights.AppUncommonlyUsedAmongPeers == False)\r\n| join (\r\nSigninLogs | where TimeGenerated {TimeRange:query} | where Status.errorCode == 0 or Status.errorCode == 0 and RiskDetail != \"none\"\r\n) on $left.SourceRecordId == $right._ItemId\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Successful Logon\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Valid Accounts\",\r\n         SubTechnique = \"\",\r\n         Description = \"Successful Sign-in with one or more of the following indications: sign by new or recently dormant accounts and sign in with resource for the first time (while none of their peers did) or to an app for the first time (while none of their peers did) or performed by a user with Risk indicaiton from AAD\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet critical = dynamic(['9b895d92-2cd3-44c7-9d02-a6ac2d5ea5c3','c4e39bd9-1100-46d3-8c65-fb160da0071f','158c047a-c907-4556-b7ef-446551a6b5f7','62e90394-69f5-4237-9190-012177145e10','d29b2b05-8046-44ba-8758-1e26182fcf32','729827e3-9c14-49f7-bb1b-9608f156bbb8','966707d0-3269-4727-9be2-8c3a10f19b9d','194ae4cb-b126-40b2-bd5b-6091b380977d','fe930be7-5e62-47db-91af-98c3a49a38b1']);\r\nlet high = dynamic(['cf1c38e5-3621-4004-a7cb-879624dced7c','7495fdc4-34c4-4d15-a289-98788ce399fd','aaf43236-0c0d-4d5f-883a-6955382ac081','3edaf663-341e-4475-9f94-5c398ef6c070','7698a772-787b-4ac8-901f-60d6b08affd2','b1be1c3e-b65d-4f19-8427-f6fa0d97feb9','9f06204d-73c1-4d4c-880a-6edb90606fd8','29232cdf-9323-42fd-ade2-1d097af3e4de','be2f45a1-457d-42af-a067-6ec1fa63bc45','7be44c8a-adaf-4e2a-84d6-ab2649e08a13','e8611ab8-c189-46e8-94e1-60213ab1f814']);\r\nlet AnomalousRoleAssignment = AuditLogs\r\n| where TimeGenerated  {TimeRange:query}\r\n| where OperationName == \"Add member to role\"\r\n| mv-expand TargetResources\r\n| extend RoleId = tostring(TargetResources.modifiedProperties[0].newValue)\r\n| where isnotempty(RoleId) and RoleId in (critical,high)\r\n| extend RoleName = tostring(TargetResources.modifiedProperties[1].newValue)\r\n| where isnotempty(RoleName)\r\n| extend TargetId = tostring(TargetResources.id)\r\n| extend Target = tostring(TargetResources.userPrincipalName)\r\n| join kind=inner ( BehaviorAnalytics\r\n     | where TimeGenerated  {TimeRange:query}\r\n     | where ActionType == \"Add member to role\"\r\n     | where UsersInsights.BlasrRadius == \"High\" or ActivityInsights.FirstTimeUserPerformedAction  == true\r\n) on $left._ItemId == $right.SourceRecordId\r\n| extend AnomalyName = \"Anomalous Role Assignemt\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Account Manipulation\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may manipulate accounts to maintain access to victim systems. These actions include adding new accounts to high privilleged groups. Dragonfly 2.0, for example, added newly created accounts to the administrators group to maintain elevated access.  The query below generates an output of all high Blast Radius users performing Add member to priveleged role, or ones that add users for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,RoleName,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority;let LogOns=materialize(\r\nBehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActivityType == \"LogOn\");\r\nlet AnomalousResourceAccess = LogOns\r\n| where ActionType == \"ResourceAccess\"\r\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\r\n| extend AnomalyName = \"Anomalous Resource Access\",\r\n         Tactic = \"Lateral Movement\",\r\n         Technique = \"\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversary may be trying to move through the environment. APT29 and APT32, for example, has used PtH & PtT techniques to lateral move around the network. The query below generates an output of all users performing an resource access (4624:3) to devices for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousRDPActivity = LogOns\r\n| where ActionType == \"RemoteInteractiveLogon\"\r\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\r\n| extend AnomalyName = \"Anomalous RDP Activity\",\r\n         Tactic = \"Lateral Movement\",\r\n         Technique = \"\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may use Valid Accounts to log into a computer using the Remote Desktop Protocol (RDP). The adversary may then perform actions as the logged-on user. FIN10, for example, has used RDP to move laterally to systems in the victim environment. The query below generates an output of all users performing a remote interactive logon (4624:10) to a device for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousLogintoDevices = LogOns\r\n| where ActionType == \"InteractiveLogon\"\r\n| where ActivityInsights.FirstTimeUserLoggedOnToDevice == true\r\n| where UsersInsights.DormantAccount == true or DevicesInsights.LocalAdmin == true\r\n| extend AnomalyName = \"Anomalous Login To Devices\",\r\n         Tactic = \"Privilege Escalation\",\r\n         Technique = \"Valid Accounts\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may steal the credentials of a specific user or service account using Credential Access techniques or capture credentials earlier in their reconnaissance process through social engineering for means of gaining Initial Access. APT33, for example, has used valid accounts for initial access and privilege escalation. The query below generates an output of all administator users performing an interactive logon (4624:2) to a device for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousPasswordReset = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Reset user password\"\r\n| where ActivityInsights.FirstTimeUserPerformedAction  == \"True\"\r\n| join (\r\nAuditLogs\r\n |  where TimeGenerated {TimeRange:query}\r\n |  where OperationName == \"Reset user password\"\r\n) on $left.SourceRecordId == $right._ItemId\r\n| mv-expand TargetResources\r\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Password Reset\",\r\n         Tactic = \"Impact\",\r\n         Technique = \"Account Access Removal\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may interrupt availability of system and network resources by inhibiting access to accounts utilized by legitimate users. Accounts may be deleted, locked, or manipulated (ex: changed credentials) to remove access to accounts. LockerGoga, for example, has been observed changing account passwords and logging off current users. The query below generates an output of all users performing Reset user password for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority\r\n| sort by TimeGenerated desc;\r\nlet AnomalousGeoLocationLogon = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Sign-in\"\r\n| where ActivityInsights.FirstTimeUserConnectedFromCountry == True and (ActivityInsights.FirstTimeConnectionFromCountryObservedInTenant == True or ActivityInsights.CountryUncommonlyConnectedFromAmongPeers == True)\r\n| join (\r\nSigninLogs\r\n |  where TimeGenerated {TimeRange:query}\r\n) on $left.SourceRecordId == $right._ItemId\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Successful Logon\",\r\n         Tactic = \"Initial Access\",\r\n         Technique = \"Valid Accounts\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may steal the credentials of a specific user or service account using Credential Access techniques or capture credentials earlier in their reconnaissance process through social engineering for means of gaining Initial Access. APT33, for example, has used valid accounts for initial access. The query below generates an output of successful Sign-in performed by a user from a new geo location he has never connected from before, and none of his peers as well.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousFailedLogon = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActivityType == \"LogOn\"\r\n| where UsersInsights.BlastRadius == \"High\"\r\n| join (\r\n  SigninLogs  \r\n     | where TimeGenerated {TimeRange:query}\r\n     | where Status.errorCode == 50126\r\n) on $left.SourceRecordId == $right._ItemId\r\n| extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Failed Logon\",\r\n         Tactic = \"Credential Access\",\r\n         Technique = \"Brute Force\",\r\n         SubTechnique = \"Password Guessing\",\r\n         Description = \"Adversaries with no prior knowledge of legitimate credentials within the system or environment may guess passwords to attempt access to accounts. Emotet, for example, has been observed using a hard coded list of passwords to brute force user accounts. The query below generates an output of all users with 'High' BlastRadius that perform failed Sign-in:Invalid username or password.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType,[\"Evidence\"]=ActivityInsights, ResourceDisplayName,AppDisplayName ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; \r\nlet AnomalousAADAccountManipulation = AuditLogs\r\n| where TimeGenerated {TimeRange:query}\r\n| where OperationName == \"Update user\"\r\n| mv-expand AdditionalDetails\r\n| where AdditionalDetails.key == \"UserPrincipalName\"\r\n| mv-expand TargetResources\r\n| extend RoleId = tostring(TargetResources.modifiedProperties[0].newValue)\r\n| where isnotempty(RoleId) and RoleId in (critical,high)\r\n| extend RoleName = tostring(TargetResources.modifiedProperties[1].newValue)\r\n| where isnotempty(RoleName)\r\n| extend TargetId = tostring(TargetResources.id)\r\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\r\n| join kind=inner ( \r\n    BehaviorAnalytics\r\n    | where TimeGenerated {TimeRange:query}\r\n    | where ActionType == \"Update user\"\r\n    | where UsersInsights.BlasrRadius == \"High\" or ActivityInsights.FirstTimeUserPerformedAction == true\r\n) on $left._ItemId == $right.SourceRecordId\r\n|  extend UserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName) \r\n| extend AnomalyName = \"Anomalous Account Manipulation\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Account Manipulation\",\r\n         SubTechnique = \"\",\r\n         Description = \"Adversaries may manipulate accounts to maintain access to victim systems. These actions include adding new accounts to high privilleged groups. Dragonfly 2.0, for example, added newly created accounts to the administrators group to maintain elevated access. The query below generates an output of all high Blast Radius users performing 'Update user' (name change) to priveleged role, or ones that changed users for the first time.\"\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,RoleName,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority; let AnomalousAADAccountCreation = BehaviorAnalytics\r\n| where TimeGenerated {TimeRange:query}\r\n| where ActionType == \"Add user\"\r\n| where ActivityInsights.FirstTimeUserPerformedAction == True or ActivityInsights.FirstTimeActionPerformedInTenant == True or ActivityInsights.ActionUncommonlyPerformedAmongPeers == true\r\n| join(\r\nAuditLogs\r\n    | where TimeGenerated {TimeRange:query} \r\n    | where OperationName == \"Add user\"\r\n) on $left.SourceRecordId == $right._ItemId\r\n| mv-expand TargetResources\r\n| extend Target =  iff(tostring(TargetResources.userPrincipalName) contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(TargetResources.userPrincipalName, \"#\")[0])),TargetResources.userPrincipalName),tostring(TargetResources.userPrincipalName)\r\n| extend DisplayName = tostring(UsersInsights.AccountDisplayName),\r\nUserPrincipalName = iff(UserPrincipalName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserPrincipalName),\r\nUserName = iff(UserName contains \"#EXT#\",replace(\"_\",\"@\",tostring(split(UserPrincipalName, \"#\")[0])),UserName)\r\n| extend AnomalyName = \"Anomalous Account Creation\",\r\n         Tactic = \"Persistence\",\r\n         Technique = \"Create Account\",\r\n         SubTechnique = \"Cloud Account\",\r\n         Description = \"Adversaries may create a cloud account to maintain access to victim systems. With a sufficient level of access, such accounts may be used to establish secondary credentialed access that does not require persistent remote access tools to be deployed on the system. The query below generates an output of all the users performing user creation for the first time and the target users that were created.\"\t\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, [\"TargetUser\"]=Target,[\"Evidence\"]=ActivityInsights ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights,[\"Anomaly Score\"]=InvestigationPriority\r\n| sort by TimeGenerated desc;\r\nlet AnomalyTable = union kind=outer  AnomalousSigninActivity, AnomalousRoleAssignment, AnomalousResourceAccess, AnomalousRDPActivity, AnomalousPasswordReset, AnomalousLogintoDevices, AnomalousGeoLocationLogon, AnomalousAADAccountManipulation, AnomalousAADAccountCreation, AnomalousFailedLogon;\r\n\r\n\r\nlet GetUserAnomalies = AnomalyTable\r\n| extend SelectedAccountUPN = tolower(tostring('{SelectedUser}')),\r\n         SelectedName = tolower(tostring('{UserName}')),\r\n         SelectAAD = tolower(tostring('{UserObjectId}')),\r\n         SelectSID = tolower(tostring('{UserSid}'))\r\n| where (tolower(UserName) == tolower(SelectedName) and SelectedName != \"\" ) or (tolower(UserPrincipalName) == tolower(SelectedAccountUPN) and SelectedAccountUPN != \"\") or (UsersInsights.AccountObjectId == SelectAAD and SelectAAD != \"\") or (UsersInsights.OnPremSid == SelectSID and SelectSID != \"\")\r\n| project TimeGenerated, AnomalyName,Tactic,Technique,SubTechnique, Description, UserName, UserPrincipalName, UsersInsights, ActivityType, ActionType, TargetUser,Evidence ,SourceIPAddress, SourceIPLocation, SourceDevice, DevicesInsights, [\"Anomaly Score\"], AccountObjectId=UsersInsights.AccountObjectId;\r\nGetUserAnomalies\r\n| where AnomalyName == {AnomalyName:value} or {AnomalyName:value} == 'All'\r\n| where Tactic == {Tactic:value} or {Tactic:value} == 'All'\r\n| where  {AnomalyScore:value} == 'All' or [\"Anomaly Score\"] == {AnomalyScore:value}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","size":1,"showAnalytics":true,"noDataMessage":"No anomalies associated with this user","noDataMessageStyle":3,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Tactic","exportParameterName":"TacticM","exportDefaultValue":"None","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Description","formatter":7,"formatOptions":{"linkTarget":"CellDetails","linkIsContextBlade":true}},{"columnMatch":"Id","formatter":5},{"columnMatch":"IncidentUrl","formatter":7,"formatOptions":{"linkTarget":"Url"}},{"columnMatch":"ParentId","formatter":5}],"filter":true},"sortBy":[]},"conditionalVisibility":{"parameterName":"UserName","comparison":"isNotEqualTo","value":"None"},"customWidth":"70","name":"query - 6 - Copy - Copy"},{"type":1,"content":{"json":"### Lateral Movement\r\n\r\nThe adversary is trying to move through your environment.\r\n\r\nLateral Movement consists of techniques that adversaries use to enter and control remote systems on a network. Following through on their primary objective often requires exploring the network to find their target and subsequently gaining access to it. Reaching their objective often involves pivoting through multiple systems and accounts to gain. Adversaries might install their own remote access tools to accomplish Lateral Movement or use legitimate credentials with native network and operating system tools, which may be stealthier.\r\n\r\n[Learn More Here](https://attack.mitre.org/tactics/TA0008/)"},"conditionalVisibility":{"parameterName":"TacticM","comparison":"isEqualTo","value":"Lateral Movement"},"customWidth":"30","name":"text - 13 - Copy"},{"type":1,"content":{"json":"### Mitre Tactic Information\r\nClick on one of the anomalies to presents an overview of ATT&CK\r\n"},"conditionalVisibility":{"parameterName":"TacticM","comparison":"isEqualTo","value":"None"},"customWidth":"30","name":"text - 13 - Copy - Copy"},{"type":1,"content":{"json":"### Initial Access\r\n\r\nThe adversary is trying to get into your network.\r\n\r\nInitial Access consists of techniques that use various entry vectors to gain their initial foothold within a network. Techniques used to gain a foothold include targeted spearphishing and exploiting weaknesses on public-facing web servers. Footholds gained through initial access may allow for continued access, like valid accounts and use of external remote services, or may be limited-use due to changing passwords.\r\n\r\n[Learn More Here](https://attack.mitre.org/tactics/TA0001/)"},"conditionalVisibility":{"parameterName":"TacticM","comparison":"isEqualTo","value":"Initial Access"},"customWidth":"30","name":"text - 13"},{"type":1,"content":{"json":"### Persistence\r\n\r\nThe adversary is trying to maintain their foothold.\r\n\r\nPersistence consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access. Techniques used for persistence include any access, action, or configuration changes that let them maintain their foothold on systems, such as replacing or hijacking legitimate code or adding startup code.\r\n\r\n[Learn More Here](https://attack.mitre.org/tactics/TA0003/)"},"conditionalVisibility":{"parameterName":"TacticM","comparison":"isEqualTo","value":"Persistence"},"customWidth":"30","name":"text - 13 - Copy"},{"type":1,"content":{"json":"### Discovery\r\n\r\nThe adversary is trying to figure out your environment.\r\n\r\nDiscovery consists of techniques an adversary may use to gain knowledge about the system and internal network. These techniques help adversaries observe the environment and orient themselves before deciding how to act. They also allow adversaries to explore what they can control and what’s around their entry point in order to discover how it could benefit their current objective. Native operating system tools are often used toward this post-compromise information-gathering objective.\r\n\r\n[Learn More Here](https://attack.mitre.org/tactics/TA0007/)"},"conditionalVisibility":{"parameterName":"TacticM","comparison":"isEqualTo","value":"Discovery"},"customWidth":"30","name":"text - 13 - Copy - Copy - Copy - Copy"},{"type":1,"content":{"json":"### Collection\r\n\r\nThe adversary is trying to gather data of interest to their goal.\r\n\r\nCollection consists of techniques adversaries may use to gather information and the sources information is collected from that are relevant to following through on the adversary's objectives. Frequently, the next goal after collecting data is to steal (exfiltrate) the data. Common target sources include various drive types, browsers, audio, video, and email. Common collection methods include capturing screenshots and keyboard input.\r\n\r\n[Learn More Here](https://attack.mitre.org/tactics/TA0009/)"},"conditionalVisibility":{"parameterName":"TacticM","comparison":"isEqualTo","value":"Collection"},"customWidth":"30","name":"text - 13 - Copy - Copy"}]}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FUEAB.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## WindowsFirewall
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/WindowsFirewall.json)

### Workbook details

> Description: This workbook will get a report on windows firewall.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Firewall\n---\nThis workbook requires the following data connectors:\n\n| Log | Requirements | Steps |\n|:------------- |:-------------|:-----|\n| Windows Firewall | Sentinel connector, Agent, Firewall log| Install Windows Firewall connector and monitor agent, Enable firewall logging on host|\n| Windows Security Events (minimal)| Sentinel connector, Agent| Enable Security Event connector (minimal) and monitor agent |\n| Azure Signin | Sentinel connector, Diagnostics setting| Create Diagnostics setting for signinlogs|\n\n"},"name":"text - 2"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"24bfb86e-cf14-4585-a8fc-21f1f7f2227a","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"value":{"durationMs":604800000},"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}]},"resourceType":"microsoft.insights/components"},{"id":"7a206eb7-2655-42d5-a7d7-2e42bd04709b","version":"KqlParameterItem/1.0","name":"Computers","type":2,"multiSelect":true,"quote":"'","delimiter":",","query":"Heartbeat\r\n| where Solutions contains \"windowsFirewall\"\r\n| distinct Computer","typeSettings":{"additionalResourceOptions":[]},"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"customWidth":"33","name":"parameters "},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat\r\n| where Solutions contains \"windowsFirewall\"\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| project Computer, ['Last update'] = TimeGenerated, OSInfo = strcat(OSType, \" \", OSName, \" \", OSMajorVersion)\r\n| top 10 by ['Last update'] desc \r\n","size":4,"title":"Active connected computers","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Computer","formatter":1,"formatOptions":{"showIcon":true}},"subtitleContent":{"columnMatch":"OSInfo","formatter":1,"formatOptions":{"showIcon":true},"dateFormat":{"formatName":"shortDateTimePattern"}},"secondaryContent":{"columnMatch":"Last update","formatter":6,"formatOptions":{"showIcon":true},"dateFormat":{"formatName":"shortDateTimePattern"}},"showBorder":true,"sortCriteriaField":"Last update","sortOrderField":2}},"customWidth":"33","name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"Heartbeat\r\n| where Solutions contains \"windowsFirewall\"\r\n| summarize dcount(Computer), ActiveComputers = makeset(Computer) by bin(TimeGenerated, 15m)","size":4,"title":"Active connected computers timeline","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"timechart","chartSettings":{"ySettings":{"min":0,"max":null}}},"customWidth":"33","name":"query - 4"},{"type":1,"content":{"json":"----\r\n## Firewall events\r\n\r\nGeneral information about firewall port, IP's, protocols and actions"},"name":"text - 13"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let commonPorts = dynamic({\"443\": \"HTTPS\", \"80\":\"HTTP\", \"3389\":\"RDP\", \"53\":\"DNS\", \"389\":\"LDAP\", \"445\":\"SMB\", \"135\":\"RPC\", \"47001\":\"WinRM\",\"22\":\"ssh\", \"21\": \"ftp\"}); // Set of common portnames\r\nlet param_Computers = \"{Computers}\";\r\nWindowsFirewall \r\n| where isnotempty(DestinationPort) and (Computer == param_Computers or param_Computers contains Computer or isempty(param_Computers)) // Filter giver computers from parameter\r\n| summarize Dropped = countif(FirewallAction =~ \"DROP\"), Allowed = countif(FirewallAction =~ \"ALLOW\"), Total = count() by tostring(DestinationPort), Protocol\r\n| extend portName = iff(commonPorts contains DestinationPort, commonPorts[DestinationPort],DestinationPort)\r\n| sort by Total desc\r\n| project [\"Destination Port\"] = DestinationPort,['Core Protocol'] = Protocol , [\"Default Protocol\"] = portName, Total, Allowed, Dropped","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Destination Port","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Core Protocol","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Default Protocol","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Total","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"Allowed","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"Dropped","formatter":4,"formatOptions":{"showIcon":true}}]}},"customWidth":"60","name":"query - 10"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let param_Computers = \"{Computers}\";\r\nWindowsFirewall \r\n| where isnotempty(DestinationPort) and (Computer == param_Computers or param_Computers contains Computer or isempty(param_Computers))// Filter giver computers from parameter\r\n| summarize Allowed = count() by tostring(DestinationPort)\r\n| sort by Allowed desc\r\n| project DestinationPort, Allowed","size":0,"title":"Allowed Connections by Port","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"40","name":"query - 11 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let commonPorts = dynamic({\"443\": \"HTTPS\", \"80\":\"HTTP\", \"3389\":\"RDP\", \"53\":\"DNS\", \"389\":\"LDAP\", \"445\":\"SMB\", \"135\":\"RPC\", \"47001\":\"WinRM\",\"22\":\"ssh\", \"21\": \"ftp\"}); // Set of common portnames\r\nlet param_Computers = \"{Computers}\";\r\nWindowsFirewall \r\n| where isnotempty(DestinationPort) and isnotempty(DestinationPort) and (Computer == param_Computers or param_Computers contains Computer or isempty(param_Computers))// Filter giver computers from parameter\r\n| summarize Allowed = count() by tostring(DestinationPort)\r\n| extend portName = iff(commonPorts contains DestinationPort, commonPorts[DestinationPort],DestinationPort)\r\n| sort by Allowed desc\r\n| project portName, Allowed","size":0,"title":"Piechart by protocol","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"33","name":"query - 15"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let commonPorts = dynamic({\"443\": \"HTTPS\", \"80\":\"HTTP\", \"3389\":\"RDP\", \"53\":\"DNS\", \"389\":\"LDAP\", \"445\":\"SMB\", \"135\":\"RPC\", \"47001\":\"WinRM\",\"22\":\"ssh\", \"21\": \"ftp\"}); // Set of common portnames\r\nlet param_Computers = \"{Computers}\";\r\nWindowsFirewall\r\n| where isnotempty(DestinationPort) and (Computer == param_Computers or param_Computers contains Computer or isempty(param_Computers))\r\n| extend DestinationPort = tostring(DestinationPort)\r\n| extend protocolName = iff(commonPorts has DestinationPort, commonPorts[DestinationPort],Protocol)\r\n| summarize Events = count() by bin(TimeGenerated,30m), protocolName","size":0,"title":"Timechart by protocol","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"areachart"},"customWidth":"66","name":"query - 15"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let param_Computers = \"{Computers}\";\r\nWindowsFirewall\r\n| where (Computer == param_Computers or param_Computers contains Computer or param_Computers == \"\")\r\n| summarize Events = count() by FirewallAction","size":0,"title":"Piechart by firewall action","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"piechart"},"customWidth":"33","name":"query - 16"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let param_Computers = \"{Computers}\";\r\nWindowsFirewall\r\n| where (Computer == param_Computers or param_Computers contains Computer or param_Computers == \"\")\r\n| summarize Events = count() by bin(TimeGenerated,30m), FirewallAction","size":0,"title":"Timechart by firewall action","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"areachart"},"customWidth":"66","name":"query - 14"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let param_Computers = \"{Computers}\";\r\nSecurityEvent\r\n| where AccountType == \"User\" and  isnotempty(IpAddress) and (Computer == param_Computers or param_Computers contains Computer or param_Computers == \"\")\r\n| summarize EventCount = count(), DistinctIPCount = dcount(IpAddress),IPAddresses = makeset(IpAddress) by Account, Computer\r\n| top 10 by DistinctIPCount desc\r\n| extend machineAccount = strcat(Account,\" - \",Computer)\r\n| project Account, Computer, ['Distinct IP Count'] = DistinctIPCount, ['Event Count'] = EventCount, IPAddresses","size":0,"title":"Windows Security Events by Account","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Account","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"Distinct IP Count","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"Event Count","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"IPAddresses","formatter":0,"formatOptions":{"showIcon":true}}]},"sortBy":[],"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Account","formatter":1},"leftContent":{"columnMatch":"Tries","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{"createOtherGroup":8}},"name":"query - 11"},{"type":1,"content":{"json":"----\r\n## Correlation\r\n\r\nThese visuals give a representation of the Windows firewall, security log and Azure signins events.\r\n\r\nResults below could mean a targeted attack to an organization's private and public cloud. <br>\r\nThis can also be used to monitor the organization's most used IP's "},"name":"text - 14"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let param_Computers = \"{Computers}\";\r\nWindowsFirewall \r\n| where (Computer == param_Computers or param_Computers contains Computer or isempty(param_Computers))\r\n| summarize FirewallEvents = count() by SourceIP\r\n| join kind = inner(\r\n   SigninLogs\r\n   | summarize SuccessAzureLogin = countif(ResultType == 0), FailedAzureLogin = countif(ResultType != 0) by SourceIP = IPAddress\r\n) on SourceIP\r\n| join kind = inner(\r\n    SecurityEvent\r\n    | where LogonType == 10 \r\n    | summarize SucessRDPLogin = countif(EventID == 4624), FailedRDPlogin = countif(EventID == 4625) by SourceIP = IpAddress, Computer\r\n) on SourceIP\r\n| project SourceIP , Computer, ['Firewall events']=FirewallEvents, ['Success Azure logins']=SuccessAzureLogin, ['Failed Azure logins']=FailedAzureLogin, ['Success RDP logins']=SucessRDPLogin, ['Failed RDP logins']=FailedRDPlogin\r\n| sort by ['Failed RDP logins'],['Failed Azure logins'] desc","size":1,"title":"Correlating events between windows firewall, security logs and Azure signins","noDataMessage":"No links between Windows firewall and azure logins (positive)","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"query - 9"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let param_Computers = \"{Computers}\";\r\nSecurityEvent\r\n| where AccountType == \"User\" and LogonType == 10 and (Computer == param_Computers or param_Computers contains Computer or isempty(param_Computers))\r\n| summarize FailedRDPLogins = countif(EventID == 4625), SuccessRDPLogins = countif(EventID == 4624) by IpAddress, Computer\r\n| join kind= inner (\r\n    WindowsFirewall\r\n    | where DestinationPort == 3389 and (Computer == param_Computers or param_Computers contains Computer or isempty(param_Computers))\r\n    | summarize FirewallDropped = countif(FirewallAction =~ \"DROP\"), FirewallAllowed = countif(FirewallAction =~ \"ALLOW\") by SourceIP \r\n) on $left.IpAddress == $right.SourceIP \r\n| project Computer, IpAddress, FailedRDPLogins, SuccessRDPLogins, FirewallDropped, FirewallAllowed\r\n| sort by SuccessRDPLogins, FailedRDPLogins desc","size":0,"title":"Correlating events between Windows firewall and security logs","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Computer","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"IpAddress","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"FailedRDPLogins","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"SuccessRDPLogins","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"FirewallDropped","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"FirewallAllowed","formatter":4,"formatOptions":{"showIcon":true}}]}},"customWidth":"50","name":"query - 11"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let param_Computers = \"{Computers}\";\r\nWindowsFirewall\r\n| where (Computer == param_Computers or param_Computers contains Computer or isempty(param_Computers)) and SourceIP !in (\"::1\",\"-\")\r\n| summarize FirewallEvents = count() by SourceIP\r\n| join(\r\nSecurityEvent\r\n| where isnotempty(IpAddress) and (Computer == param_Computers or param_Computers contains Computer or isempty(param_Computers))\r\n| summarize SecurityEvents = count() by SourceIP = IpAddress\r\n) on SourceIP\r\n| top 15 by FirewallEvents desc\r\n| project SourceIP, SecurityEvents, FirewallEvents","size":0,"title":"Correlating IPs between Windows firewall and security logs","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"SourceIP","formatter":0,"formatOptions":{"showIcon":true}},{"columnMatch":"SecurityEvents","formatter":4,"formatOptions":{"showIcon":true}},{"columnMatch":"FirewallEvents","formatter":4,"formatOptions":{"showIcon":true}}]}},"customWidth":"50","name":"query - 13"}],"fromTemplateId":"WindowsFirewall","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FWindowsFirewall.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## WorkspaceAudit
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/WorkspaceAudit.json)

### Workbook details

> Description: This workbook will get a report on a workspace.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Workspace auditing report\r\nUse this report to understand query runs across your workspace. \r\n<br/>\r\n<br/>"},"name":"text - 0"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Workspace}"],"parameters":[{"id":"ccd5adcd-8d59-4cfe-99ec-98075de2e253","version":"KqlParameterItem/1.0","name":"DefaultSubscription_Internal","type":1,"isRequired":true,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| take 1\r\n| project subscriptionId","crossComponentResources":["value::selected"],"isHiddenWhenLocked":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"1ca69445-60fc-4806-b43d-ac7e6aad630a","version":"KqlParameterItem/1.0","name":"Subscription","type":6,"query":"summarize by subscriptionId\r\n| project value = strcat(\"/subscriptions/\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)\r\n","crossComponentResources":["value::selected"],"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"queryType":1,"resourceType":"microsoft.resourcegraph/resources","value":"/subscriptions/7b76bfbc-cb1e-4df1-b6e8-b826eef6c592"},{"id":"e94aafa3-c5d9-4523-89f0-4e87aa754511","version":"KqlParameterItem/1.0","name":"Workspace","type":5,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\n| project id","crossComponentResources":["{Subscription}"],"value":"/subscriptions/7b76bfbc-cb1e-4df1-b6e8-b826eef6c592/resourceGroups/soc/providers/microsoft.operationalinsights/workspaces/cybersecuritysoc","typeSettings":{"resourceTypeFilter":{"microsoft.operationalinsights/workspaces":true},"additionalResourceOptions":[]},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"c4b69c01-2263-4ada-8d9c-43433b739ff3","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"typeSettings":{"selectableValues":[{"durationMs":300000},{"durationMs":900000},{"durationMs":1800000},{"durationMs":3600000},{"durationMs":14400000},{"durationMs":43200000},{"durationMs":86400000},{"durationMs":172800000},{"durationMs":259200000},{"durationMs":604800000},{"durationMs":1209600000},{"durationMs":2419200000},{"durationMs":2592000000},{"durationMs":5184000000},{"durationMs":7776000000}],"allowCustom":false},"value":{"durationMs":1209600000}}],"style":"pills","queryType":0,"resourceType":"microsoft.insights/components"},"name":"parameters - 1"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Summary","subTarget":"Summary","style":"link"},{"cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Failed Queries","subTarget":"Failed Queries","style":"link"},{"cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Query Run Performance","subTarget":"Query Run Performance","style":"link"},{"cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Queries run by user","subTarget":"Queries run by user","style":"link"},{"cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"Query explorer","subTarget":"Query explorer","style":"link"},{"cellValue":"selectedTab","linkTarget":"parameter","linkLabel":"CRUD Operations","subTarget":"CRUD Operations","style":"link"}]},"name":"links - 19"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"LAQueryLogs\r\n| summarize events_count=count() by bin(TimeGenerated, 1d)","size":0,"title":"Total queries run on workspace","timeContext":{"durationMs":1209600000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart"},"name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"LAQueryLogs\r\n| summarize events_count=count() by AADEmail\r\n| extend UserPrincipalName = AADEmail, Queries = events_count\r\n| join kind= leftouter (\r\n    SigninLogs)\r\n    on UserPrincipalName\r\n| extend User = UserPrincipalName, NoOfQueries = Queries\r\n| project User, NoOfQueries\r\n| summarize arg_max(NoOfQueries, *) by User\r\n| sort by NoOfQueries desc\r\n| take 20","size":0,"title":"Top query users","timeContext":{"durationMs":1209600000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"tiles","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"User","formatter":1},"leftContent":{"columnMatch":"NoOfQueries","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Summary"},"name":"group - 8"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"LAQueryLogs\r\n| where ResponseCode != 200 \r\n| summarize events_count=count() by AADEmail\r\n| sort by events_count desc \r\n| take 10","size":0,"title":"Users with the most failed queries","timeContext":{"durationMs":1209600000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"barchart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"AADEmail","formatter":1},"leftContent":{"columnMatch":"events_count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"LAQueryLogs\r\n| where ResponseCode != 200 \r\n| summarize events_count=count() by ResponseCode\r\n| extend HTTPResponse = ResponseCode, QueryCount = events_count\r\n| project-away ResponseCode, events_count\r\n| sort by QueryCount desc ","size":0,"title":"Number of failed queries by error code","timeContext":{"durationMs":1209600000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table","tileSettings":{"showBorder":false}},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Failed Queries"},"name":"group - 9"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"LAQueryLogs\r\n|summarize arg_max(StatsCPUTimeMs, *) by AADClientId\r\n| extend User = AADEmail, QueryRunTimeMs = StatsCPUTimeMs\r\n| project User, QueryRunTimeMs, QueryText\r\n| order by QueryRunTimeMs desc ","size":0,"title":"Longest running queries","timeContext":{"durationMs":1209600000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table"},"name":"query - 0"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Query Run Performance"},"name":"group - 10"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"LAQueryLogs\r\n| summarize count () by AADEmail, bin(TimeGenerated, 1d)","size":0,"title":"Query runs by user","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"timechart"},"name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"LAQueryLogs\r\n| project TimeGenerated, AADEmail, QueryTimeRangeStart, QueryTimeRangeEnd, QueryText","size":0,"timeContext":{"durationMs":0},"timeContextFromParameter":"TimeBrush","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"query - 1"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Query explorer"},"name":"group - 6"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{Workspace}"],"parameters":[{"id":"76ca20d6-06fd-4aa0-bbf4-8adbdebf7d40","version":"KqlParameterItem/1.0","name":"User","type":2,"query":"SigninLogs\r\n| distinct UserPrincipalName","crossComponentResources":["{Workspace}"],"value":"cboehmsa@seccxpninja.onmicrosoft.com","typeSettings":{"additionalResourceOptions":[]},"timeContext":{"durationMs":1209600000},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"}],"style":"pills","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"LAQueryLogs\r\n| where AADEmail contains '{User}'\r\n| summarize events_count=count() by bin(TimeGenerated, 1d) ","size":0,"title":"Query runs by user","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"linechart"},"name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"LAQueryLogs\r\n| where AADEmail contains '{User}'\r\n| project TimeGenerated, AADEmail, QueryTimeRangeStart, QueryTimeRangeEnd, QueryText\r\n","size":0,"title":"User query details","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"table"},"name":"query - 2"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"Queries run by user"},"name":"group - 7"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity \r\n| where OperationNameValue contains \"SecurityInsights\" \r\n| where OperationName contains \"Delete\" \r\n| where ActivityStatusValue contains \"Succeeded\" \r\n| project TimeGenerated, Caller, OperationName \r\n| extend User = Caller\r\n| project-away Caller\r\n| summarize events_count=count() by User\r\n| sort by events_count desc  ","size":0,"title":"Workspace delete activity","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"customWidth":"33","name":"query - 0"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity \r\n| where OperationNameValue contains \"SecurityInsights\" \r\n| where OperationName contains \"Create\" \r\n| where ActivityStatusValue contains \"Succeeded\" \r\n| project TimeGenerated, Caller, OperationName \r\n| extend User = Caller\r\n| project-away Caller\r\n| summarize events_count=count() by User\r\n| sort by events_count desc  ","size":0,"title":"Workspace create activity","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"customWidth":"33","name":"query - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity \r\n| where OperationNameValue contains \"SecurityInsights\" \r\n| where OperationName contains \"Update\" \r\n| where ActivityStatusValue contains \"Succeeded\" \r\n| project TimeGenerated, Caller, OperationName \r\n| extend User = Caller\r\n| project-away Caller\r\n| summarize events_count=count() by User\r\n| sort by events_count desc  ","size":0,"title":"Workspace update activity","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"]},"customWidth":"33","name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"AzureActivity \r\n| where OperationNameValue contains \"SecurityInsights\" \r\n| where ActivityStatusValue contains \"Failed\" \r\n| summarize count() by Caller","size":0,"title":"Unauthorized requests","color":"redBright","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","timeBrushParameterName":"Unauthorized","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"barchart"},"name":"query - 3"}]},"conditionalVisibility":{"parameterName":"selectedTab","comparison":"isEqualTo","value":"CRUD Operations"},"name":"group - 8"}],"fallbackResourceIds":["/subscriptions/7b76bfbc-cb1e-4df1-b6e8-b826eef6c592/resourcegroups/soc/providers/microsoft.operationalinsights/workspaces/cybersecuritysoc"],"fromTemplateId":"sentinel-WorkspaceAuditing","$schema":"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FWorkspaceAudit.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>

## WorkspaceUsageCost
### Workbook Tags

> Author: [thomas couilleaux](https://www.metsys.fr/)

> Reference: [Link to medium post](https://github.com/Azure/Azure-Sentinel/tree/master/Workbooks/WorkspaceUsageCost.json)

### Workbook details

> Description: This workbook will get a report on workspace usage and cost.

> Query:

```t
{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Workspace Usage and Cost\r\nUse this report to analyze the the sizes vs costs of the different tables in your workspace. \r\n<br/>\r\n<br/>"},"name":"text - 0"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"ccd5adcd-8d59-4cfe-99ec-98075de2e253","version":"KqlParameterItem/1.0","name":"DefaultSubscription_Internal","type":1,"isRequired":true,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\r\n| take 1\r\n| project subscriptionId","crossComponentResources":["value::selected"],"isHiddenWhenLocked":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"1ca69445-60fc-4806-b43d-ac7e6aad630a","version":"KqlParameterItem/1.0","name":"Subscription","type":6,"isRequired":true,"query":"summarize by subscriptionId\r\n| project value = strcat(\"/subscriptions/\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)\r\n","crossComponentResources":["value::selected"],"typeSettings":{"additionalResourceOptions":[]},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"e94aafa3-c5d9-4523-89f0-4e87aa754511","version":"KqlParameterItem/1.0","name":"Workspace","type":5,"isRequired":true,"query":"where type =~ 'microsoft.operationalinsights/workspaces'\n| project id","crossComponentResources":["{Subscription}"],"value":"/subscriptions/c3a3408b-632a-4df4-9c92-deded42a7e48/resourceGroups/SentinelAsCode-rg/providers/Microsoft.OperationalInsights/workspaces/qualif-wks","typeSettings":{"resourceTypeFilter":{"microsoft.operationalinsights/workspaces":true},"additionalResourceOptions":["value::1"]},"queryType":1,"resourceType":"microsoft.resourcegraph/resources"},{"id":"c4b69c01-2263-4ada-8d9c-43433b739ff3","version":"KqlParameterItem/1.0","name":"TimeRange","type":4,"typeSettings":{"selectableValues":[{"durationMs":300000,"createdTime":"2018-08-06T23:52:38.870Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":900000,"createdTime":"2018-08-06T23:52:38.871Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":1800000,"createdTime":"2018-08-06T23:52:38.871Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":3600000,"createdTime":"2018-08-06T23:52:38.871Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":14400000,"createdTime":"2018-08-06T23:52:38.871Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":43200000,"createdTime":"2018-08-06T23:52:38.871Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":86400000,"createdTime":"2018-08-06T23:52:38.871Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":172800000,"createdTime":"2018-08-06T23:52:38.871Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":259200000,"createdTime":"2018-08-06T23:52:38.871Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false},{"durationMs":604800000,"createdTime":"2018-08-06T23:52:38.871Z","isInitialTime":false,"grain":1,"useDashboardTimeRange":false}],"allowCustom":null},"value":{"durationMs":604800000}}],"style":"above","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"name":"parameters - 1"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource=['Table Name'] *\r\n| summarize Entries = count(), Size = sum(estimate_data_size(*)) by ['Table Name']\r\n| order by Size desc\r\n| project ['Table Name'], ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries\r\n","size":0,"showAnalytics":true,"title":"Data consumption","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"gridSettings":{"formatters":[{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}}],"filter":true}},"name":"query - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource=['Table Name'] *\r\n| summarize Entries = count(), Size = sum(estimate_data_size(*)) by ['Table Name'], ResourceGroup\r\n| order by Size desc\r\n| project ['Table Name'], ResourceGroup, ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries\r\n","size":0,"showAnalytics":true,"title":"Data consumption by ResourceGroup","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue"},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange"},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}}],"filter":true}},"name":"query - 2 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource=['Table Name'] *\r\n| summarize Entries = count(), Size = sum(estimate_data_size(*)) by ['Table Name'], ResourceProvider\r\n| order by Size desc\r\n| project ['Table Name'], ResourceProvider, ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries\r\n","size":0,"showAnalytics":true,"title":"Data consumption by ResourceProvider","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green"},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue"},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange"},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}}],"filter":true}},"name":"query - 2 - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource=['Table Name'] *\r\n| where _IsBillable == true\r\n| summarize Entries = count(), Size = sum(_BilledSize) by ['Table Name']\r\n| order by Size desc\r\n| project ['Table Name'], ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries, ['Estimation Cost'] = Size/1024/1024/1024 * (2.328+2.11)","size":0,"showAnalytics":true,"title":"Cost Estimation","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}}],"filter":true}},"name":"query - 2 - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource=['Table Name'] *\r\n| where _IsBillable == true\r\n| summarize Entries = count(), Size = sum(_BilledSize) by ['Table Name'], ResourceGroup\r\n| order by Size desc\r\n| project ['Table Name'], ResourceGroup, ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries, ['Estimation Cost'] = Size/1024/1024/1024 * (2.328+2.11)","size":0,"showAnalytics":true,"title":"Cost Estimation by ResourceGroup","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}}],"filter":true}},"name":"query - 2 - Copy - Copy"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource=['Table Name'] *\r\n| where _IsBillable == true\r\n| summarize Entries = count(), Size = sum(_BilledSize) by ['Table Name'], ResourceProvider\r\n| order by Size desc\r\n| project ['Table Name'], ResourceProvider, ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries, ['Estimation Cost'] = Size/1024/1024/1024 * (2.328+2.11)","size":0,"showAnalytics":true,"title":"Cost Estimation by ResourceProvider","timeContext":{"durationMs":0},"timeContextFromParameter":"TimeRange","exportFieldName":"Table Name","exportParameterName":"Table","exportDefaultValue":"All Tables","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","gridSettings":{"formatters":[{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Size per Entry","formatter":3,"formatOptions":{"min":0,"palette":"orange","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal","maximumFractionDigits":2}}}],"filter":true}},"name":"query - 2 - Copy - Copy - Copy"},{"type":1,"content":{"json":"💡_Click on a row in the table above to see more details_\n<br />\n<br />"},"name":"text - 3"},{"type":1,"content":{"json":"### Table Entries"},"customWidth":"50","name":"text - 4"},{"type":1,"content":{"json":"### Table Size"},"customWidth":"50","name":"text - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource=['Table Name'] *\r\n| where '{Table}' == 'All Tables' or ['Table Name'] == '{Table}'\r\n| make-series TableSize = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n| mvexpand TableSize to typeof(real), TimeGenerated to typeof(datetime) limit 1000\r\n| project TimeGenerated, ['{Table}'] = TableSize","size":0,"showAnalytics":true,"color":"green","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Namespace","exportParameterName":"Namespace","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart","gridSettings":{"formatters":[{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue","showIcon":true}}],"filter":true}},"customWidth":"50","name":"query - 6"},{"type":3,"content":{"version":"KqlItem/1.0","query":"union withsource=['Table Name'] *\r\n| where '{Table}' == 'All Tables' or ['Table Name'] == '{Table}'\r\n| make-series TableSize = sum(estimate_data_size(*)) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} \r\n| mvexpand TableSize to typeof(real), TimeGenerated to typeof(datetime) limit 1000\r\n| project TimeGenerated, ['{Table}'] = TableSize","size":0,"showAnalytics":true,"color":"blue","timeContext":{"durationMs":604800000},"timeContextFromParameter":"TimeRange","exportFieldName":"Namespace","exportParameterName":"Namespace","exportDefaultValue":"All","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{Workspace}"],"visualization":"areachart","gridSettings":{"formatters":[{"columnMatch":"Table Entries","formatter":3,"formatOptions":{"min":0,"palette":"green","showIcon":true},"numberFormat":{"unit":17,"options":{"style":"decimal"}}},{"columnMatch":"Table Size","formatter":3,"formatOptions":{"min":0,"palette":"blue","showIcon":true},"numberFormat":{"unit":2,"options":{"style":"decimal"}}},{"columnMatch":"Table Size Trend","formatter":9,"formatOptions":{"min":0,"palette":"blue","showIcon":true}}],"filter":true}},"customWidth":"50","name":"query - 7"}],"isLocked":false,"fallbackResourceIds":["/subscriptions/c3a3408b-632a-4df4-9c92-deded42a7e48/resourcegroups/accorinvest/providers/microsoft.operationalinsights/workspaces/accorinvest"],"fromTemplateId":"sentinel-UserWorkbook"}
```

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fgaelor%2FSentinelAsCode%2Fmaster%2FWorkbooks%2FWorkspaceUsageCost.json" target="_blank">
<img src="https://aka.ms/deploytoazurebutton""/>
</a>


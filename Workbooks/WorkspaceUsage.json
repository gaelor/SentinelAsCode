{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workbookName": {
            "defaultValue": "[newGuid()]",
            "type": "string",
            "metadata": {
                "description": "The unique guid for this workbook instance"
            }
        },
        "workbookDisplayName": {
            "defaultValue": "<workbook>",
            "type": "string",
            "metadata": {
                "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
            }
        },
        "workbookType": {
            "defaultValue": "sentinel",
            "type": "string",
            "metadata": {
                "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
            }
        },
        "Workspace": {
            "defaultValue": "<workspace>",
            "type": "string",
            "metadata": {
                "description": "The workspace used by the workbook"
            }
        },
        "workspaces_externalid": {
            "defaultValue": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/microsoft.operationalinsights/workspaces/', parameters('Workspace'))]",
            "type": "string"
        },
        "description": {
            "defaultValue": "This workbook will get a report on workspace usage and cost.",
            "type": "string"
        },
        "author": {
            "defaultValue": "thomas couilleaux",
            "type": "string"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "microsoft.insights/workbooks",
            "apiVersion": "2018-06-17-preview",
            "name": "[parameters('workbookName')]",
            "location": "westeurope",
            "tags": {
                "hidden-title": "[concat(parameters('workbookDisplayName'), ' - ', parameters('Workspace'))]"
            },
            "kind": "shared",
            "identity": {
                "type": "None"
            },
            "properties": {
                "displayName": "[concat(parameters('workbookDisplayName'), ' - ', parameters('Workspace'))]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Workspace Usage\\r\\nUse this report to analyze the the sizes of the different tables in your workspace. \\r\\n<br/>\\r\\n<br/>\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"ccd5adcd-8d59-4cfe-99ec-98075de2e253\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DefaultSubscription_Internal\",\"type\":1,\"isRequired\":true,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| take 1\\r\\n| project subscriptionId\",\"crossComponentResources\":[\"value::selected\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"1ca69445-60fc-4806-b43d-ac7e6aad630a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"query\":\"summarize by subscriptionId\\r\\n| project value = strcat(\\\"/subscriptions/\\\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)\\r\\n\",\"crossComponentResources\":[\"value::selected\"],\"typeSettings\":{\"additionalResourceOptions\":[]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\n| project id\",\"crossComponentResources\":[\"{Subscription}\"],\"value\":\"/subscriptions/c3a3408b-632a-4df4-9c92-deded42a7e48/resourceGroups/SentinelAsCode-rg/providers/Microsoft.OperationalInsights/workspaces/qualif-wks\",\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.operationalinsights/workspaces\":true},\"additionalResourceOptions\":[\"value::1\"]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"c4b69c01-2263-4ada-8d9c-43433b739ff3\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000,\"createdTime\":\"2018-08-06T23:52:38.870Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":900000,\"createdTime\":\"2018-08-06T23:52:38.871Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":1800000,\"createdTime\":\"2018-08-06T23:52:38.871Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":3600000,\"createdTime\":\"2018-08-06T23:52:38.871Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":14400000,\"createdTime\":\"2018-08-06T23:52:38.871Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":43200000,\"createdTime\":\"2018-08-06T23:52:38.871Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":86400000,\"createdTime\":\"2018-08-06T23:52:38.871Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":172800000,\"createdTime\":\"2018-08-06T23:52:38.871Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":259200000,\"createdTime\":\"2018-08-06T23:52:38.871Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":604800000,\"createdTime\":\"2018-08-06T23:52:38.871Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false}],\"allowCustom\":null},\"value\":{\"durationMs\":604800000}}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=['Table Name'] *\\r\\n| summarize Entries = count(), Size = sum(estimate_data_size(*)) by ['Table Name']\\r\\n| order by Size desc\\r\\n| project ['Table Name'], ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Data consumption\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Table Name\",\"exportParameterName\":\"Table\",\"exportDefaultValue\":\"All Tables\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Size per Entry\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"orange\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}}],\"filter\":true}},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=['Table Name'] *\\r\\n| summarize Entries = count(), Size = sum(estimate_data_size(*)) by ['Table Name'], ResourceGroup\\r\\n| order by Size desc\\r\\n| project ['Table Name'], ResourceGroup, ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Data consumption by ResourceGroup\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Table Name\",\"exportParameterName\":\"Table\",\"exportDefaultValue\":\"All Tables\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\"},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Size per Entry\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"orange\"},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}}],\"filter\":true}},\"name\":\"query - 2 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=['Table Name'] *\\r\\n| summarize Entries = count(), Size = sum(estimate_data_size(*)) by ['Table Name'], ResourceProvider\\r\\n| order by Size desc\\r\\n| project ['Table Name'], ResourceProvider, ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Data consumption by ResourceProvider\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Table Name\",\"exportParameterName\":\"Table\",\"exportDefaultValue\":\"All Tables\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\"},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Size per Entry\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"orange\"},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}}],\"filter\":true}},\"name\":\"query - 2 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=['Table Name'] *\\r\\n| where _IsBillable == true\\r\\n| summarize Entries = count(), Size = sum(_BilledSize) by ['Table Name']\\r\\n| order by Size desc\\r\\n| project ['Table Name'], ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries, ['Estimation Cost'] = Size/1024/1024/1024 * (2.328+2.11)\",\"size\":0,\"showAnalytics\":true,\"title\":\"Cost Estimation\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Table Name\",\"exportParameterName\":\"Table\",\"exportDefaultValue\":\"All Tables\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Size per Entry\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"orange\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}}],\"filter\":true}},\"name\":\"query - 2 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=['Table Name'] *\\r\\n| where _IsBillable == true\\r\\n| summarize Entries = count(), Size = sum(_BilledSize) by ['Table Name'], ResourceGroup\\r\\n| order by Size desc\\r\\n| project ['Table Name'], ResourceGroup, ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries, ['Estimation Cost'] = Size/1024/1024/1024 * (2.328+2.11)\",\"size\":0,\"showAnalytics\":true,\"title\":\"Cost Estimation by ResourceGroup\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Table Name\",\"exportParameterName\":\"Table\",\"exportDefaultValue\":\"All Tables\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Size per Entry\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"orange\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}}],\"filter\":true}},\"name\":\"query - 2 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=['Table Name'] *\\r\\n| where _IsBillable == true\\r\\n| summarize Entries = count(), Size = sum(_BilledSize) by ['Table Name'], ResourceProvider\\r\\n| order by Size desc\\r\\n| project ['Table Name'], ResourceProvider, ['Table Entries'] = Entries, ['Table Size'] = Size, ['Size per Entry'] = 1.0 * Size / Entries, ['Estimation Cost'] = Size/1024/1024/1024 * (2.328+2.11)\",\"size\":0,\"showAnalytics\":true,\"title\":\"Cost Estimation by ResourceProvider\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Table Name\",\"exportParameterName\":\"Table\",\"exportDefaultValue\":\"All Tables\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Size per Entry\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"orange\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}}],\"filter\":true}},\"name\":\"query - 2 - Copy - Copy - Copy\"},{\"type\":1,\"content\":{\"json\":\"💡_Click on a row in the table above to see more details_\\n<br />\\n<br />\"},\"name\":\"text - 3\"},{\"type\":1,\"content\":{\"json\":\"### Table Entries\"},\"customWidth\":\"50\",\"name\":\"text - 4\"},{\"type\":1,\"content\":{\"json\":\"### Table Size\"},\"customWidth\":\"50\",\"name\":\"text - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=['Table Name'] *\\r\\n| where '{Table}' == 'All Tables' or ['Table Name'] == '{Table}'\\r\\n| make-series TableSize = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\\r\\n| mvexpand TableSize to typeof(real), TimeGenerated to typeof(datetime) limit 1000\\r\\n| project TimeGenerated, ['{Table}'] = TableSize\",\"size\":0,\"showAnalytics\":true,\"color\":\"green\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Namespace\",\"exportParameterName\":\"Namespace\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"areachart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union withsource=['Table Name'] *\\r\\n| where '{Table}' == 'All Tables' or ['Table Name'] == '{Table}'\\r\\n| make-series TableSize = sum(estimate_data_size(*)) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} \\r\\n| mvexpand TableSize to typeof(real), TimeGenerated to typeof(datetime) limit 1000\\r\\n| project TimeGenerated, ['{Table}'] = TableSize\",\"size\":0,\"showAnalytics\":true,\"color\":\"blue\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Namespace\",\"exportParameterName\":\"Namespace\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"areachart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Table Entries\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"green\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Table Size Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 7\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/c3a3408b-632a-4df4-9c92-deded42a7e48/resourcegroups/accorinvest/providers/microsoft.operationalinsights/workspaces/accorinvest\"],\"fromTemplateId\":\"sentinel-UserWorkbook\"}",
                "version": "1.0",
                "category": "[parameters('workbookType')]",
                "sourceId": "[parameters('workspaces_externalid')]",
                "tags": [
                ]
            }
        }
    ]
}